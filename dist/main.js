(()=>{var $w=Object.create;var ad=Object.defineProperty;var Lw=Object.getOwnPropertyDescriptor;var Dw=Object.getOwnPropertyNames;var Fw=Object.getPrototypeOf,Uw=Object.prototype.hasOwnProperty;var y=(n,e)=>()=>(n&&(e=n(n=0)),e);var Ne=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),ds=(n,e)=>{for(var t in e)ad(n,t,{get:e[t],enumerable:!0})},Bw=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Dw(e))!Uw.call(n,a)&&a!==t&&ad(n,a,{get:()=>e[a],enumerable:!(r=Lw(e,a))||r.enumerable});return n};var oe=(n,e,t)=>(t=n!=null?$w(Fw(n)):{},Bw(e||!n||!n.__esModule?ad(t,"default",{value:n,enumerable:!0}):t,n));var ym,bm,_m,fu=y(()=>{ym=Symbol("Let zodToJsonSchema decide on which parser to use"),bm={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},_m=n=>typeof n=="string"?{...bm,name:n}:{...bm,...n}});var wm,id=y(()=>{fu();wm=n=>{let e=_m(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}}});function od(n,e,t,r){r?.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function F(n,e,t,r,a){n[e]=t,od(n,e,r,a)}var tn=y(()=>{});function qw(n){Am=n}function hu(){return Am}function A(n,e){let t=hu(),r=pu({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===ps?void 0:ps].filter(a=>!!a)});n.common.issues.push(r)}function mu(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}function Om(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t}function j(n){if(!n)return{};let{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>{var u,l;let{message:c}=n;return i.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:(u=c??r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(l=c??t)!==null&&l!==void 0?l:o.defaultError}},description:a}}function Im(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function av(n){return new RegExp(`^${Im(n)}$`)}function Tm(n){let e=`${Em}T${Im(n)}`,t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function sv(n,e){return!!((e==="v4"||!e)&&ev.test(n)||(e==="v6"||!e)&&tv.test(n))}function iv(n,e){let t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}function fs(n){if(n instanceof Xe){let e={};for(let t in n.shape){let r=n.shape[t];e[t]=wt.create(fs(r))}return new Xe({...n._def,shape:()=>e})}else return n instanceof Tr?new Tr({...n._def,type:fs(n.element)}):n instanceof wt?wt.create(fs(n.unwrap())):n instanceof sr?sr.create(fs(n.unwrap())):n instanceof ar?ar.create(n.items.map(e=>fs(e))):n}function fd(n,e){let t=rn(n),r=rn(e);if(n===e)return{valid:!0,data:n};if(t===E.object&&r===E.object){let a=z.objectKeys(e),s=z.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(let o of s){let u=fd(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===E.array&&r===E.array){if(n.length!==e.length)return{valid:!1};let a=[];for(let s=0;s<n.length;s++){let i=n[s],o=e[s],u=fd(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===E.date&&r===E.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}function Pm(n,e){return new Qn({values:n,typeName:w.ZodEnum,...j(e)})}function Sm(n,e={},t){return n?an.create().superRefine((r,a)=>{var s,i;if(!n(r)){let o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,l=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...l,fatal:u})}}):an.create()}var z,ld,E,rn,_,Hw,dt,ps,Am,pu,Vw,je,C,hs,Be,cd,dd,Ni,ji,I,ki,Ri,vt,vm,M,Gw,Kw,Jw,Ww,Zw,Yw,Xw,Qw,ud,ev,tv,rv,Em,nv,nn,Hn,qn,Vn,Gn,ms,Kn,Jn,an,Ir,Nt,gs,Tr,Xe,Wn,Er,gu,Zn,ar,bu,bs,ys,yu,Yn,Xn,Qn,ea,sn,ft,wt,sr,ta,ra,_s,ov,Mi,$i,na,uv,w,lv,Cm,km,cv,dv,Rm,fv,hv,pv,mv,gv,bv,yv,_v,wv,vv,xv,Av,Ov,Ev,Iv,Tv,Pv,Sv,Cv,kv,Rv,Nv,jv,Mv,xm,$v,Lv,Dv,Fv,Uv,Bv,zv,Hv,qv,se,Pr=y(()=>{(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{let s={};for(let i of a)s[i]=i;return s},n.getValidEnumValues=a=>{let s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(let o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{let s=[];for(let i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(let i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(z||(z={}));(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(ld||(ld={}));E=z.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),rn=n=>{switch(typeof n){case"undefined":return E.undefined;case"string":return E.string;case"number":return isNaN(n)?E.nan:E.number;case"boolean":return E.boolean;case"function":return E.function;case"bigint":return E.bigint;case"symbol":return E.symbol;case"object":return Array.isArray(n)?E.array:n===null?E.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?E.promise:typeof Map<"u"&&n instanceof Map?E.map:typeof Set<"u"&&n instanceof Set?E.set:typeof Date<"u"&&n instanceof Date?E.date:E.object;default:return E.unknown}},_=z.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Hw=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:"),dt=class n extends Error{constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){let t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(let i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){let l=i.path[u];u===i.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(i))):o[l]=o[l]||{_errors:[]},o=o[l],u++}}};return a(this),r}static assert(e){if(!(e instanceof n))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,z.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},r=[];for(let a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};dt.create=n=>new dt(n);ps=(n,e)=>{let t;switch(n.code){case _.invalid_type:n.received===E.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case _.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,z.jsonStringifyReplacer)}`;break;case _.unrecognized_keys:t=`Unrecognized key(s) in object: ${z.joinValues(n.keys,", ")}`;break;case _.invalid_union:t="Invalid input";break;case _.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${z.joinValues(n.options)}`;break;case _.invalid_enum_value:t=`Invalid enum value. Expected ${z.joinValues(n.options)}, received '${n.received}'`;break;case _.invalid_arguments:t="Invalid function arguments";break;case _.invalid_return_type:t="Invalid function return type";break;case _.invalid_date:t="Invalid date";break;case _.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:z.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case _.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case _.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case _.custom:t="Invalid input";break;case _.invalid_intersection_types:t="Intersection results could not be merged";break;case _.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case _.not_finite:t="Number must be finite";break;default:t=e.defaultError,z.assertNever(n)}return{message:t}},Am=ps;pu=n=>{let{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};if(a.message!==void 0)return{...a,path:s,message:a.message};let o="",u=r.filter(l=>!!l).slice().reverse();for(let l of u)o=l(i,{data:e,defaultError:o}).message;return{...a,path:s,message:o}},Vw=[];je=class n{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if(a.status==="aborted")return C;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let a of t){let s=await a.key,i=await a.value;r.push({key:s,value:i})}return n.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return C;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}},C=Object.freeze({status:"aborted"}),hs=n=>({status:"dirty",value:n}),Be=n=>({status:"valid",value:n}),cd=n=>n.status==="aborted",dd=n=>n.status==="dirty",Ni=n=>n.status==="valid",ji=n=>typeof Promise<"u"&&n instanceof Promise;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e?.message})(I||(I={}));vt=class{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},vm=(n,e)=>{if(Ni(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new dt(n.common.issues);return this._error=t,this._error}}};M=class{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return rn(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:rn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new je,ctx:{common:e.parent.common,data:e.data,parsedType:rn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(ji(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;let a={common:{issues:[],async:(r=t?.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:rn(e)},s=this._parseSync({data:e,path:a.path,parent:a});return vm(a,s)}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:rn(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(ji(a)?a:Promise.resolve(a));return vm(r,s)}refine(e,t){let r=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{let i=e(a),o=()=>s.addIssue({code:_.custom,...r(a)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new ft({schema:this,typeName:w.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return wt.create(this,this._def)}nullable(){return sr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Tr.create(this,this._def)}promise(){return sn.create(this,this._def)}or(e){return Wn.create([this,e],this._def)}and(e){return Zn.create(this,e,this._def)}transform(e){return new ft({...j(this._def),schema:this,typeName:w.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new ta({...j(this._def),innerType:this,defaultValue:t,typeName:w.ZodDefault})}brand(){return new Mi({typeName:w.ZodBranded,type:this,...j(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new ra({...j(this._def),innerType:this,catchValue:t,typeName:w.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return $i.create(this,e)}readonly(){return na.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Gw=/^c[^\s-]{8,}$/i,Kw=/^[0-9a-z]+$/,Jw=/^[0-9A-HJKMNP-TV-Z]{26}$/,Ww=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Zw=/^[a-z0-9_-]{21}$/i,Yw=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Xw=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Qw="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",ev=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,tv=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,rv=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Em="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",nv=new RegExp(`^${Em}$`);nn=class n extends M{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==E.string){let s=this._getOrReturnCtx(e);return A(s,{code:_.invalid_type,expected:E.string,received:s.parsedType}),C}let r=new je,a;for(let s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:_.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:_.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){let i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?A(a,{code:_.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&A(a,{code:_.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")Xw.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"email",code:_.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")ud||(ud=new RegExp(Qw,"u")),ud.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"emoji",code:_.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")Ww.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"uuid",code:_.invalid_string,message:s.message}),r.dirty());else if(s.kind==="nanoid")Zw.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"nanoid",code:_.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")Gw.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid",code:_.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")Kw.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid2",code:_.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")Jw.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"ulid",code:_.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),A(a,{validation:"url",code:_.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"regex",code:_.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),A(a,{code:_.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:_.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:_.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?Tm(s).test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:_.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="date"?nv.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:_.invalid_string,validation:"date",message:s.message}),r.dirty()):s.kind==="time"?av(s).test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:_.invalid_string,validation:"time",message:s.message}),r.dirty()):s.kind==="duration"?Yw.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"duration",code:_.invalid_string,message:s.message}),r.dirty()):s.kind==="ip"?sv(e.data,s.version)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"ip",code:_.invalid_string,message:s.message}),r.dirty()):s.kind==="base64"?rv.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"base64",code:_.invalid_string,message:s.message}),r.dirty()):z.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:_.invalid_string,...I.errToObj(r)})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...I.errToObj(e)})}url(e){return this._addCheck({kind:"url",...I.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...I.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...I.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...I.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...I.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...I.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...I.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...I.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...I.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:(t=e?.offset)!==null&&t!==void 0?t:!1,local:(r=e?.local)!==null&&r!==void 0?r:!1,...I.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...I.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...I.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...I.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...I.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...I.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...I.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...I.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...I.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...I.errToObj(t)})}nonempty(e){return this.min(1,I.errToObj(e))}trim(){return new n({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};nn.create=n=>{var e;return new nn({checks:[],typeName:w.ZodString,coerce:(e=n?.coerce)!==null&&e!==void 0?e:!1,...j(n)})};Hn=class n extends M{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==E.number){let s=this._getOrReturnCtx(e);return A(s,{code:_.invalid_type,expected:E.number,received:s.parsedType}),C}let r,a=new je;for(let s of this._def.checks)s.kind==="int"?z.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),A(r,{code:_.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:_.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:_.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?iv(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),A(r,{code:_.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),A(r,{code:_.not_finite,message:s.message}),a.dirty()):z.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,I.toString(t))}gt(e,t){return this.setLimit("min",e,!1,I.toString(t))}lte(e,t){return this.setLimit("max",e,!0,I.toString(t))}lt(e,t){return this.setLimit("max",e,!1,I.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:I.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:I.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:I.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:I.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:I.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:I.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:I.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:I.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:I.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:I.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&z.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};Hn.create=n=>new Hn({checks:[],typeName:w.ZodNumber,coerce:n?.coerce||!1,...j(n)});qn=class n extends M{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==E.bigint){let s=this._getOrReturnCtx(e);return A(s,{code:_.invalid_type,expected:E.bigint,received:s.parsedType}),C}let r,a=new je;for(let s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:_.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:_.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),A(r,{code:_.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):z.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,I.toString(t))}gt(e,t){return this.setLimit("min",e,!1,I.toString(t))}lte(e,t){return this.setLimit("max",e,!0,I.toString(t))}lt(e,t){return this.setLimit("max",e,!1,I.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:I.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:I.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:I.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:I.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:I.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:I.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};qn.create=n=>{var e;return new qn({checks:[],typeName:w.ZodBigInt,coerce:(e=n?.coerce)!==null&&e!==void 0?e:!1,...j(n)})};Vn=class extends M{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==E.boolean){let r=this._getOrReturnCtx(e);return A(r,{code:_.invalid_type,expected:E.boolean,received:r.parsedType}),C}return Be(e.data)}};Vn.create=n=>new Vn({typeName:w.ZodBoolean,coerce:n?.coerce||!1,...j(n)});Gn=class n extends M{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==E.date){let s=this._getOrReturnCtx(e);return A(s,{code:_.invalid_type,expected:E.date,received:s.parsedType}),C}if(isNaN(e.data.getTime())){let s=this._getOrReturnCtx(e);return A(s,{code:_.invalid_date}),C}let r=new je,a;for(let s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:_.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:_.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):z.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:I.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:I.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};Gn.create=n=>new Gn({checks:[],coerce:n?.coerce||!1,typeName:w.ZodDate,...j(n)});ms=class extends M{_parse(e){if(this._getType(e)!==E.symbol){let r=this._getOrReturnCtx(e);return A(r,{code:_.invalid_type,expected:E.symbol,received:r.parsedType}),C}return Be(e.data)}};ms.create=n=>new ms({typeName:w.ZodSymbol,...j(n)});Kn=class extends M{_parse(e){if(this._getType(e)!==E.undefined){let r=this._getOrReturnCtx(e);return A(r,{code:_.invalid_type,expected:E.undefined,received:r.parsedType}),C}return Be(e.data)}};Kn.create=n=>new Kn({typeName:w.ZodUndefined,...j(n)});Jn=class extends M{_parse(e){if(this._getType(e)!==E.null){let r=this._getOrReturnCtx(e);return A(r,{code:_.invalid_type,expected:E.null,received:r.parsedType}),C}return Be(e.data)}};Jn.create=n=>new Jn({typeName:w.ZodNull,...j(n)});an=class extends M{constructor(){super(...arguments),this._any=!0}_parse(e){return Be(e.data)}};an.create=n=>new an({typeName:w.ZodAny,...j(n)});Ir=class extends M{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Be(e.data)}};Ir.create=n=>new Ir({typeName:w.ZodUnknown,...j(n)});Nt=class extends M{_parse(e){let t=this._getOrReturnCtx(e);return A(t,{code:_.invalid_type,expected:E.never,received:t.parsedType}),C}};Nt.create=n=>new Nt({typeName:w.ZodNever,...j(n)});gs=class extends M{_parse(e){if(this._getType(e)!==E.undefined){let r=this._getOrReturnCtx(e);return A(r,{code:_.invalid_type,expected:E.void,received:r.parsedType}),C}return Be(e.data)}};gs.create=n=>new gs({typeName:w.ZodVoid,...j(n)});Tr=class n extends M{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==E.array)return A(t,{code:_.invalid_type,expected:E.array,received:t.parsedType}),C;if(a.exactLength!==null){let i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(A(t,{code:i?_.too_big:_.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(A(t,{code:_.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(A(t,{code:_.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new vt(t,i,t.path,o)))).then(i=>je.mergeArray(r,i));let s=[...t.data].map((i,o)=>a.type._parseSync(new vt(t,i,t.path,o)));return je.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new n({...this._def,minLength:{value:e,message:I.toString(t)}})}max(e,t){return new n({...this._def,maxLength:{value:e,message:I.toString(t)}})}length(e,t){return new n({...this._def,exactLength:{value:e,message:I.toString(t)}})}nonempty(e){return this.min(1,e)}};Tr.create=(n,e)=>new Tr({type:n,minLength:null,maxLength:null,exactLength:null,typeName:w.ZodArray,...j(e)});Xe=class n extends M{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=z.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==E.object){let l=this._getOrReturnCtx(e);return A(l,{code:_.invalid_type,expected:E.object,received:l.parsedType}),C}let{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Nt&&this._def.unknownKeys==="strip"))for(let l in a.data)i.includes(l)||o.push(l);let u=[];for(let l of i){let c=s[l],f=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new vt(a,f,a.path,l)),alwaysSet:l in a.data})}if(this._def.catchall instanceof Nt){let l=this._def.unknownKeys;if(l==="passthrough")for(let c of o)u.push({key:{status:"valid",value:c},value:{status:"valid",value:a.data[c]}});else if(l==="strict")o.length>0&&(A(a,{code:_.unrecognized_keys,keys:o}),r.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let l=this._def.catchall;for(let c of o){let f=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new vt(a,f,a.path,c)),alwaysSet:c in a.data})}}return a.common.async?Promise.resolve().then(async()=>{let l=[];for(let c of u){let f=await c.key,d=await c.value;l.push({key:f,value:d,alwaysSet:c.alwaysSet})}return l}).then(l=>je.mergeObjectSync(r,l)):je.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return I.errToObj,new n({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;let u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=I.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new n({...this._def,unknownKeys:"strip"})}passthrough(){return new n({...this._def,unknownKeys:"passthrough"})}extend(e){return new n({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new n({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:w.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new n({...this._def,catchall:e})}pick(e){let t={};return z.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}omit(e){let t={};return z.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}deepPartial(){return fs(this)}partial(e){let t={};return z.objectKeys(this.shape).forEach(r=>{let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new n({...this._def,shape:()=>t})}required(e){let t={};return z.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof wt;)s=s._def.innerType;t[r]=s}}),new n({...this._def,shape:()=>t})}keyof(){return Pm(z.objectKeys(this.shape))}};Xe.create=(n,e)=>new Xe({shape:()=>n,unknownKeys:"strip",catchall:Nt.create(),typeName:w.ZodObject,...j(e)});Xe.strictCreate=(n,e)=>new Xe({shape:()=>n,unknownKeys:"strict",catchall:Nt.create(),typeName:w.ZodObject,...j(e)});Xe.lazycreate=(n,e)=>new Xe({shape:n,unknownKeys:"strip",catchall:Nt.create(),typeName:w.ZodObject,...j(e)});Wn=class extends M{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(let o of s)if(o.result.status==="valid")return o.result;for(let o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let i=s.map(o=>new dt(o.ctx.common.issues));return A(t,{code:_.invalid_union,unionErrors:i}),C}if(t.common.async)return Promise.all(r.map(async s=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s,i=[];for(let u of r){let l={...t,common:{...t.common,issues:[]},parent:null},c=u._parseSync({data:t.data,path:t.path,parent:l});if(c.status==="valid")return c;c.status==="dirty"&&!s&&(s={result:c,ctx:l}),l.common.issues.length&&i.push(l.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;let o=i.map(u=>new dt(u));return A(t,{code:_.invalid_union,unionErrors:o}),C}}get options(){return this._def.options}};Wn.create=(n,e)=>new Wn({options:n,typeName:w.ZodUnion,...j(e)});Er=n=>n instanceof Yn?Er(n.schema):n instanceof ft?Er(n.innerType()):n instanceof Xn?[n.value]:n instanceof Qn?n.options:n instanceof ea?z.objectValues(n.enum):n instanceof ta?Er(n._def.innerType):n instanceof Kn?[void 0]:n instanceof Jn?[null]:n instanceof wt?[void 0,...Er(n.unwrap())]:n instanceof sr?[null,...Er(n.unwrap())]:n instanceof Mi||n instanceof na?Er(n.unwrap()):n instanceof ra?Er(n._def.innerType):[],gu=class n extends M{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.object)return A(t,{code:_.invalid_type,expected:E.object,received:t.parsedType}),C;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(A(t,{code:_.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),C)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let s of t){let i=Er(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new n({typeName:w.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...j(r)})}};Zn=class extends M{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(cd(s)||cd(i))return C;let o=fd(s.value,i.value);return o.valid?((dd(s)||dd(i))&&t.dirty(),{status:t.value,value:o.data}):(A(r,{code:_.invalid_intersection_types}),C)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};Zn.create=(n,e,t)=>new Zn({left:n,right:e,typeName:w.ZodIntersection,...j(t)});ar=class n extends M{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.array)return A(r,{code:_.invalid_type,expected:E.array,received:r.parsedType}),C;if(r.data.length<this._def.items.length)return A(r,{code:_.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),C;!this._def.rest&&r.data.length>this._def.items.length&&(A(r,{code:_.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let s=[...r.data].map((i,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new vt(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>je.mergeArray(t,i)):je.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new n({...this._def,rest:e})}};ar.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ar({items:n,typeName:w.ZodTuple,rest:null,...j(e)})};bu=class n extends M{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.object)return A(r,{code:_.invalid_type,expected:E.object,received:r.parsedType}),C;let a=[],s=this._def.keyType,i=this._def.valueType;for(let o in r.data)a.push({key:s._parse(new vt(r,o,r.path,o)),value:i._parse(new vt(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?je.mergeObjectAsync(t,a):je.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof M?new n({keyType:e,valueType:t,typeName:w.ZodRecord,...j(r)}):new n({keyType:nn.create(),valueType:e,typeName:w.ZodRecord,...j(t)})}},bs=class extends M{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.map)return A(r,{code:_.invalid_type,expected:E.map,received:r.parsedType}),C;let a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],l)=>({key:a._parse(new vt(r,o,r.path,[l,"key"])),value:s._parse(new vt(r,u,r.path,[l,"value"]))}));if(r.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of i){let l=await u.key,c=await u.value;if(l.status==="aborted"||c.status==="aborted")return C;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of i){let l=u.key,c=u.value;if(l.status==="aborted"||c.status==="aborted")return C;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}}}};bs.create=(n,e,t)=>new bs({valueType:e,keyType:n,typeName:w.ZodMap,...j(t)});ys=class n extends M{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.set)return A(r,{code:_.invalid_type,expected:E.set,received:r.parsedType}),C;let a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(A(r,{code:_.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(A(r,{code:_.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function i(u){let l=new Set;for(let c of u){if(c.status==="aborted")return C;c.status==="dirty"&&t.dirty(),l.add(c.value)}return{status:t.value,value:l}}let o=[...r.data.values()].map((u,l)=>s._parse(new vt(r,u,r.path,l)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new n({...this._def,minSize:{value:e,message:I.toString(t)}})}max(e,t){return new n({...this._def,maxSize:{value:e,message:I.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};ys.create=(n,e)=>new ys({valueType:n,minSize:null,maxSize:null,typeName:w.ZodSet,...j(e)});yu=class n extends M{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.function)return A(t,{code:_.invalid_type,expected:E.function,received:t.parsedType}),C;function r(o,u){return pu({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,hu(),ps].filter(l=>!!l),issueData:{code:_.invalid_arguments,argumentsError:u}})}function a(o,u){return pu({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,hu(),ps].filter(l=>!!l),issueData:{code:_.invalid_return_type,returnTypeError:u}})}let s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof sn){let o=this;return Be(async function(...u){let l=new dt([]),c=await o._def.args.parseAsync(u,s).catch(h=>{throw l.addIssue(r(u,h)),l}),f=await Reflect.apply(i,this,c);return await o._def.returns._def.type.parseAsync(f,s).catch(h=>{throw l.addIssue(a(f,h)),l})})}else{let o=this;return Be(function(...u){let l=o._def.args.safeParse(u,s);if(!l.success)throw new dt([r(u,l.error)]);let c=Reflect.apply(i,this,l.data),f=o._def.returns.safeParse(c,s);if(!f.success)throw new dt([a(c,f.error)]);return f.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new n({...this._def,args:ar.create(e).rest(Ir.create())})}returns(e){return new n({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new n({args:e||ar.create([]).rest(Ir.create()),returns:t||Ir.create(),typeName:w.ZodFunction,...j(r)})}},Yn=class extends M{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};Yn.create=(n,e)=>new Yn({getter:n,typeName:w.ZodLazy,...j(e)});Xn=class extends M{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return A(t,{received:t.data,code:_.invalid_literal,expected:this._def.value}),C}return{status:"valid",value:e.data}}get value(){return this._def.value}};Xn.create=(n,e)=>new Xn({value:n,typeName:w.ZodLiteral,...j(e)});Qn=class n extends M{constructor(){super(...arguments),ki.set(this,void 0)}_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),r=this._def.values;return A(t,{expected:z.joinValues(r),received:t.parsedType,code:_.invalid_type}),C}if(mu(this,ki,"f")||Om(this,ki,new Set(this._def.values),"f"),!mu(this,ki,"f").has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return A(t,{received:t.data,code:_.invalid_enum_value,options:r}),C}return Be(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return n.create(e,{...this._def,...t})}exclude(e,t=this._def){return n.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}};ki=new WeakMap;Qn.create=Pm;ea=class extends M{constructor(){super(...arguments),Ri.set(this,void 0)}_parse(e){let t=z.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==E.string&&r.parsedType!==E.number){let a=z.objectValues(t);return A(r,{expected:z.joinValues(a),received:r.parsedType,code:_.invalid_type}),C}if(mu(this,Ri,"f")||Om(this,Ri,new Set(z.getValidEnumValues(this._def.values)),"f"),!mu(this,Ri,"f").has(e.data)){let a=z.objectValues(t);return A(r,{received:r.data,code:_.invalid_enum_value,options:a}),C}return Be(e.data)}get enum(){return this._def.values}};Ri=new WeakMap;ea.create=(n,e)=>new ea({values:n,typeName:w.ZodNativeEnum,...j(e)});sn=class extends M{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.promise&&t.common.async===!1)return A(t,{code:_.invalid_type,expected:E.promise,received:t.parsedType}),C;let r=t.parsedType===E.promise?t.data:Promise.resolve(t.data);return Be(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}};sn.create=(n,e)=>new sn({type:n,typeName:w.ZodPromise,...j(e)});ft=class extends M{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===w.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{A(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){let i=a.transform(r.data,s);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return C;let u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?C:u.status==="dirty"||t.value==="dirty"?hs(u.value):u});{if(t.value==="aborted")return C;let o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?C:o.status==="dirty"||t.value==="dirty"?hs(o.value):o}}if(a.type==="refinement"){let i=o=>{let u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){let o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?C:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?C:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Ni(i))return i;let o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Ni(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);z.assertNever(a)}};ft.create=(n,e,t)=>new ft({schema:n,typeName:w.ZodEffects,effect:e,...j(t)});ft.createWithPreprocess=(n,e,t)=>new ft({schema:e,effect:{type:"preprocess",transform:n},typeName:w.ZodEffects,...j(t)});wt=class extends M{_parse(e){return this._getType(e)===E.undefined?Be(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};wt.create=(n,e)=>new wt({innerType:n,typeName:w.ZodOptional,...j(e)});sr=class extends M{_parse(e){return this._getType(e)===E.null?Be(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};sr.create=(n,e)=>new sr({innerType:n,typeName:w.ZodNullable,...j(e)});ta=class extends M{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===E.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};ta.create=(n,e)=>new ta({innerType:n,typeName:w.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...j(e)});ra=class extends M{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return ji(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new dt(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new dt(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};ra.create=(n,e)=>new ra({innerType:n,typeName:w.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...j(e)});_s=class extends M{_parse(e){if(this._getType(e)!==E.nan){let r=this._getOrReturnCtx(e);return A(r,{code:_.invalid_type,expected:E.nan,received:r.parsedType}),C}return{status:"valid",value:e.data}}};_s.create=n=>new _s({typeName:w.ZodNaN,...j(n)});ov=Symbol("zod_brand"),Mi=class extends M{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},$i=class n extends M{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?C:s.status==="dirty"?(t.dirty(),hs(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{let a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?C:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new n({in:e,out:t,typeName:w.ZodPipeline})}},na=class extends M{_parse(e){let t=this._def.innerType._parse(e),r=a=>(Ni(a)&&(a.value=Object.freeze(a.value)),a);return ji(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}};na.create=(n,e)=>new na({innerType:n,typeName:w.ZodReadonly,...j(e)});uv={object:Xe.lazycreate};(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(w||(w={}));lv=(n,e={message:`Input not instance of ${n.name}`})=>Sm(t=>t instanceof n,e),Cm=nn.create,km=Hn.create,cv=_s.create,dv=qn.create,Rm=Vn.create,fv=Gn.create,hv=ms.create,pv=Kn.create,mv=Jn.create,gv=an.create,bv=Ir.create,yv=Nt.create,_v=gs.create,wv=Tr.create,vv=Xe.create,xv=Xe.strictCreate,Av=Wn.create,Ov=gu.create,Ev=Zn.create,Iv=ar.create,Tv=bu.create,Pv=bs.create,Sv=ys.create,Cv=yu.create,kv=Yn.create,Rv=Xn.create,Nv=Qn.create,jv=ea.create,Mv=sn.create,xm=ft.create,$v=wt.create,Lv=sr.create,Dv=ft.createWithPreprocess,Fv=$i.create,Uv=()=>Cm().optional(),Bv=()=>km().optional(),zv=()=>Rm().optional(),Hv={string:n=>nn.create({...n,coerce:!0}),number:n=>Hn.create({...n,coerce:!0}),boolean:n=>Vn.create({...n,coerce:!0}),bigint:n=>qn.create({...n,coerce:!0}),date:n=>Gn.create({...n,coerce:!0})},qv=C,se=Object.freeze({__proto__:null,defaultErrorMap:ps,setErrorMap:qw,getErrorMap:hu,makeIssue:pu,EMPTY_PATH:Vw,addIssueToContext:A,ParseStatus:je,INVALID:C,DIRTY:hs,OK:Be,isAborted:cd,isDirty:dd,isValid:Ni,isAsync:ji,get util(){return z},get objectUtil(){return ld},ZodParsedType:E,getParsedType:rn,ZodType:M,datetimeRegex:Tm,ZodString:nn,ZodNumber:Hn,ZodBigInt:qn,ZodBoolean:Vn,ZodDate:Gn,ZodSymbol:ms,ZodUndefined:Kn,ZodNull:Jn,ZodAny:an,ZodUnknown:Ir,ZodNever:Nt,ZodVoid:gs,ZodArray:Tr,ZodObject:Xe,ZodUnion:Wn,ZodDiscriminatedUnion:gu,ZodIntersection:Zn,ZodTuple:ar,ZodRecord:bu,ZodMap:bs,ZodSet:ys,ZodFunction:yu,ZodLazy:Yn,ZodLiteral:Xn,ZodEnum:Qn,ZodNativeEnum:ea,ZodPromise:sn,ZodEffects:ft,ZodTransformer:ft,ZodOptional:wt,ZodNullable:sr,ZodDefault:ta,ZodCatch:ra,ZodNaN:_s,BRAND:ov,ZodBranded:Mi,ZodPipeline:$i,ZodReadonly:na,custom:Sm,Schema:M,ZodSchema:M,late:uv,get ZodFirstPartyTypeKind(){return w},coerce:Hv,any:gv,array:wv,bigint:dv,boolean:Rm,date:fv,discriminatedUnion:Ov,effect:xm,enum:Nv,function:Cv,instanceof:lv,intersection:Ev,lazy:kv,literal:Rv,map:Pv,nan:cv,nativeEnum:jv,never:yv,null:mv,nullable:Lv,number:km,object:vv,oboolean:zv,onumber:Bv,optional:$v,ostring:Uv,pipeline:Fv,preprocess:Dv,promise:Mv,record:Tv,set:Sv,strictObject:xv,string:Cm,symbol:hv,transformer:xm,tuple:Iv,undefined:pv,union:Av,unknown:bv,void:_v,NEVER:qv,ZodIssueCode:_,quotelessJson:Hw,ZodError:dt})});function Nm(){return{}}var hd=y(()=>{});function jm(n,e){let t={type:"array"};return n.type?._def?.typeName!==w.ZodAny&&(t.items=S(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&F(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&F(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(F(t,"minItems",n.exactLength.value,n.exactLength.message,e),F(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}var pd=y(()=>{Pr();tn();ue()});function Mm(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?F(t,"minimum",r.value,r.message,e):F(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),F(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?F(t,"maximum",r.value,r.message,e):F(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),F(t,"maximum",r.value,r.message,e));break;case"multipleOf":F(t,"multipleOf",r.value,r.message,e);break}return t}var md=y(()=>{tn()});function $m(){return{type:"boolean"}}var gd=y(()=>{});function Lm(n,e){return S(n.type._def,e)}var bd=y(()=>{ue()});var Dm,yd=y(()=>{ue();Dm=(n,e)=>S(n.innerType._def,e)});function _d(n,e,t){let r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>_d(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Vv(n,e)}}var Vv,wd=y(()=>{tn();Vv=(n,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let r of n.checks)switch(r.kind){case"min":F(t,"minimum",r.value,r.message,e);break;case"max":F(t,"maximum",r.value,r.message,e);break}return t}});function Fm(n,e){return{...S(n.innerType._def,e),default:n.defaultValue()}}var vd=y(()=>{ue()});function Um(n,e){return e.effectStrategy==="input"?S(n.schema._def,e):{}}var xd=y(()=>{ue()});function Bm(n){return{type:"string",enum:n.values}}var Ad=y(()=>{});function zm(n,e){let t=[S(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),S(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if(Gv(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}var Gv,Od=y(()=>{ue();Gv=n=>"type"in n&&n.type==="string"?!1:"allOf"in n});function Hm(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var Ed=y(()=>{});function _u(n,e){let t={type:"string"};function r(a){return e.patternStrategy==="escape"?Kv(a):a}if(n.checks)for(let a of n.checks)switch(a.kind){case"min":F(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":F(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":jt(t,"email",a.message,e);break;case"format:idn-email":jt(t,"idn-email",a.message,e);break;case"pattern:zod":Mt(t,aa.email,a.message,e);break}break;case"url":jt(t,"uri",a.message,e);break;case"uuid":jt(t,"uuid",a.message,e);break;case"regex":Mt(t,a.regex,a.message,e);break;case"cuid":Mt(t,aa.cuid,a.message,e);break;case"cuid2":Mt(t,aa.cuid2,a.message,e);break;case"startsWith":Mt(t,RegExp(`^${r(a.value)}`),a.message,e);break;case"endsWith":Mt(t,RegExp(`${r(a.value)}$`),a.message,e);break;case"datetime":jt(t,"date-time",a.message,e);break;case"date":jt(t,"date",a.message,e);break;case"time":jt(t,"time",a.message,e);break;case"duration":jt(t,"duration",a.message,e);break;case"length":F(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),F(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{Mt(t,RegExp(r(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&jt(t,"ipv4",a.message,e),a.version!=="v4"&&jt(t,"ipv6",a.message,e);break}case"emoji":Mt(t,aa.emoji,a.message,e);break;case"ulid":{Mt(t,aa.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{jt(t,"binary",a.message,e);break}case"contentEncoding:base64":{F(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{Mt(t,aa.base64,a.message,e);break}}break}case"nanoid":Mt(t,aa.nanoid,a.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var aa,Kv,jt,Mt,qm,wu=y(()=>{tn();aa={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u"),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};Kv=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),jt=(n,e,t,r)=>{n.format||n.anyOf?.some(a=>a.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):F(n,"format",e,t,r)},Mt=(n,e,t,r)=>{n.pattern||n.allOf?.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:qm(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):F(n,"pattern",qm(e,r),t,r)},qm=(n,e)=>{if(!e.applyRegexFlags||!n.flags)return n.source;let t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source,a="",s=!1,i=!1,o=!1;for(let u=0;u<r.length;u++){if(s){a+=r[u],s=!1;continue}if(t.i){if(i){if(r[u].match(/[a-z]/)){o?(a+=r[u],a+=`${r[u-2]}-${r[u]}`.toUpperCase(),o=!1):r[u+1]==="-"&&r[u+2]?.match(/[a-z]/)?(a+=r[u],o=!0):a+=`${r[u]}${r[u].toUpperCase()}`;continue}}else if(r[u].match(/[a-z]/)){a+=`[${r[u]}${r[u].toUpperCase()}]`;continue}}if(t.m){if(r[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&r[u]==="."){a+=i?`${r[u]}\r
`:`[${r[u]}\r
]`;continue}a+=r[u],r[u]==="\\"?s=!0:i&&r[u]==="]"?i=!1:!i&&r[u]==="["&&(i=!0)}try{let u=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}});function vu(n,e){if(e.target==="openApi3"&&n.keyType?._def.typeName===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((r,a)=>({...r,[a]:S(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",a]})??{}}),{}),additionalProperties:!1};let t={type:"object",additionalProperties:S(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(n.keyType?._def.typeName===w.ZodString&&n.keyType._def.checks?.length){let r=Object.entries(_u(n.keyType._def,e)).reduce((a,[s,i])=>s==="type"?a:{...a,[s]:i},{});return{...t,propertyNames:r}}else if(n.keyType?._def.typeName===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}var xu=y(()=>{Pr();ue();wu()});function Vm(n,e){if(e.mapStrategy==="record")return vu(n,e);let t=S(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=S(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}var Id=y(()=>{ue();xu()});function Gm(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}var Td=y(()=>{});function Km(){return{not:{}}}var Pd=y(()=>{});function Jm(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Sd=y(()=>{});function Zm(n,e){if(e.target==="openApi3")return Wm(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Li&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=Li[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Wm(n,e)}var Li,Wm,Au=y(()=>{ue();Li={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};Wm=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>S(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0}});function Ym(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Li[n.innerType._def.typeName],nullable:!0}:{type:[Li[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=S(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=S(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}var Cd=y(()=>{ue();Au()});function Xm(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",od(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?F(t,"minimum",r.value,r.message,e):F(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),F(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?F(t,"maximum",r.value,r.message,e):F(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),F(t,"maximum",r.value,r.message,e));break;case"multipleOf":F(t,"multipleOf",r.value,r.message,e);break}return t}var kd=y(()=>{tn()});function Jv(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":S(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":S(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Qm(n,e){let t={type:"object",...Object.entries(n.shape()).reduce((r,[a,s])=>{if(s===void 0||s._def===void 0)return r;let i=S(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?r:{properties:{...r.properties,[a]:i},required:s.isOptional()?r.required:[...r.required,a]}},{properties:{},required:[]}),additionalProperties:Jv(n,e)};return t.required.length||delete t.required,t}var Rd=y(()=>{ue()});var eg,Nd=y(()=>{ue();eg=(n,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return S(n.innerType._def,e);let t=S(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}}});var tg,jd=y(()=>{ue();tg=(n,e)=>{if(e.pipeStrategy==="input")return S(n.in._def,e);if(e.pipeStrategy==="output")return S(n.out._def,e);let t=S(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=S(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}}});function rg(n,e){return S(n.type._def,e)}var Md=y(()=>{ue()});function ng(n,e){let r={type:"array",uniqueItems:!0,items:S(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&F(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&F(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}var $d=y(()=>{tn();ue()});function ag(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>S(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:S(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>S(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}var Ld=y(()=>{ue()});function sg(){return{not:{}}}var Dd=y(()=>{});function ig(){return{}}var Fd=y(()=>{});var og,Ud=y(()=>{ue();og=(n,e)=>S(n.innerType._def,e)});function S(n,e,t=!1){let r=e.seen.get(n);if(e.override){let i=e.override?.(n,e,r,t);if(i!==ym)return i}if(r&&!t){let i=Wv(r,e);if(i!==void 0)return i}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=Yv(n,n.typeName,e);return s&&Xv(n,e,s),a.jsonSchema=s,s}var Wv,Zv,Yv,Xv,ue=y(()=>{Pr();hd();pd();md();gd();bd();yd();wd();vd();xd();Ad();Od();Ed();Id();Td();Pd();Sd();Cd();kd();Rd();Nd();jd();Md();xu();$d();wu();Ld();Dd();Au();Fd();Ud();fu();Wv=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Zv(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Zv=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Yv=(n,e,t)=>{switch(e){case w.ZodString:return _u(n,t);case w.ZodNumber:return Xm(n,t);case w.ZodObject:return Qm(n,t);case w.ZodBigInt:return Mm(n,t);case w.ZodBoolean:return $m();case w.ZodDate:return _d(n,t);case w.ZodUndefined:return sg();case w.ZodNull:return Jm(t);case w.ZodArray:return jm(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return Zm(n,t);case w.ZodIntersection:return zm(n,t);case w.ZodTuple:return ag(n,t);case w.ZodRecord:return vu(n,t);case w.ZodLiteral:return Hm(n,t);case w.ZodEnum:return Bm(n);case w.ZodNativeEnum:return Gm(n);case w.ZodNullable:return Ym(n,t);case w.ZodOptional:return eg(n,t);case w.ZodMap:return Vm(n,t);case w.ZodSet:return ng(n,t);case w.ZodLazy:return S(n.getter()._def,t);case w.ZodPromise:return rg(n,t);case w.ZodNaN:case w.ZodNever:return Km();case w.ZodEffects:return Um(n,t);case w.ZodAny:return Nm();case w.ZodUnknown:return ig();case w.ZodDefault:return Fm(n,t);case w.ZodBranded:return Lm(n,t);case w.ZodReadonly:return og(n,t);case w.ZodCatch:return Dm(n,t);case w.ZodPipeline:return tg(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(r=>{})(e)}},Xv=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t)});var Q,Bd=y(()=>{ue();id();Q=(n,e)=>{let t=wm(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[l,c])=>({...u,[l]:S(c._def,{...t,currentPath:[...t.basePath,t.definitionPath,l]},!0)??{}}),{}):void 0,a=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,s=S(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);let o=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o}});var ht=y(()=>{fu();id();tn();ue();hd();pd();md();gd();bd();yd();wd();vd();xd();Ad();Od();Ed();Id();Td();Pd();Sd();Cd();kd();Rd();Nd();jd();Md();Ud();xu();$d();wu();Ld();Dd();Au();Fd();Bd();Bd()});function zd(n,e=ws){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function ws(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}var Hd=y(()=>{});var qd=Ne((xC,ug)=>{"use strict";ug.exports=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var Gd=Ne((AC,Vd)=>{"use strict";var Qv=/[\p{Lu}]/u,e0=/[\p{Ll}]/u,lg=/^[\p{Lu}](?![\p{Lu}])/gu,fg=/([\p{Alpha}\p{N}_]|$)/u,hg=/[_.\- ]+/,t0=new RegExp("^"+hg.source),cg=new RegExp(hg.source+fg.source,"gu"),dg=new RegExp("\\d+"+fg.source,"gu"),r0=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){let o=n[i];r&&Qv.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&e0.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},n0=(n,e)=>(lg.lastIndex=0,n.replace(lg,t=>e(t))),a0=(n,e)=>(cg.lastIndex=0,dg.lastIndex=0,n.replace(cg,(t,r)=>e(r)).replace(dg,t=>e(t))),pg=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";let t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=r0(n,t,r)),n=n.replace(t0,""),e.preserveConsecutiveUppercase?n=n0(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),a0(n,r))};Vd.exports=pg;Vd.exports.default=pg});function gg(n,e){return e?.[n]||(0,mg.default)(n)}function bg(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}var mg,s0,yg=y(()=>{mg=oe(qd(),1),s0=oe(Gd(),1)});function _g(n){return Array.isArray(n)?[...n]:{...n}}function i0(n,e){let t=_g(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=_g(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function Kd(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var pt,vs=y(()=>{yg();pt=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Kd(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let l of u.reverse()){if(!(l in s)||s[l]===void 0)return;(!(l in i)||i[l]===void 0)&&(typeof s[l]=="object"&&s[l]!=null?i[l]={}:Array.isArray(s[l])&&(i[l]=[])),s=s[l],i=i[l]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:bg(Object.keys(t).length?i0(r,t):r,gg,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}});function $t(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?Ou(n,e)??[...n,...e]:[...n,{type:"text",text:e}]}function o0(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,a+1));let s={};for(let i of Object.keys(r))s[i]=t(r[i],a+1);return s}return JSON.stringify(t(n,0),null,2)}function we(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=we(t[r],a);else if(Array.isArray(t[r]))t[r]=Ou(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function Ou(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=we(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}function Qe(n){return typeof n?._getType=="function"}function wg(n){return Qe(n)&&typeof n.concat=="function"}var _e,mt,Lt=y(()=>{vs();_e=class extends pt{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=o0(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};mt=class extends _e{}});function vg(n){let e=[],t=[];for(let r of n)if(r.function){let a=r.function.name;try{let s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var Di=y(()=>{Lt()});function xg(n){return n._getType()==="ai"}var le,fe,xs=y(()=>{Hd();Lt();Di();le=class extends _e{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let a=r.additional_kwargs?.tool_calls,s=r.tool_calls;a!=null&&a.length>0&&(s===void 0||s.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&s===void 0){let[i,o]=vg(a);r.tool_calls=i??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};fe=class n extends mt{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{let r=[],a=[];for(let s of e.tool_call_chunks){let i={};try{if(i=ws(s.args??"{}")??{},typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id,type:"tool_call"})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:$t(this.content,e.content),additional_kwargs:we(this.additional_kwargs,e.additional_kwargs),response_metadata:we(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let r=Ou(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:r.input_tokens+a.input_tokens,output_tokens:r.output_tokens+a.output_tokens,total_tokens:r.total_tokens+a.total_tokens};t.usage_metadata=s}return new n(t)}}});var et,sa,Eu=y(()=>{Lt();et=class n extends _e{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},sa=class n extends mt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:$t(this.content,e.content),additional_kwargs:we(this.additional_kwargs,e.additional_kwargs),response_metadata:we(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}});var Fi,Iu=y(()=>{Lt();Fi=class n extends mt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new n({content:$t(this.content,e.content),additional_kwargs:we(this.additional_kwargs,e.additional_kwargs),response_metadata:we(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}});var he,ia,Ui=y(()=>{Lt();he=class extends _e{static lc_name(){return"HumanMessage"}_getType(){return"human"}},ia=class n extends mt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new n({content:$t(this.content,e.content),additional_kwargs:we(this.additional_kwargs,e.additional_kwargs),response_metadata:we(this.response_metadata,e.response_metadata),id:this.id??e.id})}}});var oa,ua,Tu=y(()=>{Lt();oa=class extends _e{static lc_name(){return"SystemMessage"}_getType(){return"system"}},ua=class n extends mt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new n({content:$t(this.content,e.content),additional_kwargs:we(this.additional_kwargs,e.additional_kwargs),response_metadata:we(this.response_metadata,e.response_metadata),id:this.id??e.id})}}});function Ag(n){let{type:e,...t}=n;if(e==="human"||e==="user")return new he(t);if(e==="ai"||e==="assistant")return new le(t);if(e==="system")return new oa(t);throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Dt(n){if(typeof n=="string")return new he(n);if(Qe(n))return n;if(Array.isArray(n)){let[e,t]=n;return Ag({type:e,content:t})}else return Ag(n)}function Pu(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${s}: ${i}${o}`)}return r.join(`
`)}function Jd(n){let e=n._getType();if(e==="human")return new ia({...n});if(e==="ai"){let t={...n};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(r=>({...r,type:"tool_call_chunk",index:void 0,args:JSON.stringify(r.args)}))}),new fe({...t})}else{if(e==="system")return new ua({...n});if(e==="function")return new Fi({...n});if(et.isInstance(n))return new sa({...n});throw new Error("Unknown message type.")}}var on=y(()=>{xs();Lt();Eu();Iu();Ui();Tu();Di()});var Ig=Ne((XC,Eg)=>{function xt(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Eg.exports=xt;xt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};xt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};xt.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};xt.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};xt.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};xt.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};xt.prototype.start=xt.prototype.try;xt.prototype.errors=function(){return this._errors};xt.prototype.attempts=function(){return this._attempts};xt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e}});var Tg=Ne(la=>{var l0=Ig();la.operation=function(n){var e=la.timeouts(n);return new l0(e,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})};la.timeouts=function(n){if(n instanceof Array)return[].concat(n);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in n)e[t]=n[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<e.retries;a++)r.push(this.createTimeout(a,e));return n&&n.forever&&!r.length&&r.push(this.createTimeout(a,e)),r.sort(function(s,i){return s-i}),r};la.createTimeout=function(n,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,n));return r=Math.min(r,e.maxTimeout),r};la.wrap=function(n,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in n)typeof n[r]=="function"&&t.push(r)}for(var a=0;a<t.length;a++){var s=t[a],i=n[s];n[s]=function(u){var l=la.operation(e),c=Array.prototype.slice.call(arguments,1),f=c.pop();c.push(function(d){l.retry(d)||(d&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){u.apply(n,c)})}.bind(n,i),n[s].options=e}}});var Sg=Ne((ek,Pg)=>{Pg.exports=Tg()});var ca=Ne((tk,Cu)=>{"use strict";var c0=Sg(),d0=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],Su=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},f0=(n,e,t)=>{let r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},h0=n=>d0.includes(n),Cg=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};let a=c0.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof Su)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!h0(i.message))a.stop(),r(i);else{f0(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});Cu.exports=Cg;Cu.exports.default=Cg;Cu.exports.AbortError=Su});var kg,Rg=y(()=>{kg=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i});function p0(n){return typeof n=="string"&&kg.test(n)}var Sr,Ng=y(()=>{Rg();Sr=p0});function jg(n,e=0){return(Ie[n[e+0]]+Ie[n[e+1]]+Ie[n[e+2]]+Ie[n[e+3]]+"-"+Ie[n[e+4]]+Ie[n[e+5]]+"-"+Ie[n[e+6]]+Ie[n[e+7]]+"-"+Ie[n[e+8]]+Ie[n[e+9]]+"-"+Ie[n[e+10]]+Ie[n[e+11]]+Ie[n[e+12]]+Ie[n[e+13]]+Ie[n[e+14]]+Ie[n[e+15]]).toLowerCase()}var Ie,ku,Mg=y(()=>{Ie=[];for(ku=0;ku<256;++ku)Ie.push((ku+256).toString(16).slice(1))});function Wd(){if(!Ru&&(Ru=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ru))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ru(m0)}var Ru,m0,$g=y(()=>{m0=new Uint8Array(16)});var g0,Zd,Lg=y(()=>{g0=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Zd={randomUUID:g0}});function b0(n,e,t){if(Zd.randomUUID&&!e&&!n)return Zd.randomUUID();n=n||{};var r=n.random||(n.rng||Wd)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(var a=0;a<16;++a)e[t+a]=r[a];return e}return jg(r)}var K,Dg=y(()=>{Lg();$g();Mg();K=b0});var Cr=y(()=>{Dg();Ng()});function Nu(n){return typeof n=="function"&&"langsmith:traceable"in n}var Xd,Yd,y0,Qd,_0,Ug,pk,Bg=y(()=>{Xd=class{getStore(){}run(e,t){return t()}},Yd=Symbol.for("ls:tracing_async_local_storage"),y0=new Xd,Qd=class{getInstance(){return globalThis[Yd]??y0}initializeGlobalInstance(e){globalThis[Yd]===void 0&&(globalThis[Yd]=e)}},_0=new Qd,Ug=()=>{let n=_0.getInstance().getStore();if(n===void 0)throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join(`
`));return n},pk=Symbol.for("langsmith:traceable:root")});var ef=y(()=>{Bg()});function Mu(n,e){return w0.call(n,e)}function $u(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Mu(n,t)&&e.push(t);return e}function Me(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Lu(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function ir(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function Bi(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function ju(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(ju(n[t]))return!0}else if(typeof n=="object"){let t=$u(n),r=t.length;for(var e=0;e<r;e++)if(ju(n[t[e]]))return!0}}return!1}function zg(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var w0,da,zi=y(()=>{w0=Object.prototype.hasOwnProperty;da=class extends Error{constructor(e,t,r,a,s){super(zg(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=zg(e,{name:t,index:r,operation:a,tree:s})}}});var tf={};ds(tf,{JsonPatchError:()=>re,_areEquals:()=>Hi,applyOperation:()=>fa,applyPatch:()=>un,applyReducer:()=>A0,deepClone:()=>v0,getValueByPointer:()=>Du,validate:()=>Hg,validator:()=>Fu});function Du(n,e){if(e=="")return n;var t={op:"_get",path:e};return fa(n,t),t.value}function fa(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):Fu(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Du(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=Hi(n,e.value),i.test===!1)throw new re("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new re("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=Me(n));let o=(e.path||"").split("/"),u=n,l=1,c=o.length,f,d,h;for(typeof t=="function"?h=t:h=Fu;;){if(d=o[l],d&&d.indexOf("~")!=-1&&(d=Bi(d)),a&&(d=="__proto__"||d=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(u[d]===void 0?f=o.slice(0,l).join("/"):l==c-1&&(f=e.path),f!==void 0&&h(e,0,n,f)),l++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!Lu(d))throw new re("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);Lu(d)&&(d=~~d)}if(l>=c){if(t&&e.op==="add"&&d>u.length)throw new re("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let p=x0[e.op].call(e,u,d,n);if(p.test===!1)throw new re("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(l>=c){let p=As[e.op].call(e,u,d,n);if(p.test===!1)throw new re("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[d],t&&l<c&&(!u||typeof u!="object"))throw new re("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function un(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new re("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Me(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=fa(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function A0(n,e,t){let r=fa(n,e);if(r.test===!1)throw new re("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function Fu(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new re("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(As[n.op]){if(typeof n.path!="string")throw new re("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new re('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new re("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new re("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&ju(n.value))throw new re("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new re("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new re("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=Hg([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new re("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new re("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Hg(n,e,t){try{if(!Array.isArray(n))throw new re("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)un(Me(e),Me(n),t||!0);else{t=t||Fu;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof re)return a;throw a}}function Hi(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!Hi(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!Hi(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}var re,v0,As,x0,Uu=y(()=>{zi();re=da,v0=Me,As={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Du(t,this.path);r&&(r=Me(r));let a=fa(t,{op:"remove",path:this.from}).removed;return fa(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=Du(t,this.from);return fa(t,{op:"add",path:this.path,value:Me(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Hi(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},x0={add:function(n,e,t){return Lu(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:As.move,copy:As.copy,test:As.test,_get:As._get}});function qg(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=$u(e),i=$u(n),o=!1,u=!1,l=i.length-1;l>=0;l--){var c=i[l],f=n[c];if(Mu(e,c)&&!(e[c]===void 0&&f!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof f=="object"&&f!=null&&typeof d=="object"&&d!=null&&Array.isArray(f)===Array.isArray(d)?qg(f,d,t,r+"/"+ir(c),a):f!==d&&(o=!0,a&&t.push({op:"test",path:r+"/"+ir(c),value:Me(f)}),t.push({op:"replace",path:r+"/"+ir(c),value:Me(d)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+ir(c),value:Me(f)}),t.push({op:"remove",path:r+"/"+ir(c)}),u=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&s.length==i.length))for(var l=0;l<s.length;l++){var c=s[l];!Mu(n,c)&&e[c]!==void 0&&t.push({op:"add",path:r+"/"+ir(c),value:Me(e[c])})}}}function Bu(n,e,t=!1){var r=[];return qg(n,e,r,"",t),r}var Vg=y(()=>{zi();Uu();});var Ok,rf=y(()=>{Uu();Vg();zi();Uu();zi();Ok={...tf,JsonPatchError:da,deepClone:Me,escapePathComponent:ir,unescapePathComponent:Bi}});async function Kg(){return nf===void 0&&(nf={library:"langchain-js",runtime:P0()}),nf}function Te(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var O0,E0,I0,Gg,T0,P0,nf,Os=y(()=>{O0=()=>typeof window<"u"&&typeof window.document<"u",E0=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",I0=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Gg=()=>typeof Deno<"u",T0=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Gg(),P0=()=>{let n;return O0()?n="browser":T0()?n="node":E0()?n="webworker":I0()?n="jsdom":Gg()?n="deno":n="other",n}});var af,ha,sf=y(()=>{Cr();vs();Os();af=class{},ha=class n extends af{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Kd(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Te("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return pt.prototype.toJSON.call(this)}toJSONNotImplemented(){return pt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:K()}),Object.assign(this,e)}}return new t}}});function of(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function S0(n){return n.replace(/[-:.]/g,"")}function C0(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return S0(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}var At,Es=y(()=>{sf();At=class extends ha{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){let t=C0(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await this.onRunCreate?.(r)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleChatModelStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}async handleChainStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(f),await this.onChainStart?.(f),f}async handleChainEnd(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=of(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=of(s.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=of(s.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}async handleToolStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onToolStart?.(c),c}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}async handleRetrieverStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onRetrieverStart?.(c),c}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,s,i){let o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:i?.chunk}),o}}});var uf,k0,lf,Ft,qi=y(()=>{uf=class{getStore(){}run(e,t){return t()}},k0=new uf,lf=class{getInstance(){return globalThis.__lc_tracing_async_local_storage??k0}initializeGlobalInstance(e){globalThis.__lc_tracing_async_local_storage===void 0&&(globalThis.__lc_tracing_async_local_storage=e)}},Ft=new lf});function cf(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function tt(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=tt(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}async function Jg(n,e,t,...r){let a=new kr({generator:e,startSetup:t}),s=await a.setup;return{output:n(a,s,...r),setup:s}}var ve,kr,Rr=y(()=>{qi();ve=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};kr=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise((t,r)=>{Ft.getInstance().run(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(s=>t(void 0),r)})})}async next(...e){return this.firstResultUsed?Ft.getInstance().run(this.config,async()=>this.generator.next(...e)):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}});async function Wg(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function Zg(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function R0(n){return n!==void 0&&n.message!==void 0}var Ut,Vi,zu,Gi,df=y(()=>{rf();Es();Rr();xs();Ut=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=un({},t);return new Vi({ops:t,state:r[r.length-1].newDocument})}},Vi=class n extends Ut{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=un(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=un({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},zu=n=>n.name==="log_stream_tracer";Gi=class extends At{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ve.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new Ut({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Ut({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Wg(e,this._schemaFormat)),await this.writer.write(new Ut({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Wg(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await Zg(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new Ut({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new Ut({ops:[{op:"replace",path:"/final_output",value:await Zg(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?R0(r?.chunk)?i=r?.chunk:i=new fe(t):i=t;let o=new Ut({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}}});var ff,pa,ze,Ki=y(()=>{ff="__run",pa=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},ze=class n extends pa{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}});function Hu({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var Vu,qu,hf=y(()=>{Es();Rr();xs();Ki();Vu=n=>n.name==="event_stream_tracer",qu=class extends At{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ve.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}let s=this.tappedPromises.get(e);if(s===void 0){let i;s=new Promise(o=>{i=o}),this.tappedPromises.set(e,s);try{let o={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...o,data:{chunk:r.value}},a),yield r.value;for await(let u of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...o,data:{chunk:u}},a),yield u}finally{i()}}else{yield r.value;for await(let i of t)yield i}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Hu(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(a.runType==="chat_model")i="on_chat_model_stream",r?.chunk===void 0?s=new fe({content:t}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",r?.chunk===void 0?s=new pa({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=e.outputs?.generations,s;if(t.runType==="chat_model"){for(let i of a??[]){if(s!==void 0)break;s=i[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a?.map(i=>i.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Hu(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Hu(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Hu(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}});var pf=Ne((Wk,Qg)=>{"use strict";var Yg=(n=0)=>e=>`\x1B[${38+n};5;${e}m`,Xg=(n=0)=>(e,t,r)=>`\x1B[${38+n};2;${e};${t};${r}m`;function N0(){let n=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,r]of Object.entries(e)){for(let[a,s]of Object.entries(r))e[a]={open:`\x1B[${s[0]}m`,close:`\x1B[${s[1]}m`},r[a]=e[a],n.set(s[0],s[1]);Object.defineProperty(e,t,{value:r,enumerable:!1})}return Object.defineProperty(e,"codes",{value:n,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=Yg(),e.color.ansi16m=Xg(),e.bgColor.ansi256=Yg(10),e.bgColor.ansi16m=Xg(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,r,a)=>t===r&&r===a?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(a/255*5),enumerable:!1},hexToRgb:{value:t=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!r)return[0,0,0];let{colorString:a}=r.groups;a.length===3&&(a=a.split("").map(i=>i+i).join(""));let s=Number.parseInt(a,16);return[s>>16&255,s>>8&255,s&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(Qg,"exports",{enumerable:!0,get:N0})});function He(n,e){return`${n.open}${e}${n.close}`}function Bt(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function ln(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var mf,rt,Ji,eb=y(()=>{mf=oe(pf(),1);Es();({color:rt}=mf.default),Ji=class extends At{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?He(mf.default.bold,o):o}).join(" > ");return He(rt.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Bt(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.cyan,"[chain/end]")} [${t}] [${ln(e)}] Exiting Chain run with output: ${Bt(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.red,"[chain/error]")} [${t}] [${ln(e)}] Chain run errored with error: ${Bt(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${He(rt.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Bt(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.cyan,"[llm/end]")} [${t}] [${ln(e)}] Exiting LLM run with output: ${Bt(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.red,"[llm/error]")} [${t}] [${ln(e)}] LLM run errored with error: ${Bt(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.cyan,"[tool/end]")} [${t}] [${ln(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.red,"[tool/error]")} [${t}] [${ln(e)}] Tool run errored with error: ${Bt(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Bt(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.cyan,"[retriever/end]")} [${t}] [${ln(e)}] Exiting Retriever run with output: ${Bt(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${He(rt.red,"[retriever/error]")} [${t}] [${ln(e)}] Retriever run errored with error: ${Bt(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${He(rt.blue,"[agent/action]")} [${r}] Agent selected action: ${Bt(t.actions[t.actions.length-1],"[action]")}`)}}});function gf(){if(!Gu&&(Gu=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Gu))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Gu(j0)}var Gu,j0,tb=y(()=>{j0=new Uint8Array(16)});var rb,nb=y(()=>{rb=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i});function M0(n){return typeof n=="string"&&rb.test(n)}var Wi,ab=y(()=>{nb();Wi=M0});function sb(n,e=0){return Pe[n[e+0]]+Pe[n[e+1]]+Pe[n[e+2]]+Pe[n[e+3]]+"-"+Pe[n[e+4]]+Pe[n[e+5]]+"-"+Pe[n[e+6]]+Pe[n[e+7]]+"-"+Pe[n[e+8]]+Pe[n[e+9]]+"-"+Pe[n[e+10]]+Pe[n[e+11]]+Pe[n[e+12]]+Pe[n[e+13]]+Pe[n[e+14]]+Pe[n[e+15]]}var Pe,ib=y(()=>{Pe=[];for(let n=0;n<256;++n)Pe.push((n+256).toString(16).slice(1))});var $0,bf,ob=y(()=>{$0=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),bf={randomUUID:$0}});function L0(n,e,t){if(bf.randomUUID&&!e&&!n)return bf.randomUUID();n=n||{};let r=n.random||(n.rng||gf)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let a=0;a<16;++a)e[t+a]=r[a];return e}return sb(r)}var zt,ub=y(()=>{ob();tb();ib();zt=L0});var Is=y(()=>{ub();ab()});var cb=Ne((cR,yf)=>{"use strict";var D0=Object.prototype.hasOwnProperty,qe="~";function Zi(){}Object.create&&(Zi.prototype=Object.create(null),new Zi().__proto__||(qe=!1));function F0(n,e,t){this.fn=n,this.context=e,this.once=t||!1}function lb(n,e,t,r,a){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new F0(t,r||n,a),i=qe?qe+e:e;return n._events[i]?n._events[i].fn?n._events[i]=[n._events[i],s]:n._events[i].push(s):(n._events[i]=s,n._eventsCount++),n}function Ju(n,e){--n._eventsCount===0?n._events=new Zi:delete n._events[e]}function $e(){this._events=new Zi,this._eventsCount=0}$e.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)D0.call(t,r)&&e.push(qe?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};$e.prototype.listeners=function(e){var t=qe?qe+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,s=r.length,i=new Array(s);a<s;a++)i[a]=r[a].fn;return i};$e.prototype.listenerCount=function(e){var t=qe?qe+e:e,r=this._events[t];return r?r.fn?1:r.length:0};$e.prototype.emit=function(e,t,r,a,s,i){var o=qe?qe+e:e;if(!this._events[o])return!1;var u=this._events[o],l=arguments.length,c,f;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,a),!0;case 5:return u.fn.call(u.context,t,r,a,s),!0;case 6:return u.fn.call(u.context,t,r,a,s,i),!0}for(f=1,c=new Array(l-1);f<l;f++)c[f-1]=arguments[f];u.fn.apply(u.context,c)}else{var d=u.length,h;for(f=0;f<d;f++)switch(u[f].once&&this.removeListener(e,u[f].fn,void 0,!0),l){case 1:u[f].fn.call(u[f].context);break;case 2:u[f].fn.call(u[f].context,t);break;case 3:u[f].fn.call(u[f].context,t,r);break;case 4:u[f].fn.call(u[f].context,t,r,a);break;default:if(!c)for(h=1,c=new Array(l-1);h<l;h++)c[h-1]=arguments[h];u[f].fn.apply(u[f].context,c)}}return!0};$e.prototype.on=function(e,t,r){return lb(this,e,t,r,!1)};$e.prototype.once=function(e,t,r){return lb(this,e,t,r,!0)};$e.prototype.removeListener=function(e,t,r,a){var s=qe?qe+e:e;if(!this._events[s])return this;if(!t)return Ju(this,s),this;var i=this._events[s];if(i.fn)i.fn===t&&(!a||i.once)&&(!r||i.context===r)&&Ju(this,s);else{for(var o=0,u=[],l=i.length;o<l;o++)(i[o].fn!==t||a&&!i[o].once||r&&i[o].context!==r)&&u.push(i[o]);u.length?this._events[s]=u.length===1?u[0]:u:Ju(this,s)}return this};$e.prototype.removeAllListeners=function(e){var t;return e?(t=qe?qe+e:e,this._events[t]&&Ju(this,t)):(this._events=new Zi,this._eventsCount=0),this};$e.prototype.off=$e.prototype.removeListener;$e.prototype.addListener=$e.prototype.on;$e.prefixed=qe;$e.EventEmitter=$e;typeof yf<"u"&&(yf.exports=$e)});var fb=Ne((dR,db)=>{"use strict";db.exports=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))});var pb=Ne((fR,Zu)=>{"use strict";var U0=fb(),Wu=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},hb=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}let s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}let i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new Wu(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);U0(n.then(r,a),()=>{clearTimeout(s)})});Zu.exports=hb;Zu.exports.default=hb;Zu.exports.TimeoutError=Wu});var mb=Ne(_f=>{"use strict";Object.defineProperty(_f,"__esModule",{value:!0});function B0(n,e,t){let r=0,a=n.length;for(;a>0;){let s=a/2|0,i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}_f.default=B0});var gb=Ne(vf=>{"use strict";Object.defineProperty(vf,"__esModule",{value:!0});var z0=mb(),wf=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}let a=z0.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){let e=this._queue.shift();return e?.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};vf.default=wf});var ma=Ne(Af=>{"use strict";Object.defineProperty(Af,"__esModule",{value:!0});var H0=cb(),bb=pb(),q0=gb(),Yu=()=>{},V0=new bb.TimeoutError,xf=class extends H0{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Yu,this._resolveIdle=Yu,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:q0.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Yu,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Yu,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{let s=async()=>{this._pendingCount++,this._intervalCount++;try{let i=this._timeout===void 0&&t.timeout===void 0?e():bb.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(V0)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};Af.default=xf});var yb,Xu,G0,K0,Yi,_b=y(()=>{yb=oe(ca(),1),Xu=oe(ma(),1),G0=[400,401,403,404,405,406,407,408],K0=[409],Yi=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Xu.default?this.queue=new Xu.default.default({concurrency:this.maxConcurrency}):this.queue=new Xu.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,yb.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;let s=a?.response,i=s?.status;if(i){if(G0.includes(+i))throw a;if(K0.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});function Of(n){return typeof n?._getType=="function"}function Ef(n){let e={type:n._getType(),data:{content:n.content}};return n?.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var wb=y(()=>{});async function Pf(){if(If===void 0){let n=X0(),e=ex();If={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:el,...e}}return If}function xb(){let n=Q0()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[r,a]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function Q0(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function or(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}function ex(){if(Tf!==void 0)return Tf;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=or(t);r!==void 0&&(e[t]=r)}return Tf=e,e}var Nr,J0,W0,Z0,vb,Y0,X0,If,Tf,Qu=y(()=>{tl();J0=()=>typeof window<"u"&&typeof window.document<"u",W0=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Z0=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),vb=()=>typeof Deno<"u",Y0=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!vb(),X0=()=>Nr||(J0()?Nr="browser":Y0()?Nr="node":W0()?Nr="webworker":Z0()?Nr="jsdom":vb()?Nr="deno":Nr="other",Nr)});function V(n){if(!Wi(n))throw new Error(`Invalid UUID: ${n}`)}var Ab=y(()=>{Is()});function Sf(n){Ob[n]||(console.warn(n),Ob[n]=!0)}var Ob,Cf=y(()=>{Ob={}});async function Eb(n){let e=await Pf(),t=xb();return n.map(r=>{let a=r.extra??{},s=a.metadata;return r.extra={...a,runtime:{...e,...a?.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...s}},r})}async function nx(n){let e=[];for await(let t of n)e.push(t);return e}function kf(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var tx,rx,jr,ax,Rf,sx,Ts,Nf=y(()=>{Is();_b();wb();Qu();tl();Ab();Cf();tx=()=>{let n=or("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},rx=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},jr=async(n,e)=>{let t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};ax=async n=>{if(n?.status===429){let e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1},Rf=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");let t=[];for(;t.length<e&&this.items.length;){let r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}},sx=20971520,Ts=class n{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Rf}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=n.getDefaultClientConfig();this.tracingSampleRate=tx(),this.apiUrl=kf(e.apiUrl??t.apiUrl)??"",this.apiKey=kf(e.apiKey??t.apiKey),this.webUrl=kf(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Yi(e.callerOptions??{}),this.batchIngestCaller=new Yi({...e.callerOptions??{},onFailedResponseHook:ax}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){let e=or("LANGCHAIN_API_KEY"),t=or("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=or("LANGCHAIN_HIDE_INPUTS")==="true",a=or("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:rx(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${el}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){let r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0,a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));let s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);let o=await i.json();if(o.length===0||(yield o,o.length<a))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.sampledPostUuids.has(a.id)&&(r.push(a),this.sampledPostUuids.delete(a.id));return r}else{let r=[];for(let a of e)Math.random()<this.tracingSampleRate&&(r.push(a),this.sampledPostUuids.add(a.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){let[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){let r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;let a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){let e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=await Eb([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(s[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=e?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[],a=t?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[];if(r.length>0&&a.length>0){let l=r.reduce((f,d)=>(d.id&&(f[d.id]=d),f),{}),c=[];for(let f of a)f.id!==void 0&&l[f.id]?l[f.id]={...l[f.id],...f}:c.push(f);r=Object.values(l),a=c}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;if(r=await Eb(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(let l of s.post)await this.createRun(l);for(let l of s.patch)l.id!==void 0&&await this.updateRun(l.id,l);return}let i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??sx,o={post:[],patch:[]},u=0;for(let l of["post","patch"]){let c=l,f=s[c].reverse(),d=f.pop();for(;d!==void 0;){let h=JSON.stringify(d);u>0&&u+h.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=h.length,o[c].push(d),d=f.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(r,"batch create run")}async updateRun(e,t){V(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){V(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r?.projectName?a=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?a=r?.projectId:a=(await this.readProject({projectName:or("LANGCHAIN_PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await nx(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>(s?.dotted_order??"").localeCompare(i?.dotted_order??""));for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:l,runType:c,error:f,id:d,query:h,filter:p,traceFilter:g,treeFilter:m,limit:b,select:x}=e,v=[];if(t&&(v=Array.isArray(t)?t:[t]),r){let N=Array.isArray(r)?r:[r],X=await Promise.all(N.map(ct=>this.readProject({projectName:ct}).then(nd=>nd.id)));v.push(...X)}let k=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],O={session:v.length?v:null,run_type:c,reference_example:i,query:h,filter:p,trace_filter:g,tree_filter:m,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:f,id:d,limit:b,trace:s,select:x||k,is_root:l},B=0;for await(let N of this._getCursorPaginatedList("/runs/query",O))if(b){if(B>=b)break;if(N.length+B>b){yield*N.slice(0,b-B);break}B+=N.length,yield*N}else yield*N}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:s,projectIds:i,referenceExampleIds:o,startTime:u,endTime:l,error:c,query:f,filter:d,traceFilter:h,treeFilter:p,isRoot:g,dataSourceType:m}){let b=i||[];s&&(b=[...i||[],...await Promise.all(s.map(B=>this.readProject({projectName:B}).then(N=>N.id)))]);let v=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:b,reference_example:o,start_time:u,end_time:l,error:c,query:f,filter:d,trace_filter:h,tree_filter:p,is_root:g,data_source_type:m}).filter(([B,N])=>N!==void 0));return await(await this.caller.call(fetch,`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(v),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||zt()};V(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){V(e);let t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(t,"unshare run")}async readRunSharedLink(e){V(e);let r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return V(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),V(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};V(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){V(e);let t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(t,"unshare dataset")}async readSharedDataset(e){return V(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=s||{};r&&(l.metadata=r);let c={name:e,extra:l,description:t};i!==null&&(c.reference_dataset_id=i);let f=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await f.json();if(!f.ok)throw new Error(`Failed to create session ${e}: ${f.status} ${f.statusText}`);return d}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let l={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},c=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),f=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return f}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)V(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)V(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){let o=new URLSearchParams;if(e!==void 0)for(let u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){let u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(let u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,V(r);let a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(d=>{l.append("input_keys",d)}),a.forEach(d=>{l.append("output_keys",d)}),s&&l.append("description",s),i&&l.append("data_type",i),o&&l.append("name",o);let c=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!c.ok){let d=await c.json();throw d.detail&&d.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){let a={name:e,description:t};r&&(a.data_type=r);let s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok){let o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)V(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s}={}){let i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let u of r)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(let u of this._getPaginated(i,o))yield*u}async updateDataset(e){let{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");let s=t??(await this.readDataset({datasetName:r})).id;V(s);let i=await this.caller.call(fetch,`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to update dataset ${s}: ${i.status} ${i.statusText}`);return await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)V(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to delete ${r}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);let f={dataset_id:l,inputs:e,outputs:t,created_at:(s||new Date)?.toISOString(),id:i,metadata:o,split:u},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createExamples(e){let{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e,l=o;if(l===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:u})).id);let c=t.map((h,p)=>({dataset_id:l,inputs:h,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),f=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!f.ok)throw new Error(`Failed to create examples: ${f.status} ${f.statusText}`);return await f.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>Of(i)?Ef(i):i),s=Of(t)?Ef(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){V(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o,limit:u,offset:l,filter:c}={}){let f;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)f=e;else if(t!==void 0)f=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let d=new URLSearchParams({dataset:f}),h=a?typeof a=="string"?a:a?.toISOString():void 0;h&&d.append("as_of",h);let p=i??!0;if(d.append("inline_s3_urls",p.toString()),r!==void 0)for(let m of r)d.append("id",m);if(s!==void 0)for(let m of s)d.append("splits",m);if(o!==void 0){let m=JSON.stringify(o);d.append("metadata",m)}u!==void 0&&d.append("limit",u.toString()),l!==void 0&&d.append("offset",l.toString()),c!==void 0&&d.append("filter",c);let g=0;for await(let m of this._getPaginated("/examples",d)){for(let b of m)yield b,g++;if(u!==void 0&&g>=u)break}}async deleteExample(e){V(e);let t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){V(e);let r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async updateExamples(e){let t=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!t.ok)throw new Error(`Failed to update examples: ${t.status} ${t.statusText}`);return await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,V(a);let s=new URLSearchParams,i=r?typeof r=="string"?r:r?.toISOString():void 0;return i&&s.append("as_of",i),await this._get(`/datasets/${a}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:s=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,V(i);let o={split_name:r,examples:a.map(l=>(V(l),l)),remove:s},u=await this.caller.call(fetch,`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(u,"update dataset splits")}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){Sf("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),[u,l]=await this._logEvaluationFeedback(o,i,r);return l[0]}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,feedbackConfig:f,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");let p={type:u??"api",metadata:o??{}};l!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:l}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&V(p.metadata.__run.run_id);let g={id:c??zt(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:f,session_id:d},m=`${this.apiUrl}/feedback`,b=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(g),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await jr(b,"create feedback"),g}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),V(e);let o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jr(o,"update feedback")}async readFeedback(e){V(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){V(e);let t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(a??new Date)?.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){V(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async _logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e),s=[];for(let i of a){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:t&&(u=t.id),s.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[a,s]}async logEvaluationFeedback(e,t,r){let[a]=await this._logEvaluationFeedback(e,t,r);return a}}});var Ib=y(()=>{Qu()});var Tb=y(()=>{Qu();Nf();Ib();Cf()});var el,tl=y(()=>{Nf();Tb();el="0.1.39"});var Pb=y(()=>{tl()});var rl,Sb=y(()=>{Pb();ef();Os();Es();rl=class extends At{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=r??Te("LANGCHAIN_PROJECT")??Te("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new Ts({});let s=this.getTraceableRunTree();if(s){let i=s,o=new Set;for(;i.parent_run&&!(o.has(i.id)||(o.add(i.id),!i.parent_run));)i=i.parent_run;o.clear();let u=[i];for(;u.length>0;){let l=u.shift();!l||o.has(l.id)||(o.add(l.id),this.runMap.set(l.id,l),l.child_runs&&u.push(...l.child_runs))}this.client=s.client??this.client,this.projectName=s.project_name??this.projectName,this.exampleId=s.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Kg()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return Ug()}catch{return}}}});function ix(){let n="default"in nl.default?nl.default.default:nl.default;return new n({autoStart:!0,concurrency:1})}async function pe(n,e){e===!0?await n():(typeof jf>"u"&&(jf=ix()),jf.add(n))}var nl,jf,Cb=y(()=>{nl=oe(ma(),1)});var kb,Rb=y(()=>{Os();kb=n=>n!==void 0?n:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>Te(t)==="true")});function Xi(n){return"name"in n?n:ha.fromMethods(n)}var Mf,Ps,$f,al,Lf,Df,Ot,Ff=y(()=>{Cr();sf();eb();on();Os();Sb();Cb();Rb();Te("LANGCHAIN_TRACING_V2")==="true"&&Te("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);Mf=class{setHandler(e){return this.setHandlers([e])}},Ps=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>pe(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},$f=class extends Ps{getChild(e){let t=new Ot(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},al=class extends Ps{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>pe(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(u){if(console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Lf=class extends Ps{getChild(e){let t=new Ot(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>pe(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>pe(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Df=class extends Ps{getChild(e){let t=new Ot(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>pe(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Ot=class n extends Mf{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:K();return await Promise.all(this.handlers.map(d=>pe(async()=>{if(!d.ignoreLLM)try{await d.handleLLMStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u)}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new al(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:K();return await Promise.all(this.handlers.map(d=>pe(async()=>{if(!d.ignoreLLM)try{if(d.handleChatModelStart)await d.handleChatModelStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u);else if(d.handleLLMStart){let h=Pu(l);await d.handleLLMStart?.(e,[h],f,this._parentRunId,s,this.tags,this.metadata,u)}}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new al(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=K(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>pe(async()=>{if(!u.ignoreChain)try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Lf(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=K(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>pe(async()=>{if(!u.ignoreAgent)try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Df(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=K(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>pe(async()=>{if(!u.ignoreRetriever)try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new $f(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>pe(async()=>{if(!i.ignoreCustomEvent)try{await i.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends ha{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:K()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,s,i,o){return this._configureSync(e,t,r,a,s,i,o)}static _configureSync(e,t,r,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers(e?.map(Xi)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(Xi):t?.handlers,!1));let l=Te("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=kb(),f=c||(Te("LANGCHAIN_TRACING")??!1);if(l||f){if(u||(u=new n),l&&!u.handlers.some(d=>d.name===Ji.prototype.name)){let d=new Ji;u.addHandler(d,!0)}if(f&&!u.handlers.some(d=>d.name==="langchain_tracer")&&c){let d=new rl;u.addHandler(d,!0),u._parentRunId=d.getTraceableRunTree()?.id??u._parentRunId}}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}}});async function gt(n){return Ot.configure(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function il(...n){let e={};for(let t of n.filter(r=>!!r))for(let r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){let a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){let a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{let i=a.copy();for(let o of s)i.addHandler(Xi(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){let i=s.copy();for(let o of a)i.addHandler(Xi(o),!0);e.callbacks=i}else e.callbacks=new Ot(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{let a=r;e[a]=t[a]??e[a]}return e}function H(n){let e=Ft.getInstance().getStore(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:r,...a}=e;t=Object.entries(a).reduce((s,[i,o])=>(o!==void 0&&(s[i]=o),s),t)}if(n&&(t=Object.entries(n).reduce((r,[a,s])=>(s!==void 0&&(r[a]=s),r),t)),t?.configurable)for(let r of Object.keys(t.configurable))ox.has(typeof t.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=t.configurable[r]);return t}function xe(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){let o=H(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}var sl,ox,Ss=y(()=>{Ff();qi();sl=25;ox=new Set(["string","number","boolean"])});var Nb,ol,ux,lx,Mr,Qi=y(()=>{Nb=oe(ca(),1),ol=oe(ma(),1),ux=[400,401,402,403,404,405,406,407,409],lx=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;let e=n?.response?.status??n?.status;if(e&&ux.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){let t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}},Mr=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??lx;let t="default"in ol.default?ol.default.default:ol.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Nb.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});var eo,jb=y(()=>{Es();eo=class extends At{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}});function to(n){return n?n.lc_runnable:!1}var ul,Uf=y(()=>{ul=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>this.includeTags?.includes(s))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>!this.excludeTags?.includes(s))),r}}});function Bf(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}function cx(n,e){let t=e[n.source]??n.source,r=e[n.target]??n.target;return[t,r]}function dx(n){let e="";for(let[t,r]of Object.entries(n))e+=`	classDef ${t}class fill:${r};
`;return e}function Mb(n,e,t){let{firstNodeLabel:r,lastNodeLabel:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{},l=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){let f="default",d={[f]:"{0}([{1}]):::otherclass"};r!==void 0&&(d[r]="{0}[{0}]:::startclass"),a!==void 0&&(d[a]="{0}[{0}]:::endclass");for(let h of Object.values(n)){let p=d[h]??d[f],g=Bf(h),m=h.split(":"),b=m[m.length-1];l+=`	${p.replace(/\{0\}/g,g).replace(/\{1\}/g,b)};
`}}let c="";for(let f of e){let d=f.source.includes(":")?f.source.split(":")[0]:void 0,h=f.target.includes(":")?f.target.split(":")[0]:void 0;c!==""&&(c!==d||c!==h)&&(l+=`	end
`,c=""),c===""&&d!==void 0&&d===h&&(l=`	subgraph ${d}
`,c=d);let[p,g]=cx(f,n),m="";if(f.data!==void 0){let b=f.data,x=b.split(" ");x.length>u&&(b=x.reduce((v,k,O)=>(O%u===0&&v.push(""),v[v.length-1]+=` ${k}`,v),[]).join("<br>")),f.conditional?m=` -. ${b} .-> `:m=` -- ${b} --> `}else f.conditional?m=" -.-> ":m=" --> ";l+=`	${Bf(p)}${m}${Bf(g)};
`}return c!==""&&(l+=`end
`),i&&s!==void 0&&(l+=dx(s)),l}async function $b(n,e){let{backgroundColor:t="white"}=e??{},r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let a=`https://mermaid.ink/img/${r}?bgColor=${t}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}var Lb=y(()=>{});function zf(n){if(Sr(n.id))if(to(n.data))try{let e=n.data.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e.length>Db&&(e=`${e.substring(0,Db)}...`),e}catch{return n.data.getName()}else return n.data.name??"UnknownSchema";else return n.id}function fx(n){return to(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...Q(n.data.schema),title:n.data.name}}}var Db,ro,Fb=y(()=>{ht();Cr();Uf();Lb();Db=42;ro=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Sr(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...fx(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||K(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let s={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(s),s}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e,t=""){let r=t;Object.values(e.nodes).map(l=>l.id).every(Sr)&&(r="");let s=l=>r?`${r}:${l}`:l;Object.entries(e.nodes).forEach(([l,c])=>{this.nodes[s(l)]={...c,id:s(l)}});let i=e.edges.map(l=>({...l,source:s(l.source),target:s(l.target)}));this.edges=[...this.edges,...i];let o=e.firstNode(),u=e.lastNode();return[o?{id:s(o.id),data:o.data}:void 0,u?{id:s(u.id),data:u.data}:void 0]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:a={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:s}=e??{},i={};for(let f of Object.values(this.nodes))i[f.id]=zf(f);let o=this.firstNode(),u=o?zf(o):void 0,l=this.lastNode(),c=l?zf(l):void 0;return Mb(i,this.edges,{firstNodeLabel:u,lastNodeLabel:c,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:s})}async drawMermaidPng(e){let t=this.drawMermaid(e);return $b(t,{backgroundColor:e?.backgroundColor})}}});function Ub(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return ve.fromReadableStream(t)}var Bb=y(()=>{Rr()});function Hf(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}function ll(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*qf(n,e){let t=Ft.getInstance();for(;;){let{value:r,done:a}=t.run(n,e.next.bind(e));if(a)break;yield r}}async function*Vf(n,e){let t=Ft.getInstance(),r=e[Symbol.asyncIterator]();for(;;){let{value:a,done:s}=await t.run(n,r.next.bind(e));if(s)break;yield a}}var zb,Hb=y(()=>{qi();zb=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function"});function qb(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}var cl,Vb=y(()=>{cl=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}});function Se(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}function hx(n){if(Nu(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}function $r(n){if(typeof n=="function")return new lr({func:n});if(q.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=$r(r);return new cn({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}function px(n,e){let t=e.name??n.getName(),r=e.description??e.schema?.description;return e.schema.constructor===se.ZodString?new no({name:t,description:r,schema:se.object({input:se.string()}).transform(a=>a.input),bound:n}):new no({name:t,description:r,schema:e.schema,bound:n})}var Gf,q,ur,dl,fl,Ht,cn,Kf,lr,hl,Cs,pl,no,Et=y(()=>{Pr();Gf=oe(ca(),1);Cr();ef();df();hf();vs();Rr();Ss();Qi();jb();Uf();qi();Fb();Bb();Hb();Vb();q=class extends pt{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new ur({bound:this,kwargs:e,config:{}})}map(){return new dl({bound:this})}withRetry(e){return new fl({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new ur({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new hl({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(H);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>H(s===0?e:r))}return Array.from({length:t},()=>H(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=a[0]?.maxConcurrency??r?.maxConcurrency,i=new Mr({maxConcurrency:s,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>i.call(async()=>{try{return await this.invoke(u,a[l])}catch(c){if(r?.returnExceptions)return c;throw c}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=H(t),a=new kr({generator:this._streamIterator(e,r),config:r});return await a.setup,ve.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=H(e):t=H({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){let a=H(r),i=await(await gt(a))?.handleChainStart(this.toJSON(),Se(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let o;try{o=await e.call(this,t,a,i)}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(Se(o,"output")),o}async _batchWithConfig(e,t,r,a){let s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(gt)),o=await Promise.all(i.map(async(l,c)=>{let f=await l?.handleChainStart(this.toJSON(),Se(t[c],"input"),s[c].runId,s[c].runType,void 0,void 0,s[c].runName??this.getName());return delete s[c].runId,f})),u;try{u=await e.call(this,t,s,o,a)}catch(l){throw await Promise.all(o.map(c=>c?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd(Se(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=H(r),l=await gt(u);async function*c(){for await(let d of e){if(s)if(a===void 0)a=d;else try{a=tt(a,d)}catch{a=void 0,s=!1}yield d}}let f;try{let d=await Jg(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),u);delete u.runId,f=d.setup;let h=f?.handlers.find(Vu),p=d.output;h!==void 0&&f!==void 0&&(p=h.tapOutputIterable(f.runId,p));let g=f?.handlers.find(zu);g!==void 0&&f!==void 0&&(p=g.tapOutputIterable(f.runId,p));for await(let m of p)if(yield m,o)if(i===void 0)i=m;else try{i=tt(i,m)}catch{i=void 0,o=!1}}catch(d){throw await f?.handleChainError(d,void 0,void 0,void 0,{inputs:Se(a,"input")}),d}await f?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Se(a,"input")})}getGraph(e){let t=new ro,r=t.addNode({name:`${this.getName()}Input`,schema:se.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:se.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Ht({first:this,last:$r(e)})}pick(e){return this.pipe(new pl(e))}assign(e){return this.pipe(new Cs(new cn({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=tt(r,a);yield*this._streamIterator(r,H(t))}async*streamLog(e,t,r){let a=new Gi({...r,autoClose:!1,_schemaFormat:"original"}),s=H(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.inheritableHandlers.push(t),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let l of u){let c=new Ut({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(c)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?Ub(a):ve.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){let a=new qu({...r,autoClose:!1}),s=H(t),i=s.runId??K();s.runId=i;let o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{let h=o.copy();h.inheritableHandlers.push(a),s.callbacks=h}let u=this;async function l(){try{let h=await u.stream(e,s),p=a.tapOutputIterable(i,h);for await(let g of p);}finally{await a.finish()}}let c=l(),f=!1,d;try{for await(let h of a){if(!f){h.data.input=e,f=!0,d=h.run_id,yield h;continue}h.run_id===d&&h.event.endsWith("_end")&&h.data?.input&&delete h.data.input,yield h}}finally{await c}}async*_streamEventsV1(e,t,r){let a,s=!1,i=H(t),o=i.tags??[],u=i.metadata??{},l=i.runName??this.getName(),c=new Gi({...r,autoClose:!1,_schemaFormat:"streaming_events"}),f=new ul({...r}),d=this._streamLog(e,c,i);for await(let p of d){if(a?a=a.concat(p):a=Vi.fromRunLogPatch(p),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let x={...a.state},v={run_id:x.id,event:`on_${x.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};f.includeEvent(v,x.type)&&(yield v)}let g=p.ops.filter(x=>x.path.startsWith("/logs/")).map(x=>x.path.split("/")[2]),m=[...new Set(g)];for(let x of m){let v,k={},O=a.state.logs[x];if(O.end_time===void 0?O.streamed_output.length>0?v="stream":v="start":v="end",v==="start")O.inputs!==void 0&&(k.input=O.inputs);else if(v==="end")O.inputs!==void 0&&(k.input=O.inputs),k.output=O.final_output;else if(v==="stream"){let B=O.streamed_output.length;if(B!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${B} instead. Encountered in: "${O.name}"`);k={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${v}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:k}}let{state:b}=a;if(b.streamed_output.length>0){let x=b.streamed_output.length;if(x!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${x} instead. Encountered in: "${b.name}"`);let v={chunk:b.streamed_output[0]};b.streamed_output=[];let k={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:u,name:l,data:v};f.includeEvent(k,b.type)&&(yield k)}}let h=a?.state;if(h!==void 0){let p={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:o,metadata:u,data:{output:h.final_output}};f.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return to(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new ur({bound:this,config:{},configFactories:[a=>({callbacks:[new eo({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return px(this,e)}},ur=class n extends q{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=il(this.config,...e);return il(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(H(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(H(s),this.kwargs))):await this._mergeConfig(H(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(H(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(H(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(H(t),this.kwargs))}streamEvents(e,t,r){let a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(H(t),a.kwargs),version:t.version},r)};return ve.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&q.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new eo({config:a,onStart:e,onEnd:t,onError:r})]})]})}},dl=class n extends q{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,xe(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},fl=class extends ur{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return xe(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return(0,Gf.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){let s={};try{await(0,Gf.default)(async i=>{let o=e.map((d,h)=>h).filter(d=>s[d.toString()]===void 0||s[d.toString()]instanceof Error),u=o.map(d=>e[d]),l=o.map(d=>this._patchConfigForRetry(i,t?.[d],r?.[d])),c=await super.batch(u,l,{...a,returnExceptions:!0}),f;for(let d=0;d<c.length;d+=1){let h=c[d],p=o[d];h instanceof Error&&f===void 0&&(f=h,f.input=u[d]),s[p.toString()]=h}if(f)throw f;return c},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(a?.returnExceptions!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Ht=class n extends q{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=H(t),s=await(await gt(r))?.handleChainStart(this.toJSON(),Se(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i=e,o;try{let u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1)i=await u[l].invoke(i,xe(r,{callbacks:s?.getChild(`seq:step:${l+1}`)}));o=await this.last.invoke(i,xe(r,{callbacks:s?.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(Se(o,"output")),o}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(gt)),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),Se(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((c,f)=>{let d=c?.getChild(`seq:step:${u+1}`);return xe(a[f],{callbacks:d})}),r)}catch(u){throw await Promise.all(i.map(l=>l?.handleChainError(u))),u}return await Promise.all(i.map(u=>u?.handleChainEnd(Se(o,"output")))),o}async*_streamIterator(e,t){let r=await gt(t),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),Se(e,"input"),a,void 0,void 0,void 0,s?.runName),o=[this.first,...this.middle,this.last],u=!0,l;async function*c(){yield e}try{let f=o[0].transform(c(),xe(s,{callbacks:i?.getChild("seq:step:1")}));for(let d=1;d<o.length;d+=1)f=await o[d].transform(f,xe(s,{callbacks:i?.getChild(`seq:step:${d+1}`)}));for await(let d of f)if(yield d,u)if(l===void 0)l=d;else try{l=tt(l,d)}catch{l=void 0,u=!1}}catch(f){throw await i?.handleChainError(f),f}await i?.handleChainEnd(Se(l,"output"))}getGraph(e){let t=new ro,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:$r(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&q.isRunnable(e)}static from([e,...t],r){return new n({first:$r(e),middle:t.slice(0,-1).map($r),last:$r(t[t.length-1]),name:r})}},cn=class n extends q{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=$r(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=H(t),s=await(await gt(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,xe(r,{callbacks:s?.getChild(`map:key:${o}`)}))}))}catch(o){throw await s?.handleChainError(o),o}return await s?.handleChainEnd(i),i}async*_transform(e,t,r){let a={...this.steps},s=cf(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],l)=>{let c=u.transform(s[l],xe(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,c.next().then(f=>({key:o,gen:c,result:f}))]}));for(;i.size;){let{key:o,result:u,gen:l}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,l.next().then(c=>({key:o,gen:l,result:c}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=H(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,ve.fromAsyncGenerator(s)}},Kf=class n extends q{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Nu(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await gt(r);return await this.func(xe(r,{callbacks:a}),e)}async*_streamIterator(e,t){let r=await this.invoke(e,t);if(ll(r)){for await(let a of r)yield a;return}if(zb(r)){for(;;){let a=r.next();if(a.done)break;yield a.value}return}yield r}static from(e){return new n({func:e})}};lr=class n extends q{static lc_name(){return"RunnableLambda"}constructor(e){if(Nu(e.func))return Kf.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),hx(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{let i=xe(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??sl)-1});Ft.getInstance().run(i,async()=>{try{let o=await this.func(e,{...i,config:i});if(o&&q.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??sl)-1})}else if(ll(o)){let u;for await(let l of Vf(i,o))if(u===void 0)u=l;else try{u=tt(u,l)}catch{u=l}o=u}else if(Hf(o)){let u;for(let l of qf(i,o))if(u===void 0)u=l;else try{u=tt(u,l)}catch{u=l}o=u}a(o)}catch(o){s(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(let o of e)if(a===void 0)a=o;else try{a=tt(a,o)}catch{a=o}let s=xe(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??sl)-1}),i=await new Promise((o,u)=>{Ft.getInstance().run(s,async()=>{try{let l=await this.func(a,{...s,config:s});o(l)}catch(l){u(l)}})});if(i&&q.isRunnable(i)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let o=await i.stream(a,s);for await(let u of o)yield u}else if(ll(i))for await(let o of Vf(s,i))yield o;else if(Hf(i))for(let o of qf(s,i))yield o;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=H(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,ve.fromAsyncGenerator(s)}},hl=class extends q{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=H(t),a=await gt(t),{runId:s,...i}=r,o=await a?.handleChainStart(this.toJSON(),Se(e,"input"),s,void 0,void 0,void 0,i?.runName),u;for(let l of this.runnables())try{let c=await l.invoke(e,xe(i,{callbacks:o?.getChild()}));return await o?.handleChainEnd(Se(c,"output")),c}catch(c){u===void 0&&(u=c)}throw u===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(u),u)}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>gt(u))),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),Se(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o;for(let u of this.runnables())try{let l=await u.batch(e,i.map((c,f)=>xe(a[f],{callbacks:c?.getChild()})),r);return await Promise.all(i.map((c,f)=>c?.handleChainEnd(Se(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(i.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};Cs=class extends q{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof cn&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=cf(e),o=this.mapper.transform(i,xe(r,{callbacks:t?.getChild()})),u=o.next();for await(let l of s){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let c=Object.fromEntries(Object.entries(l).filter(([f])=>!a.includes(f)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(let l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=H(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,ve.fromAsyncGenerator(s)}},pl=class extends q{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=H(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,ve.fromAsyncGenerator(s)}},no=class extends ur{constructor(e){let t=Ht.from([lr.from(async r=>{let a;if(qb(r))try{a=await this.schema.parseAsync(r.args)}catch{throw new cl("Received tool input did not match expected schema",JSON.stringify(r.args))}else a=r;return a}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}});var Jf=y(()=>{Lt()});var Gb=y(()=>{Et();xs();Eu();Iu();Ui();Jf();Tu();Di();on()});var ks=y(()=>{xs();Lt();Eu();Iu();Ui();Tu();on();Gb();Jf();Di()});var ao,Rs,Ns,gl,so=y(()=>{vs();Ui();on();ao=class extends pt{},Rs=class extends ao{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new he(this.value)]}},Ns=class extends ao{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Pu(this.messages)}toChatMessages(){return this.messages}},gl=class extends ao{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new he({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}});var Zb=Ne(bl=>{"use strict";bl.byteLength=wx;bl.toByteArray=xx;bl.fromByteArray=Ex;var cr=[],It=[],_x=typeof Uint8Array<"u"?Uint8Array:Array,Yf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(ga=0,Jb=Yf.length;ga<Jb;++ga)cr[ga]=Yf[ga],It[Yf.charCodeAt(ga)]=ga;var ga,Jb;It[45]=62;It[95]=63;function Wb(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function wx(n){var e=Wb(n),t=e[0],r=e[1];return(t+r)*3/4-r}function vx(n,e,t){return(e+t)*3/4-t}function xx(n){var e,t=Wb(n),r=t[0],a=t[1],s=new _x(vx(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=It[n.charCodeAt(u)]<<18|It[n.charCodeAt(u+1)]<<12|It[n.charCodeAt(u+2)]<<6|It[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=It[n.charCodeAt(u)]<<2|It[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=It[n.charCodeAt(u)]<<10|It[n.charCodeAt(u+1)]<<4|It[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function Ax(n){return cr[n>>18&63]+cr[n>>12&63]+cr[n>>6&63]+cr[n&63]}function Ox(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(Ax(r));return a.join("")}function Ex(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(Ox(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(cr[e>>2]+cr[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(cr[e>>10]+cr[e>>4&63]+cr[e<<2&63]+"=")),a.join("")}});var Lr,fo=y(()=>{so();$s();Lr=class extends Dr{async formatPromptValue(e){let t=await this.format(e);return new Rs(t)}}});function rh(n){return typeof n=="function"}function pA(n){return Ds(n)?"array":typeof n}function th(n){return n.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function ay(n,e){return n!=null&&typeof n=="object"&&e in n}function mA(n,e){return n!=null&&typeof n!="object"&&n.hasOwnProperty&&n.hasOwnProperty(e)}function bA(n,e){return gA.call(n,e)}function _A(n){return!bA(yA,n)}function vA(n){return String(n).replace(/[&<>"'`=\/]/g,function(t){return wA[t]})}function IA(n,e){if(!n)return[];var t=!1,r=[],a=[],s=[],i=!1,o=!1,u="",l=0;function c(){if(i&&!o)for(;s.length;)delete a[s.pop()];else s=[];i=!1,o=!1}var f,d,h;function p(X){if(typeof X=="string"&&(X=X.split(AA,2)),!Ds(X)||X.length!==2)throw new Error("Invalid tags: "+X);f=new RegExp(th(X[0])+"\\s*"),d=new RegExp("\\s*"+th(X[1])),h=new RegExp("\\s*"+th("}"+X[1]))}p(e||Tt.tags);for(var g=new po(n),m,b,x,v,k,O;!g.eos();){if(m=g.pos,x=g.scanUntil(f),x)for(var B=0,N=x.length;B<N;++B)v=x.charAt(B),_A(v)?(s.push(a.length),u+=v):(o=!0,t=!0,u+=" "),a.push(["text",v,m,m+1]),m+=1,v===`
`&&(c(),u="",l=0,t=!1);if(!g.scan(f))break;if(i=!0,b=g.scan(EA)||"name",g.scan(xA),b==="="?(x=g.scanUntil(sy),g.scan(sy),g.scanUntil(d)):b==="{"?(x=g.scanUntil(h),g.scan(OA),g.scanUntil(d),b="&"):x=g.scanUntil(d),!g.scan(d))throw new Error("Unclosed tag at "+g.pos);if(b==">"?k=[b,x,m,g.pos,u,l,t]:k=[b,x,m,g.pos],l++,a.push(k),b==="#"||b==="^")r.push(k);else if(b==="/"){if(O=r.pop(),!O)throw new Error('Unopened section "'+x+'" at '+m);if(O[1]!==x)throw new Error('Unclosed section "'+O[1]+'" at '+m)}else b==="name"||b==="{"||b==="&"?o=!0:b==="="&&p(x)}if(c(),O=r.pop(),O)throw new Error('Unclosed section "'+O[1]+'" at '+g.pos);return PA(TA(a))}function TA(n){for(var e=[],t,r,a=0,s=n.length;a<s;++a)t=n[a],t&&(t[0]==="text"&&r&&r[0]==="text"?(r[1]+=t[1],r[3]=t[3]):(e.push(t),r=t));return e}function PA(n){for(var e=[],t=e,r=[],a,s,i=0,o=n.length;i<o;++i)switch(a=n[i],a[0]){case"#":case"^":t.push(a),r.push(a),t=a[4]=[];break;case"/":s=r.pop(),s[5]=a[2],t=r.length>0?r[r.length-1][4]:e;break;default:t.push(a)}return e}function po(n){this.string=n,this.tail=n,this.pos=0}function Ls(n,e){this.view=n,this.cache={".":this.view},this.parent=e}function Ve(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}var hA,Ds,gA,yA,wA,xA,AA,sy,OA,EA,Tt,ho,El,iy=y(()=>{hA=Object.prototype.toString,Ds=Array.isArray||function(e){return hA.call(e)==="[object Array]"};gA=RegExp.prototype.test;yA=/\S/;wA={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};xA=/\s*/,AA=/\s+/,sy=/\s*=/,OA=/\s*\}/,EA=/#|\^|\/|>|\{|&|=|!/;po.prototype.eos=function(){return this.tail===""};po.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};po.prototype.scanUntil=function(e){var t=this.tail.search(e),r;switch(t){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=r.length,r};Ls.prototype.push=function(e){return new Ls(e,this)};Ls.prototype.lookup=function(e){var t=this.cache,r;if(t.hasOwnProperty(e))r=t[e];else{for(var a=this,s,i,o,u=!1;a;){if(e.indexOf(".")>0)for(s=a.view,i=e.split("."),o=0;s!=null&&o<i.length;)o===i.length-1&&(u=ay(s,i[o])||mA(s,i[o])),s=s[i[o++]];else s=a.view[e],u=ay(a.view,e);if(u){r=s;break}a=a.parent}t[e]=r}return rh(r)&&(r=r.call(this.view)),r};Ve.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};Ve.prototype.parse=function(e,t){var r=this.templateCache,a=e+":"+(t||Tt.tags).join(":"),s=typeof r<"u",i=s?r.get(a):void 0;return i==null&&(i=IA(e,t),s&&r.set(a,i)),i};Ve.prototype.render=function(e,t,r,a){var s=this.getConfigTags(a),i=this.parse(e,s),o=t instanceof Ls?t:new Ls(t,void 0);return this.renderTokens(i,o,r,e,a)};Ve.prototype.renderTokens=function(e,t,r,a,s){for(var i="",o,u,l,c=0,f=e.length;c<f;++c)l=void 0,o=e[c],u=o[0],u==="#"?l=this.renderSection(o,t,r,a,s):u==="^"?l=this.renderInverted(o,t,r,a,s):u===">"?l=this.renderPartial(o,t,r,s):u==="&"?l=this.unescapedValue(o,t):u==="name"?l=this.escapedValue(o,t,s):u==="text"&&(l=this.rawValue(o)),l!==void 0&&(i+=l);return i};Ve.prototype.renderSection=function(e,t,r,a,s){var i=this,o="",u=t.lookup(e[1]);function l(d){return i.render(d,t,r,s)}if(u){if(Ds(u))for(var c=0,f=u.length;c<f;++c)o+=this.renderTokens(e[4],t.push(u[c]),r,a,s);else if(typeof u=="object"||typeof u=="string"||typeof u=="number")o+=this.renderTokens(e[4],t.push(u),r,a,s);else if(rh(u)){if(typeof a!="string")throw new Error("Cannot use higher-order sections without the original template");u=u.call(t.view,a.slice(e[3],e[5]),l),u!=null&&(o+=u)}else o+=this.renderTokens(e[4],t,r,a,s);return o}};Ve.prototype.renderInverted=function(e,t,r,a,s){var i=t.lookup(e[1]);if(!i||Ds(i)&&i.length===0)return this.renderTokens(e[4],t,r,a,s)};Ve.prototype.indentPartial=function(e,t,r){for(var a=t.replace(/[^ \t]/g,""),s=e.split(`
`),i=0;i<s.length;i++)s[i].length&&(i>0||!r)&&(s[i]=a+s[i]);return s.join(`
`)};Ve.prototype.renderPartial=function(e,t,r,a){if(r){var s=this.getConfigTags(a),i=rh(r)?r(e[1]):r[e[1]];if(i!=null){var o=e[6],u=e[5],l=e[4],c=i;u==0&&l&&(c=this.indentPartial(i,l,o));var f=this.parse(c,s);return this.renderTokens(f,t,r,c,a)}}};Ve.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(r!=null)return r};Ve.prototype.escapedValue=function(e,t,r){var a=this.getConfigEscape(r)||Tt.escape,s=t.lookup(e[1]);if(s!=null)return typeof s=="number"&&a===Tt.escape?String(s):a(s)};Ve.prototype.rawValue=function(e){return e[1]};Ve.prototype.getConfigTags=function(e){return Ds(e)?e:e&&typeof e=="object"?e.tags:void 0};Ve.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!Ds(e))return e.escape};Tt={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(n){ho.templateCache=n},get templateCache(){return ho.templateCache}},ho=new Ve;Tt.clearCache=function(){return ho.clearCache()};Tt.parse=function(e,t){return ho.parse(e,t)};Tt.render=function(e,t,r,a){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+pA(e)+'" was given as the first argument for mustache#render(template, view, partials)');return ho.render(e,t,r,a)};Tt.escape=vA;Tt.Scanner=po;Tt.Context=Ls;Tt.Writer=Ve;El=Tt});function oy(){El.escape=n=>n}var mo,SA,Il,CA,kA,nh,RA,Gt,uy,wa,Fs=y(()=>{iy();mo=n=>{let e=n.split(""),t=[],r=(s,i)=>{for(let o=i;o<e.length;o+=1)if(s.includes(e[o]))return o;return-1},a=0;for(;a<e.length;)if(e[a]==="{"&&a+1<e.length&&e[a+1]==="{")t.push({type:"literal",text:"{"}),a+=2;else if(e[a]==="}"&&a+1<e.length&&e[a+1]==="}")t.push({type:"literal",text:"}"}),a+=2;else if(e[a]==="{"){let s=r("}",a);if(s<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(a+1,s).join("")}),a=s+1}else{if(e[a]==="}")throw new Error("Single '}' in template.");{let s=r("{}",a),i=(s<0?e.slice(a):e.slice(a,s)).join("");t.push({type:"literal",text:i}),a=s<0?e.length:s}}return t},SA=n=>n.map(e=>e[0]==="name"?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}),Il=n=>{oy();let e=El.parse(n);return SA(e)},CA=(n,e)=>mo(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`(f-string) Missing value for input ${r.name}`)}return t+r.text},""),kA=(n,e)=>(oy(),El.render(n,e)),nh={"f-string":CA,mustache:kA},RA={"f-string":mo,mustache:Il},Gt=(n,e,t)=>nh[e](n,t),uy=(n,e)=>RA[e](n),wa=(n,e,t)=>{if(!(e in nh)){let r=Object.keys(nh);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{let r=t.reduce((a,s)=>(a[s]="foo",a),{});Array.isArray(n)?n.forEach(a=>{if(a.type==="text")Gt(a.text,e,r);else if(a.type==="image_url")if(typeof a.image_url=="string")Gt(a.image_url,e,r);else{let s=a.image_url.url;Gt(s,e,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(a,null,2)}`)}):Gt(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}}});var ah={};ds(ah,{PromptTemplate:()=>Kt});var Kt,Us=y(()=>{fo();Fs();Kt=class n extends Lr{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),wa(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return Gt(this.template,this.templateFormat,t)}static fromExamples(e,t,r,a=`

`,s=""){let i=[s,...e,t].join(a);return new n({inputVariables:r,template:i})}static fromTemplate(e,t){let{templateFormat:r="f-string",...a}=t??{},s=new Set;return uy(e,r).forEach(i=>{i.type==="variable"&&s.add(i.name)}),new n({inputVariables:[...s],templateFormat:r,template:e,...a})}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new n({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}});var Bs,sh=y(()=>{so();$s();Fs();Bs=class n extends Dr{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),wa([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}async format(e){let t={};for(let[i,o]of Object.entries(this.template))typeof o=="string"?t[i]=Gt(o,this.templateFormat,e):t[i]=o;let r=e.url||t.url,a=e.detail||t.detail;if(!r)throw new Error("Must provide either an image URL.");if(typeof r!="string")throw new Error("url must be a string.");let s={url:r};return a&&(s.detail=a),s}async formatPromptValue(e){let t=await this.format(e);return new gl(t)}}});function NA(n){return typeof n.formatMessages=="function"}function jA(n,e){if(NA(n)||Qe(n))return n;if(Array.isArray(n)&&n[0]==="placeholder"){let a=n[1];if(typeof a!="string"||a[0]!=="{"||a[a.length-1]!=="}")throw new Error(`Invalid placeholder template: "${n[1]}". Expected a variable name surrounded by curly braces.`);let s=a.slice(1,-1);return new ih({variableName:s,optional:!0})}let t=Dt(n),r;if(typeof t.content=="string"?r=t.content:r=t.content.map(a=>"text"in a?{text:a.text}:"image_url"in a?{image_url:a.image_url}:a),t._getType()==="human")return Tl.fromTemplate(r,e);if(t._getType()==="ai")return lh.fromTemplate(r,e);if(t._getType()==="system")return ch.fromTemplate(r,e);if(et.isInstance(t))return uh.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function MA(n){return n.constructor.lc_name()==="MessagesPlaceholder"}var go,ih,oh,bo,uh,yo,Tl,lh,ch,zs,_o=y(()=>{ks();so();Et();fo();$s();Us();sh();Fs();go=class extends q{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(r=>this.formatMessages(r),e,{...t,runType:"prompt"})}},ih=class extends go{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let a=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw a.name="InputFormatError",a}let r;try{Array.isArray(t)?r=t.map(Dt):r=[Dt(t)]}catch(a){let s=typeof t=="string"?t:JSON.stringify(t,null,2),i=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${s}`,`Additional message: ${a.message}`].join(`

`));throw i.name="InputFormatError",i}return r}},oh=class extends go{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},bo=class extends Dr{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new Ns(t)}},uh=class extends oh{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new et(await this.prompt.format(e),this.role)}static fromTemplate(e,t,r){return new this(Kt.fromTemplate(e,{templateFormat:r?.templateFormat}),t)}},yo=class extends go{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let r=[];this.prompt.forEach(a=>{"inputVariables"in a&&(r=r.concat(a.inputVariables))}),this.inputVariables=r}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let r=t._messageClass();return new r({content:e})}else if(t.chatMessageClass){let r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(Kt.fromTemplate(e,t));let r=[];for(let a of e)if(typeof a=="string"||typeof a=="object"&&"text"in a){let s="";typeof a=="string"?s=a:typeof a.text=="string"&&(s=a.text??""),r.push(Kt.fromTemplate(s,t))}else if(typeof a=="object"&&"image_url"in a){let s=a.image_url??"",i,o=[];if(typeof s=="string"){let u;t?.templateFormat==="mustache"?u=Il(s):u=mo(s);let l=u.flatMap(c=>c.type==="variable"?[c.name]:[]);if((l?.length??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${s}`);o=[l[0]]}else o=[];s={url:s},i=new Bs({template:s,inputVariables:o,templateFormat:t?.templateFormat})}else if(typeof s=="object"){if("url"in s){let u;t?.templateFormat==="mustache"?u=Il(s.url):u=mo(s.url),o=u.flatMap(l=>l.type==="variable"?[l.name]:[])}else o=[];i=new Bs({template:s,inputVariables:o,templateFormat:t?.templateFormat})}else throw new Error("Invalid image template");r.push(i)}return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof Lr){let t=await this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let r of this.prompt){let a={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(let s of r.inputVariables)a||(a={[s]:e[s]}),a={...a,[s]:e[s]};if(r instanceof Lr){let s=await r.format(a);t.push({type:"text",text:s})}else if(r instanceof Bs){let s=await r.format(a);t.push({type:"image_url",image_url:s})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},Tl=class extends yo{static _messageClass(){return he}static lc_name(){return"HumanMessagePromptTemplate"}},lh=class extends yo{static _messageClass(){return le}static lc_name(){return"AIMessagePromptTemplate"}},ch=class extends yo{static _messageClass(){return oa}static lc_name(){return"SystemMessagePromptTemplate"}};zs=class n extends bo{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let o of this.promptMessages)if(!(o instanceof _e))for(let u of o.inputVariables)t.add(u);let r=this.inputVariables,a=new Set(this.partialVariables?r.concat(Object.keys(this.partialVariables)):r),s=new Set([...a].filter(o=>!t.has(o)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are not used in any of the prompt messages.`);let i=new Set([...t].filter(o=>!a.has(o)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if(typeof e.content=="string")return e;let r=await Promise.all(e.content.map(async a=>{if(a.type!=="image_url")return a;let s="";typeof a.image_url=="string"?s=a.image_url:s=a.image_url.url;let o=await Kt.fromTemplate(s,{templateFormat:this.templateFormat}).format(t);return typeof a.image_url!="string"&&"url"in a.image_url?a.image_url.url=o:a.image_url=o,a}));return e.content=r,e}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=[];for(let a of this.promptMessages)if(a instanceof _e)r.push(await this._parseImagePrompts(a,t));else{let s=a.inputVariables.reduce((o,u)=>{if(!(u in t)&&!(MA(a)&&a.optional))throw new Error(`Missing value for input variable \`${u.toString()}\``);return o[u]=t[u],o},{}),i=await a.formatMessages(s);r=r.concat(i)}return r}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}static fromTemplate(e,t){let r=Kt.fromTemplate(e,t),a=new Tl({prompt:r});return this.fromMessages([a])}static fromMessages(e,t){let r=e.reduce((i,o)=>i.concat(o instanceof n?o.promptMessages:[jA(o,t)]),[]),a=e.reduce((i,o)=>o instanceof n?Object.assign(i,o.partialVariables):i,Object.create(null)),s=new Set;for(let i of r)if(!(i instanceof _e))for(let o of i.inputVariables)o in a||s.add(o);return new this({...t,inputVariables:[...s],promptMessages:r,partialVariables:a,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}});var ly={};ds(ly,{FewShotChatMessagePromptTemplate:()=>fh,FewShotPromptTemplate:()=>dh});var dh,fh,hh=y(()=>{fo();Fs();Us();_o();dh=class n extends Lr{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),wa(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),a=await Promise.all(r.map(i=>this.examplePrompt.format(i))),s=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return Gt(s,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let r=await Kt.deserialize(t),a;if(Array.isArray(e.examples))a=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new n({inputVariables:e.input_variables,examplePrompt:r,examples:a,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}},fh=class n extends bo{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),wa(this.prefix+this.suffix,this.templateFormat,t)}}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t);r=r.map(s=>{let i={};return this.examplePrompt.inputVariables.forEach(o=>{i[o]=s[o]}),i});let a=[];for(let s of r){let i=await this.examplePrompt.formatMessages(s);a.push(...i)}return a}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),s=(await Promise.all(r.map(o=>this.examplePrompt.formatMessages(o)))).flat().map(o=>o.content),i=[this.prefix,...s,this.suffix].join(this.exampleSeparator);return Gt(i,this.templateFormat,t)}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}}});var Dr,$s=y(()=>{Et();Dr=class extends q{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},r={};for(let[s,i]of Object.entries(t))typeof i=="string"?r[s]=i:r[s]=await i();return{...r,...e}}async invoke(e,t){return this._callWithConfig(r=>this.formatPromptValue(r),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await Promise.resolve().then(()=>(Us(),ah));return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await Promise.resolve().then(()=>(Us(),ah));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await Promise.resolve().then(()=>(hh(),ly));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}});var xw=Ne((J8,vw)=>{vw.exports=function(){var n=document.getSelection();if(!n.rangeCount)return function(){};for(var e=document.activeElement,t=[],r=0;r<n.rangeCount;r++)t.push(n.getRangeAt(r));switch(e.tagName.toUpperCase()){case"INPUT":case"TEXTAREA":e.blur();break;default:e=null;break}return n.removeAllRanges(),function(){n.type==="Caret"&&n.removeAllRanges(),n.rangeCount||t.forEach(function(a){n.addRange(a)}),e&&e.focus()}}});var Ew=Ne((W8,Ow)=>{"use strict";var pT=xw(),Aw={"text/plain":"Text","text/html":"Url",default:"Text"},mT="Copy to clipboard: #{key}, Enter";function gT(n){var e=(/mac os x/i.test(navigator.userAgent)?"\u2318":"Ctrl")+"+C";return n.replace(/#{\s*key\s*}/g,e)}function bT(n,e){var t,r,a,s,i,o,u=!1;e||(e={}),t=e.debug||!1;try{a=pT(),s=document.createRange(),i=document.getSelection(),o=document.createElement("span"),o.textContent=n,o.ariaHidden="true",o.style.all="unset",o.style.position="fixed",o.style.top=0,o.style.clip="rect(0, 0, 0, 0)",o.style.whiteSpace="pre",o.style.webkitUserSelect="text",o.style.MozUserSelect="text",o.style.msUserSelect="text",o.style.userSelect="text",o.addEventListener("copy",function(c){if(c.stopPropagation(),e.format)if(c.preventDefault(),typeof c.clipboardData>"u"){t&&console.warn("unable to use e.clipboardData"),t&&console.warn("trying IE specific stuff"),window.clipboardData.clearData();var f=Aw[e.format]||Aw.default;window.clipboardData.setData(f,n)}else c.clipboardData.clearData(),c.clipboardData.setData(e.format,n);e.onCopy&&(c.preventDefault(),e.onCopy(c.clipboardData))}),document.body.appendChild(o),s.selectNodeContents(o),i.addRange(s);var l=document.execCommand("copy");if(!l)throw new Error("copy command was unsuccessful");u=!0}catch(c){t&&console.error("unable to copy using execCommand: ",c),t&&console.warn("trying IE specific stuff");try{window.clipboardData.setData(e.format||"text",n),e.onCopy&&e.onCopy(window.clipboardData),u=!0}catch(f){t&&console.error("unable to copy using clipboardData: ",f),t&&console.error("falling back to prompt"),r=gT("message"in e?e.message:mT),window.prompt(r,n)}}finally{i&&(typeof i.removeRange=="function"?i.removeRange(s):i.removeAllRanges()),o&&document.body.removeChild(o),a()}return u}Ow.exports=bT});var sd={id:"acode.plugin.chatgpt",name:"AI Assistant Beta",main:"dist/main.js",version:"2.0.0",readme:"readme.md",icon:"icon.png",minVersionCode:290,files:["assets/ai_assistant.svg","assets/user_avatar.png","assets/insert-context.svg","assets/github-dark.css","assets/highlight.min.js","assets/markdown-it.min.js"],price:0,author:{name:"Raunak",email:"bajrangcoders@gmail.com",github:"bajrangCoder"}};var cm=`/*---------------------------------------*\\
 * Styles For Image generator
 * DALL-E
\\*---------------------------------------*/
.main-sidebar-cont * {
  box-sizing: border-box;
}
.main-sidebar-cont .sidebar-ai-heading {
  text-align: center;
  padding-bottom: 15px;
}
.main-sidebar-cont .prompt-area {
  width: 100%;
  font: initial;
  font-size: 0.9rem;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid gray;
  outline: none;
  color: var(--primary-text-color);
  resize: none;
  margin-bottom: 8px;
  background: transparent;
}
.main-sidebar-cont .prompt-area:focus-visible {
  border-color: var(--button-background-color);
}
.main-sidebar-cont .size-selector {
  width: 100%;
  margin-bottom: 16px;
  background: transparent;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid gray;
  outline: none;
  color: var(--primary-text-color);
}
.main-sidebar-cont .size-selector:focus-visible {
  border-color: var(--button-background-color);
}
.main-sidebar-cont .generatorBtn {
  border: none;
  background: var(--button-background-color);
  color: var(--button-text-color);
  padding: 10px 16px;
  border-top-left-radius: 15px;
  border-bottom-right-radius: 15px;
  font-weight: 600;
  font-size: 16px;
}
.main-sidebar-cont .img-fluid {
  max-width: 100%;
  margin-top: 10px;
}

/*---------------------------------------*\\
 * Styles For Text Generator
 * AI Assistant
\\*---------------------------------------*/
#acode-ai-assistant {
  /**
    * Display User input in chatBox
    */
  /**
    * Displat Ai response in chatBox
    */
  /**
    * Highlights Code AREA
    * In Ai response
    */
  /**
    * Error In ai response
    */
  /**
    * PROMPT AREA For CHATGPT
    */
}
#acode-ai-assistant * {
  box-sizing: border-box;
}
#acode-ai-assistant .mainApp {
  position: absolute;
  left: 0;
  width: 100%;
  height: calc(100% - 80px);
  background: var(--primary-color);
}
#acode-ai-assistant .chatBox {
  height: 100%;
  width: 100%;
  white-space: pre-wrap;
  overflow-y: auto;
}
#acode-ai-assistant .wrapper {
  padding-block: 12px;
  padding-inline: 10px;
}
#acode-ai-assistant .wrapper .chat {
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
#acode-ai-assistant .wrapper .chat .profile {
  height: 35px;
  width: 35px;
  border-radius: 8px;
  background: #5436da;
  display: flex;
  align-items: center;
  justify-content: center;
}
#acode-ai-assistant .wrapper .chat .profile img {
  width: 60%;
}
#acode-ai-assistant .wrapper .chat .message {
  flex: 1;
  color: var(--primary-text-color);
  font-size: 16px;
  line-height: 1.5;
  user-select: text;
}
#acode-ai-assistant .ai_wrapper {
  padding-block: 12px 30px;
  padding-inline: 10px;
  background-color: var(--secondary-color);
}
#acode-ai-assistant .ai_wrapper .ai_chat {
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
#acode-ai-assistant .ai_wrapper .ai_chat .ai_profile {
  height: 35px;
  width: 35px;
  border-radius: 8px;
  background: #10a37f;
  display: flex;
  align-items: center;
  justify-content: center;
}
#acode-ai-assistant .ai_wrapper .ai_chat .ai_profile img {
  width: 60%;
}
#acode-ai-assistant .ai_wrapper .ai_message {
  flex: 1;
  color: var(--secondary-text-color);
  font-size: 16px;
  line-height: 1.5;
  overflow: hidden;
  user-select: text;
  /*
    code block in ai response
    */
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock {
  border: 2px solid var(--border-color);
  width: 100%;
  border-radius: 5px;
  overflow-x: auto;
  position: relative;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .copy-button {
  position: absolute;
  top: 4px;
  right: 8px;
  border: none;
  outline: none;
  border-radius: 8px;
  height: 24px;
  width: 28px;
  color: lightgray;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  background: rgb(26, 34, 46);
  box-shadow: 0 4px 0 #1b232f;
  transition: all 0.3s ease-in-out;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .copy-button:active {
  box-shadow: 0;
  color: gray;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .codesArea {
  box-sizing: border-box;
  padding: 12px;
  margin-bottom: 0;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .codesArea::-webkit-scrollbar {
  height: 10px;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .codesArea::-webkit-scrollbar-thumb {
  background: lightgray;
  border-radius: 4px;
}
#acode-ai-assistant .ai_wrapper .ai_message hr {
  margin: 1rem 0;
  color: inherit;
  border: 0;
  border-top: 1px solid;
  opacity: 0.25;
}
#acode-ai-assistant .ai_wrapper .ai_message h6,
#acode-ai-assistant .ai_wrapper .ai_message h5,
#acode-ai-assistant .ai_wrapper .ai_message h4,
#acode-ai-assistant .ai_wrapper .ai_message h3,
#acode-ai-assistant .ai_wrapper .ai_message h2,
#acode-ai-assistant .ai_wrapper .ai_message h1 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-weight: 500;
  line-height: 1.2;
  color: inherit;
}
#acode-ai-assistant .ai_wrapper .ai_message h1 {
  font-size: calc(1.375rem + 1.5vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h2 {
  font-size: calc(1.325rem + 0.9vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h3 {
  font-size: calc(1.3rem + 0.6vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h4 {
  font-size: calc(1.275rem + 0.3vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h5 {
  font-size: 1.25rem;
}
#acode-ai-assistant .ai_wrapper .ai_message h6 {
  font-size: 1rem;
}
#acode-ai-assistant .ai_wrapper .ai_message p {
  margin-top: 0;
  margin-bottom: 1rem;
}
#acode-ai-assistant .ai_wrapper .ai_message ul,
#acode-ai-assistant .ai_wrapper .ai_message ol {
  margin: 1em 0;
  padding: 0 0 0 2em;
}
#acode-ai-assistant .ai_wrapper .ai_message ul {
  list-style-type: disc;
}
#acode-ai-assistant .ai_wrapper .ai_message li p:last-child {
  margin: 0;
}
#acode-ai-assistant .ai_wrapper .ai_message dt {
  font-weight: 700;
}
#acode-ai-assistant .ai_wrapper .ai_message dd {
  margin-bottom: 0.5rem;
  margin-left: 0;
}
#acode-ai-assistant .ai_wrapper .ai_message blockquote {
  margin: 0 0 1rem;
}
#acode-ai-assistant .ai_wrapper .ai_message b,
#acode-ai-assistant .ai_wrapper .ai_message strong {
  font-weight: bolder;
}
#acode-ai-assistant .ai_wrapper .ai_message small,
#acode-ai-assistant .ai_wrapper .ai_message .small {
  font-size: 0.875em;
}
#acode-ai-assistant .ai_wrapper .ai_message pre,
#acode-ai-assistant .ai_wrapper .ai_message code,
#acode-ai-assistant .ai_wrapper .ai_message kbd,
#acode-ai-assistant .ai_wrapper .ai_message samp {
  font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 1em;
}
#acode-ai-assistant .ai_wrapper .ai_message pre {
  display: block;
  margin-top: 0;
  margin-bottom: 1rem;
  overflow: auto;
  font-size: 0.875em;
}
#acode-ai-assistant .ai_wrapper .ai_message pre code {
  font-size: inherit;
  color: inherit;
}
#acode-ai-assistant .ai_wrapper .ai_message code {
  font-size: 0.875em;
  color: var(--link-text-color);
  word-wrap: break-word;
}
#acode-ai-assistant .ai_wrapper .ai_message a > code {
  color: inherit;
}
#acode-ai-assistant .ai_wrapper .ai_message kbd {
  padding: 0.1875rem 0.375rem;
  font-size: 0.875em;
  color: var(--primary-text-color);
  background-color: var(--popup-background-color);
  border-radius: 0.25rem;
}
#acode-ai-assistant .ai_wrapper .ai_message kbd kbd {
  padding: 0;
  font-size: 1em;
}
#acode-ai-assistant .error-box {
  border: 1px solid var(--error-text-color);
  color: var(--error-text-color);
  font-weight: 700;
  padding: 8px;
  white-space: pre-wrap;
  word-break: break-word;
  border-radius: 10px;
}
#acode-ai-assistant .inputBox {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 80px;
  padding: 8px;
  display: flex;
  background-color: var(--popup-background-color);
  box-shadow: 0px -2px 4px var(--box-shadow-color);
  z-index: 1;
}
#acode-ai-assistant .chatTextarea {
  flex: 1;
  height: 100%;
  resize: none;
  border: none;
  outline: none;
  background: none;
  font: initial;
  font-size: 1.1rem;
  color: var(--primary-text-color);
  padding-inline-end: 8px;
}
#acode-ai-assistant .sendBtn {
  height: 40px;
  width: 40px;
  border-radius: 8px;
  border: none;
  outline: none;
  background-color: rgba(0, 0, 0, 0.2);
  color: gray;
  display: grid;
  place-items: center;
}
#acode-ai-assistant .sendBtn:active {
  background-color: var(--button-background-color);
  color: var(--primary-text-color);
}
#acode-ai-assistant .stopGenerationBtn {
  height: 40px;
  width: 40px;
  border-radius: 8px;
  border: none;
  outline: none;
  background-color: var(--button-background-color);
  color: var(--primary-text-color);
  display: grid;
  place-items: center;
}
#acode-ai-assistant .stopGenerationBtn:active {
  background-color: rgba(0, 0, 0, 0.2);
}
#acode-ai-assistant .hide {
  display: none;
}`;var dm;(function(n){n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT"})(dm||(dm={}));var lu;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(lu||(lu={}));var cu;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(cu||(cu={}));var fm;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(fm||(fm={}));var hm;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(hm||(hm={}));var du;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.OTHER="OTHER"})(du||(du={}));var pm;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(pm||(pm={}));var mm;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(mm||(mm={}));var gm;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(gm||(gm={}));var VT=[du.RECITATION,du.SAFETY];ht();ks();Ki();var gx=typeof window=="object"?window:{},$="0123456789abcdef".split(""),bx=[-2147483648,8388608,32768,128],qt=[24,16,8,0];var Ae=[];function Vt(n){n?(Ae[0]=Ae[16]=Ae[1]=Ae[2]=Ae[3]=Ae[4]=Ae[5]=Ae[6]=Ae[7]=Ae[8]=Ae[9]=Ae[10]=Ae[11]=Ae[12]=Ae[13]=Ae[14]=Ae[15]=0,this.blocks=Ae):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Vt.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===gx.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<qt[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<qt[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<qt[a++&3],i[a>>2]|=(128|t&63)<<qt[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<qt[a++&3],i[a>>2]|=(128|t>>6&63)<<qt[a++&3],i[a>>2]|=(128|t&63)<<qt[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<qt[a++&3],i[a>>2]|=(128|t>>12&63)<<qt[a++&3],i[a>>2]|=(128|t>>6&63)<<qt[a++&3],i[a>>2]|=(128|t&63)<<qt[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Vt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=bx[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};Vt.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};Vt.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return $[n>>28&15]+$[n>>24&15]+$[n>>20&15]+$[n>>16&15]+$[n>>12&15]+$[n>>8&15]+$[n>>4&15]+$[n&15]+$[e>>28&15]+$[e>>24&15]+$[e>>20&15]+$[e>>16&15]+$[e>>12&15]+$[e>>8&15]+$[e>>4&15]+$[e&15]+$[t>>28&15]+$[t>>24&15]+$[t>>20&15]+$[t>>16&15]+$[t>>12&15]+$[t>>8&15]+$[t>>4&15]+$[t&15]+$[r>>28&15]+$[r>>24&15]+$[r>>20&15]+$[r>>16&15]+$[r>>12&15]+$[r>>8&15]+$[r>>4&15]+$[r&15]+$[a>>28&15]+$[a>>24&15]+$[a>>20&15]+$[a>>16&15]+$[a>>12&15]+$[a>>8&15]+$[a>>4&15]+$[a&15]};Vt.prototype.toString=Vt.prototype.hex;Vt.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};Vt.prototype.array=Vt.prototype.digest;Vt.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var Wf=n=>new Vt(!0).update(n).hex();on();var Kb=(...n)=>Wf(n.join("_"));var Zf=class{},yx=new Map,ml=class n extends Zf{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Kb(e,t))??null)}async update(e,t,r){this.cache.set(Kb(e,t),r)}static global(){return new n(yx)}};so();on();Qi();var Yb=oe(Zb(),1),Ix=Object.defineProperty,Tx=(n,e,t)=>e in n?Ix(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Px=(n,e,t)=>(Tx(n,typeof e!="symbol"?e+"":e,t),t);function Sx(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){let s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){let a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function Cx(n,e){return n.length===1?[e.get(n.join(","))]:Sx(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function kx(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Xf=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{let[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((l,c)=>r[l]=u+c),r},{});for(let[r,a]of Object.entries(t)){let s=Yb.default.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){let r=new RegExp(this.patStr,"ug"),a=Xf.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!i.has(l)):t);if(o.size>0){let l=Xf.specialTokenRegex([...o]),c=n.match(l);if(c!=null)throw new Error(`The text contains a special token that is not allowed: ${c[0]}`)}let u=0;for(;;){let l=null,c=u;for(;a.lastIndex=c,l=a.exec(n),!(l==null||i.has(l[0]));)c=l.index+1;let f=l?.index??n.length;for(let h of n.substring(u,f).matchAll(r)){let p=this.textEncoder.encode(h[0]),g=this.rankMap.get(p.join(","));if(g!=null){s.push(g);continue}s.push(...Cx(p,this.rankMap))}if(l==null)break;let d=this.specialTokens[l[0]];s.push(d),u=l.index+l[0].length}return s}decode(n){let e=[],t=0;for(let s=0;s<n.length;++s){let i=n[s],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}let r=new Uint8Array(t),a=0;for(let s of e)r.set(s,a),a+=s.length;return this.textDecoder.decode(r)}},js=Xf;Px(js,"specialTokenRegex",n=>new RegExp(n.map(e=>kx(e)).join("|"),"g"));function io(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":return"o200k_base";default:throw new Error("Unknown model")}}Qi();var yl={},Rx=new Mr({});async function Nx(n){return n in yl||(yl[n]=Rx.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new js(e)).catch(e=>{throw delete yl[n],e})),await yl[n]}async function Xb(n){return Nx(io(n))}Et();var jx=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;var Mx=()=>!1,Qf=class extends q{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??Mx(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},_l=class extends Qf{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=ml.global():this.cache=void 0,this.caller=new Mr(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Xb("modelName"in this?jx(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new Rs(e):Array.isArray(e)?new Ns(e.map(Dt)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};Ff();Et();hf();df();Rr();Rr();Et();Ss();var nt=class extends q{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=H(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){let r=H(t),a,s=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=tt(a,i)}catch{a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new Cs(new cn({steps:e}))}};function ba(n){return typeof n?.parse=="function"}var ya=class n extends _l{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r?.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let a=n._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptions(t),o={...s.metadata,...this.getLsParams(i)},u=await Ot.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await u?.handleChatModelStart(this.toJSON(),[a],s.runId,void 0,l,void 0,void 0,s.runName),f;try{for await(let d of this._streamResponseChunks(a,i,c?.[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,f?f=f.concat(d):f=d}catch(d){throw await Promise.all((c??[]).map(h=>h?.handleLLMError(d))),d}await Promise.all((c??[]).map(d=>d?.handleLLMEnd({generations:[[f]]})))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,r){let a=e.map(h=>h.map(Dt)),s={...r.metadata,...this.getLsParams(t)},i=await Ot.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this?.invocationParams(t),batch_size:1},u=await i?.handleChatModelStart(this.toJSON(),a,r.runId,void 0,o,void 0,void 0,r.runName),l=[],c=[];if(!!u?.[0].handlers.find(h=>Vu(h)||zu(h))&&a.length===1&&this._streamResponseChunks!==n.prototype._streamResponseChunks)try{let h=await this._streamResponseChunks(a[0],t,u?.[0]),p;for await(let g of h)p===void 0?p=g:p=tt(p,g);if(p===void 0)throw new Error("Received empty response from chat model call.");l.push([p]),await u?.[0].handleLLMEnd({generations:l,llmOutput:{}})}catch(h){throw await u?.[0].handleLLMError(h),h}else{let h=await Promise.allSettled(a.map((p,g)=>this._generate(p,{...t,promptIndex:g},u?.[g])));await Promise.all(h.map(async(p,g)=>{if(p.status==="fulfilled"){let m=p.value;for(let b of m.generations)b.message.response_metadata={...b.generationInfo,...b.message.response_metadata};return m.generations.length===1&&(m.generations[0].message.response_metadata={...m.llmOutput,...m.generations[0].message.response_metadata}),l[g]=m.generations,c[g]=m.llmOutput,u?.[g]?.handleLLMEnd({generations:[m.generations],llmOutput:m.llmOutput})}else return await u?.[g]?.handleLLMError(p.reason),Promise.reject(p.reason)}))}let d={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(d,ff,{value:u?{runIds:u?.map(h=>h.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(m=>m.map(Dt)),o={...s.metadata,...this.getLsParams(a)},u=await Ot.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1,cached:!0},c=await u?.handleChatModelStart(this.toJSON(),i,s.runId,void 0,l,void 0,void 0,s.runName),f=[],h=(await Promise.allSettled(i.map(async(m,b)=>{let x=n._convertInputToPromptValue(m).toString(),v=await t.lookup(x,r);return v==null&&f.push(b),v}))).map((m,b)=>({result:m,runManager:c?.[b]})).filter(({result:m})=>m.status==="fulfilled"&&m.value!=null||m.status==="rejected"),p=[];await Promise.all(h.map(async({result:m,runManager:b},x)=>{if(m.status==="fulfilled"){let v=m.value;return p[x]=v,v.length&&await b?.handleLLMNewToken(v[0].text),b?.handleLLMEnd({generations:[v]})}else return await b?.handleLLMError(m.reason),Promise.reject(m.reason)}));let g={generations:p,missingPromptIndices:f};return Object.defineProperty(g,ff,{value:c?{runIds:c?.map(m=>m.runId)}:void 0,configurable:!0}),g}async generate(e,t,r){let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(h=>h.map(Dt)),[i,o]=this._separateRunnableConfigFromCallOptions(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:f}=await this._generateCached({messages:s,cache:u,llmStringKey:l,parsedOptions:o,handledOptions:i}),d={};if(f.length>0){let h=await this._generateUncached(f.map(p=>s[p]),o,i);await Promise.all(h.generations.map(async(p,g)=>{let m=f[g];c[m]=p;let b=n._convertInputToPromptValue(s[m]).toString();return u.update(b,l,p)})),d=h.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(Dt)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new he(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');let r=e,a=t?.name,s=r.description??"A function available to call.",i=t?.method,o=t?.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=a??"extract",l;ba(r)?l=[{type:"function",function:{name:u,description:s,parameters:Q(r)}}]:("name"in r&&(u=r.name),l=[{type:"function",function:{name:u,description:s,parameters:r}}]);let c=this.bindTools(l),f=lr.from(g=>{if(!g.tool_calls||g.tool_calls.length===0)throw new Error("No tool calls found in the response.");let m=g.tool_calls.find(b=>b.name===u);if(!m)throw new Error(`No tool call found with name ${u}.`);return m.args});if(!o)return c.pipe(f).withConfig({runName:"StructuredOutput"});let d=nt.assign({parsed:(g,m)=>f.invoke(g.raw,m)}),h=nt.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return Ht.from([{raw:c},p]).withConfig({runName:"StructuredOutputRunnable"})}},wl=class extends ya{async _generate(e,t,r){let a=await this._call(e,t,r),s=new le(a);if(typeof s.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}};ks();Ki();Rr();async function*Qb(n,e,t){let r=n;r.startsWith("http://localhost:")&&(r=r.replace("http://localhost:","http://127.0.0.1:"));let a=await fetch(r,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...t.headers},signal:t.signal});if(!a.ok){let u,l=await a.text();try{let c=JSON.parse(l);u=new Error(`Ollama call failed with status code ${a.status}: ${c.error}`)}catch{u=new Error(`Ollama call failed with status code ${a.status}: ${l}`)}throw u.response=a,u}if(!a.body)throw new Error("Could not begin Ollama stream. Please check the given URL and try again.");let s=ve.fromReadableStream(a.body),i=new TextDecoder,o="";for await(let u of s){let c=(o+i.decode(u)).split(`
`);o=c.pop()||"";for(let f of c)try{yield JSON.parse(f)}catch{console.warn(`Received a non-JSON parseable chunk: ${f}`)}}}async function*ey(n,e,t){yield*Qb(`${n}/api/generate`,e,t)}async function*ty(n,e,t){yield*Qb(`${n}/api/chat`,e,t)}var vl=class extends wl{static lc_name(){return"ChatOllama"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama2"}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://localhost:11434"}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:"5m"}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16KV",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGqa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyBase",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyScale",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMLock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMMap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model??this.model,this.baseUrl=e.baseUrl?.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl??this.baseUrl,this.keepAlive=e.keepAlive??this.keepAlive,this.embeddingOnly=e.embeddingOnly,this.f16KV=e.f16KV,this.frequencyPenalty=e.frequencyPenalty,this.headers=e.headers,this.logitsAll=e.logitsAll,this.lowVram=e.lowVram,this.mainGpu=e.mainGpu,this.mirostat=e.mirostat,this.mirostatEta=e.mirostatEta,this.mirostatTau=e.mirostatTau,this.numBatch=e.numBatch,this.numCtx=e.numCtx,this.numGpu=e.numGpu,this.numGqa=e.numGqa,this.numKeep=e.numKeep,this.numPredict=e.numPredict,this.numThread=e.numThread,this.penalizeNewline=e.penalizeNewline,this.presencePenalty=e.presencePenalty,this.repeatLastN=e.repeatLastN,this.repeatPenalty=e.repeatPenalty,this.ropeFrequencyBase=e.ropeFrequencyBase,this.ropeFrequencyScale=e.ropeFrequencyScale,this.temperature=e.temperature,this.stop=e.stop,this.tfsZ=e.tfsZ,this.topK=e.topK,this.topP=e.topP,this.typicalP=e.typicalP,this.useMLock=e.useMLock,this.useMMap=e.useMMap,this.vocabOnly=e.vocabOnly,this.format=e.format}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"ollama",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.temperature??void 0,ls_stop:this.stop,ls_max_tokens:t.options.num_predict}}_llmType(){return"ollama"}invocationParams(e){return{model:this.model,format:this.format,keep_alive:this.keepAlive,options:{embedding_only:this.embeddingOnly,f16_kv:this.f16KV,frequency_penalty:this.frequencyPenalty,logits_all:this.logitsAll,low_vram:this.lowVram,main_gpu:this.mainGpu,mirostat:this.mirostat,mirostat_eta:this.mirostatEta,mirostat_tau:this.mirostatTau,num_batch:this.numBatch,num_ctx:this.numCtx,num_gpu:this.numGpu,num_gqa:this.numGqa,num_keep:this.numKeep,num_predict:this.numPredict,num_thread:this.numThread,penalize_newline:this.penalizeNewline,presence_penalty:this.presencePenalty,repeat_last_n:this.repeatLastN,repeat_penalty:this.repeatPenalty,rope_frequency_base:this.ropeFrequencyBase,rope_frequency_scale:this.ropeFrequencyScale,temperature:this.temperature,stop:e?.stop??this.stop,tfs_z:this.tfsZ,top_k:this.topK,top_p:this.topP,typical_p:this.typicalP,use_mlock:this.useMLock,use_mmap:this.useMMap,vocab_only:this.vocabOnly}}}_combineLLMOutput(){return{}}async*_streamResponseChunksLegacy(e,t,r){let a=ey(this.baseUrl,{...this.invocationParams(t),prompt:this._formatMessagesAsPrompt(e)},{...t,headers:this.headers});for await(let s of a)s.done?yield new ze({text:"",message:new fe({content:""}),generationInfo:{model:s.model,total_duration:s.total_duration,load_duration:s.load_duration,prompt_eval_count:s.prompt_eval_count,prompt_eval_duration:s.prompt_eval_duration,eval_count:s.eval_count,eval_duration:s.eval_duration}}):(yield new ze({text:s.response,message:new fe({content:s.response})}),await r?.handleLLMNewToken(s.response??""))}async*_streamResponseChunks(e,t,r){try{let a=await this.caller.call(async()=>ty(this.baseUrl,{...this.invocationParams(t),messages:this._convertMessagesToOllamaMessages(e)},{...t,headers:this.headers}));for await(let s of a)s.done?yield new ze({text:"",message:new fe({content:""}),generationInfo:{model:s.model,total_duration:s.total_duration,load_duration:s.load_duration,prompt_eval_count:s.prompt_eval_count,prompt_eval_duration:s.prompt_eval_duration,eval_count:s.eval_count,eval_duration:s.eval_duration}}):(yield new ze({text:s.message.content,message:new fe({content:s.message.content})}),await r?.handleLLMNewToken(s.message.content??""))}catch(a){if(a.response?.status===404)console.warn("[WARNING]: It seems you are using a legacy version of Ollama. Please upgrade to a newer version for better chat support."),yield*this._streamResponseChunksLegacy(e,t,r);else throw a}}_convertMessagesToOllamaMessages(e){return e.map(t=>{let r;if(t._getType()==="human")r="user";else if(t._getType()==="ai")r="assistant";else if(t._getType()==="system")r="system";else throw new Error(`Unsupported message type for Ollama: ${t._getType()}`);let a="",s=[];if(typeof t.content=="string")a=t.content;else for(let i of t.content)if(i.type==="text")a=`${a}
${i.text}`;else if(i.type==="image_url"&&typeof i.image_url=="string"){let o=i.image_url.split(",");s.push(o[1]??o[0])}else throw new Error('Unsupported message content type. Must either have type "text" or type "image_url" with a string "image_url" field.');return{role:r,content:a,images:s}})}_formatMessagesAsPrompt(e){return e.map(r=>{let a;return r._getType()==="human"?a=`[INST] ${r.content} [/INST]`:r._getType()==="ai"?a=r.content:r._getType()==="system"?a=`<<SYS>> ${r.content} <</SYS>>`:et.isInstance(r)?a=`

${r.role[0].toUpperCase()}${r.role.slice(1)}: ${r.content}`:(console.warn(`Unsupported message type passed to Ollama: "${r._getType()}"`),a=""),a}).join(`
`)}async _call(e,t,r){let a=[];for await(let s of this._streamResponseChunks(e,t,r))a.push(s.message.content);return a.join("")}};vs();ks();var eh=class extends pt{addUserMessage(e){return this.addMessage(new he(e))}addAIChatMessage(e){return this.addMessage(new le(e))}addAIMessage(e){return this.addMessage(new le(e))}async addMessages(e){for(let t of e)await this.addMessage(t)}clear(){throw new Error("Not implemented.")}},oo=class extends eh{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}};Et();Ss();Et();Ss();Et();Ss();Rr();ks();Et();var uo=class extends ur{constructor(e){let t=new lr({func:(i,o)=>this._enterHistory(i,o??{})}).withConfig({runName:"loadHistory"}),r=e.historyMessagesKey??e.inputMessagesKey;r&&(t=nt.assign({[r]:t}).withConfig({runName:"insertHistory"}));let a=t.pipe(e.runnable.withListeners({onEnd:(i,o)=>this._exitHistory(i,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),s=e.config??{};super({...e,config:s,bound:a}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"historyMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getMessageHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if(typeof e=="object"&&!Array.isArray(e)&&!Qe(e)){let r;this.inputMessagesKey?r=this.inputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="input",Array.isArray(e[r])&&Array.isArray(e[r][0])?t=e[r][0]:t=e[r]}else t=e;if(typeof t=="string")return[new he(t)];if(Array.isArray(t))return t;if(Qe(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(!Array.isArray(e)&&!Qe(e)&&typeof e!="string"){let r;this.outputMessagesKey!==void 0?r=this.outputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="output",e.generations!==void 0?t=e.generations[0][0].message:t=e[r]}else t=e;if(typeof t=="string")return[new le(t)];if(Array.isArray(t))return t;if(Qe(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){let a=await(t?.configurable?.messageHistory).getMessages();return this.historyMessagesKey===void 0?a.concat(this._getInputMessages(e)):a}async _exitHistory(e,t){let r=t.configurable?.messageHistory,a;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?a=e.inputs[0]:a=e.inputs;let s=this._getInputMessages(a);if(this.historyMessagesKey===void 0){let u=await r.getMessages();s=s.slice(u.length)}let i=e.outputs;if(!i)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);let o=this._getOutputMessages(i);await r.addMessages([...s,...o])}async _mergeConfig(...e){let t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){let a={[this.inputMessagesKey??"input"]:"foo"},s={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(a)}, ${JSON.stringify(s)})`)}let{sessionId:r}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(r),t}};var dn=class extends q{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a?.callbacks),e,{...t,runType:"parser"})}},Ms=class extends dn{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},dr=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}};Lt();on();Ki();function lo(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!lo(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let i of r)if(!lo(n[i],e[i]))return!1;return!0}return n===e}var JM=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var Lx=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,Dx=[0,31,28,31,30,31,30,31,31,30,31,30,31],Fx=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,Ux=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,Bx=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,zx=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,Hx=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,qx=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,Vx=/^(?:\/(?:[^~/]|~0|~1)*)*$/,Gx=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,Kx=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,Jx=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,Wx=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,Zx=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,Yx=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,Xx=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},Qx=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,eA=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,tA=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function at(n){return n.test.bind(n)}var rA={date:ry,time:ny.bind(void 0,!1),"date-time":iA,duration:tA,uri:lA,"uri-reference":at(Bx),"uri-template":at(zx),url:at(Hx),email:Xx,hostname:at(Ux),ipv4:at(Qx),ipv6:at(eA),regex:dA,uuid:at(qx),"json-pointer":at(Vx),"json-pointer-uri-fragment":at(Gx),"relative-json-pointer":at(Kx)},nA={...rA,date:at(Jx),time:at(Wx),"date-time":at(Zx),"uri-reference":at(Yx)};function aA(n){return n%4===0&&(n%100!==0||n%400===0)}function ry(n){let e=n.match(Lx);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&aA(t)?29:Dx[r])}function ny(n,e){let t=e.match(Fx);if(!t)return!1;let r=+t[1],a=+t[2],s=+t[3],i=!!t[5];return(r<=23&&a<=59&&s<=59||r==23&&a==59&&s==60)&&(!n||i)}var sA=/t|\s/i;function iA(n){let e=n.split(sA);return e.length==2&&ry(e[0])&&ny(!0,e[1])}var oA=/\/|:/,uA=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function lA(n){return oA.test(n)&&uA.test(n)}var cA=/[^\\]\\Z/;function dA(n){if(cA.test(n))return!1;try{return new RegExp(n),!0}catch{return!1}}var _a=class extends Ms{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},co=class extends _a{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(wg(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new ze({message:a,text:a.content})}else if(Qe(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new ze({message:Jd(a),text:a.content})}else s=new pa({text:a});r===void 0?r=s:r=r.concat(s);let i=await this.parsePartialResult([r]);i!=null&&!lo(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}};var xl=class extends _a{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((t,r)=>t+this._messageContentComplexToString(r),"")}};Pr();ht();var Al=class extends Ms{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=se.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,se.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Q(this.schema))}
\`\`\`
`}async parse(e){try{let r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new dr(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};rf();Hd();var Ol=class extends co{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Bu(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return zd(e[0].text)}async parse(e){return zd(e,JSON.parse)}getFormatInstructions(){return""}};$s();_o();hh();$s();_o();Us();fo();Fs();sh();_o();var cy=["user","model","function","system"],dy;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(dy||(dy={}));var fy;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(fy||(fy={}));var hy;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(hy||(hy={}));var py;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(py||(py={}));var Sl;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.OTHER="OTHER"})(Sl||(Sl={}));var my;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(my||(my={}));var gy;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(gy||(gy={}));var by;(function(n){n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT"})(by||(by={}));var Ge=class extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}},fn=class extends Ge{constructor(e,t){super(e),this.response=t}};var $A="https://generativelanguage.googleapis.com",LA="v1beta",DA="0.7.1",FA="genai-js",va;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(va||(va={}));var Cl=class{constructor(e,t,r,a,s){this.model=e,this.task=t,this.apiKey=r,this.stream=a,this.requestOptions=s}toString(){var e,t;let r=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||LA,s=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||$A}/${r}/${this.model}:${this.task}`;return this.stream&&(s+="?alt=sse"),s}};function UA(n){let e=[];return n?.apiClient&&e.push(n.apiClient),e.push(`${FA}/${DA}`),e.join(" ")}async function BA(n){let e=new Headers;return e.append("Content-Type","application/json"),e.append("x-goog-api-client",UA(n.requestOptions)),e.append("x-goog-api-key",n.apiKey),e}async function zA(n,e,t,r,a,s){let i=new Cl(n,e,t,r,s);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},qA(s)),{method:"POST",headers:await BA(i),body:a})}}async function xo(n,e,t,r,a,s){return HA(n,e,t,r,a,s,fetch)}async function HA(n,e,t,r,a,s,i=fetch){let o=new Cl(n,e,t,r,s),u;try{let l=await zA(n,e,t,r,a,s);if(u=await i(l.url,l.fetchOptions),!u.ok){let c="";try{let f=await u.json();c=f.error.message,f.error.details&&(c+=` ${JSON.stringify(f.error.details)}`)}catch{}throw new Error(`[${u.status} ${u.statusText}] ${c}`)}}catch(l){let c=new Ge(`Error fetching from ${o.toString()}: ${l.message}`);throw c.stack=l.stack,c}return u}function qA(n){let e={};if(n?.timeout>=0){let t=new AbortController,r=t.signal;setTimeout(()=>t.abort(),n.timeout),e.signal=r}return e}function bh(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Pl(n.candidates[0]))throw new fn(`${hn(n)}`,n);return VA(n)}else if(n.promptFeedback)throw new fn(`Text not available. ${hn(n)}`,n);return""},n.functionCall=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Pl(n.candidates[0]))throw new fn(`${hn(n)}`,n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),yy(n)[0]}else if(n.promptFeedback)throw new fn(`Function call not available. ${hn(n)}`,n)},n.functionCalls=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Pl(n.candidates[0]))throw new fn(`${hn(n)}`,n);return yy(n)}else if(n.promptFeedback)throw new fn(`Function call not available. ${hn(n)}`,n)},n}function VA(n){var e,t,r,a;return!((a=(r=(t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0?void 0:t.parts)===null||r===void 0?void 0:r[0])===null||a===void 0)&&a.text?n.candidates[0].content.parts.map(({text:s})=>s).join(""):""}function yy(n){var e,t,r,a;let s=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let i of(a=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||a===void 0?void 0:a.parts)i.functionCall&&s.push(i.functionCall);if(s.length>0)return s}var GA=[Sl.RECITATION,Sl.SAFETY];function Pl(n){return!!n.finishReason&&GA.includes(n.finishReason)}function hn(n){var e,t,r;let a="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)a+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(a+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(a+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((r=n.candidates)===null||r===void 0)&&r[0]){let s=n.candidates[0];Pl(s)&&(a+=`Candidate was blocked due to ${s.finishReason}`,s.finishMessage&&(a+=`: ${s.finishMessage}`))}return a}function wo(n){return this instanceof wo?(this.v=n,this):new wo(n)}function KA(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),a,s=[];return a={},i("next"),i("throw"),i("return"),a[Symbol.asyncIterator]=function(){return this},a;function i(d){r[d]&&(a[d]=function(h){return new Promise(function(p,g){s.push([d,h,p,g])>1||o(d,h)})})}function o(d,h){try{u(r[d](h))}catch(p){f(s[0][3],p)}}function u(d){d.value instanceof wo?Promise.resolve(d.value.v).then(l,c):f(s[0][2],d)}function l(d){o("next",d)}function c(d){o("throw",d)}function f(d,h){d(h),s.shift(),s.length&&o(s[0][0],s[0][1])}}var _y=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function JA(n){let e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=YA(e),[r,a]=t.tee();return{stream:ZA(r),response:WA(a)}}async function WA(n){let e=[],t=n.getReader();for(;;){let{done:r,value:a}=await t.read();if(r)return bh(XA(e));e.push(a)}}function ZA(n){return KA(this,arguments,function*(){let t=n.getReader();for(;;){let{value:r,done:a}=yield wo(t.read());if(a)break;yield yield wo(bh(r))}})}function YA(n){let e=n.getReader();return new ReadableStream({start(r){let a="";return s();function s(){return e.read().then(({value:i,done:o})=>{if(o){if(a.trim()){r.error(new Ge("Failed to parse stream"));return}r.close();return}a+=i;let u=a.match(_y),l;for(;u;){try{l=JSON.parse(u[1])}catch{r.error(new Ge(`Error parsing JSON response: "${u[1]}"`));return}r.enqueue(l),a=a.substring(u[0].length),u=a.match(_y)}return s()})}}})}function XA(n){let e=n[n.length-1],t={promptFeedback:e?.promptFeedback};for(let r of n)if(r.candidates)for(let a of r.candidates){let s=a.index;if(t.candidates||(t.candidates=[]),t.candidates[s]||(t.candidates[s]={index:a.index}),t.candidates[s].citationMetadata=a.citationMetadata,t.candidates[s].finishReason=a.finishReason,t.candidates[s].finishMessage=a.finishMessage,t.candidates[s].safetyRatings=a.safetyRatings,a.content&&a.content.parts){t.candidates[s].content||(t.candidates[s].content={role:a.content.role||"user",parts:[]});let i={};for(let o of a.content.parts)o.text&&(i.text=o.text),o.functionCall&&(i.functionCall=o.functionCall),Object.keys(i).length===0&&(i.text=""),t.candidates[s].content.parts.push(i)}}return t}async function Ay(n,e,t,r){let a=await xo(e,va.STREAM_GENERATE_CONTENT,n,!0,JSON.stringify(t),r);return JA(a)}async function Oy(n,e,t,r){let s=await(await xo(e,va.GENERATE_CONTENT,n,!1,JSON.stringify(t),r)).json();return{response:bh(s)}}function kl(n){let e=[];if(typeof n=="string")e=[{text:n}];else for(let t of n)typeof t=="string"?e.push({text:t}):e.push(t);return QA(e)}function QA(n){let e={role:"user",parts:[]},t={role:"function",parts:[]},r=!1,a=!1;for(let s of n)"functionResponse"in s?(t.parts.push(s),a=!0):(e.parts.push(s),r=!0);if(r&&a)throw new Ge("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!a)throw new Ge("No content is provided for sending chat message.");return r?e:t}function ph(n){return n.contents?n:{contents:[kl(n)]}}function eO(n){return typeof n=="string"||Array.isArray(n)?{content:kl(n)}:n}var wy=["text","inlineData","functionCall","functionResponse"],tO={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall"],system:["text"]},vy={user:["model"],function:["model"],model:["user","function"],system:[]};function rO(n){let e;for(let t of n){let{role:r,parts:a}=t;if(!e&&r!=="user")throw new Ge(`First content should be with role 'user', got ${r}`);if(!cy.includes(r))throw new Ge(`Each item should include role field. Got ${r} but valid roles are: ${JSON.stringify(cy)}`);if(!Array.isArray(a))throw new Ge("Content should have 'parts' property with an array of Parts");if(a.length===0)throw new Ge("Each Content should have at least one part");let s={text:0,inlineData:0,functionCall:0,functionResponse:0};for(let o of a)for(let u of wy)u in o&&(s[u]+=1);let i=tO[r];for(let o of wy)if(!i.includes(o)&&s[o]>0)throw new Ge(`Content with role '${r}' can't contain '${o}' part`);if(e&&!vy[r].includes(e.role))throw new Ge(`Content with role '${r}' can't follow '${e.role}'. Valid previous roles: ${JSON.stringify(vy)}`);e=t}}var xy="SILENT_ERROR",mh=class{constructor(e,t,r,a){this.model=t,this.params=r,this.requestOptions=a,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,r?.history&&(rO(r.history),this._history=r.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,r,a,s,i;await this._sendPromise;let o=kl(e),u={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(s=this.params)===null||s===void 0?void 0:s.toolConfig,systemInstruction:(i=this.params)===null||i===void 0?void 0:i.systemInstruction,contents:[...this._history,o]},l;return this._sendPromise=this._sendPromise.then(()=>Oy(this._apiKey,this.model,u,this.requestOptions)).then(c=>{var f;if(c.response.candidates&&c.response.candidates.length>0){this._history.push(o);let d=Object.assign({parts:[],role:"model"},(f=c.response.candidates)===null||f===void 0?void 0:f[0].content);this._history.push(d)}else{let d=hn(c.response);d&&console.warn(`sendMessage() was unsuccessful. ${d}. Inspect response object for details.`)}l=c}),await this._sendPromise,l}async sendMessageStream(e){var t,r,a,s,i;await this._sendPromise;let o=kl(e),u={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(s=this.params)===null||s===void 0?void 0:s.toolConfig,systemInstruction:(i=this.params)===null||i===void 0?void 0:i.systemInstruction,contents:[...this._history,o]},l=Ay(this._apiKey,this.model,u,this.requestOptions);return this._sendPromise=this._sendPromise.then(()=>l).catch(c=>{throw new Error(xy)}).then(c=>c.response).then(c=>{if(c.candidates&&c.candidates.length>0){this._history.push(o);let f=Object.assign({},c.candidates[0].content);f.role||(f.role="model"),this._history.push(f)}else{let f=hn(c);f&&console.warn(`sendMessageStream() was unsuccessful. ${f}. Inspect response object for details.`)}}).catch(c=>{c.message!==xy&&console.error(c)}),l}};async function nO(n,e,t,r){return(await xo(e,va.COUNT_TOKENS,n,!1,JSON.stringify(Object.assign(Object.assign({},t),{model:e})),r)).json()}async function aO(n,e,t,r){return(await xo(e,va.EMBED_CONTENT,n,!1,JSON.stringify(t),r)).json()}async function sO(n,e,t,r){let a=t.requests.map(i=>Object.assign(Object.assign({},i),{model:e}));return(await xo(e,va.BATCH_EMBED_CONTENTS,n,!1,JSON.stringify({requests:a}),r)).json()}var gh=class{constructor(e,t,r){this.apiKey=e,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=t.systemInstruction,this.requestOptions=r||{}}async generateContent(e){let t=ph(e);return Oy(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}async generateContentStream(e){let t=ph(e);return Ay(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}startChat(e){return new mh(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},e),this.requestOptions)}async countTokens(e){let t=ph(e);return nO(this.apiKey,this.model,t,this.requestOptions)}async embedContent(e){let t=eO(e);return aO(this.apiKey,this.model,t,this.requestOptions)}async batchEmbedContents(e){return sO(this.apiKey,this.model,e,this.requestOptions)}};var vo=class{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new Ge("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new gh(this.apiKey,e,t)}};Os();ht();function Ey(n){let e={...n};if(Object.hasOwn(e,"additionalProperties")&&delete e.additionalProperties,e.properties){let t=Object.keys(e.properties);Iy(e.properties,t,0)}return e}function Iy(n,e,t){if(t>=e.length||!n)return;let r=e[t];n[r]=Ey(n[r]),Iy(n,e,t+1)}function Rl(n){let e=Ey(Q(n)),{$schema:t,...r}=e;return r}ht();Et();function iO(n){return{name:n.name,description:n.description,parameters:Q(n.schema)}}function Ty(n){return yh(n)||oO(n)?{type:"function",function:iO(n)}:n}function yh(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function oO(n){return n!==void 0&&q.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}function uO(n){let e=n._getType();return et.isInstance(n)?n.role:n.name??e}function lO(n){switch(n){case"ai":case"model":return"model";case"system":case"human":return"user";default:throw new Error(`Unknown / unsupported author: ${n}`)}}function cO(n){if("mimeType"in n&&"data"in n)return{inlineData:{mimeType:n.mimeType,data:n.data}};throw new Error("Invalid media content")}function dO(n,e){return typeof n=="string"?[{text:n}]:n.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){if(!e)throw new Error("This model does not support images");let r;if(typeof t.image_url=="string")r=t.image_url;else if(typeof t.image_url=="object"&&"url"in t.image_url)r=t.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");let[a,s]=r.split(",");if(!a.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");let[i,o]=a.replace(/^data:/,"").split(";");if(o!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:s,mimeType:i}}}else if(t.type==="media")return cO(t);throw new Error(`Unknown content type ${t.type}`)})}function _h(n,e){return n.reduce((t,r,a)=>{if(!Qe(r))throw new Error("Unsupported message input");let s=uO(r);if(s==="system"&&a!==0)throw new Error("System message should be the first one");let i=lO(s),o=t.content[t.content.length];if(!t.mergeWithPreviousContent&&o&&o.role===i)throw new Error("Google Generative AI requires alternate messages between authors");let u=dO(r.content,e);if(t.mergeWithPreviousContent){let c=t.content[t.content.length-1];if(!c)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return c.parts.push(...u),{mergeWithPreviousContent:!1,content:t.content}}let l={role:i,parts:u};return{mergeWithPreviousContent:s==="system",content:[...t.content,l]}},{content:[],mergeWithPreviousContent:!1}).content}function Py(n){if(!n.candidates||n.candidates.length===0||!n.candidates[0])return{generations:[],llmOutput:{filters:n.promptFeedback}};let e=n.functionCalls(),[t]=n.candidates,{content:r,...a}=t,s=r?.parts[0]?.text??"";return{generations:[{text:s,message:new le({content:s,tool_calls:e,additional_kwargs:{...a}}),generationInfo:a}]}}function Sy(n){if(!n.candidates||n.candidates.length===0)return null;let[e]=n.candidates,{content:t,...r}=e,a=t?.parts[0]?.text??"";return new ze({text:a,message:new fe({content:a,name:t?t.role:void 0,additional_kwargs:{}}),generationInfo:r})}function wh(n){return n.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?n:[{functionDeclarations:n.map(e=>{if(yh(e)){let t=Rl(e.schema);return{name:e.name,description:e.description,parameters:t}}return e})}]}var Ao=class extends dn{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new dr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let t=e.flatMap(s=>{let{message:i}=s;return!("tool_calls"in i)||!Array.isArray(i.tool_calls)?[]:i.tool_calls});if(t[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");let[r]=t;return await this._validateResult(r.args)}};var Nl=class extends ya{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=e?.model?.replace(/^models\//,"")??e?.modelName?.replace(/^models\//,"")??this.model,this.model=this.modelName,this.maxOutputTokens=e?.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e?.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=e?.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e?.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e?.stopSequences??this.stopSequences,this.apiKey=e?.apiKey??Te("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e?.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(r=>r.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=e?.streaming??this.streaming,this.client=new vo(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK}},{apiVersion:e?.apiVersion,baseUrl:e?.baseUrl})}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){return this.bind({tools:wh(e),...t})}invocationParams(e){let t=e?.tools;return Array.isArray(t)&&!t.some(r=>!("lc_namespace"in r))?{tools:wh(e?.tools)}:{tools:e?.tools}}async _generate(e,t,r){let a=_h(e,this._isMultimodalModel),s=this.invocationParams(t);if(this.streaming){let u={},l=this._streamResponseChunks(e,t,r),c={};for await(let d of l){let h=d.generationInfo?.completion??0;c[h]===void 0?c[h]=d:c[h]=c[h].concat(d)}return{generations:Object.entries(c).sort(([d],[h])=>parseInt(d,10)-parseInt(h,10)).map(([d,h])=>h),llmOutput:{estimatedTokenUsage:u}}}let i=await this.caller.callWithOptions({signal:t?.signal},async()=>{let u;try{u=await this.client.generateContent({...s,contents:a})}catch(l){throw l.message?.includes("400 Bad Request")&&(l.status=400),l}return u}),o=Py(i.response);return await r?.handleLLMNewToken(o.generations[0].text??""),o}async*_streamResponseChunks(e,t,r){let a=_h(e,this._isMultimodalModel),s=this.invocationParams(t),i=await this.caller.callWithOptions({signal:t?.signal},async()=>{let{stream:o}=await this.client.generateContentStream({...s,contents:a});return o});for await(let o of i){let u=Sy(o);u&&(yield u,await r?.handleLLMNewToken(u.text??""))}}withStructuredOutput(e,t){let r=e,a=t?.name,s=t?.method,i=t?.includeRaw;if(s==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "functionCalling" as a method.');let o=a??"extract",u,l;if(ba(r)){let p=Rl(r);l=[{functionDeclarations:[{name:o,description:p.description??"A function available to call.",parameters:p}]}],u=new Ao({returnSingle:!0,keyName:o,zodSchema:r})}else{let p;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(p=r,o=r.name):p={name:o,description:r.description??"",parameters:r},l=[{functionDeclarations:[p]}],u=new Ao({returnSingle:!0,keyName:o})}let c=this.bind({tools:l});if(!i)return c.pipe(u).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});let f=nt.assign({parsed:(p,g)=>u.invoke(p.raw,g)}),d=nt.assign({parsed:()=>null}),h=f.withFallbacks({fallbacks:[d]});return Ht.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}};Qi();ht();var xa="0.3.3";var Cy=!1,Aa,vh,fO,hO,pO,xh,mO,jl,Ah,Oh,Eh,Ml,Ih;function ky(n,e={auto:!1}){if(Cy)throw new Error(`you must \`import 'groq-sdk/shims/${n.kind}'\` before importing anything else from groq-sdk`);if(Aa)throw new Error(`can't \`import 'groq-sdk/shims/${n.kind}'\` after \`import 'groq-sdk/shims/${Aa}'\``);Cy=e.auto,Aa=n.kind,vh=n.fetch,fO=n.Request,hO=n.Response,pO=n.Headers,xh=n.FormData,mO=n.Blob,jl=n.File,Ah=n.ReadableStream,Oh=n.getMultipartRequestOptions,Eh=n.getDefaultAgent,Ml=n.fileFromPath,Ih=n.isFsReadStream}var $l=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Ry({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n",t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new $l(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:i=>!1}}Aa||ky(Ry(),{auto:!0});var Th={};ds(Th,{APIConnectionError:()=>Fr,APIConnectionTimeoutError:()=>Oa,APIError:()=>me,APIUserAbortError:()=>pn,AuthenticationError:()=>qs,BadRequestError:()=>Hs,ConflictError:()=>Ks,GroqError:()=>Oe,InternalServerError:()=>Zs,NotFoundError:()=>Gs,PermissionDeniedError:()=>Vs,RateLimitError:()=>Ws,UnprocessableEntityError:()=>Js});var Oe=class extends Error{},me=class n extends Oe{constructor(e,t,r,a){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.error=t}static makeMessage(e,t,r){let a=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e)return new Fr({cause:Ll(t)});let s=t;return e===400?new Hs(e,s,r,a):e===401?new qs(e,s,r,a):e===403?new Vs(e,s,r,a):e===404?new Gs(e,s,r,a):e===409?new Ks(e,s,r,a):e===422?new Js(e,s,r,a):e===429?new Ws(e,s,r,a):e>=500?new Zs(e,s,r,a):new n(e,s,r,a)}},pn=class extends me{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},Fr=class extends me{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},Oa=class extends Fr{constructor({message:e}={}){super({message:e??"Request timed out."})}},Hs=class extends me{constructor(){super(...arguments),this.status=400}},qs=class extends me{constructor(){super(...arguments),this.status=401}},Vs=class extends me{constructor(){super(...arguments),this.status=403}},Gs=class extends me{constructor(){super(...arguments),this.status=404}},Ks=class extends me{constructor(){super(...arguments),this.status=409}},Js=class extends me{constructor(){super(...arguments),this.status=422}},Ws=class extends me{constructor(){super(...arguments),this.status=429}},Zs=class extends me{};var Dl=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1,a=new Ph;async function*s(){if(!e.body)throw t.abort(),new Oe("Attempted to iterate over a response with no body");let o=new Ys,u=Ny(e.body);for await(let l of u)for(let c of o.decode(l)){let f=a.decode(c);f&&(yield f)}for(let l of o.flush()){let c=a.decode(l);c&&(yield c)}}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(let u of s())if(!o){if(u.data.startsWith("[DONE]")){o=!0;continue}if(u.event===null){let l;try{l=JSON.parse(u.data)}catch(c){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),c}if(l&&l.error)throw new me(void 0,l.error,void 0,void 0);yield l}}o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||t.abort()}}return new n(i,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let i=new Ys,o=Ny(e);for await(let u of o)for(let l of i.decode(u))yield l;for(let u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){let i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new n(()=>a(e),this.controller),new n(()=>a(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new Ah({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await t.next();if(i)return a.close();let o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){await t.return?.()}})}},Ph=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=bO(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}},Ys=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),a=t.split(n.NEWLINE_REGEXP);return a.length===1&&!r?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),r||(this.buffer=[a.pop()||""]),a)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Oe(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Oe(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Oe("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};Ys.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]);Ys.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function bO(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function Ny(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var jy=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",yO=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&My(n),My=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",_O=n=>yO(n)||jy(n)||Ih(n);async function kh(n,e,t={}){if(n=await n,jy(n)){let a=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new jl([a],e,t)}let r=await wO(n);if(e||(e=xO(n)??"unknown_file"),!t.type){let a=r[0]?.type;typeof a=="string"&&(t={...t,type:a})}return new jl(r,e,t)}async function wO(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(My(n))e.push(await n.arrayBuffer());else if(AO(n))for await(let t of n)e.push(t);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${n?.constructor?.name}; props: ${vO(n)}`);return e}function vO(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function xO(n){return Sh(n.name)||Sh(n.filename)||Sh(n.path)?.split(/[\\/]/).pop()}var Sh=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},AO=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Rh=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var Oo=async n=>{let e=await $y(n.body);return Oh(e,n)},$y=async n=>{let e=new xh;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Ch(e,t,r))),e};var Ch=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(_O(t)){let r=await kh(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Ch(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>Ch(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var EO=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},IO=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Fl;async function zy(n){let{response:e}=n;if(n.options.stream)return Xs("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Dl.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let s=await e.json();return Xs("response",e.status,e.url,e.headers,s),s}let a=await e.text();return Xs("response",e.status,e.url,e.headers,a),a}var Ul=class n extends Promise{constructor(e,t=zy){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Bl=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e4,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Nh("maxRetries",t),this.timeout=Nh("timeout",r),this.httpAgent=a,this.fetch=s??vh}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...CO(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${LO()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(a=>({method:e,path:t,...a})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){let{method:t,path:r,query:a,headers:s={}}=e,i=Rh(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),u=this.buildURL(r,a);"timeout"in e&&Nh("timeout",e.timeout);let l=e.timeout??this.timeout,c=e.httpAgent??this.httpAgent??Eh(u),f=l+1e3;typeof c?.options?.timeout=="number"&&f>(c.options.timeout??0)&&(c.options.timeout=f),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let d=this.buildHeaders({options:e,headers:s,contentLength:o});return{req:{method:t,...i&&{body:i},headers:d,...c&&{agent:c},signal:e.signal??null},url:u,timeout:l}}buildHeaders({options:e,headers:t,contentLength:r}){let a={};r&&(a["content-length"]=r);let s=this.defaultHeaders(e);return By(a,s),By(a,t),Rh(e.body)&&Aa!=="node"&&delete a["content-type"],this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return me.generate(e,t,r,a)}request(e,t=null){return new Ul(this.makeRequest(e,t))}async makeRequest(e,t){let r=await e;t==null&&(t=r.maxRetries??this.maxRetries),await this.prepareOptions(r);let{req:a,url:s,timeout:i}=this.buildRequest(r);if(await this.prepareRequest(a,{url:s,options:r}),Xs("request",s,r,a.headers),r.signal?.aborted)throw new pn;let o=new AbortController,u=await this.fetchWithTimeout(s,a,i,o).catch(Ll);if(u instanceof Error){if(r.signal?.aborted)throw new pn;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new Oa:new Fr({cause:u})}let l=TO(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){let g=`retrying, ${t} attempts remaining`;return Xs(`response (error; ${g})`,u.status,s,l),this.retryRequest(r,t,l)}let c=await u.text().catch(g=>Ll(g).message),f=kO(c),d=f?void 0:c;throw Xs(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,s,l,d),this.makeStatusError(u.status,f,d,l)}return{response:u,options:r,controller:o}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new jh(this,r,e)}buildURL(e,t){let r=NO(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return MO(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new Oe(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:a.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a,s=r?.["retry-after-ms"];if(s){let o=parseFloat(s);Number.isNaN(o)||(a=o)}let i=r?.["retry-after"];if(i&&!a){let o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){let o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await jO(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${xa}`}},Ly=class{constructor(e,t,r,a){Fl.set(this,void 0),EO(this,Fl,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new Oe("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await IO(this,Fl,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Fl=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},jh=class extends Ul{constructor(e,t,r){super(t,async a=>new r(e,a.response,await zy(a),a.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},TO=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}});var PO=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xa,"X-Stainless-OS":Fy(Deno.build.os),"X-Stainless-Arch":Dy(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xa,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xa,"X-Stainless-OS":Fy(process.platform),"X-Stainless-Arch":Dy(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=SO();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xa,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xa,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function SO(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}var Dy=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Fy=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Uy,CO=()=>Uy??(Uy=PO()),kO=n=>{try{return JSON.parse(n)}catch{return}},RO=new RegExp("^(?:[a-z]+:)?//","i"),NO=n=>RO.test(n),jO=n=>new Promise(e=>setTimeout(e,n)),Nh=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Oe(`${n} must be an integer`);if(e<0)throw new Oe(`${n} must be a positive integer`);return e},Ll=n=>n instanceof Error?n:new Error(n);var Mh=n=>{if(typeof process<"u")return process.env?.[n]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(n)?.trim()};function MO(n){if(!n)return!0;for(let e in n)return!1;return!0}function $O(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function By(n,e){for(let t in e){if(!$O(e,t))continue;let r=t.toLowerCase();if(!r)continue;let a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function Xs(n,...e){typeof process<"u"&&process.env.DEBUG==="true"&&console.log(`Groq:DEBUG:${n}`,...e)}var LO=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Hy=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";var st=class{constructor(e){this._client=e}};var Ea=class extends st{create(e,t){return this._client.post("/openai/v1/chat/completions",{body:e,...t,stream:e.stream??!1})}};Ea||(Ea={});var mn=class extends st{constructor(){super(...arguments),this.completions=new Ea(this._client)}};(function(n){n.Completions=Ea})(mn||(mn={}));var gn=class extends st{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}};gn||(gn={});var Ia=class extends st{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",Oo({body:e,...t}))}};Ia||(Ia={});var Ta=class extends st{create(e,t){return this._client.post("/openai/v1/audio/translations",Oo({body:e,...t}))}};Ta||(Ta={});var bn=class extends st{constructor(){super(...arguments),this.transcriptions=new Ia(this._client),this.translations=new Ta(this._client)}};(function(n){n.Transcriptions=Ia,n.Translations=Ta})(bn||(bn={}));var qy,ce=class extends Bl{constructor({baseURL:e=Mh("GROQ_BASE_URL"),apiKey:t=Mh("GROQ_API_KEY"),...r}={}){if(t===void 0)throw new Oe("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");let a={apiKey:t,...r,baseURL:e||"https://api.groq.com"};if(!a.dangerouslyAllowBrowser&&Hy())throw new Oe("This is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew Groq({ dangerouslyAllowBrowser: true })");super({baseURL:a.baseURL,timeout:a.timeout??6e4,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.chat=new mn(this),this.audio=new bn(this),this.models=new gn(this),this._options=a,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};qy=ce;ce.Groq=qy;ce.GroqError=Oe;ce.APIError=me;ce.APIConnectionError=Fr;ce.APIConnectionTimeoutError=Oa;ce.APIUserAbortError=pn;ce.NotFoundError=Gs;ce.ConflictError=Ks;ce.RateLimitError=Ws;ce.BadRequestError=Hs;ce.AuthenticationError=qs;ce.InternalServerError=Zs;ce.PermissionDeniedError=Vs;ce.UnprocessableEntityError=Js;var{GroqError:jL,APIError:ML,APIConnectionError:$L,APIConnectionTimeoutError:LL,APIUserAbortError:DL,NotFoundError:FL,ConflictError:UL,RateLimitError:BL,BadRequestError:zL,AuthenticationError:HL,InternalServerError:qL,PermissionDeniedError:VL,UnprocessableEntityError:GL}=Th;(function(n){n.toFile=kh,n.fileFromPath=Ml,n.Chat=mn,n.Audio=bn,n.Models=gn})(ce||(ce={}));var Vy=ce;function Lh(n,e){if(n.function===void 0)return;let t;if(e?.partial)try{t=ws(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(a){throw new dr([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join(`
`))}let r={name:n.function.name,args:t,type:"tool_call"};return e?.returnId&&(r.id=n.id),r}function Gy(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function Ky(n,e){return{name:n.function?.name,args:n.function?.arguments,id:n.id,error:e,type:"invalid_tool_call"}}var $h=class extends dn{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){let t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);let r=JSON.parse(JSON.stringify(t)),a=[];for(let s of r){let i=Lh(s,{partial:!0});if(i!==void 0){let o={type:i.name,args:i.args,id:i.id};Object.defineProperty(o,"name",{get(){return this.type}}),Object.defineProperty(o,"arguments",{get(){return this.args}}),a.push(o)}}return a}},Eo=class extends dn{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new $h(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new dr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let r=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName),a=r;return this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))}};function HO(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}}function Jy(n){return n.map(e=>{if(typeof e.content!="string")throw new Error("Non string message content not supported");let t={role:HO(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id};return xg(e)&&e.tool_calls?.length?t.tool_calls=e.tool_calls.map(Gy):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function qO(n){let e=n.tool_calls;switch(n.role){case"assistant":{let t=[],r=[];for(let a of e??[])try{t.push(Lh(a,{returnId:!0}))}catch(s){r.push(Ky(a,s.message))}return new le({content:n.content||"",additional_kwargs:{tool_calls:e},tool_calls:t,invalid_tool_calls:r})}default:return new et(n.content||"",n.role??"unknown")}}function VO(n){let{role:e}=n,t=n.content??"",r;return n.function_call?r={function_call:n.function_call}:n.tool_calls?r={tool_calls:n.tool_calls}:r={},e==="user"?new ia({content:t}):e==="assistant"?new fe({content:t,additional_kwargs:r}):e==="system"?new ua({content:t}):new sa({content:t,role:e})}var zl=class extends ya{static lc_name(){return"ChatGroq"}_llmType(){return"groq"}get lc_secrets(){return{apiKey:"GROQ_API_KEY"}}constructor(e){super(e??{}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"mixtral-8x7b-32768"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"mixtral-8x7b-32768"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0});let t=e?.apiKey||Te("GROQ_API_KEY");if(!t)throw new Error('Groq API key not found. Please set the GROQ_API_KEY environment variable or provide the key into "apiKey"');this.client=new Vy({apiKey:t,dangerouslyAllowBrowser:!0}),this.temperature=e?.temperature??this.temperature,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.streaming=e?.streaming??this.streaming,this.stop=e?.stopSequences??(typeof e?.stop=="string"?[e.stop]:e?.stop)??[],this.stopSequences=this.stop,this.maxTokens=e?.maxTokens}async completionWithRetry(e,t){return this.caller.call(async()=>this.client.chat.completions.create(e,t))}invocationParams(e){let t=super.invocationParams(e);return e.tool_choice!==void 0&&(t.tool_choice=e.tool_choice),e.tools!==void 0&&(t.tools=e.tools),e.response_format!==void 0&&(t.response_format=e.response_format),{...t,stop:e.stop??this.stopSequences,model:this.model,temperature:this.temperature,max_tokens:this.maxTokens}}bindTools(e,t){return this.bind({tools:e.map(Ty),...t})}async*_streamResponseChunks(e,t,r){let a=this.invocationParams(t),s=Jy(e);if(t.tools!==void 0&&t.tools.length>0){let o=(await this._generateNonStreaming(e,t,r)).generations[0].message;if(o===void 0||typeof o.content!="string")throw new Error("Could not parse Groq output.");let u=o.tool_calls?.map((l,c)=>({name:l.name,args:JSON.stringify(l.args),id:l.id,index:c}));yield new ze({message:new fe({content:o.content,additional_kwargs:o.additional_kwargs,tool_call_chunks:u}),text:o.content})}else{let i=await this.completionWithRetry({...a,messages:s,stream:!0},{signal:t?.signal,headers:t?.headers});for await(let o of i){let u=o?.choices[0];if(!u)continue;let l=new ze({message:VO(u.delta??{}),text:u.delta.content??"",generationInfo:{finishReason:u.finish_reason}});yield l,r?.handleLLMNewToken(l.text??"")}if(t.signal?.aborted)throw new Error("AbortError")}}async _generate(e,t,r){if(this.streaming){let a={},s=this._streamResponseChunks(e,t,r),i={};for await(let u of s){let l=u.generationInfo?.completion??0;i[l]===void 0?i[l]=u:i[l]=i[l].concat(u)}return{generations:Object.entries(i).sort(([u],[l])=>parseInt(u,10)-parseInt(l,10)).map(([u,l])=>l),llmOutput:{estimatedTokenUsage:a}}}else return this._generateNonStreaming(e,t,r)}async _generateNonStreaming(e,t,r){let a={},s=this.invocationParams(t),i=Jy(e),o=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,headers:t?.headers});if("usage"in o&&o.usage){let{completion_tokens:l,prompt_tokens:c,total_tokens:f}=o.usage;l&&(a.completionTokens=(a.completionTokens??0)+l),c&&(a.promptTokens=(a.promptTokens??0)+c),f&&(a.totalTokens=(a.totalTokens??0)+f)}let u=[];if("choices"in o&&o.choices)for(let l of o.choices){let f={text:l.message?.content??"",message:qO(l.message??{role:"assistant"})};f.generationInfo={...l.finish_reason?{finish_reason:l.finish_reason}:{},...l.logprobs?{logprobs:l.logprobs}:{}},u.push(f)}return{generations:u,llmOutput:{tokenUsage:a}}}withStructuredOutput(e,t){let r=e,a=t?.name,s=t?.method,i=t?.includeRaw,o=a??"extract",u,l;if(s==="jsonMode")l=this.bind({response_format:{type:"json_object"}}),ba(r)?u=Al.fromZodSchema(r):u=new Ol;else if(ba(r)){let h=Q(r);l=this.bind({tools:[{type:"function",function:{name:o,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:o}}}),u=new Eo({returnSingle:!0,keyName:o,zodSchema:r})}else{let h;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(h=r,o=r.name):(o=r.title??o,h={name:o,description:r.description??"",parameters:r}),l=this.bind({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:o}}}),u=new Eo({returnSingle:!0,keyName:o})}if(!i)return l.pipe(u).withConfig({runName:"ChatGroqStructuredOutput"});let c=nt.assign({parsed:(h,p)=>u.invoke(h.raw,p)}),f=nt.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[f]});return Ht.from([{raw:l},d]).withConfig({runName:"ChatGroqStructuredOutput"})}};var Yh={};ds(Yh,{APIConnectionError:()=>Br,APIConnectionTimeoutError:()=>zr,APIError:()=>de,APIUserAbortError:()=>ne,AuthenticationError:()=>ni,BadRequestError:()=>ri,ConflictError:()=>ii,InternalServerError:()=>li,NotFoundError:()=>si,OpenAIError:()=>R,PermissionDeniedError:()=>ai,RateLimitError:()=>ui,UnprocessableEntityError:()=>oi});var Pa="4.52.7";var Wy=!1,Sa,Dh,GO,KO,JO,Fh,WO,Hl,Uh,Bh,zh,ql,Hh;function Zy(n,e={auto:!1}){if(Wy)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(Sa)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${Sa}'\``);Wy=e.auto,Sa=n.kind,Dh=n.fetch,GO=n.Request,KO=n.Response,JO=n.Headers,Fh=n.FormData,WO=n.Blob,Hl=n.File,Uh=n.ReadableStream,Bh=n.getMultipartRequestOptions,zh=n.getDefaultAgent,ql=n.fileFromPath,Hh=n.isFsReadStream}var Vl=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Yy({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new Vl(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}Sa||Zy(Yy(),{auto:!0});var fr=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let i of YO(e,t))if(!s){if(i.data.startsWith("[DONE]")){s=!0;continue}if(i.event===null){let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(o&&o.error)throw new de(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(i.event=="error")throw new de(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new n(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let i=new Qs,o=Xy(e);for await(let u of o)for(let l of i.decode(u))yield l;for(let u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){let i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new n(()=>a(e),this.controller),new n(()=>a(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new Uh({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await t.next();if(i)return a.close();let o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){await t.return?.()}})}};async function*YO(n,e){if(!n.body)throw e.abort(),new R("Attempted to iterate over a response with no body");let t=new qh,r=new Qs,a=Xy(n.body);for await(let s of XO(a))for(let i of r.decode(s)){let o=t.decode(i);o&&(yield o)}for(let s of r.flush()){let i=t.decode(s);i&&(yield i)}}async function*XO(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=QO(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}function QO(n){for(let r=0;r<n.length-2;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}var qh=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=eE(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}},Qs=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),a=t.split(n.NEWLINE_REGEXP);return r&&a.pop(),a.length===1&&!r?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),r||(this.buffer=[a.pop()||""]),a)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new R(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new R(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new R("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};Qs.NEWLINE_CHARS=new Set([`
`,"\r"]);Qs.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function eE(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function Xy(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var Qy=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",e_=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Gl(n),Gl=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",tE=n=>e_(n)||Qy(n)||Hh(n);async function Kh(n,e,t){if(n=await n,t??(t=e_(n)?{lastModified:n.lastModified,type:n.type}:{}),Qy(n)){let a=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new Hl([a],e,t)}let r=await rE(n);if(e||(e=aE(n)??"unknown_file"),!t.type){let a=r[0]?.type;typeof a=="string"&&(t={...t,type:a})}return new Hl(r,e,t)}async function rE(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Gl(n))e.push(await n.arrayBuffer());else if(sE(n))for await(let t of n)e.push(t);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${n?.constructor?.name}; props: ${nE(n)}`);return e}function nE(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function aE(n){return Vh(n.name)||Vh(n.filename)||Vh(n.path)?.split(/[\\/]/).pop()}var Vh=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},sE=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Jh=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var hr=async n=>{let e=await t_(n.body);return Bh(e,n)},t_=async n=>{let e=new Fh;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Gh(e,t,r))),e};var Gh=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(tE(t)){let r=await Kh(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Gh(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>Gh(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var oE=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},uE=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Kl;async function i_(n){let{response:e}=n;if(n.options.stream)return ei("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):fr.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let s=await e.json();return ei("response",e.status,e.url,e.headers,s),s}let a=await e.text();return ei("response",e.status,e.url,e.headers,a),a}var Jl=class n extends Promise{constructor(e,t=i_){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Wl=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Wh("maxRetries",t),this.timeout=Wh("timeout",r),this.httpAgent=a,this.fetch=s??Dh}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...hE(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${bE()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async a=>{let s=a&&Gl(a?.body)?new DataView(await a.body.arrayBuffer()):a?.body instanceof DataView?a.body:a?.body instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a?.body)?new DataView(a.body.buffer):a?.body;return{method:e,path:t,...a,body:s}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e){let{method:t,path:r,query:a,headers:s={}}=e,i=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Jh(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),u=this.buildURL(r,a);"timeout"in e&&Wh("timeout",e.timeout);let l=e.timeout??this.timeout,c=e.httpAgent??this.httpAgent??zh(u),f=l+1e3;typeof c?.options?.timeout=="number"&&f>(c.options.timeout??0)&&(c.options.timeout=f),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let d=this.buildHeaders({options:e,headers:s,contentLength:o});return{req:{method:t,...i&&{body:i},headers:d,...c&&{agent:c},signal:e.signal??null},url:u,timeout:l}}buildHeaders({options:e,headers:t,contentLength:r}){let a={};r&&(a["content-length"]=r);let s=this.defaultHeaders(e);return s_(a,s),s_(a,t),Jh(e.body)&&Sa!=="node"&&delete a["content-type"],this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return de.generate(e,t,r,a)}request(e,t=null){return new Jl(this.makeRequest(e,t))}async makeRequest(e,t){let r=await e;t==null&&(t=r.maxRetries??this.maxRetries),await this.prepareOptions(r);let{req:a,url:s,timeout:i}=this.buildRequest(r);if(await this.prepareRequest(a,{url:s,options:r}),ei("request",s,r,a.headers),r.signal?.aborted)throw new ne;let o=new AbortController,u=await this.fetchWithTimeout(s,a,i,o).catch(Zl);if(u instanceof Error){if(r.signal?.aborted)throw new ne;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new zr:new Br({cause:u})}let l=lE(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){let g=`retrying, ${t} attempts remaining`;return ei(`response (error; ${g})`,u.status,s,l),this.retryRequest(r,t,l)}let c=await u.text().catch(g=>Zl(g).message),f=pE(c),d=f?void 0:c;throw ei(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,s,l,d),this.makeStatusError(u.status,f,d,l)}return{response:u,options:r,controller:o}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new Zh(this,r,e)}buildURL(e,t){let r=gE(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return o_(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new R(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:a.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a,s=r?.["retry-after-ms"];if(s){let o=parseFloat(s);Number.isNaN(o)||(a=o)}let i=r?.["retry-after"];if(i&&!a){let o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){let o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Ur(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Pa}`}},Io=class{constructor(e,t,r,a){Kl.set(this,void 0),oE(this,Kl,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new R("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await uE(this,Kl,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Kl=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Zh=class extends Jl{constructor(e,t,r){super(t,async a=>new r(e,a.response,await i_(a),a.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},lE=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),cE={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Z=n=>typeof n=="object"&&n!==null&&!o_(n)&&Object.keys(n).every(e=>u_(cE,e)),dE=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Pa,"X-Stainless-OS":n_(Deno.build.os),"X-Stainless-Arch":r_(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Pa,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Pa,"X-Stainless-OS":n_(process.platform),"X-Stainless-Arch":r_(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=fE();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Pa,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Pa,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function fE(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}var r_=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",n_=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),a_,hE=()=>a_??(a_=dE()),pE=n=>{try{return JSON.parse(n)}catch{return}},mE=new RegExp("^(?:[a-z]+:)?//","i"),gE=n=>mE.test(n),Ur=n=>new Promise(e=>setTimeout(e,n)),Wh=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new R(`${n} must be an integer`);if(e<0)throw new R(`${n} must be a positive integer`);return e},Zl=n=>n instanceof Error?n:new Error(n);var To=n=>{if(typeof process<"u")return process.env?.[n]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(n)?.trim()};function o_(n){if(!n)return!0;for(let e in n)return!1;return!0}function u_(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function s_(n,e){for(let t in e){if(!u_(e,t))continue;let r=t.toLowerCase();if(!r)continue;let a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function ei(n,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}var bE=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),l_=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function Yl(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var R=class extends Error{},de=class n extends R{constructor(e,t,r,a){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a?.["x-request-id"];let s=t;this.error=s,this.code=s?.code,this.param=s?.param,this.type=s?.type}static makeMessage(e,t,r){let a=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e)return new Br({cause:Zl(t)});let s=t?.error;return e===400?new ri(e,s,r,a):e===401?new ni(e,s,r,a):e===403?new ai(e,s,r,a):e===404?new si(e,s,r,a):e===409?new ii(e,s,r,a):e===422?new oi(e,s,r,a):e===429?new ui(e,s,r,a):e>=500?new li(e,s,r,a):new n(e,s,r,a)}},ne=class extends de{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},Br=class extends de{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},zr=class extends Br{constructor({message:e}={}){super({message:e??"Request timed out."})}},ri=class extends de{constructor(){super(...arguments),this.status=400}},ni=class extends de{constructor(){super(...arguments),this.status=401}},ai=class extends de{constructor(){super(...arguments),this.status=403}},si=class extends de{constructor(){super(...arguments),this.status=404}},ii=class extends de{constructor(){super(...arguments),this.status=409}},oi=class extends de{constructor(){super(...arguments),this.status=422}},ui=class extends de{constructor(){super(...arguments),this.status=429}},li=class extends de{};var yn=class extends Io{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}},ee=class extends Io{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}};var T=class{constructor(e){this._client=e}};var Ca=class extends T{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}};Ca||(Ca={});var _n=class extends T{constructor(){super(...arguments),this.completions=new Ca(this._client)}};(function(n){n.Completions=Ca})(_n||(_n={}));var ka=class extends T{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}};ka||(ka={});var Ra=class extends T{create(e,t){return this._client.post("/audio/transcriptions",hr({body:e,...t}))}};Ra||(Ra={});var Na=class extends T{create(e,t){return this._client.post("/audio/translations",hr({body:e,...t}))}};Na||(Na={});var wn=class extends T{constructor(){super(...arguments),this.transcriptions=new Ra(this._client),this.translations=new Na(this._client),this.speech=new ka(this._client)}};(function(n){n.Transcriptions=Ra,n.Translations=Na,n.Speech=ka})(wn||(wn={}));var vn=class extends T{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/batches",xn,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},xn=class extends ee{};(function(n){n.BatchesPage=xn})(vn||(vn={}));var ja=class extends T{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/assistants",Ma,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},Ma=class extends ee{};(function(n){n.AssistantsPage=Ma})(ja||(ja={}));function Xh(n){return typeof n.parse=="function"}var An=n=>n?.role==="assistant",Qh=n=>n?.role==="function",ep=n=>n?.role==="tool";var Jt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},D=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Le,Xl,Ql,Po,So,ec,Co,Hr,ko,tc,rc,ci,tp,nc,rp,np,ap,sp,f_,ip,d_=10,di=class{constructor(){Le.add(this),this.controller=new AbortController,Xl.set(this,void 0),Ql.set(this,()=>{}),Po.set(this,()=>{}),So.set(this,void 0),ec.set(this,()=>{}),Co.set(this,()=>{}),Hr.set(this,{}),this._chatCompletions=[],this.messages=[],ko.set(this,!1),tc.set(this,!1),rc.set(this,!1),ci.set(this,!1),sp.set(this,e=>{if(Jt(this,tc,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new ne),e instanceof ne)return Jt(this,rc,!0,"f"),this._emit("abort",e);if(e instanceof R)return this._emit("error",e);if(e instanceof Error){let t=new R(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new R(String(e)))}),Jt(this,Xl,new Promise((e,t)=>{Jt(this,Ql,e,"f"),Jt(this,Po,t,"f")}),"f"),Jt(this,So,new Promise((e,t)=>{Jt(this,ec,e,"f"),Jt(this,Co,t,"f")}),"f"),D(this,Xl,"f").catch(()=>{}),D(this,So,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},D(this,sp,"f"))},0)}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Qh(e)||ep(e))&&e.content)this._emit("functionCallResult",e.content);else if(An(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(An(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}_connected(){this.ended||(D(this,Ql,"f").call(this),this._emit("connect"))}get ended(){return D(this,ko,"f")}get errored(){return D(this,tc,"f")}get aborted(){return D(this,rc,"f")}abort(){this.controller.abort()}on(e,t){return(D(this,Hr,"f")[e]||(D(this,Hr,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=D(this,Hr,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(D(this,Hr,"f")[e]||(D(this,Hr,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Jt(this,ci,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){Jt(this,ci,!0,"f"),await D(this,So,"f")}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new R("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),D(this,Le,"m",tp).call(this)}async finalMessage(){return await this.done(),D(this,Le,"m",nc).call(this)}async finalFunctionCall(){return await this.done(),D(this,Le,"m",rp).call(this)}async finalFunctionCallResult(){return await this.done(),D(this,Le,"m",np).call(this)}async totalUsage(){return await this.done(),D(this,Le,"m",ap).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(D(this,ko,"f"))return;e==="end"&&(Jt(this,ko,!0,"f"),D(this,ec,"f").call(this));let r=D(this,Hr,"f")[e];if(r&&(D(this,Hr,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!D(this,ci,"f")&&!r?.length&&Promise.reject(a),D(this,Po,"f").call(this,a),D(this,Co,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!D(this,ci,"f")&&!r?.length&&Promise.reject(a),D(this,Po,"f").call(this,a),D(this,Co,"f").call(this,a),this._emit("end")}}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=D(this,Le,"m",nc).call(this);t&&this._emit("finalMessage",t);let r=D(this,Le,"m",tp).call(this);r&&this._emit("finalContent",r);let a=D(this,Le,"m",rp).call(this);a&&this._emit("finalFunctionCall",a);let s=D(this,Le,"m",np).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",D(this,Le,"m",ap).call(this))}async _createChatCompletion(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),D(this,Le,"m",f_).call(this,t);let s=await e.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(s)}async _runChatCompletion(e,t,r){for(let a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){let a="function",{function_call:s="auto",stream:i,...o}=t,u=typeof s!="string"&&s?.name,{maxChatCompletions:l=d_}=r||{},c={};for(let d of t.functions)c[d.name||d.function.name]=d;let f=t.functions.map(d=>({name:d.name||d.function.name,parameters:d.parameters,description:d.description}));for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){let p=(await this._createChatCompletion(e,{...o,function_call:s,functions:f,messages:[...this.messages]},r)).choices[0]?.message;if(!p)throw new R("missing message in ChatCompletion response");if(!p.function_call)return;let{name:g,arguments:m}=p.function_call,b=c[g];if(b){if(u&&u!==g){let O=`Invalid function_call: ${JSON.stringify(g)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,name:g,content:O});continue}}else{let O=`Invalid function_call: ${JSON.stringify(g)}. Available options are: ${f.map(B=>JSON.stringify(B.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:g,content:O});continue}let x;try{x=Xh(b)?await b.parse(m):m}catch(O){this._addMessage({role:a,name:g,content:O instanceof Error?O.message:String(O)});continue}let v=await b.function(x,this),k=D(this,Le,"m",ip).call(this,v);if(this._addMessage({role:a,name:g,content:k}),u)return}}async _runTools(e,t,r){let a="tool",{tool_choice:s="auto",stream:i,...o}=t,u=typeof s!="string"&&s?.function?.name,{maxChatCompletions:l=d_}=r||{},c={};for(let d of t.tools)d.type==="function"&&(c[d.function.name||d.function.function.name]=d.function);let f="tools"in t?t.tools.map(d=>d.type==="function"?{type:"function",function:{name:d.function.name||d.function.function.name,parameters:d.function.parameters,description:d.function.description}}:d):void 0;for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){let p=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:f,messages:[...this.messages]},r)).choices[0]?.message;if(!p)throw new R("missing message in ChatCompletion response");if(!p.tool_calls)return;for(let g of p.tool_calls){if(g.type!=="function")continue;let m=g.id,{name:b,arguments:x}=g.function,v=c[b];if(v){if(u&&u!==b){let N=`Invalid tool_call: ${JSON.stringify(b)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,tool_call_id:m,content:N});continue}}else{let N=`Invalid tool_call: ${JSON.stringify(b)}. Available options are: ${f.map(X=>JSON.stringify(X.function.name)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:m,content:N});continue}let k;try{k=Xh(v)?await v.parse(x):x}catch(N){let X=N instanceof Error?N.message:String(N);this._addMessage({role:a,tool_call_id:m,content:X});continue}let O=await v.function(k,this),B=D(this,Le,"m",ip).call(this,O);if(this._addMessage({role:a,tool_call_id:m,content:B}),u)return}}}};Xl=new WeakMap,Ql=new WeakMap,Po=new WeakMap,So=new WeakMap,ec=new WeakMap,Co=new WeakMap,Hr=new WeakMap,ko=new WeakMap,tc=new WeakMap,rc=new WeakMap,ci=new WeakMap,sp=new WeakMap,Le=new WeakSet,tp=function(){return D(this,Le,"m",nc).call(this).content??null},nc=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(An(t)){let{function_call:r,...a}=t,s={...a,content:t.content??null};return r&&(s.function_call=r),s}}throw new R("stream ended without producing a ChatCompletionMessage with role=assistant")},rp=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(An(t)&&t?.function_call)return t.function_call;if(An(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},np=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Qh(t)&&t.content!=null||ep(t)&&t.content!=null&&this.messages.some(r=>r.role==="assistant"&&r.tool_calls?.some(a=>a.type==="function"&&a.id===t.tool_call_id)))return t.content}},ap=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},f_=function(e){if(e.n!=null&&e.n>1)throw new R("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ip=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Ro=class n extends di{static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e){super._addMessage(e),An(e)&&e.content&&this._emit("content",e.content)}};var Wt=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},op=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},pr,On,up,lp,ac,h_,fi=class n extends di{constructor(){super(...arguments),pr.add(this),On.set(this,void 0)}get currentChatCompletionSnapshot(){return Wt(this,On,"f")}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let a=new n;return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),Wt(this,pr,"m",up).call(this);let s=await e.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let i of s)Wt(this,pr,"m",lp).call(this,i);if(s.controller.signal?.aborted)throw new ne;return this._addChatCompletion(Wt(this,pr,"m",ac).call(this))}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Wt(this,pr,"m",up).call(this),this._connected();let a=fr.fromReadableStream(e,this.controller),s;for await(let i of a)s&&s!==i.id&&this._addChatCompletion(Wt(this,pr,"m",ac).call(this)),Wt(this,pr,"m",lp).call(this,i),s=i.id;if(a.controller.signal?.aborted)throw new ne;return this._addChatCompletion(Wt(this,pr,"m",ac).call(this))}[(On=new WeakMap,pr=new WeakSet,up=function(){this.ended||op(this,On,void 0,"f")},lp=function(t){if(this.ended)return;let r=Wt(this,pr,"m",h_).call(this,t);this._emit("chunk",t,r);let a=t.choices[0]?.delta?.content,s=r.choices[0]?.message;a!=null&&s?.role==="assistant"&&s?.content&&this._emit("content",a,s.content)},ac=function(){if(this.ended)throw new R("stream has ended, this shouldn't happen");let t=Wt(this,On,"f");if(!t)throw new R("request ended without sending any chunks");return op(this,On,void 0,"f"),OE(t)},h_=function(t){var r,a,s;let i=Wt(this,On,"f"),{choices:o,...u}=t;i?Object.assign(i,u):i=op(this,On,{...u,choices:[]},"f");for(let{delta:l,finish_reason:c,index:f,logprobs:d=null,...h}of t.choices){let p=i.choices[f];if(p||(p=i.choices[f]={finish_reason:c,index:f,message:{},logprobs:d,...h}),d)if(!p.logprobs)p.logprobs=Object.assign({},d);else{let{content:k,...O}=d;Object.assign(p.logprobs,O),k&&((r=p.logprobs).content??(r.content=[]),p.logprobs.content.push(...k))}if(c&&(p.finish_reason=c),Object.assign(p,h),!l)continue;let{content:g,function_call:m,role:b,tool_calls:x,...v}=l;if(Object.assign(p.message,v),g&&(p.message.content=(p.message.content||"")+g),b&&(p.message.role=b),m&&(p.message.function_call?(m.name&&(p.message.function_call.name=m.name),m.arguments&&((a=p.message.function_call).arguments??(a.arguments=""),p.message.function_call.arguments+=m.arguments)):p.message.function_call=m),x){p.message.tool_calls||(p.message.tool_calls=[]);for(let{index:k,id:O,type:B,function:N,...X}of x){let ct=(s=p.message.tool_calls)[k]??(s[k]={});Object.assign(ct,X),O&&(ct.id=O),B&&(ct.type=B),N&&(ct.function??(ct.function={arguments:""})),N?.name&&(ct.function.name=N.name),N?.arguments&&(ct.function.arguments+=N.arguments)}}}return i},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new fr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function OE(n){let{id:e,choices:t,created:r,model:a,system_fingerprint:s,...i}=n;return{...i,id:e,choices:t.map(({message:o,finish_reason:u,index:l,logprobs:c,...f})=>{if(!u)throw new R(`missing finish_reason for choice ${l}`);let{content:d=null,function_call:h,tool_calls:p,...g}=o,m=o.role;if(!m)throw new R(`missing role for choice ${l}`);if(h){let{arguments:b,name:x}=h;if(b==null)throw new R(`missing function_call.arguments for choice ${l}`);if(!x)throw new R(`missing function_call.name for choice ${l}`);return{...f,message:{content:d,function_call:{arguments:b,name:x},role:m},finish_reason:u,index:l,logprobs:c}}return p?{...f,index:l,finish_reason:u,logprobs:c,message:{...g,role:m,content:d,tool_calls:p.map((b,x)=>{let{function:v,type:k,id:O,...B}=b,{arguments:N,name:X,...ct}=v||{};if(O==null)throw new R(`missing choices[${l}].tool_calls[${x}].id
${sc(n)}`);if(k==null)throw new R(`missing choices[${l}].tool_calls[${x}].type
${sc(n)}`);if(X==null)throw new R(`missing choices[${l}].tool_calls[${x}].function.name
${sc(n)}`);if(N==null)throw new R(`missing choices[${l}].tool_calls[${x}].function.arguments
${sc(n)}`);return{...B,id:O,type:k,function:{...ct,name:X,arguments:N}}})}}:{...f,message:{...g,content:d,role:m},finish_reason:u,index:l,logprobs:c}}),created:r,model:a,object:"chat.completion",...s?{system_fingerprint:s}:{}}}function sc(n){return JSON.stringify(n)}var No=class n extends fi{static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}};var jo=class extends T{runFunctions(e,t){return e.stream?No.runFunctions(this._client.chat.completions,e,t):Ro.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?No.runTools(this._client.chat.completions,e,t):Ro.runTools(this._client.chat.completions,e,t)}stream(e,t){return fi.createChatCompletion(this._client.chat.completions,e,t)}};var $a=class extends T{constructor(){super(...arguments),this.completions=new jo(this._client)}};(function(n){n.Completions=jo})($a||($a={}));var Zt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},te=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ic,oc,Mo,$o,uc,Lo,qr,Do,lc,cc,hi,cp,dc=class{constructor(){this.controller=new AbortController,ic.set(this,void 0),oc.set(this,()=>{}),Mo.set(this,()=>{}),$o.set(this,void 0),uc.set(this,()=>{}),Lo.set(this,()=>{}),qr.set(this,{}),Do.set(this,!1),lc.set(this,!1),cc.set(this,!1),hi.set(this,!1),cp.set(this,e=>{if(Zt(this,lc,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new ne),e instanceof ne)return Zt(this,cc,!0,"f"),this._emit("abort",e);if(e instanceof R)return this._emit("error",e);if(e instanceof Error){let t=new R(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new R(String(e)))}),Zt(this,ic,new Promise((e,t)=>{Zt(this,oc,e,"f"),Zt(this,Mo,t,"f")}),"f"),Zt(this,$o,new Promise((e,t)=>{Zt(this,uc,e,"f"),Zt(this,Lo,t,"f")}),"f"),te(this,ic,"f").catch(()=>{}),te(this,$o,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emit("end")},te(this,cp,"f"))},0)}_addRun(e){return e}_connected(){this.ended||(te(this,oc,"f").call(this),this._emit("connect"))}get ended(){return te(this,Do,"f")}get errored(){return te(this,lc,"f")}get aborted(){return te(this,cc,"f")}abort(){this.controller.abort()}on(e,t){return(te(this,qr,"f")[e]||(te(this,qr,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=te(this,qr,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(te(this,qr,"f")[e]||(te(this,qr,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Zt(this,hi,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){Zt(this,hi,!0,"f"),await te(this,$o,"f")}_emit(e,...t){if(te(this,Do,"f"))return;e==="end"&&(Zt(this,Do,!0,"f"),te(this,uc,"f").call(this));let r=te(this,qr,"f")[e];if(r&&(te(this,qr,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!te(this,hi,"f")&&!r?.length&&Promise.reject(a),te(this,Mo,"f").call(this,a),te(this,Lo,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!te(this,hi,"f")&&!r?.length&&Promise.reject(a),te(this,Mo,"f").call(this,a),te(this,Lo,"f").call(this,a),this._emit("end")}}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,s){return await this._createToolAssistantStream(r,e,t,a,s)}async _createThreadAssistantStream(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s=await e.createAndRun({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addRun(s)}async _createToolAssistantStream(e,t,r,a,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o=await e.submitToolOutputs(t,r,{...a,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addRun(o)}async _createAssistantStream(e,t,r,a){let s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i=await e.create(t,{...r,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addRun(i)}};ic=new WeakMap,oc=new WeakMap,Mo=new WeakMap,$o=new WeakMap,uc=new WeakMap,Lo=new WeakMap,qr=new WeakMap,Do=new WeakMap,lc=new WeakMap,cc=new WeakMap,hi=new WeakMap,cp=new WeakMap;var P=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},bt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Ce,dp,mr,fc,Yt,Da,pi,La,mc,yt,hc,pc,Bo,Fo,Uo,p_,m_,g_,b_,y_,__,w_,gr=class n extends dc{constructor(){super(...arguments),Ce.add(this),dp.set(this,[]),mr.set(this,{}),fc.set(this,{}),Yt.set(this,void 0),Da.set(this,void 0),pi.set(this,void 0),La.set(this,void 0),mc.set(this,void 0),yt.set(this,void 0),hc.set(this,void 0),pc.set(this,void 0),Bo.set(this,void 0)}[(dp=new WeakMap,mr=new WeakMap,fc=new WeakMap,Yt=new WeakMap,Da=new WeakMap,pi=new WeakMap,La=new WeakMap,mc=new WeakMap,yt=new WeakMap,hc=new WeakMap,pc=new WeakMap,Bo=new WeakMap,Ce=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let a=fr.fromReadableStream(e,this.controller);for await(let s of a)P(this,Ce,"m",Fo).call(this,s);if(a.controller.signal?.aborted)throw new ne;return this._addRun(P(this,Ce,"m",Uo).call(this))}toReadableStream(){return new fr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,s){let i=new n;return i._run(()=>i._runToolAssistantStream(e,t,r,a,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o={...a,stream:!0},u=await e.submitToolOutputs(t,r,o,{...s,signal:this.controller.signal});this._connected();for await(let l of u)P(this,Ce,"m",Fo).call(this,l);if(u.controller.signal?.aborted)throw new ne;return this._addRun(P(this,Ce,"m",Uo).call(this))}static createThreadAssistantStream(e,t,r){let a=new n;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){let s=new n;return s._run(()=>s._runAssistantStream(e,t,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return P(this,hc,"f")}currentRun(){return P(this,pc,"f")}currentMessageSnapshot(){return P(this,Yt,"f")}currentRunStepSnapshot(){return P(this,Bo,"f")}async finalRunSteps(){return await this.done(),Object.values(P(this,mr,"f"))}async finalMessages(){return await this.done(),Object.values(P(this,fc,"f"))}async finalRun(){if(await this.done(),!P(this,Da,"f"))throw Error("Final run was not received.");return P(this,Da,"f")}async _createThreadAssistantStream(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});this._connected();for await(let o of i)P(this,Ce,"m",Fo).call(this,o);if(i.controller.signal?.aborted)throw new ne;return this._addRun(P(this,Ce,"m",Uo).call(this))}async _createAssistantStream(e,t,r,a){let s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...r,stream:!0},o=await e.create(t,i,{...a,signal:this.controller.signal});this._connected();for await(let u of o)P(this,Ce,"m",Fo).call(this,u);if(o.controller.signal?.aborted)throw new ne;return this._addRun(P(this,Ce,"m",Uo).call(this))}static accumulateDelta(e,t){for(let[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let s=e[r];if(s==null){e[r]=a;continue}if(r==="index"||r==="type"){e[r]=a;continue}if(typeof s=="string"&&typeof a=="string")s+=a;else if(typeof s=="number"&&typeof a=="number")s+=a;else if(Yl(s)&&Yl(a))s=this.accumulateDelta(s,a);else if(Array.isArray(s)&&Array.isArray(a)){if(s.every(i=>typeof i=="string"||typeof i=="number")){s.push(...a);continue}}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${s}`);e[r]=s}return e}};Fo=function(e){if(!this.ended)switch(bt(this,hc,e,"f"),P(this,Ce,"m",g_).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":P(this,Ce,"m",w_).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":P(this,Ce,"m",m_).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":P(this,Ce,"m",p_).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Uo=function(){if(this.ended)throw new R("stream has ended, this shouldn't happen");if(!P(this,Da,"f"))throw Error("Final run has not been received");return P(this,Da,"f")},p_=function(e){let[t,r]=P(this,Ce,"m",y_).call(this,e,P(this,Yt,"f"));bt(this,Yt,t,"f"),P(this,fc,"f")[t.id]=t;for(let a of r){let s=t.content[a.index];s?.type=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let a of e.data.delta.content){if(a.type=="text"&&a.text){let s=a.text,i=t.content[a.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(a.index!=P(this,pi,"f")){if(P(this,La,"f"))switch(P(this,La,"f").type){case"text":this._emit("textDone",P(this,La,"f").text,P(this,Yt,"f"));break;case"image_file":this._emit("imageFileDone",P(this,La,"f").image_file,P(this,Yt,"f"));break}bt(this,pi,a.index,"f")}bt(this,La,t.content[a.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(P(this,pi,"f")!==void 0){let a=e.data.content[P(this,pi,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,P(this,Yt,"f"));break;case"text":this._emit("textDone",a.text,P(this,Yt,"f"));break}}P(this,Yt,"f")&&this._emit("messageDone",e.data),bt(this,Yt,void 0,"f")}},m_=function(e){let t=P(this,Ce,"m",b_).call(this,e);switch(bt(this,Bo,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let s of r.step_details.tool_calls)s.index==P(this,mc,"f")?this._emit("toolCallDelta",s,t.step_details.tool_calls[s.index]):(P(this,yt,"f")&&this._emit("toolCallDone",P(this,yt,"f")),bt(this,mc,s.index,"f"),bt(this,yt,t.step_details.tool_calls[s.index],"f"),P(this,yt,"f")&&this._emit("toolCallCreated",P(this,yt,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":bt(this,Bo,void 0,"f"),e.data.step_details.type=="tool_calls"&&P(this,yt,"f")&&(this._emit("toolCallDone",P(this,yt,"f")),bt(this,yt,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},g_=function(e){P(this,dp,"f").push(e),this._emit("event",e)},b_=function(e){switch(e.event){case"thread.run.step.created":return P(this,mr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=P(this,mr,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let a=gr.accumulateDelta(t,r.delta);P(this,mr,"f")[e.data.id]=a}return P(this,mr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":P(this,mr,"f")[e.data.id]=e.data;break}if(P(this,mr,"f")[e.data.id])return P(this,mr,"f")[e.data.id];throw new Error("No snapshot available")},y_=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(let s of a.delta.content)if(s.index in t.content){let i=t.content[s.index];t.content[s.index]=P(this,Ce,"m",__).call(this,s,i)}else t.content[s.index]=s,r.push(s);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},__=function(e,t){return gr.accumulateDelta(t,e)},w_=function(e){switch(bt(this,pc,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":bt(this,Da,e.data,"f"),P(this,yt,"f")&&(this._emit("toolCallDone",P(this,yt,"f")),bt(this,yt,void 0,"f"));break;case"thread.run.cancelling":break}};var Fa=class extends T{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t={},r){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Ua,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}},Ua=class extends ee{};(function(n){n.MessagesPage=Ua})(Fa||(Fa={}));var Ba=class extends T{retrieve(e,t,r,a){return this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t,r={},a){return Z(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,za,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},za=class extends ee{};(function(n){n.RunStepsPage=za})(Ba||(Ba={}));var Ha=class extends T{constructor(){super(...arguments),this.steps=new Ba(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/runs`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t={},r){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,qa,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}createAndStream(e,t,r){return gr.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...a}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await Ur(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,r){return gr.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,a){let s=await this.submitToolOutputs(e,t,r,a);return await this.poll(e,s.id,a)}submitToolOutputsStream(e,t,r,a){return gr.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}},qa=class extends ee{};(function(n){n.RunsPage=qa,n.Steps=Ba,n.RunStepsPage=za})(Ha||(Ha={}));var Va=class extends T{constructor(){super(...arguments),this.runs=new Ha(this._client),this.messages=new Fa(this._client)}create(e={},t){return Z(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return gr.createThreadAssistantStream(e,this._client.beta.threads,t)}};(function(n){n.Runs=Ha,n.RunsPage=qa,n.Messages=Fa,n.MessagesPage=Ua})(Va||(Va={}));var O_=async n=>{let e=await Promise.allSettled(n),t=e.filter(a=>a.status==="rejected");if(t.length){for(let a of t)console.error(a.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let r=[];for(let a of e)a.status==="fulfilled"&&r.push(a.value);return r};var Ga=class extends T{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},r){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Vr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let s=await this.retrieve(e,t,{...r,headers:a}).withResponse(),i=s.data;switch(i.status){case"in_progress":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let u=s.response.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await Ur(o);break;case"failed":case"completed":return i}}}async upload(e,t,r){let a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){let a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}},Vr=class extends ee{};(function(n){n.VectorStoreFilesPage=Vr})(Ga||(Ga={}));var Ka=class extends T{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r={},a){return Z(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Vr,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:a}).withResponse();switch(s.status){case"in_progress":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await Ur(o);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let s=a?.maxConcurrency??5,i=Math.min(s,t.length),o=this._client,u=t.values(),l=[...r];async function c(d){for(let h of d){let p=await o.files.create({file:h,purpose:"assistants"},a);l.push(p.id)}}let f=Array(i).fill(u).map(c);return await O_(f),await this.createAndPoll(e,{file_ids:l})}};Ka||(Ka={});var Ja=class extends T{constructor(){super(...arguments),this.files=new Ga(this._client),this.fileBatches=new Ka(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/vector_stores",Wa,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},Wa=class extends ee{};(function(n){n.VectorStoresPage=Wa,n.Files=Ga,n.VectorStoreFilesPage=Vr,n.FileBatches=Ka})(Ja||(Ja={}));var En=class extends T{constructor(){super(...arguments),this.vectorStores=new Ja(this._client),this.chat=new $a(this._client),this.assistants=new ja(this._client),this.threads=new Va(this._client)}};(function(n){n.VectorStores=Ja,n.VectorStoresPage=Wa,n.Chat=$a,n.Assistants=ja,n.AssistantsPage=Ma,n.Threads=Va})(En||(En={}));var In=class extends T{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};In||(In={});var Tn=class extends T{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};Tn||(Tn={});var Pn=class extends T{create(e,t){return this._client.post("/files",hr({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/files",Sn,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let a=new Set(["processed","error","deleted"]),s=Date.now(),i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await Ur(t),i=await this.retrieve(e),Date.now()-s>r)throw new zr({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}},Sn=class extends yn{};(function(n){n.FileObjectsPage=Sn})(Pn||(Pn={}));var Za=class extends T{list(e,t={},r){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Ya,{query:t,...r})}},Ya=class extends ee{};(function(n){n.FineTuningJobCheckpointsPage=Ya})(Za||(Za={}));var Xa=class extends T{constructor(){super(...arguments),this.checkpoints=new Za(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Qa,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return Z(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,es,{query:t,...r})}},Qa=class extends ee{},es=class extends ee{};(function(n){n.FineTuningJobsPage=Qa,n.FineTuningJobEventsPage=es,n.Checkpoints=Za,n.FineTuningJobCheckpointsPage=Ya})(Xa||(Xa={}));var Cn=class extends T{constructor(){super(...arguments),this.jobs=new Xa(this._client)}};(function(n){n.Jobs=Xa,n.FineTuningJobsPage=Qa,n.FineTuningJobEventsPage=es})(Cn||(Cn={}));var kn=class extends T{createVariation(e,t){return this._client.post("/images/variations",hr({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",hr({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};kn||(kn={});var Rn=class extends T{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Nn,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},Nn=class extends yn{};(function(n){n.ModelsPage=Nn})(Rn||(Rn={}));var jn=class extends T{create(e,t){return this._client.post("/moderations",{body:e,...t})}};jn||(jn={});var S_,Y=class extends Wl{constructor({baseURL:e=To("OPENAI_BASE_URL"),apiKey:t=To("OPENAI_API_KEY"),organization:r=To("OPENAI_ORG_ID")??null,project:a=To("OPENAI_PROJECT_ID")??null,...s}={}){if(t===void 0)throw new R("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let i={apiKey:t,organization:r,project:a,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&l_())throw new R(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new In(this),this.chat=new _n(this),this.embeddings=new Tn(this),this.files=new Pn(this),this.images=new kn(this),this.audio=new wn(this),this.moderations=new jn(this),this.models=new Rn(this),this.fineTuning=new Cn(this),this.beta=new En(this),this.batches=new vn(this),this._options=i,this.apiKey=t,this.organization=r,this.project=a}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};S_=Y;Y.OpenAI=S_;Y.OpenAIError=R;Y.APIError=de;Y.APIConnectionError=Br;Y.APIConnectionTimeoutError=zr;Y.APIUserAbortError=ne;Y.NotFoundError=si;Y.ConflictError=ii;Y.RateLimitError=ui;Y.BadRequestError=ri;Y.AuthenticationError=ni;Y.InternalServerError=li;Y.PermissionDeniedError=ai;Y.UnprocessableEntityError=oi;Y.toFile=Kh;Y.fileFromPath=ql;var{OpenAIError:BU,APIError:zU,APIConnectionError:HU,APIConnectionTimeoutError:C_,APIUserAbortError:k_,NotFoundError:qU,ConflictError:VU,RateLimitError:GU,BadRequestError:KU,AuthenticationError:JU,InternalServerError:WU,PermissionDeniedError:ZU,UnprocessableEntityError:YU}=Yh;(function(n){n.Page=yn,n.CursorPage=ee,n.Completions=In,n.Chat=_n,n.Embeddings=Tn,n.Files=Pn,n.FileObjectsPage=Sn,n.Images=kn,n.Audio=wn,n.Moderations=jn,n.Models=Rn,n.ModelsPage=Nn,n.FineTuning=Cn,n.Beta=En,n.Batches=vn,n.BatchesPage=xn})(Y||(Y={}));function fp(n,e=mi){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function mi(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}var R_=oe(qd(),1),RE=oe(Gd(),1);function N_(n,e){return e?.[n]||(0,R_.default)(n)}function j_(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function M_(n){return Array.isArray(n)?[...n]:{...n}}function NE(n,e){let t=M_(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=M_(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function hp(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var Xt=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,hp(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let l of u.reverse()){if(!(l in s)||s[l]===void 0)return;(!(l in i)||i[l]===void 0)&&(typeof s[l]=="object"&&s[l]!=null?i[l]={}:Array.isArray(s[l])&&(i[l]=[])),s=s[l],i=i[l]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:j_(Object.keys(t).length?NE(r,t):r,N_,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Pt(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?zo(n,e)??[...n,...e]:[...n,{type:"text",text:e}]}function jE(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,a+1));let s={};for(let i of Object.keys(r))s[i]=t(r[i],a+1);return s}return JSON.stringify(t(n,0),null,2)}var Ke=class extends Xt{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=jE(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};function ie(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=ie(t[r],a);else if(Array.isArray(t[r]))t[r]=zo(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function zo(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=ie(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}function $_(n,e){if(!n&&!e)throw new Error("Cannot merge two undefined objects.");if(!n||!e)return n||e;if(typeof n!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof n}
Right ${typeof e}`);if(typeof n=="string"&&typeof e=="string")return n+e;if(Array.isArray(n)&&Array.isArray(e))return zo(n,e);if(typeof n=="object"&&typeof e=="object")return ie(n,e);if(n===e)return n;throw new Error(`Can not merge objects of different types.
Left ${n}
Right ${e}`)}var it=class extends Ke{};function gi(n){return typeof n?._getType=="function"}function L_(n){return gi(n)&&typeof n.concat=="function"}var Mn=class extends Ke{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},bi=class n extends it{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new n({content:Pt(this.content,e.content),additional_kwargs:ie(this.additional_kwargs,e.additional_kwargs),response_metadata:ie(this.response_metadata,e.response_metadata),artifact:$_(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function D_(n){let e=[],t=[];for(let r of n)if(r.function){let a=r.function.name;try{let s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var br=class extends Ke{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let a=r.additional_kwargs?.tool_calls,s=r.tool_calls;a!=null&&a.length>0&&(s===void 0||s.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&s===void 0){let[i,o]=D_(a);r.tool_calls=i??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};function pp(n){return n._getType()==="ai"}var St=class n extends it{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{let r=[],a=[];for(let s of e.tool_call_chunks){let i={};try{if(i=mi(s.args??"{}")??{},typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id,type:"tool_call"})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:Pt(this.content,e.content),additional_kwargs:ie(this.additional_kwargs,e.additional_kwargs),response_metadata:ie(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let r=zo(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:r.input_tokens+a.input_tokens,output_tokens:r.output_tokens+a.output_tokens,total_tokens:r.total_tokens+a.total_tokens};t.usage_metadata=s}return new n(t)}};var $n=class n extends Ke{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},ts=class n extends it{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:Pt(this.content,e.content),additional_kwargs:ie(this.additional_kwargs,e.additional_kwargs),response_metadata:ie(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}};var rs=class n extends it{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new n({content:Pt(this.content,e.content),additional_kwargs:ie(this.additional_kwargs,e.additional_kwargs),response_metadata:ie(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};var Qt=class extends Ke{static lc_name(){return"HumanMessage"}_getType(){return"human"}},ns=class n extends it{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new n({content:Pt(this.content,e.content),additional_kwargs:ie(this.additional_kwargs,e.additional_kwargs),response_metadata:ie(this.response_metadata,e.response_metadata),id:this.id??e.id})}};var Ho=class extends Ke{static lc_name(){return"SystemMessage"}_getType(){return"system"}},as=class n extends it{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new n({content:Pt(this.content,e.content),additional_kwargs:ie(this.additional_kwargs,e.additional_kwargs),response_metadata:ie(this.response_metadata,e.response_metadata),id:this.id??e.id})}};function F_(n){let{type:e,...t}=n;if(e==="human"||e==="user")return new Qt(t);if(e==="ai"||e==="assistant")return new br(t);if(e==="system")return new Ho(t);throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function ss(n){if(typeof n=="string")return new Qt(n);if(gi(n))return n;if(Array.isArray(n)){let[e,t]=n;return F_({type:e,content:t})}else return F_(n)}function qo(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${s}: ${i}${o}`)}return r.join(`
`)}function mp(n){let e=n._getType();if(e==="human")return new ns({...n});if(e==="ai"){let t={...n};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(r=>({...r,type:"tool_call_chunk",index:void 0,args:JSON.stringify(r.args)}))}),new St({...t})}else{if(e==="system")return new as({...n});if(e==="function")return new rs({...n});if($n.isInstance(n))return new ts({...n});throw new Error("Unknown message type.")}}Pr();var Vp=oe(ca(),1);Cr();var bp=class{getStore(){}run(e,t){return t()}},gp=Symbol.for("ls:tracing_async_local_storage"),$E=new bp,yp=class{getInstance(){return globalThis[gp]??$E}initializeGlobalInstance(e){globalThis[gp]===void 0&&(globalThis[gp]=e)}},LE=new yp,U_=()=>{let n=LE.getInstance().getStore();if(n===void 0)throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join(`
`));return n};var TB=Symbol.for("langsmith:traceable:root");function gc(n){return typeof n=="function"&&"langsmith:traceable"in n}var _p={};ds(_p,{JsonPatchError:()=>ae,_areEquals:()=>Go,applyOperation:()=>os,applyPatch:()=>Ln,applyReducer:()=>BE,deepClone:()=>FE,getValueByPointer:()=>vc,validate:()=>z_,validator:()=>xc});var DE=Object.prototype.hasOwnProperty;function yc(n,e){return DE.call(n,e)}function _c(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)yc(n,t)&&e.push(t);return e}function De(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function wc(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function yr(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function Vo(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function bc(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(bc(n[t]))return!0}else if(typeof n=="object"){let t=_c(n),r=t.length;for(var e=0;e<r;e++)if(bc(n[t[e]]))return!0}}return!1}function B_(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var is=class extends Error{constructor(e,t,r,a,s){super(B_(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=B_(e,{name:t,index:r,operation:a,tree:s})}};var ae=is,FE=De,yi={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=vc(t,this.path);r&&(r=De(r));let a=os(t,{op:"remove",path:this.from}).removed;return os(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=vc(t,this.from);return os(t,{op:"add",path:this.path,value:De(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Go(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},UE={add:function(n,e,t){return wc(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:yi.move,copy:yi.copy,test:yi.test,_get:yi._get};function vc(n,e){if(e=="")return n;var t={op:"_get",path:e};return os(n,t),t.value}function os(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):xc(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=vc(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=Go(n,e.value),i.test===!1)throw new ae("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new ae("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=De(n));let o=(e.path||"").split("/"),u=n,l=1,c=o.length,f,d,h;for(typeof t=="function"?h=t:h=xc;;){if(d=o[l],d&&d.indexOf("~")!=-1&&(d=Vo(d)),a&&(d=="__proto__"||d=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(u[d]===void 0?f=o.slice(0,l).join("/"):l==c-1&&(f=e.path),f!==void 0&&h(e,0,n,f)),l++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!wc(d))throw new ae("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);wc(d)&&(d=~~d)}if(l>=c){if(t&&e.op==="add"&&d>u.length)throw new ae("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let p=UE[e.op].call(e,u,d,n);if(p.test===!1)throw new ae("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(l>=c){let p=yi[e.op].call(e,u,d,n);if(p.test===!1)throw new ae("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[d],t&&l<c&&(!u||typeof u!="object"))throw new ae("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function Ln(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new ae("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=De(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=os(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function BE(n,e,t){let r=os(n,e);if(r.test===!1)throw new ae("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function xc(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new ae("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(yi[n.op]){if(typeof n.path!="string")throw new ae("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new ae('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new ae("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new ae("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&bc(n.value))throw new ae("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new ae("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new ae("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=z_([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ae("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new ae("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function z_(n,e,t){try{if(!Array.isArray(n))throw new ae("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Ln(De(e),De(n),t||!0);else{t=t||xc;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof ae)return a;throw a}}function Go(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!Go(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!Go(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}function H_(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=_c(e),i=_c(n),o=!1,u=!1,l=i.length-1;l>=0;l--){var c=i[l],f=n[c];if(yc(e,c)&&!(e[c]===void 0&&f!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof f=="object"&&f!=null&&typeof d=="object"&&d!=null&&Array.isArray(f)===Array.isArray(d)?H_(f,d,t,r+"/"+yr(c),a):f!==d&&(o=!0,a&&t.push({op:"test",path:r+"/"+yr(c),value:De(f)}),t.push({op:"replace",path:r+"/"+yr(c),value:De(d)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+yr(c),value:De(f)}),t.push({op:"remove",path:r+"/"+yr(c)}),u=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&s.length==i.length))for(var l=0;l<s.length;l++){var c=s[l];!yc(n,c)&&e[c]!==void 0&&t.push({op:"add",path:r+"/"+yr(c),value:De(e[c])})}}}function Ac(n,e,t=!1){var r=[];return H_(n,e,r,"",t),r}var LB={..._p,JsonPatchError:is,deepClone:De,escapePathComponent:yr,unescapePathComponent:Vo};Cr();var zE=()=>typeof window<"u"&&typeof window.document<"u",HE=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",qE=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),q_=()=>typeof Deno<"u",VE=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!q_(),GE=()=>{let n;return zE()?n="browser":VE()?n="node":HE()?n="webworker":qE()?n="jsdom":q_()?n="deno":n="other",n},wp;async function V_(){return wp===void 0&&(wp={library:"langchain-js",runtime:GE()}),wp}function W(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var vp=class{},us=class n extends vp{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,hp(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:W("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Xt.prototype.toJSON.call(this)}toJSONNotImplemented(){return Xt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:K()}),Object.assign(this,e)}}return new t}};function xp(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function KE(n){return n.replace(/[-:.]/g,"")}function JE(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return KE(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}var Ct=class extends us{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){let t=JE(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await this.onRunCreate?.(r)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleChatModelStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}async handleChainStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(f),await this.onChainStart?.(f),f}async handleChainEnd(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=xp(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=xp(s.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=xp(s.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}async handleToolStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onToolStart?.(c),c}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}async handleRetrieverStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onRetrieverStart?.(c),c}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,s,i){let o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:i?.chunk}),o}};var Ap=class{getStore(){}run(e,t){return t()}},WE=new Ap,Op=class{getInstance(){return globalThis.__lc_tracing_async_local_storage??WE}initializeGlobalInstance(e){globalThis.__lc_tracing_async_local_storage===void 0&&(globalThis.__lc_tracing_async_local_storage=e)}},kt=new Op;var Fe=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function Ep(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Je(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Je(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var Gr=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise((t,r)=>{kt.getInstance().run(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(s=>t(void 0),r)})})}async next(...e){return this.firstResultUsed?kt.getInstance().run(this.config,async()=>this.generator.next(...e)):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}};async function G_(n,e,t,...r){let a=new Gr({generator:e,startSetup:t}),s=await a.setup;return{output:n(a,s,...r),setup:s}}var er=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=Ln({},t);return new Ko({ops:t,state:r[r.length-1].newDocument})}},Ko=class n extends er{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=Ln(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=Ln({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},Wo=n=>n.name==="log_stream_tracer";async function K_(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function J_(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function ZE(n){return n!==void 0&&n.message!==void 0}var Jo=class extends Ct{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Fe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new er({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new er({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await K_(e,this._schemaFormat)),await this.writer.write(new er({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await K_(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await J_(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new er({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new er({ops:[{op:"replace",path:"/final_output",value:await J_(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?ZE(r?.chunk)?i=r?.chunk:i=new St(t):i=t;let o=new er({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}};var Oc="__run",_r=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},Dn=class n extends _r{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};function Ec({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var Zo=n=>n.name==="event_stream_tracer",Ic=class extends Ct{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Fe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}let s=this.tappedPromises.get(e);if(s===void 0){let i;s=new Promise(o=>{i=o}),this.tappedPromises.set(e,s);try{let o={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...o,data:{chunk:r.value}},a),yield r.value;for await(let u of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...o,data:{chunk:u}},a),yield u}finally{i()}}else{yield r.value;for await(let i of t)yield i}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Ec(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(a.runType==="chat_model")i="on_chat_model_stream",r?.chunk===void 0?s=new St({content:t}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",r?.chunk===void 0?s=new _r({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=e.outputs?.generations,s;if(t.runType==="chat_model"){for(let i of a??[]){if(s!==void 0)break;s=i[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a?.map(i=>i.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Ec(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Ec(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Ec(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};Cr();var Ip=oe(pf(),1);function We(n,e){return`${n.open}${e}${n.close}`}function tr(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function Fn(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:ot}=Ip.default,Yo=class extends Ct{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?We(Ip.default.bold,o):o}).join(" > ");return We(ot.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.green,"[chain/start]")} [${t}] Entering Chain run with input: ${tr(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.cyan,"[chain/end]")} [${t}] [${Fn(e)}] Exiting Chain run with output: ${tr(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.red,"[chain/error]")} [${t}] [${Fn(e)}] Chain run errored with error: ${tr(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${We(ot.green,"[llm/start]")} [${t}] Entering LLM run with input: ${tr(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.cyan,"[llm/end]")} [${t}] [${Fn(e)}] Exiting LLM run with output: ${tr(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.red,"[llm/error]")} [${t}] [${Fn(e)}] LLM run errored with error: ${tr(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.cyan,"[tool/end]")} [${t}] [${Fn(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.red,"[tool/error]")} [${t}] [${Fn(e)}] Tool run errored with error: ${tr(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${tr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.cyan,"[retriever/end]")} [${t}] [${Fn(e)}] Exiting Retriever run with output: ${tr(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${We(ot.red,"[retriever/error]")} [${t}] [${Fn(e)}] Retriever run errored with error: ${tr(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${We(ot.blue,"[agent/action]")} [${r}] Agent selected action: ${tr(t.actions[t.actions.length-1],"[action]")}`)}};Is();var W_=oe(ca(),1),Tc=oe(ma(),1),YE=[400,401,403,404,405,406,407,408],XE=[409],Xo=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Tc.default?this.queue=new Tc.default.default({concurrency:this.maxConcurrency}):this.queue=new Tc.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,W_.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;let s=a?.response,i=s?.status;if(i){if(YE.includes(+i))throw a;if(XE.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Tp(n){return typeof n?._getType=="function"}function Pp(n){let e={type:n._getType(),data:{content:n.content}};return n?.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var Kr,QE=()=>typeof window<"u"&&typeof window.document<"u",eI=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",tI=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Z_=()=>typeof Deno<"u",rI=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Z_(),nI=()=>Kr||(QE()?Kr="browser":rI()?Kr="node":eI()?Kr="webworker":tI()?Kr="jsdom":Z_()?Kr="deno":Kr="other",Kr),Sp;async function kp(){if(Sp===void 0){let n=nI(),e=sI();Sp={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Pc,...e}}return Sp}function Y_(){let n=aI()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[r,a]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function aI(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function wr(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var Cp;function sI(){if(Cp!==void 0)return Cp;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=wr(t);r!==void 0&&(e[t]=r)}return Cp=e,e}Is();function G(n){if(!Wi(n))throw new Error(`Invalid UUID: ${n}`)}var X_={};function Rp(n){X_[n]||(console.warn(n),X_[n]=!0)}async function Q_(n){let e=await kp(),t=Y_();return n.map(r=>{let a=r.extra??{},s=a.metadata;return r.extra={...a,runtime:{...e,...a?.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...s}},r})}var iI=()=>{let n=wr("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},oI=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},Jr=async(n,e)=>{let t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function uI(n){let e=[];for await(let t of n)e.push(t);return e}function Np(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var lI=async n=>{if(n?.status===429){let e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1},jp=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");let t=[];for(;t.length<e&&this.items.length;){let r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}},cI=20971520,_i=class n{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new jp}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=n.getDefaultClientConfig();this.tracingSampleRate=iI(),this.apiUrl=Np(e.apiUrl??t.apiUrl)??"",this.apiKey=Np(e.apiKey??t.apiKey),this.webUrl=Np(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Xo(e.callerOptions??{}),this.batchIngestCaller=new Xo({...e.callerOptions??{},onFailedResponseHook:lI}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){let e=wr("LANGCHAIN_API_KEY"),t=wr("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=wr("LANGCHAIN_HIDE_INPUTS")==="true",a=wr("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:oI(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${Pc}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){let r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0,a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));let s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);let o=await i.json();if(o.length===0||(yield o,o.length<a))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.sampledPostUuids.has(a.id)&&(r.push(a),this.sampledPostUuids.delete(a.id));return r}else{let r=[];for(let a of e)Math.random()<this.tracingSampleRate&&(r.push(a),this.sampledPostUuids.add(a.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){let[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){let r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;let a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){let e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=await Q_([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(s[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=e?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[],a=t?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[];if(r.length>0&&a.length>0){let l=r.reduce((f,d)=>(d.id&&(f[d.id]=d),f),{}),c=[];for(let f of a)f.id!==void 0&&l[f.id]?l[f.id]={...l[f.id],...f}:c.push(f);r=Object.values(l),a=c}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;if(r=await Q_(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(let l of s.post)await this.createRun(l);for(let l of s.patch)l.id!==void 0&&await this.updateRun(l.id,l);return}let i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??cI,o={post:[],patch:[]},u=0;for(let l of["post","patch"]){let c=l,f=s[c].reverse(),d=f.pop();for(;d!==void 0;){let h=JSON.stringify(d);u>0&&u+h.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=h.length,o[c].push(d),d=f.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(r,"batch create run")}async updateRun(e,t){G(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){G(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r?.projectName?a=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?a=r?.projectId:a=(await this.readProject({projectName:wr("LANGCHAIN_PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await uI(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>(s?.dotted_order??"").localeCompare(i?.dotted_order??""));for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:l,runType:c,error:f,id:d,query:h,filter:p,traceFilter:g,treeFilter:m,limit:b,select:x}=e,v=[];if(t&&(v=Array.isArray(t)?t:[t]),r){let N=Array.isArray(r)?r:[r],X=await Promise.all(N.map(ct=>this.readProject({projectName:ct}).then(nd=>nd.id)));v.push(...X)}let k=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],O={session:v.length?v:null,run_type:c,reference_example:i,query:h,filter:p,trace_filter:g,tree_filter:m,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:f,id:d,limit:b,trace:s,select:x||k,is_root:l},B=0;for await(let N of this._getCursorPaginatedList("/runs/query",O))if(b){if(B>=b)break;if(N.length+B>b){yield*N.slice(0,b-B);break}B+=N.length,yield*N}else yield*N}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:s,projectIds:i,referenceExampleIds:o,startTime:u,endTime:l,error:c,query:f,filter:d,traceFilter:h,treeFilter:p,isRoot:g,dataSourceType:m}){let b=i||[];s&&(b=[...i||[],...await Promise.all(s.map(B=>this.readProject({projectName:B}).then(N=>N.id)))]);let v=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:b,reference_example:o,start_time:u,end_time:l,error:c,query:f,filter:d,trace_filter:h,tree_filter:p,is_root:g,data_source_type:m}).filter(([B,N])=>N!==void 0));return await(await this.caller.call(fetch,`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(v),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||zt()};G(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){G(e);let t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(t,"unshare run")}async readRunSharedLink(e){G(e);let r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return G(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),G(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};G(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){G(e);let t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(t,"unshare dataset")}async readSharedDataset(e){return G(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=s||{};r&&(l.metadata=r);let c={name:e,extra:l,description:t};i!==null&&(c.reference_dataset_id=i);let f=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await f.json();if(!f.ok)throw new Error(`Failed to create session ${e}: ${f.status} ${f.statusText}`);return d}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let l={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},c=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),f=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return f}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)G(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)G(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){let o=new URLSearchParams;if(e!==void 0)for(let u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){let u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(let u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,G(r);let a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(d=>{l.append("input_keys",d)}),a.forEach(d=>{l.append("output_keys",d)}),s&&l.append("description",s),i&&l.append("data_type",i),o&&l.append("name",o);let c=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!c.ok){let d=await c.json();throw d.detail&&d.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){let a={name:e,description:t};r&&(a.data_type=r);let s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok){let o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)G(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s}={}){let i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let u of r)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(let u of this._getPaginated(i,o))yield*u}async updateDataset(e){let{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");let s=t??(await this.readDataset({datasetName:r})).id;G(s);let i=await this.caller.call(fetch,`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to update dataset ${s}: ${i.status} ${i.statusText}`);return await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)G(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to delete ${r}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);let f={dataset_id:l,inputs:e,outputs:t,created_at:(s||new Date)?.toISOString(),id:i,metadata:o,split:u},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createExamples(e){let{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e,l=o;if(l===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:u})).id);let c=t.map((h,p)=>({dataset_id:l,inputs:h,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),f=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!f.ok)throw new Error(`Failed to create examples: ${f.status} ${f.statusText}`);return await f.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>Tp(i)?Pp(i):i),s=Tp(t)?Pp(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){G(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o,limit:u,offset:l,filter:c}={}){let f;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)f=e;else if(t!==void 0)f=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let d=new URLSearchParams({dataset:f}),h=a?typeof a=="string"?a:a?.toISOString():void 0;h&&d.append("as_of",h);let p=i??!0;if(d.append("inline_s3_urls",p.toString()),r!==void 0)for(let m of r)d.append("id",m);if(s!==void 0)for(let m of s)d.append("splits",m);if(o!==void 0){let m=JSON.stringify(o);d.append("metadata",m)}u!==void 0&&d.append("limit",u.toString()),l!==void 0&&d.append("offset",l.toString()),c!==void 0&&d.append("filter",c);let g=0;for await(let m of this._getPaginated("/examples",d)){for(let b of m)yield b,g++;if(u!==void 0&&g>=u)break}}async deleteExample(e){G(e);let t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){G(e);let r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async updateExamples(e){let t=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!t.ok)throw new Error(`Failed to update examples: ${t.status} ${t.statusText}`);return await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,G(a);let s=new URLSearchParams,i=r?typeof r=="string"?r:r?.toISOString():void 0;return i&&s.append("as_of",i),await this._get(`/datasets/${a}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:s=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,G(i);let o={split_name:r,examples:a.map(l=>(G(l),l)),remove:s},u=await this.caller.call(fetch,`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(u,"update dataset splits")}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){Rp("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),[u,l]=await this._logEvaluationFeedback(o,i,r);return l[0]}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,feedbackConfig:f,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");let p={type:u??"api",metadata:o??{}};l!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:l}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&G(p.metadata.__run.run_id);let g={id:c??zt(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:f,session_id:d},m=`${this.apiUrl}/feedback`,b=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(g),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Jr(b,"create feedback"),g}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),G(e);let o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Jr(o,"update feedback")}async readFeedback(e){G(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){G(e);let t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(a??new Date)?.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){G(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async _logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e),s=[];for(let i of a){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:t&&(u=t.id),s.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[a,s]}async logEvaluationFeedback(e,t,r){let[a]=await this._logEvaluationFeedback(e,t,r);return a}};var Pc="0.1.39";var Sc=class extends Ct{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=r??W("LANGCHAIN_PROJECT")??W("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new _i({});let s=this.getTraceableRunTree();if(s){let i=s,o=new Set;for(;i.parent_run&&!(o.has(i.id)||(o.add(i.id),!i.parent_run));)i=i.parent_run;o.clear();let u=[i];for(;u.length>0;){let l=u.shift();!l||o.has(l.id)||(o.add(l.id),this.runMap.set(l.id,l),l.child_runs&&u.push(...l.child_runs))}this.client=s.client??this.client,this.projectName=s.project_name??this.projectName,this.exampleId=s.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await V_()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return U_()}catch{return}}};var Cc=oe(ma(),1),Mp;function dI(){let n="default"in Cc.default?Cc.default.default:Cc.default;return new n({autoStart:!0,concurrency:1})}async function ge(n,e){e===!0?await n():(typeof Mp>"u"&&(Mp=dI()),Mp.add(n))}var ew=n=>n!==void 0?n:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>W(t)==="true");W("LANGCHAIN_TRACING_V2")==="true"&&W("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);function tw(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}var $p=class{setHandler(e){return this.setHandlers([e])}},wi=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>ge(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Lp=class extends wi{getChild(e){let t=new Ze(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},kc=class extends wi{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>ge(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(u){if(console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Dp=class extends wi{getChild(e){let t=new Ze(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>ge(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>ge(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Fp=class extends wi{getChild(e){let t=new Ze(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>ge(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Ze=class n extends $p{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:K();return await Promise.all(this.handlers.map(d=>ge(async()=>{if(!d.ignoreLLM)try{await d.handleLLMStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u)}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new kc(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:K();return await Promise.all(this.handlers.map(d=>ge(async()=>{if(!d.ignoreLLM)try{if(d.handleChatModelStart)await d.handleChatModelStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u);else if(d.handleLLMStart){let h=qo(l);await d.handleLLMStart?.(e,[h],f,this._parentRunId,s,this.tags,this.metadata,u)}}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new kc(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=K(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ge(async()=>{if(!u.ignoreChain)try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Dp(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=K(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ge(async()=>{if(!u.ignoreAgent)try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Fp(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=K(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ge(async()=>{if(!u.ignoreRetriever)try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Lp(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>ge(async()=>{if(!i.ignoreCustomEvent)try{await i.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleCustomEvent: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends us{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:K()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,s,i,o){return this._configureSync(e,t,r,a,s,i,o)}static _configureSync(e,t,r,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers(e?.map(Qo)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(Qo):t?.handlers,!1));let l=W("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=ew(),f=c||(W("LANGCHAIN_TRACING")??!1);if(l||f){if(u||(u=new n),l&&!u.handlers.some(d=>d.name===Yo.prototype.name)){let d=new Yo;u.addHandler(d,!0)}if(f&&!u.handlers.some(d=>d.name==="langchain_tracer")&&c){let d=new Sc;u.addHandler(d,!0),u._parentRunId=d.getTraceableRunTree()?.id??u._parentRunId}}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}};function Qo(n){return"name"in n?n:us.fromMethods(n)}var Rc=25;async function _t(n){return Ze.configure(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function Nc(...n){let e={};for(let t of n.filter(r=>!!r))for(let r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){let a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){let a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{let i=a.copy();for(let o of s)i.addHandler(Qo(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){let i=s.copy();for(let o of a)i.addHandler(Qo(o),!0);e.callbacks=i}else e.callbacks=new Ze(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{let a=r;e[a]=t[a]??e[a]}return e}var fI=new Set(["string","number","boolean"]);function U(n){let e=kt.getInstance().getStore(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:r,...a}=e;t=Object.entries(a).reduce((s,[i,o])=>(o!==void 0&&(s[i]=o),s),t)}if(n&&(t=Object.entries(n).reduce((r,[a,s])=>(s!==void 0&&(r[a]=s),r),t)),t?.configurable)for(let r of Object.keys(t.configurable))fI.has(typeof t.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=t.configurable[r]);return t}function be(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){let o=U(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}var rw=oe(ca(),1),jc=oe(ma(),1),hI=[400,401,402,403,404,405,406,407,409],pI=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;let e=n?.response?.status??n?.status;if(e&&hI.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){let t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}},Wr=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??pI;let t="default"in jc.default?jc.default.default:jc.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,rw.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var eu=class extends Ct{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}};function tu(n){return n?n.lc_runnable:!1}var Mc=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>this.includeTags?.includes(s))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>!this.excludeTags?.includes(s))),r}};ht();Cr();function Up(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}function mI(n,e){let t=e[n.source]??n.source,r=e[n.target]??n.target;return[t,r]}function gI(n){let e="";for(let[t,r]of Object.entries(n))e+=`	classDef ${t}class fill:${r};
`;return e}function nw(n,e,t){let{firstNodeLabel:r,lastNodeLabel:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{},l=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){let f="default",d={[f]:"{0}([{1}]):::otherclass"};r!==void 0&&(d[r]="{0}[{0}]:::startclass"),a!==void 0&&(d[a]="{0}[{0}]:::endclass");for(let h of Object.values(n)){let p=d[h]??d[f],g=Up(h),m=h.split(":"),b=m[m.length-1];l+=`	${p.replace(/\{0\}/g,g).replace(/\{1\}/g,b)};
`}}let c="";for(let f of e){let d=f.source.includes(":")?f.source.split(":")[0]:void 0,h=f.target.includes(":")?f.target.split(":")[0]:void 0;c!==""&&(c!==d||c!==h)&&(l+=`	end
`,c=""),c===""&&d!==void 0&&d===h&&(l=`	subgraph ${d}
`,c=d);let[p,g]=mI(f,n),m="";if(f.data!==void 0){let b=f.data,x=b.split(" ");x.length>u&&(b=x.reduce((v,k,O)=>(O%u===0&&v.push(""),v[v.length-1]+=` ${k}`,v),[]).join("<br>")),f.conditional?m=` -. ${b} .-> `:m=` -- ${b} --> `}else f.conditional?m=" -.-> ":m=" --> ";l+=`	${Up(p)}${m}${Up(g)};
`}return c!==""&&(l+=`end
`),i&&s!==void 0&&(l+=gI(s)),l}async function aw(n,e){let{backgroundColor:t="white"}=e??{},r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let a=`https://mermaid.ink/img/${r}?bgColor=${t}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}var sw=42;function Bp(n){if(Sr(n.id))if(tu(n.data))try{let e=n.data.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e.length>sw&&(e=`${e.substring(0,sw)}...`),e}catch{return n.data.getName()}else return n.data.name??"UnknownSchema";else return n.id}function bI(n){return tu(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...Q(n.data.schema),title:n.data.name}}}var ru=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Sr(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...bI(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||K(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let s={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(s),s}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e,t=""){let r=t;Object.values(e.nodes).map(l=>l.id).every(Sr)&&(r="");let s=l=>r?`${r}:${l}`:l;Object.entries(e.nodes).forEach(([l,c])=>{this.nodes[s(l)]={...c,id:s(l)}});let i=e.edges.map(l=>({...l,source:s(l.source),target:s(l.target)}));this.edges=[...this.edges,...i];let o=e.firstNode(),u=e.lastNode();return[o?{id:s(o.id),data:o.data}:void 0,u?{id:s(u.id),data:u.data}:void 0]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:a={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:s}=e??{},i={};for(let f of Object.values(this.nodes))i[f.id]=Bp(f);let o=this.firstNode(),u=o?Bp(o):void 0,l=this.lastNode(),c=l?Bp(l):void 0;return nw(i,this.edges,{firstNodeLabel:u,lastNodeLabel:c,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:s})}async drawMermaidPng(e){let t=this.drawMermaid(e);return aw(t,{backgroundColor:e?.backgroundColor})}};function iw(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return Fe.fromReadableStream(t)}function zp(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}var ow=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function $c(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Hp(n,e){let t=kt.getInstance();for(;;){let{value:r,done:a}=t.run(n,e.next.bind(e));if(a)break;yield r}}async function*qp(n,e){let t=kt.getInstance(),r=e[Symbol.asyncIterator]();for(;;){let{value:a,done:s}=await t.run(n,r.next.bind(e));if(s)break;yield a}}function Lc(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}var vi=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};function ke(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var J=class extends Xt{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Yr({bound:this,kwargs:e,config:{}})}map(){return new Dc({bound:this})}withRetry(e){return new Fc({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Yr({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Uc({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(U);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>U(s===0?e:r))}return Array.from({length:t},()=>U(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=a[0]?.maxConcurrency??r?.maxConcurrency,i=new Wr({maxConcurrency:s,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>i.call(async()=>{try{return await this.invoke(u,a[l])}catch(c){if(r?.returnExceptions)return c;throw c}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=U(t),a=new Gr({generator:this._streamIterator(e,r),config:r});return await a.setup,Fe.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=U(e):t=U({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){let a=U(r),i=await(await _t(a))?.handleChainStart(this.toJSON(),ke(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let o;try{o=await e.call(this,t,a,i)}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(ke(o,"output")),o}async _batchWithConfig(e,t,r,a){let s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(_t)),o=await Promise.all(i.map(async(l,c)=>{let f=await l?.handleChainStart(this.toJSON(),ke(t[c],"input"),s[c].runId,s[c].runType,void 0,void 0,s[c].runName??this.getName());return delete s[c].runId,f})),u;try{u=await e.call(this,t,s,o,a)}catch(l){throw await Promise.all(o.map(c=>c?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd(ke(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=U(r),l=await _t(u);async function*c(){for await(let d of e){if(s)if(a===void 0)a=d;else try{a=Je(a,d)}catch{a=void 0,s=!1}yield d}}let f;try{let d=await G_(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),u);delete u.runId,f=d.setup;let h=f?.handlers.find(Zo),p=d.output;h!==void 0&&f!==void 0&&(p=h.tapOutputIterable(f.runId,p));let g=f?.handlers.find(Wo);g!==void 0&&f!==void 0&&(p=g.tapOutputIterable(f.runId,p));for await(let m of p)if(yield m,o)if(i===void 0)i=m;else try{i=Je(i,m)}catch{i=void 0,o=!1}}catch(d){throw await f?.handleChainError(d,void 0,void 0,void 0,{inputs:ke(a,"input")}),d}await f?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:ke(a,"input")})}getGraph(e){let t=new ru,r=t.addNode({name:`${this.getName()}Input`,schema:se.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:se.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Xr({first:this,last:Zr(e)})}pick(e){return this.pipe(new Bc(e))}assign(e){return this.pipe(new xi(new Un({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=Je(r,a);yield*this._streamIterator(r,U(t))}async*streamLog(e,t,r){let a=new Jo({...r,autoClose:!1,_schemaFormat:"original"}),s=U(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.inheritableHandlers.push(t),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let l of u){let c=new er({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(c)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?iw(a):Fe.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){let a=new Ic({...r,autoClose:!1}),s=U(t),i=s.runId??K();s.runId=i;let o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{let h=o.copy();h.inheritableHandlers.push(a),s.callbacks=h}let u=this;async function l(){try{let h=await u.stream(e,s),p=a.tapOutputIterable(i,h);for await(let g of p);}finally{await a.finish()}}let c=l(),f=!1,d;try{for await(let h of a){if(!f){h.data.input=e,f=!0,d=h.run_id,yield h;continue}h.run_id===d&&h.event.endsWith("_end")&&h.data?.input&&delete h.data.input,yield h}}finally{await c}}async*_streamEventsV1(e,t,r){let a,s=!1,i=U(t),o=i.tags??[],u=i.metadata??{},l=i.runName??this.getName(),c=new Jo({...r,autoClose:!1,_schemaFormat:"streaming_events"}),f=new Mc({...r}),d=this._streamLog(e,c,i);for await(let p of d){if(a?a=a.concat(p):a=Ko.fromRunLogPatch(p),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let x={...a.state},v={run_id:x.id,event:`on_${x.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};f.includeEvent(v,x.type)&&(yield v)}let g=p.ops.filter(x=>x.path.startsWith("/logs/")).map(x=>x.path.split("/")[2]),m=[...new Set(g)];for(let x of m){let v,k={},O=a.state.logs[x];if(O.end_time===void 0?O.streamed_output.length>0?v="stream":v="start":v="end",v==="start")O.inputs!==void 0&&(k.input=O.inputs);else if(v==="end")O.inputs!==void 0&&(k.input=O.inputs),k.output=O.final_output;else if(v==="stream"){let B=O.streamed_output.length;if(B!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${B} instead. Encountered in: "${O.name}"`);k={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${v}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:k}}let{state:b}=a;if(b.streamed_output.length>0){let x=b.streamed_output.length;if(x!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${x} instead. Encountered in: "${b.name}"`);let v={chunk:b.streamed_output[0]};b.streamed_output=[];let k={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:u,name:l,data:v};f.includeEvent(k,b.type)&&(yield k)}}let h=a?.state;if(h!==void 0){let p={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:o,metadata:u,data:{output:h.final_output}};f.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return tu(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Yr({bound:this,config:{},configFactories:[a=>({callbacks:[new eu({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return _I(this,e)}},Yr=class n extends J{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=Nc(this.config,...e);return Nc(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(U(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(U(s),this.kwargs))):await this._mergeConfig(U(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(U(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(U(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(U(t),this.kwargs))}streamEvents(e,t,r){let a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(U(t),a.kwargs),version:t.version},r)};return Fe.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&J.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new eu({config:a,onStart:e,onEnd:t,onError:r})]})]})}},Dc=class n extends J{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,be(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},Fc=class extends Yr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return be(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return(0,Vp.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){let s={};try{await(0,Vp.default)(async i=>{let o=e.map((d,h)=>h).filter(d=>s[d.toString()]===void 0||s[d.toString()]instanceof Error),u=o.map(d=>e[d]),l=o.map(d=>this._patchConfigForRetry(i,t?.[d],r?.[d])),c=await super.batch(u,l,{...a,returnExceptions:!0}),f;for(let d=0;d<c.length;d+=1){let h=c[d],p=o[d];h instanceof Error&&f===void 0&&(f=h,f.input=u[d]),s[p.toString()]=h}if(f)throw f;return c},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(a?.returnExceptions!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Xr=class n extends J{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=U(t),s=await(await _t(r))?.handleChainStart(this.toJSON(),ke(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i=e,o;try{let u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1)i=await u[l].invoke(i,be(r,{callbacks:s?.getChild(`seq:step:${l+1}`)}));o=await this.last.invoke(i,be(r,{callbacks:s?.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(ke(o,"output")),o}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(_t)),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),ke(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((c,f)=>{let d=c?.getChild(`seq:step:${u+1}`);return be(a[f],{callbacks:d})}),r)}catch(u){throw await Promise.all(i.map(l=>l?.handleChainError(u))),u}return await Promise.all(i.map(u=>u?.handleChainEnd(ke(o,"output")))),o}async*_streamIterator(e,t){let r=await _t(t),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),ke(e,"input"),a,void 0,void 0,void 0,s?.runName),o=[this.first,...this.middle,this.last],u=!0,l;async function*c(){yield e}try{let f=o[0].transform(c(),be(s,{callbacks:i?.getChild("seq:step:1")}));for(let d=1;d<o.length;d+=1)f=await o[d].transform(f,be(s,{callbacks:i?.getChild(`seq:step:${d+1}`)}));for await(let d of f)if(yield d,u)if(l===void 0)l=d;else try{l=Je(l,d)}catch{l=void 0,u=!1}}catch(f){throw await i?.handleChainError(f),f}await i?.handleChainEnd(ke(l,"output"))}getGraph(e){let t=new ru,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:Zr(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&J.isRunnable(e)}static from([e,...t],r){return new n({first:Zr(e),middle:t.slice(0,-1).map(Zr),last:Zr(t[t.length-1]),name:r})}},Un=class n extends J{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=Zr(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=U(t),s=await(await _t(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,be(r,{callbacks:s?.getChild(`map:key:${o}`)}))}))}catch(o){throw await s?.handleChainError(o),o}return await s?.handleChainEnd(i),i}async*_transform(e,t,r){let a={...this.steps},s=Ep(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],l)=>{let c=u.transform(s[l],be(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,c.next().then(f=>({key:o,gen:c,result:f}))]}));for(;i.size;){let{key:o,result:u,gen:l}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,l.next().then(c=>({key:o,gen:l,result:c}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=U(t),s=new Gr({generator:this.transform(r(),a),config:a});return await s.setup,Fe.fromAsyncGenerator(s)}},Gp=class n extends J{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!gc(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await _t(r);return await this.func(be(r,{callbacks:a}),e)}async*_streamIterator(e,t){let r=await this.invoke(e,t);if($c(r)){for await(let a of r)yield a;return}if(ow(r)){for(;;){let a=r.next();if(a.done)break;yield a.value}return}yield r}static from(e){return new n({func:e})}};function yI(n){if(gc(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Qr=class n extends J{static lc_name(){return"RunnableLambda"}constructor(e){if(gc(e.func))return Gp.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),yI(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{let i=be(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??Rc)-1});kt.getInstance().run(i,async()=>{try{let o=await this.func(e,{...i,config:i});if(o&&J.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??Rc)-1})}else if($c(o)){let u;for await(let l of qp(i,o))if(u===void 0)u=l;else try{u=Je(u,l)}catch{u=l}o=u}else if(zp(o)){let u;for(let l of Hp(i,o))if(u===void 0)u=l;else try{u=Je(u,l)}catch{u=l}o=u}a(o)}catch(o){s(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(let o of e)if(a===void 0)a=o;else try{a=Je(a,o)}catch{a=o}let s=be(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??Rc)-1}),i=await new Promise((o,u)=>{kt.getInstance().run(s,async()=>{try{let l=await this.func(a,{...s,config:s});o(l)}catch(l){u(l)}})});if(i&&J.isRunnable(i)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let o=await i.stream(a,s);for await(let u of o)yield u}else if($c(i))for await(let o of qp(s,i))yield o;else if(zp(i))for(let o of Hp(s,i))yield o;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=U(t),s=new Gr({generator:this.transform(r(),a),config:a});return await s.setup,Fe.fromAsyncGenerator(s)}};var Uc=class extends J{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=U(t),a=await _t(t),{runId:s,...i}=r,o=await a?.handleChainStart(this.toJSON(),ke(e,"input"),s,void 0,void 0,void 0,i?.runName),u;for(let l of this.runnables())try{let c=await l.invoke(e,be(i,{callbacks:o?.getChild()}));return await o?.handleChainEnd(ke(c,"output")),c}catch(c){u===void 0&&(u=c)}throw u===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(u),u)}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>_t(u))),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),ke(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o;for(let u of this.runnables())try{let l=await u.batch(e,i.map((c,f)=>be(a[f],{callbacks:c?.getChild()})),r);return await Promise.all(i.map((c,f)=>c?.handleChainEnd(ke(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(i.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Zr(n){if(typeof n=="function")return new Qr({func:n});if(J.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=Zr(r);return new Un({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var xi=class extends J{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Un&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=Ep(e),o=this.mapper.transform(i,be(r,{callbacks:t?.getChild()})),u=o.next();for await(let l of s){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let c=Object.fromEntries(Object.entries(l).filter(([f])=>!a.includes(f)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(let l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=U(t),s=new Gr({generator:this.transform(r(),a),config:a});return await s.setup,Fe.fromAsyncGenerator(s)}},Bc=class extends J{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=U(t),s=new Gr({generator:this.transform(r(),a),config:a});return await s.setup,Fe.fromAsyncGenerator(s)}},nu=class extends Yr{constructor(e){let t=Xr.from([Qr.from(async r=>{let a;if(Lc(r))try{a=await this.schema.parseAsync(r.args)}catch{throw new vi("Received tool input did not match expected schema",JSON.stringify(r.args))}else a=r;return a}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function _I(n,e){let t=e.name??n.getName(),r=e.description??e.schema?.description;return e.schema.constructor===se.ZodString?new nu({name:t,description:r,schema:se.object({input:se.string()}).transform(a=>a.input),bound:n}):new nu({name:t,description:r,schema:e.schema,bound:n})}ht();var wI=typeof window=="object"?window:{},L="0123456789abcdef".split(""),vI=[-2147483648,8388608,32768,128],rr=[24,16,8,0];var Ee=[];function nr(n){n?(Ee[0]=Ee[16]=Ee[1]=Ee[2]=Ee[3]=Ee[4]=Ee[5]=Ee[6]=Ee[7]=Ee[8]=Ee[9]=Ee[10]=Ee[11]=Ee[12]=Ee[13]=Ee[14]=Ee[15]=0,this.blocks=Ee):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}nr.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===wI.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<rr[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<rr[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<rr[a++&3],i[a>>2]|=(128|t&63)<<rr[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<rr[a++&3],i[a>>2]|=(128|t>>6&63)<<rr[a++&3],i[a>>2]|=(128|t&63)<<rr[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<rr[a++&3],i[a>>2]|=(128|t>>12&63)<<rr[a++&3],i[a>>2]|=(128|t>>6&63)<<rr[a++&3],i[a>>2]|=(128|t&63)<<rr[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};nr.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=vI[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};nr.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};nr.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return L[n>>28&15]+L[n>>24&15]+L[n>>20&15]+L[n>>16&15]+L[n>>12&15]+L[n>>8&15]+L[n>>4&15]+L[n&15]+L[e>>28&15]+L[e>>24&15]+L[e>>20&15]+L[e>>16&15]+L[e>>12&15]+L[e>>8&15]+L[e>>4&15]+L[e&15]+L[t>>28&15]+L[t>>24&15]+L[t>>20&15]+L[t>>16&15]+L[t>>12&15]+L[t>>8&15]+L[t>>4&15]+L[t&15]+L[r>>28&15]+L[r>>24&15]+L[r>>20&15]+L[r>>16&15]+L[r>>12&15]+L[r>>8&15]+L[r>>4&15]+L[r&15]+L[a>>28&15]+L[a>>24&15]+L[a>>20&15]+L[a>>16&15]+L[a>>12&15]+L[a>>8&15]+L[a>>4&15]+L[a&15]};nr.prototype.toString=nr.prototype.hex;nr.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};nr.prototype.array=nr.prototype.digest;nr.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var Kp=n=>new nr(!0).update(n).hex();var uw=(...n)=>Kp(n.join("_"));var Jp=class{},xI=new Map,zc=class n extends Jp{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(uw(e,t))??null)}async update(e,t,r){this.cache.set(uw(e,t),r)}static global(){return new n(xI)}};var Hc=class extends Xt{},qc=class extends Hc{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Qt(this.value)]}},Vc=class extends Hc{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return qo(this.messages)}toChatMessages(){return this.messages}};var Gc={},AI=new Wr({});async function OI(n){return n in Gc||(Gc[n]=AI.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new js(e)).catch(e=>{throw delete Gc[n],e})),await Gc[n]}async function lw(n){return OI(io(n))}var EI=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;var II=()=>!1,au=class extends J{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??II(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},su=class extends au{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=zc.global():this.cache=void 0,this.caller=new Wr(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await lw("modelName"in this?EI(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new qc(e):Array.isArray(e)?new Vc(e.map(ss)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};var vr=class extends J{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=U(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){let r=U(t),a,s=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=Je(a,i)}catch{a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new xi(new Un({steps:e}))}};function cw(n){return typeof n?.parse=="function"}var Kc=class n extends su{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r?.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let a=n._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptions(t),o={...s.metadata,...this.getLsParams(i)},u=await Ze.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await u?.handleChatModelStart(this.toJSON(),[a],s.runId,void 0,l,void 0,void 0,s.runName),f;try{for await(let d of this._streamResponseChunks(a,i,c?.[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,f?f=f.concat(d):f=d}catch(d){throw await Promise.all((c??[]).map(h=>h?.handleLLMError(d))),d}await Promise.all((c??[]).map(d=>d?.handleLLMEnd({generations:[[f]]})))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,r){let a=e.map(h=>h.map(ss)),s={...r.metadata,...this.getLsParams(t)},i=await Ze.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this?.invocationParams(t),batch_size:1},u=await i?.handleChatModelStart(this.toJSON(),a,r.runId,void 0,o,void 0,void 0,r.runName),l=[],c=[];if(!!u?.[0].handlers.find(h=>Zo(h)||Wo(h))&&a.length===1&&this._streamResponseChunks!==n.prototype._streamResponseChunks)try{let h=await this._streamResponseChunks(a[0],t,u?.[0]),p;for await(let g of h)p===void 0?p=g:p=Je(p,g);if(p===void 0)throw new Error("Received empty response from chat model call.");l.push([p]),await u?.[0].handleLLMEnd({generations:l,llmOutput:{}})}catch(h){throw await u?.[0].handleLLMError(h),h}else{let h=await Promise.allSettled(a.map((p,g)=>this._generate(p,{...t,promptIndex:g},u?.[g])));await Promise.all(h.map(async(p,g)=>{if(p.status==="fulfilled"){let m=p.value;for(let b of m.generations)b.message.response_metadata={...b.generationInfo,...b.message.response_metadata};return m.generations.length===1&&(m.generations[0].message.response_metadata={...m.llmOutput,...m.generations[0].message.response_metadata}),l[g]=m.generations,c[g]=m.llmOutput,u?.[g]?.handleLLMEnd({generations:[m.generations],llmOutput:m.llmOutput})}else return await u?.[g]?.handleLLMError(p.reason),Promise.reject(p.reason)}))}let d={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(d,Oc,{value:u?{runIds:u?.map(h=>h.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(m=>m.map(ss)),o={...s.metadata,...this.getLsParams(a)},u=await Ze.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1,cached:!0},c=await u?.handleChatModelStart(this.toJSON(),i,s.runId,void 0,l,void 0,void 0,s.runName),f=[],h=(await Promise.allSettled(i.map(async(m,b)=>{let x=n._convertInputToPromptValue(m).toString(),v=await t.lookup(x,r);return v==null&&f.push(b),v}))).map((m,b)=>({result:m,runManager:c?.[b]})).filter(({result:m})=>m.status==="fulfilled"&&m.value!=null||m.status==="rejected"),p=[];await Promise.all(h.map(async({result:m,runManager:b},x)=>{if(m.status==="fulfilled"){let v=m.value;return p[x]=v,v.length&&await b?.handleLLMNewToken(v[0].text),b?.handleLLMEnd({generations:[v]})}else return await b?.handleLLMError(m.reason),Promise.reject(m.reason)}));let g={generations:p,missingPromptIndices:f};return Object.defineProperty(g,Oc,{value:c?{runIds:c?.map(m=>m.runId)}:void 0,configurable:!0}),g}async generate(e,t,r){let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(h=>h.map(ss)),[i,o]=this._separateRunnableConfigFromCallOptions(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:f}=await this._generateCached({messages:s,cache:u,llmStringKey:l,parsedOptions:o,handledOptions:i}),d={};if(f.length>0){let h=await this._generateUncached(f.map(p=>s[p]),o,i);await Promise.all(h.generations.map(async(p,g)=>{let m=f[g];c[m]=p;let b=n._convertInputToPromptValue(s[m]).toString();return u.update(b,l,p)})),d=h.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(ss)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new Qt(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');let r=e,a=t?.name,s=r.description??"A function available to call.",i=t?.method,o=t?.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=a??"extract",l;cw(r)?l=[{type:"function",function:{name:u,description:s,parameters:Q(r)}}]:("name"in r&&(u=r.name),l=[{type:"function",function:{name:u,description:s,parameters:r}}]);let c=this.bindTools(l),f=Qr.from(g=>{if(!g.tool_calls||g.tool_calls.length===0)throw new Error("No tool calls found in the response.");let m=g.tool_calls.find(b=>b.name===u);if(!m)throw new Error(`No tool call found with name ${u}.`);return m.args});if(!o)return c.pipe(f).withConfig({runName:"StructuredOutput"});let d=vr.assign({parsed:(g,m)=>f.invoke(g.raw,m)}),h=vr.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return Xr.from([{raw:c},p]).withConfig({runName:"StructuredOutputRunnable"})}};ht();function dw(n){return{name:n.name,description:n.description,parameters:Q(n.schema)}}function Jc(n){return TI(n)||PI(n)?{type:"function",function:dw(n)}:n}function TI(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function PI(n){return n!==void 0&&J.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}var Ai=class extends J{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a?.callbacks),e,{...t,runType:"parser"})}},Oi=class extends Ai{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},Bn=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}};function iu(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!iu(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let i of r)if(!iu(n[i],e[i]))return!1;return!0}return n===e}var kH=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var CI=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,kI=[0,31,28,31,30,31,30,31,31,30,31,30,31],RI=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,NI=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,jI=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,MI=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,$I=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,LI=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,DI=/^(?:\/(?:[^~/]|~0|~1)*)*$/,FI=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,UI=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,BI=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,zI=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,HI=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,qI=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,VI=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},GI=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,KI=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,JI=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function ut(n){return n.test.bind(n)}var WI={date:fw,time:hw.bind(void 0,!1),"date-time":QI,duration:JI,uri:rT,"uri-reference":ut(jI),"uri-template":ut(MI),url:ut($I),email:VI,hostname:ut(NI),ipv4:ut(GI),ipv6:ut(KI),regex:aT,uuid:ut(LI),"json-pointer":ut(DI),"json-pointer-uri-fragment":ut(FI),"relative-json-pointer":ut(UI)},ZI={...WI,date:ut(BI),time:ut(zI),"date-time":ut(HI),"uri-reference":ut(qI)};function YI(n){return n%4===0&&(n%100!==0||n%400===0)}function fw(n){let e=n.match(CI);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&YI(t)?29:kI[r])}function hw(n,e){let t=e.match(RI);if(!t)return!1;let r=+t[1],a=+t[2],s=+t[3],i=!!t[5];return(r<=23&&a<=59&&s<=59||r==23&&a==59&&s==60)&&(!n||i)}var XI=/t|\s/i;function QI(n){let e=n.split(XI);return e.length==2&&fw(e[0])&&hw(!0,e[1])}var eT=/\/|:/,tT=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function rT(n){return eT.test(n)&&tT.test(n)}var nT=/[^\\]\\Z/;function aT(n){if(nT.test(n))return!1;try{return new RegExp(n),!0}catch{return!1}}var Ei=class extends Oi{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},ou=class extends Ei{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(L_(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new Dn({message:a,text:a.content})}else if(gi(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new Dn({message:mp(a),text:a.content})}else s=new _r({text:a});r===void 0?r=s:r=r.concat(s);let i=await this.parsePartialResult([r]);i!=null&&!iu(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}};Pr();ht();var Wc=class extends Oi{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=se.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,se.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Q(this.schema))}
\`\`\`
`}async parse(e){try{let r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new Bn(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};var Zc=class extends ou{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Ac(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return fp(e[0].text)}async parse(e){return fp(e,JSON.parse)}getFormatInstructions(){return""}};function Zp(n,e){if(n.function===void 0)return;let t;if(e?.partial)try{t=mi(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(a){throw new Bn([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join(`
`))}let r={name:n.function.name,args:t,type:"tool_call"};return e?.returnId&&(r.id=n.id),r}function pw(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function mw(n,e){return{name:n.function?.name,args:n.function?.arguments,id:n.id,error:e,type:"invalid_tool_call"}}var Wp=class extends Ai{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){let t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);let r=JSON.parse(JSON.stringify(t)),a=[];for(let s of r){let i=Zp(s,{partial:!0});if(i!==void 0){let o={type:i.name,args:i.args,id:i.id};Object.defineProperty(o,"name",{get(){return this.type}}),Object.defineProperty(o,"arguments",{get(){return this.args}}),a.push(o)}}return a}},uu=class extends Ai{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new Wp(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Bn(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let r=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName),a=r;return this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))}};ht();function zn(n){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i}=n;if((r||i)&&a&&e)return`${a}/${e}`;if(r||i){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}ht();function Ii(n){let e;return n.constructor.name===C_.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===k_.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}function iT(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function gw(n){let e=["namespace functions {",""];for(let t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(bw(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function bw(n,e){let t=[];for(let[r,a]of Object.entries(n.properties??{}))a.description&&e<2&&t.push(`// ${a.description}`),n.required?.includes(r)?t.push(`${r}: ${Yc(a,e)},`):t.push(`${r}?: ${Yc(a,e)},`);return t.map(r=>" ".repeat(e)+r).join(`
`)}function Yc(n,e){if(iT(n))return n.anyOf.map(t=>Yc(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",bw(n,e+2),"}"].join(`
`);case"array":return n.items?`${Yc(n.items,e)}[]`:"any[]";default:return""}}function oT(n){return n.role!=="system"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function ww(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!$n.isInstance(n))throw new Error("Invalid generic chat message");return oT(n)}default:throw new Error(`Unknown message type: ${e}`)}}function uT(n){let e=n.tool_calls;switch(n.role){case"assistant":{let t=[],r=[];for(let a of e??[])try{t.push(Zp(a,{returnId:!0}))}catch(s){r.push(mw(a,s.message))}return new br({content:n.content||"",tool_calls:t,invalid_tool_calls:r,additional_kwargs:{function_call:n.function_call,tool_calls:e}})}default:return new $n(n.content||"",n.role??"unknown")}}function lT(n,e){let t=n.role??e,r=n.content??"",a;if(n.function_call?a={function_call:n.function_call}:n.tool_calls?a={tool_calls:n.tool_calls}:a={},t==="user")return new ns({content:r});if(t==="assistant"){let s=[];if(Array.isArray(n.tool_calls))for(let i of n.tool_calls)s.push({name:i.function?.name,args:i.function?.arguments,id:i.id,index:i.index});return new St({content:r,tool_call_chunks:s,additional_kwargs:a})}else return t==="system"?new as({content:r}):t==="function"?new rs({content:r,additional_kwargs:a,name:n.name}):t==="tool"?new bi({content:r,additional_kwargs:a,tool_call_id:n.tool_call_id}):new ts({content:r,role:t})}function yw(n){return n.map(e=>{let t={role:ww(e),content:e.content};return e.name!=null&&(t.name=e.name),e.additional_kwargs.function_call!=null&&(t.function_call=e.additional_kwargs.function_call),pp(e)&&e.tool_calls?.length?t.tool_calls=e.tool_calls.map(pw):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}var Ti=class extends Kc{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??W("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??W("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??W("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??W("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??W("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??W("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??W("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??""}this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){return this.bind({tools:e.map(Jc),...t})}invocationParams(e){function t(a){return a!==void 0&&a.every(s=>Array.isArray(s.lc_namespace))}return{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:t(e?.tools)?e?.tools.map(Jc):e?.tools,tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...e?.stream_options!==void 0?{stream_options:e.stream_options}:{},parallel_tool_calls:e?.parallel_tool_calls,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){let a=yw(e),s={...this.invocationParams(t),messages:a,stream:!0},i,o=await this.completionWithRetry(s,t),u;for await(let l of o){let c=l?.choices[0];if(l.usage&&(u=l.usage),!c)continue;let{delta:f}=c;if(!f)continue;let d=lT(f,i);i=f.role??i;let h={prompt:t.promptIndex??0,completion:c.index??0};if(typeof d.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let p={...h};c.finish_reason!==void 0&&(p.finish_reason=c.finish_reason),this.logprobs&&(p.logprobs=c.logprobs);let g=new Dn({message:d,text:d.content,generationInfo:p});yield g,r?.handleLLMNewToken(g.text??"",h,void 0,void 0,void 0,{chunk:g})}if(u&&(yield new Dn({message:new St({content:"",usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens}}),text:""})),t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let a={},s=this.invocationParams(t),i=yw(e);if(s.stream){let o=this._streamResponseChunks(e,t,r),u={};for await(let p of o){p.message.response_metadata={...p.generationInfo,...p.message.response_metadata};let g=p.generationInfo?.completion??0;u[g]===void 0?u[g]=p:u[g]=u[g].concat(p)}let l=Object.entries(u).sort(([p],[g])=>parseInt(p,10)-parseInt(g,10)).map(([p,g])=>g),{functions:c,function_call:f}=this.invocationParams(t),d=await this.getEstimatedTokenCountFromPrompt(e,c,f),h=await this.getNumTokensFromGenerations(l);return a.promptTokens=d,a.completionTokens=h,a.totalTokens=d+h,{generations:l,llmOutput:{estimatedTokenUsage:a}}}else{let o=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,...t?.options}),{completion_tokens:u,prompt_tokens:l,total_tokens:c}=o?.usage??{};u&&(a.completionTokens=(a.completionTokens??0)+u),l&&(a.promptTokens=(a.promptTokens??0)+l),c&&(a.totalTokens=(a.totalTokens??0)+c);let f=[];for(let d of o?.choices??[]){let p={text:d.message?.content??"",message:uT(d.message??{role:"assistant"})};p.generationInfo={...d.finish_reason?{finish_reason:d.finish_reason}:{},...d.logprobs?{logprobs:d.logprobs}:{}},pp(p.message)&&(p.message.usage_metadata={input_tokens:a.promptTokens??0,output_tokens:a.completionTokens??0,total_tokens:a.totalTokens??0}),f.push(p)}return{generations:f,llmOutput:{tokenUsage:a}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){let s=gw(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),r==="none"?a+=1:typeof r=="object"&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>r.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)))).reduce((r,a)=>r+a,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;this.model==="gpt-3.5-turbo-0301"?(r=4,a=-1):(r=3,a=1);let s=await Promise.all(e.map(async i=>{let o=await this.getNumTokens(i.content),u=await this.getNumTokens(ww(i)),l=i.name!==void 0?a+await this.getNumTokens(i.name):0,c=o+r+u+l,f=i;if(f._getType()==="function"&&(c-=2),f.additional_kwargs?.function_call&&(c+=3),f?.additional_kwargs.function_call?.name&&(c+=await this.getNumTokens(f.additional_kwargs.function_call?.name)),f.additional_kwargs.function_call?.arguments)try{c+=await this.getNumTokens(JSON.stringify(JSON.parse(f.additional_kwargs.function_call?.arguments)))}catch(d){console.error("Error parsing function arguments",d,JSON.stringify(f.additional_kwargs.function_call)),c+=await this.getNumTokens(f.additional_kwargs.function_call?.arguments)}return t+=c,c}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(a){throw Ii(a)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},a=zn(r),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new Y(s)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,a,s,i;cT(e)?(r=e.schema,a=e.name,s=e.method,i=e.includeRaw):(r=e,a=t?.name,s=t?.method,i=t?.includeRaw);let o,u;if(s==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),_w(r)?u=Wc.fromZodSchema(r):u=new Zc;else{let d=a??"extract";if(_w(r)){let h=Q(r);o=this.bind({tools:[{type:"function",function:{name:d,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:d}}}),u=new uu({returnSingle:!0,keyName:d,zodSchema:r})}else{let h;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(h=r,d=r.name):(d=r.title??d,h={name:d,description:r.description??"",parameters:r}),o=this.bind({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:d}}}),u=new uu({returnSingle:!0,keyName:d})}}if(!i)return o.pipe(u);let l=vr.assign({parsed:(d,h)=>u.invoke(d.raw,h)}),c=vr.assign({parsed:()=>null}),f=l.withFallbacks({fallbacks:[c]});return Xr.from([{raw:o},f])}};function _w(n){return typeof n?.parse=="function"}function cT(n){return n!==void 0&&typeof n.schema=="object"}Pr();var Yp=class extends au{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let r,a;Lc(e)?(r=e.id,a=e.args):a=e;let s=U(t);return this.call(a,{...s,configurable:{...s.configurable,tool_call_id:r}})}async call(e,t,r){let a;try{a=await this.schema.parseAsync(e)}catch{throw new vi("Received tool input did not match expected schema",JSON.stringify(e))}let s=tw(t),o=await(await Ze.configure(s.callbacks,this.callbacks,s.tags||r,this.tags,s.metadata,this.metadata,{verbose:this.verbose}))?.handleToolStart(this.toJSON(),typeof a=="string"?a:JSON.stringify(a),s.runId,void 0,void 0,void 0,s.runName);delete s.runId;let u;try{u=await this._call(a,o,s)}catch(h){throw await o?.handleToolError(h),h}let l,c;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[l,c]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else l=u;let f;s&&"configurable"in s&&(f=s.configurable.tool_call_id);let d=fT({content:l,artifact:c,toolCallId:f,name:this.name});return await o?.handleToolEnd(d),d}},Xc=class extends Yp{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:se.object({input:se.string().optional()}).transform(t=>t.input)})}call(e,t){return super.call(typeof e=="string"||!e?{input:e}:e,t)}};function fT(n){let{content:e,artifact:t,toolCallId:r}=n;return r?typeof e=="string"||Array.isArray(e)&&e.every(a=>typeof a=="object")?new Mn({content:e,artifact:t,tool_call_id:r,name:n.name}):new Mn({content:hT(e),artifact:t,tool_call_id:r,name:n.name}):e}function hT(n){try{return JSON.stringify(n,null,2)}catch{return`${n}`}}var Xp=class extends Xc{static lc_name(){return"DallEAPIWrapper"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.apiKey??e?.openAIApiKey??W("OPENAI_API_KEY"),r=e?.organization??W("OPENAI_ORGANIZATION"),a={apiKey:t,organization:r,dangerouslyAllowBrowser:!0};this.client=new Y(a),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.responseFormat=e?.responseFormat??this.responseFormat,this.user=e?.user}async _call(e){let t=await this.client.images.generate({model:this.model,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user}),r="";return this.responseFormat==="url"?[r]=t.data.map(a=>a.url).filter(a=>a!=="undefined"):[r]=t.data.map(a=>a.b64_json).filter(a=>a!=="undefined"),r}};Object.defineProperty(Xp,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var um=oe(Ew());Is();var Qc=class{constructor(e){this.secret=e}_encode(e){return new TextEncoder().encode(e)}_decode(e){return new TextDecoder().decode(e)}async _importKey(e){let t=await crypto.subtle.importKey("raw",this._encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:this._encode("salt"),iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async _encrypt(e){let t=await this._importKey(this.secret),r=crypto.getRandomValues(new Uint8Array(12)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},t,this._encode(e));return{iv:r,encrypted:a}}async _decrypt(e,t){let r=await this._importKey(this.secret),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},r,e);return this._decode(a)}async saveAPIKey(e,t){let{iv:r,encrypted:a}=await this._encrypt(t),s={iv:Array.from(r),encrypted:Array.from(new Uint8Array(a))};localStorage.setItem(e,JSON.stringify(s))}async getAPIKey(e){let t=localStorage.getItem(e);if(!t)return null;let{iv:r,encrypted:a}=JSON.parse(t);return await this._decrypt(new Uint8Array(a),new Uint8Array(r))}deleteAPIKey(e){localStorage.removeItem(e)}apiKeyExists(e){return localStorage.getItem(e)!==null}};var lt=["OpenAI","Google","Ollama","Groq","OpenAI-Like"],Rt="OpenAI-Like",Iw='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14L21 3m0 0l-6.5 18a.55.55 0 0 1-1 0L10 14l-7-3.5a.55.55 0 0 1 0-1L21 3"/></svg>',Tw='<svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" height="1.5em" width="1.5em"><path fill="currentColor" d="M15 37.95q-1.25 0-2.125-.875T12 34.95v-28q0-1.25.875-2.125T15 3.95h22q1.25 0 2.125.875T40 6.95v28q0 1.25-.875 2.125T37 37.95Zm0-3h22v-28H15v28Zm-6 9q-1.25 0-2.125-.875T6 40.95V12.3q0-.65.425-1.075Q6.85 10.8 7.5 10.8q.65 0 1.075.425Q9 11.65 9 12.3v28.65h22.2q.65 0 1.075.425.425.425.425 1.075 0 .65-.425 1.075-.425.425-1.075.425Zm6-37v28-28Z"/></svg>',Pw='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-stop"><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></svg>';var Re=typeof globalThis<"u"&&globalThis||typeof self<"u"&&self||typeof global<"u"&&global||{},Ye={searchParams:"URLSearchParams"in Re,iterable:"Symbol"in Re&&"iterator"in Symbol,blob:"FileReader"in Re&&"Blob"in Re&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in Re,arrayBuffer:"ArrayBuffer"in Re};function yT(n){return n&&DataView.prototype.isPrototypeOf(n)}Ye.arrayBuffer&&(Sw=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],kw=ArrayBuffer.isView||function(n){return n&&Sw.indexOf(Object.prototype.toString.call(n))>-1});var Sw,kw;function Pi(n){if(typeof n!="string"&&(n=String(n)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(n)||n==="")throw new TypeError('Invalid character in header field name: "'+n+'"');return n.toLowerCase()}function em(n){return typeof n!="string"&&(n=String(n)),n}function tm(n){var e={next:function(){var t=n.shift();return{done:t===void 0,value:t}}};return Ye.iterable&&(e[Symbol.iterator]=function(){return e}),e}function ye(n){this.map={},n instanceof ye?n.forEach(function(e,t){this.append(t,e)},this):Array.isArray(n)?n.forEach(function(e){if(e.length!=2)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):n&&Object.getOwnPropertyNames(n).forEach(function(e){this.append(e,n[e])},this)}ye.prototype.append=function(n,e){n=Pi(n),e=em(e);var t=this.map[n];this.map[n]=t?t+", "+e:e};ye.prototype.delete=function(n){delete this.map[Pi(n)]};ye.prototype.get=function(n){return n=Pi(n),this.has(n)?this.map[n]:null};ye.prototype.has=function(n){return this.map.hasOwnProperty(Pi(n))};ye.prototype.set=function(n,e){this.map[Pi(n)]=em(e)};ye.prototype.forEach=function(n,e){for(var t in this.map)this.map.hasOwnProperty(t)&&n.call(e,this.map[t],t,this)};ye.prototype.keys=function(){var n=[];return this.forEach(function(e,t){n.push(t)}),tm(n)};ye.prototype.values=function(){var n=[];return this.forEach(function(e){n.push(e)}),tm(n)};ye.prototype.entries=function(){var n=[];return this.forEach(function(e,t){n.push([t,e])}),tm(n)};Ye.iterable&&(ye.prototype[Symbol.iterator]=ye.prototype.entries);function Qp(n){if(!n._noBody){if(n.bodyUsed)return Promise.reject(new TypeError("Already read"));n.bodyUsed=!0}}function Rw(n){return new Promise(function(e,t){n.onload=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function _T(n){var e=new FileReader,t=Rw(e);return e.readAsArrayBuffer(n),t}function wT(n){var e=new FileReader,t=Rw(e),r=/charset=([A-Za-z0-9_-]+)/.exec(n.type),a=r?r[1]:"utf-8";return e.readAsText(n,a),t}function vT(n){for(var e=new Uint8Array(n),t=new Array(e.length),r=0;r<e.length;r++)t[r]=String.fromCharCode(e[r]);return t.join("")}function Cw(n){if(n.slice)return n.slice(0);var e=new Uint8Array(n.byteLength);return e.set(new Uint8Array(n)),e.buffer}function Nw(){return this.bodyUsed=!1,this._initBody=function(n){this.bodyUsed=this.bodyUsed,this._bodyInit=n,n?typeof n=="string"?this._bodyText=n:Ye.blob&&Blob.prototype.isPrototypeOf(n)?this._bodyBlob=n:Ye.formData&&FormData.prototype.isPrototypeOf(n)?this._bodyFormData=n:Ye.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)?this._bodyText=n.toString():Ye.arrayBuffer&&Ye.blob&&yT(n)?(this._bodyArrayBuffer=Cw(n.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):Ye.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(n)||kw(n))?this._bodyArrayBuffer=Cw(n):this._bodyText=n=Object.prototype.toString.call(n):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||(typeof n=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):Ye.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},Ye.blob&&(this.blob=function(){var n=Qp(this);if(n)return n;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var n=Qp(this);return n||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}else{if(Ye.blob)return this.blob().then(_T);throw new Error("could not read as ArrayBuffer")}},this.text=function(){var n=Qp(this);if(n)return n;if(this._bodyBlob)return wT(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(vT(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},Ye.formData&&(this.formData=function(){return this.text().then(OT)}),this.json=function(){return this.text().then(JSON.parse)},this}var xT=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function AT(n){var e=n.toUpperCase();return xT.indexOf(e)>-1?e:n}function cs(n,e){if(!(this instanceof cs))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');e=e||{};var t=e.body;if(n instanceof cs){if(n.bodyUsed)throw new TypeError("Already read");this.url=n.url,this.credentials=n.credentials,e.headers||(this.headers=new ye(n.headers)),this.method=n.method,this.mode=n.mode,this.signal=n.signal,!t&&n._bodyInit!=null&&(t=n._bodyInit,n.bodyUsed=!0)}else this.url=String(n);if(this.credentials=e.credentials||this.credentials||"same-origin",(e.headers||!this.headers)&&(this.headers=new ye(e.headers)),this.method=AT(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal||function(){if("AbortController"in Re){var s=new AbortController;return s.signal}}(),this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&t)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(t),(this.method==="GET"||this.method==="HEAD")&&(e.cache==="no-store"||e.cache==="no-cache")){var r=/([?&])_=[^&]*/;if(r.test(this.url))this.url=this.url.replace(r,"$1_="+new Date().getTime());else{var a=/\?/;this.url+=(a.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}cs.prototype.clone=function(){return new cs(this,{body:this._bodyInit})};function OT(n){var e=new FormData;return n.trim().split("&").forEach(function(t){if(t){var r=t.split("="),a=r.shift().replace(/\+/g," "),s=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(a),decodeURIComponent(s))}}),e}function ET(n){var e=new ye,t=n.replace(/\r?\n[\t ]+/g," ");return t.split("\r").map(function(r){return r.indexOf(`
`)===0?r.substr(1,r.length):r}).forEach(function(r){var a=r.split(":"),s=a.shift().trim();if(s){var i=a.join(":").trim();try{e.append(s,i)}catch(o){console.warn("Response "+o.message)}}}),e}Nw.call(cs.prototype);function xr(n,e){if(!(this instanceof xr))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(e||(e={}),this.type="default",this.status=e.status===void 0?200:e.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=e.statusText===void 0?"":""+e.statusText,this.headers=new ye(e.headers),this.url=e.url||"",this._initBody(n)}Nw.call(xr.prototype);xr.prototype.clone=function(){return new xr(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new ye(this.headers),url:this.url})};xr.error=function(){var n=new xr(null,{status:200,statusText:""});return n.ok=!1,n.status=0,n.type="error",n};var IT=[301,302,303,307,308];xr.redirect=function(n,e){if(IT.indexOf(e)===-1)throw new RangeError("Invalid status code");return new xr(null,{status:e,headers:{location:n}})};var ls=Re.DOMException;try{new ls}catch{ls=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack},ls.prototype=Object.create(Error.prototype),ls.prototype.constructor=ls}function jw(n,e){return new Promise(function(t,r){var a=new cs(n,e);if(a.signal&&a.signal.aborted)return r(new ls("Aborted","AbortError"));var s=new XMLHttpRequest;function i(){s.abort()}s.onload=function(){var l={statusText:s.statusText,headers:ET(s.getAllResponseHeaders()||"")};a.url.indexOf("file://")===0&&(s.status<200||s.status>599)?l.status=200:l.status=s.status,l.url="responseURL"in s?s.responseURL:l.headers.get("X-Request-URL");var c="response"in s?s.response:s.responseText;setTimeout(function(){t(new xr(c,l))},0)},s.onerror=function(){setTimeout(function(){r(new TypeError("Network request failed"))},0)},s.ontimeout=function(){setTimeout(function(){r(new TypeError("Network request timed out"))},0)},s.onabort=function(){setTimeout(function(){r(new ls("Aborted","AbortError"))},0)};function o(l){try{return l===""&&Re.location.href?Re.location.href:l}catch{return l}}if(s.open(a.method,o(a.url),!0),a.credentials==="include"?s.withCredentials=!0:a.credentials==="omit"&&(s.withCredentials=!1),"responseType"in s&&(Ye.blob?s.responseType="blob":Ye.arrayBuffer&&(s.responseType="arraybuffer")),e&&typeof e.headers=="object"&&!(e.headers instanceof ye||Re.Headers&&e.headers instanceof Re.Headers)){var u=[];Object.getOwnPropertyNames(e.headers).forEach(function(l){u.push(Pi(l)),s.setRequestHeader(l,em(e.headers[l]))}),a.headers.forEach(function(l,c){u.indexOf(c)===-1&&s.setRequestHeader(c,l)})}else a.headers.forEach(function(l,c){s.setRequestHeader(c,l)});a.signal&&(a.signal.addEventListener("abort",i),s.onreadystatechange=function(){s.readyState===4&&a.signal.removeEventListener("abort",i)}),s.send(typeof a._bodyInit>"u"?null:a._bodyInit)})}jw.polyfill=!0;Re.fetch||(Re.fetch=jw,Re.Headers=ye,Re.Request=cs,Re.Response=xr);var TT="0.5.6",PT=Object.defineProperty,ST=(n,e,t)=>e in n?PT(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,rm=(n,e,t)=>(ST(n,typeof e!="symbol"?e+"":e,t),t),am=class n extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,n)}},sm=class{constructor(e,t,r){rm(this,"abortController"),rm(this,"itr"),rm(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=r}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(let e of this.itr){if("error"in e)throw new Error(e.error);if(yield e,e.done||e.status==="success"){this.doneCallback();return}}throw new Error("Did not receive done or success response in stream.")}},im=async n=>{if(n.ok)return;let e=`Error ${n.status}: ${n.statusText}`,t=null;if(n.headers.get("content-type")?.includes("application/json"))try{t=await n.json(),e=t.error||e}catch{console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response"),e=await n.text()||e}catch{console.log("Failed to get text from error response")}throw new am(e,n.status)};function CT(){return typeof window<"u"&&window.navigator?`${window.navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:typeof process<"u"?`${process.arch} ${process.platform} Node.js/${process.version}`:""}var om=async(n,e,t={})=>{let r={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/${TT} (${CT()})`};return t.headers||(t.headers={}),t.headers={...r,...t.headers},n(e,t)},Mw=async(n,e)=>{let t=await om(n,e);return await im(t),t};var Si=async(n,e,t,r)=>{let s=(o=>o!==null&&typeof o=="object"&&!Array.isArray(o))(t)?JSON.stringify(t):t,i=await om(n,e,{method:"POST",body:s,signal:r?.signal});return await im(i),i},kT=async(n,e,t)=>{let r=await om(n,e,{method:"DELETE",body:JSON.stringify(t)});return await im(r),r},RT=async function*(n){let e=new TextDecoder("utf-8"),t="",r=n.getReader();for(;;){let{done:a,value:s}=await r.read();if(a)break;t+=e.decode(s);let i=t.split(`
`);t=i.pop()??"";for(let o of i)try{yield JSON.parse(o)}catch{console.warn("invalid json: ",o)}}for(let a of t.split(`
`).filter(s=>s!==""))try{yield JSON.parse(a)}catch{console.warn("invalid json: ",a)}},NT=n=>{if(!n)return"http://127.0.0.1:11434";let e=n.includes("://");n.startsWith(":")&&(n=`http://127.0.0.1${n}`,e=!1),e||(n=`http://${n}`);let t=new URL(n),r=t.port;r||(e?r=t.protocol==="https:"?"443":"80":r="11434");let a=`${t.protocol}//${t.hostname}:${r}${t.pathname}`;return a.endsWith("/")&&(a=a.slice(0,-1)),a},jT=Object.defineProperty,MT=(n,e,t)=>e in n?jT(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,nm=(n,e,t)=>(MT(n,typeof e!="symbol"?e+"":e,t),t),ed=class{constructor(e){nm(this,"config"),nm(this,"fetch"),nm(this,"ongoingStreamedRequests",[]),this.config={host:""},e?.proxy||(this.config.host=NT(e?.host??"http://127.0.0.1:11434")),this.fetch=fetch,e?.fetch!=null&&(this.fetch=e.fetch)}abort(){for(let e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,t){t.stream=t.stream??!1;let r=`${this.config.host}/api/${e}`;if(t.stream){let s=new AbortController,i=await Si(this.fetch,r,t,{signal:s.signal});if(!i.body)throw new Error("Missing body");let o=RT(i.body),u=new sm(s,o,()=>{let l=this.ongoingStreamedRequests.indexOf(u);l>-1&&this.ongoingStreamedRequests.splice(l,1)});return this.ongoingStreamedRequests.push(u),u}return await(await Si(this.fetch,r,t)).json()}async encodeImage(e){if(typeof e!="string"){let t=new Uint8Array(e),r="",a=t.byteLength;for(let s=0;s<a;s++)r+=String.fromCharCode(t[s]);return btoa(r)}return e}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(let t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{name:e.model,stream:e.stream,modelfile:e.modelfile,quantize:e.quantize})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await kT(this.fetch,`${this.config.host}/api/delete`,{name:e.model}),{status:"success"}}async copy(e){return await Si(this.fetch,`${this.config.host}/api/copy`,{...e}),{status:"success"}}async list(){return await(await Mw(this.fetch,`${this.config.host}/api/tags`)).json()}async show(e){return await(await Si(this.fetch,`${this.config.host}/api/show`,{...e})).json()}async embed(e){return await(await Si(this.fetch,`${this.config.host}/api/embed`,{...e})).json()}async embeddings(e){return await(await Si(this.fetch,`${this.config.host}/api/embeddings`,{...e})).json()}async ps(){return await(await Mw(this.fetch,`${this.config.host}/api/ps`)).json()}},$T=new ed;async function td(n,e){let t;try{switch(n){case lt[0]:let r=await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw acode.alert("AI Assistant",`Error fetching OpenAI models: ${r.statusText}`),new Error(`Error fetching OpenAI models: ${r.statusText}`);t=(await r.json()).data.filter(d=>/gpt/i.test(d.id)).map(d=>d.id);break;case lt[1]:let s=await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${e}`,{headers:{"Content-Type":"application/json"}});if(!s.ok)throw acode.alert("AI Assistant",`Error fetching Google AI models: ${s.statusText}`),new Error(`Error fetching Google AI models: ${s.statusText}`);t=(await s.json()).models.filter(d=>/gemini/i.test(d.name)).map(d=>d.name.replace(/^models\//,""));break;case lt[2]:let o=window.localStorage.getItem("Ollama-Host")?window.localStorage.getItem("Ollama-Host"):"http://localhost:11434";t=(await new ed({host:o}).list()).models.map(d=>d.model);break;case lt[3]:let c=await fetch("https://api.groq.com/openai/v1/models",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!c.ok)throw acode.alert("AI Assistant",`Error fetching Groq AI models: ${c.statusText}`),new Error(`Error fetching Groq AI models: ${c.statusText}`);t=(await c.json()).data.map(d=>d.id);break;case OPENAI_LIKE:return[];default:throw new Error(`Unsupported provider: ${n}`)}}catch(r){return console.error(r.message),[]}return t}var Eq=acode.require("multiPrompt"),Ue=acode.require("fs"),Ci=acode.require("select"),Ar=acode.require("prompt"),LT=acode.require("dialogBox"),DT=acode.require("helpers"),Or=acode.require("loader"),Iq=acode.require("sidebarApps"),Tq=acode.require("toInternalUrl"),FT=acode.require("contextMenu"),UT=acode.require("selectionMenu"),{editor:BT}=editorManager,rd=window.DATA_STORAGE+"chatgpt",en=null,lm=class{async init(e){this.$githubDarkFile=tag("link",{rel:"stylesheet",href:this.baseUrl+"assets/github-dark.css"}),this.$higlightJsFile=tag("script",{src:this.baseUrl+"assets/highlight.min.js"}),this.$markdownItFile=tag("script",{src:this.baseUrl+"assets/markdown-it.min.js"}),this.$style=tag("style",{textContent:cm}),document.head.append(this.$githubDarkFile,this.$higlightJsFile,this.$markdownItFile,this.$style),BT.commands.addCommand({name:"ai_assistant",description:"AI Assistant",exec:this.run.bind(this)}),UT.add(async()=>{let l=await Ci("AI Actions",["Explain Code","Rewrite","Generate Code"],{onHide:()=>{window.toast("Work is in progress...",3e3)}})},"\u2728","all"),e.id="acode-ai-assistant",e.settitle("AI Assistant"),this.$page=e;let t=tag("span",{className:"icon more_vert",dataset:{action:"toggle-menu"}}),r=tag("span",{className:"icon historyrestore",dataset:{action:"history"}}),a=tag("span",{className:"icon add",dataset:{action:"new-chat"}}),s=tag("span",{className:"icon insert_invitationevent",dataset:{action:"insert-context"}});this.$page.header.append(a,s,r,t),r.onclick=this.myHistory.bind(this),a.onclick=this.newChat.bind(this);let o=FT({innerHTML:()=>`
        <li action="model-provider" provider="">Provider: ${window.localStorage.getItem("ai-assistant-provider")}</li>
        <li action="model" modelNme="">Model: ${window.localStorage.getItem("ai-assistant-model-name")}</li>
        `,...{top:"35px",right:"10px",toggler:t,transformOrigin:"top right"}});o.onclick=async l=>{switch(o.hide(),l.target.getAttribute("action")){case"model-provider":let f=window.localStorage.getItem("ai-assistant-provider"),d=await Ci("Select AI Provider",lt,{default:f||""});if(f!=d)if(d===Rt){let g=await Ar("API Key","","text",{required:!0});if(!g)return;let m=await Ar("API Base URL","https://api.openai.com/v1","text",{required:!0}),b=await Ar("Model Name","","text",{required:!0});if(!b)return;window.localStorage.setItem("ai-assistant-provider",Rt),window.localStorage.setItem("ai-assistant-model-name",b),window.localStorage.setItem("openai-like-baseurl",m),await this.apiKeyManager.saveAPIKey(Rt,g),this.initiateModel(Rt,g,b),this.newChat()}else if(window.localStorage.getItem(d)===null){let g=d==lt[2]?"No Need Of API Key":await Ar("API key of selected provider","","text",{required:!0});if(!g)return;Or.showTitleLoader(),window.toast("Fetching available models from your account",2e3);let m=await td(d,g);Or.removeTitleLoader();let b=await Ci("Select AI Model",m);window.localStorage.setItem("ai-assistant-provider",d),window.localStorage.setItem("ai-assistant-model-name",b),await this.apiKeyManager.saveAPIKey(d,g),this.initiateModel(d,g,b),this.newChat()}else{let g=await this.apiKeyManager.getAPIKey(d);this.initiateModel(d,g,window.localStorage.getItem("ai-assistant-model-name")),this.newChat()}break;case"model":Or.showTitleLoader(),window.toast("Fetching available models from your account",2e3);let h=window.localStorage.getItem("ai-assistant-provider"),p=await this.apiKeyManager.getAPIKey(h);if(h===Rt){Or.removeTitleLoader();let g=window.localStorage.getItem("ai-assistant-model-name")||"",m=await Ar("Enter Model Name",g,"text",{required:!0});m&&(window.localStorage.setItem("ai-assistant-model-name",m),this.initiateModel(Rt,p,m))}else{let g=await td(h,p);Or.removeTitleLoader();let m=await Ci("Select AI Model",g,{default:window.localStorage.getItem("ai-assistant-model-name")||""});window.localStorage.getItem("ai-assistant-model-name")!=m&&(window.localStorage.setItem("ai-assistant-model-name",m),this.initiateModel(h,p,m))}break}};let u=tag("div",{className:"mainApp"});this.$chatBox=tag("div",{className:"chatBox"}),this.$inputBox=tag("div",{className:"inputBox"}),this.$chatTextarea=tag("textarea",{className:"chatTextarea",placeholder:"Type your query..."}),this.$sendBtn=tag("button",{className:"sendBtn"}),this.$sendBtn.innerHTML=Iw,this.$stopGenerationBtn=tag("button",{className:"stopGenerationBtn hide"}),this.$stopGenerationBtn.innerHTML=Pw,this.$stopGenerationBtn.onclick=this.stopGenerating.bind(this),this.$inputBox.append(this.$chatTextarea,this.$sendBtn,this.$stopGenerationBtn),u.append(this.$inputBox,this.$chatBox),this.$page.append(u),this.messageHistories={},this.messageSessionConfig={configurable:{sessionId:zt()}}}async run(){try{let e;if(await Ue(window.DATA_STORAGE+"secret.key").exists())e=await Ue(window.DATA_STORAGE+"secret.key").readFile("utf-8");else{let s=await Ar("Enter a secret pass pharse to save the api key","","text",{required:!0});if(!s)return;e=s}this.apiKeyManager=new Qc(e);let t,r=window.localStorage.getItem("ai-assistant-provider");if(r)t=await this.apiKeyManager.getAPIKey(r);else{let s=await Ci("Select AI Provider",lt);if(s===Rt){let i=await Ar("API Key","","text",{required:!0});if(!i)return;let o=await Ar("API Base URL","https://api.openai.com/v1","text",{required:!0}),u=await Ar("Model Name","","text",{required:!0});if(!u)return;window.localStorage.setItem("ai-assistant-provider",Rt),window.localStorage.setItem("ai-assistant-model-name",u),window.localStorage.setItem("openai-like-baseurl",o),t=i,r=Rt,await Ue(window.DATA_STORAGE).createFile("secret.key",e),await this.apiKeyManager.saveAPIKey(Rt,t),window.toast("Configuration saved \u{1F389}",3e3)}else{let i=s==lt[2]?"No Need Of API Key":await Ar("API key of selected provider","","text",{required:!0});if(!i)return;Or.showTitleLoader(),window.toast("Fetching available models from your account",2e3);let o=await td(s,i);Or.removeTitleLoader();let u=await Ci("Select AI Model",o);window.localStorage.setItem("ai-assistant-provider",s),window.localStorage.setItem("ai-assistant-model-name",u),r=s,t=i,await Ue(window.DATA_STORAGE).createFile("secret.key",e),await this.apiKeyManager.saveAPIKey(r,t),window.toast("Configuration saved \u{1F389}",3e3)}}let a=window.localStorage.getItem("ai-assistant-model-name");this.initiateModel(r,t,a),this.$mdIt=window.markdownit({html:!1,xhtmlOut:!1,breaks:!1,linkify:!1,typographer:!1,quotes:"\u201C\u201D\u2018\u2019",highlight:function(s,i){let o=document.createElement("button");o.classList.add("copy-button"),o.innerHTML=Tw,o.setAttribute("data-str",s);let u=`<pre class="hljs codesArea"><code>${hljs.highlightAuto(s).value}</code></pre>`;return`<div class="codeBlock">${o.outerHTML}${u}</div>`}}),this.$sendBtn.addEventListener("click",this.sendQuery.bind(this)),this.$page.show()}catch(e){console.log(e)}}initiateModel(e,t,r){switch(e){case lt[0]:this.modelInstance=new Ti({apiKey:t,model:r});break;case lt[1]:this.modelInstance=new Nl({model:r,apiKey:t,safetySettings:[{category:lu.HARM_CATEGORY_HARASSMENT,threshold:cu.BLOCK_LOW_AND_ABOVE}]});break;case lt[2]:let a=window.localStorage.getItem("Ollama-Host")?window.localStorage.getItem("Ollama-Host"):"http://localhost:11434";this.modelInstance=new vl({baseUrl:a,model:r});break;case lt[3]:this.modelInstance=new zl({apiKey:t,model:r});break;case Rt:let s=window.localStorage.getItem("openai-like-baseurl")||"https://api.openai.com/v1";this.modelInstance=new Ti({apiKey:t,model:r,configuration:{baseURL:s}});break;default:throw new Error("Unknown provider")}}_sanitizeFileName(e){return e.replace(/[^\w\s.-]/gi,"").trim().replace(/\s+/g,"_")}transformMessages(e){return e.map((r,a)=>a%2===0&&a+1<e.length?{prompt:e[a].content,result:e[a+1].content}:null).filter(r=>r!==null)}async saveHistory(){try{let e=this.messageSessionConfig.configurable.sessionId;if(!this.messageHistories[e].messages.length)return;if(en==null)try{let r=`${this._sanitizeFileName(this.messageHistories[e].messages[0].content.substring(0,30))}__${e}.json`;await Ue(rd).exists()||await Ue(window.DATA_STORAGE).createDirectory("chatgpt");let a=await this.messageHistories[e].getMessages(),s=this.transformMessages(a);en=await Ue(rd).createFile(r,s)}catch(t){alert(t.message)}else try{if(!await Ue(en).exists()){this.newChat(),window.toast("Some error occurred or file you trying to open has been deleted");return}let t=await this.messageHistories[e].getMessages();en=await Ue(en).writeFile(this.transformMessages(t))}catch(t){alert(t.message)}}catch(e){window.alert(e.message)}}newChat(){this.$chatBox.innerHTML="",window.toast("New session",3e3),this.messageHistories={},this.messageSessionConfig={configurable:{sessionId:zt()}},en=null}async getHistoryItems(){if(await Ue(rd).exists()){let e=await Ue(rd).lsDir(),t="";for(let r=0;r<e.length;r++)t+=`<li class="dialog-item" style="background: var(--secondary-color);color: var(--secondary-text-color);padding: 5px;margin-bottom: 5px;border-radius: 8px;font-size:15px;display:flex;flex-direction:row;justify-content:space-between;gap:5px;" data-path="${JSON.parse(JSON.stringify(e[r])).url}">
                  <p class="history-item">${e[r].name.split("__")[0].substring(0,25)}...</p><div><button class="delete-history-btn" style="height:25px;width:25px;border:none;padding:5px;outline:none;border-radius:50%;background:var(--error-text-color);text-align:center;">\u2717</button></div>
                </li>`;return t}else{let e="";return e='<li style="background: var(--secondary-color);color: var(--secondary-text-color);padding: 10px;border-radius: 8px;" data-path="#not-available">Not Available</li>',e}}extractUUID(e){let t=/([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})/,r=e.match(t);return r?r[0]:null}async displayHistory(e,t){this.$chatBox.innerHTML="";let r=e.slice(1,e.length-1),a=this.extractUUID(r);if(!a){this.newChat(),window.toast("Some error occurred");return}if(!await Ue(r).exists()){this.newChat(),window.toast("Some error occurred or file you trying to open has been deleted");return}en=r;try{t.hide(),Or.create("Wait","Fetching chat history....");let s=await Ue(r).readFile(),i=JSON.parse(await DT.decodeText(s));this.messageHistories={},this.messageHistories[a]=new oo;let o=i.flatMap(u=>[new he({content:u.prompt}),new le({content:u.result})]);await this.messageHistories[a].addMessages(o),this.messageSessionConfig={configurable:{sessionId:a}},i.forEach(u=>{this.appendUserQuery(u.prompt),this.appendGptResponse(u.result)}),Or.destroy()}catch(s){Or.destroy(),console.error(s.message)}}async myHistory(){try{let t=`<ul>${await this.getHistoryItems()}</ul>`,r=LT("Conversation History",t,"Cancel");r.onclick(async a=>{let s=a.target.closest(".dialog-item"),i=s.querySelector(".delete-history-btn"),o=s.querySelector(".history-item");if(s.getAttribute("data-path")!="#not-available"&&s.getAttribute("data-path")){if(a.target===s||a.target===o){let u=JSON.stringify(s.getAttribute("data-path"));this.displayHistory(u,r)}else if(a.target===i){let u=JSON.stringify(s.getAttribute("data-path")),l=u.slice(1,u.length-1);if(await Ue(s.getAttribute("data-path")).delete(),en==l){let c=document.querySelector(".chatBox");c.innerHTML="",this.messageHistories={},this.messageSessionConfig={configurable:{sessionId:zt()}}}s.remove(),window.toast("Deleted",3e3),en=null}}})}catch(e){window.alert(e.message)}}async sendQuery(){let e=this.$chatTextarea;e.value!=""&&(this.appendUserQuery(e.value),this.scrollToBottom(),this.appendGptResponse(""),this.loader(),this.getChatgptResponse(e.value),e.value="")}async appendUserQuery(e){try{let t=this.baseUrl+"assets/user_avatar.png",r=tag("div",{className:"wrapper"}),a=tag("div",{className:"chat"}),s=tag("div",{className:"profile",child:tag("img",{src:t,alt:"user"})}),i=tag("div",{className:"message",textContent:e});a.append(s,i),r.append(a),this.$chatBox.appendChild(r)}catch(t){window.alert(t)}}async appendGptResponse(e){let t=this.baseUrl+"assets/ai_assistant.svg",r=tag("div",{className:"ai_wrapper"}),a=tag("div",{className:"ai_chat"}),s=tag("div",{className:"ai_profile",child:tag("img",{src:t,alt:"ai"})}),i=tag("div",{className:"ai_message"});i.innerHTML=this.$mdIt.render(e);let o=i.querySelectorAll(".copy-button");if(o)for(let u of o)u.addEventListener("click",function(){(0,um.default)(this.dataset.str),window.toast("Copied to clipboard",3e3)});a.append(s,i),r.append(a),this.$chatBox.appendChild(r)}async stopGenerating(){this.abortController.abort(),this.$stopGenerationBtn.classList.add("hide"),this.$sendBtn.classList.remove("hide")}async getChatgptResponse(e){try{let t=Array.from(document.querySelectorAll(".ai_message"));this.abortController=new AbortController;let{signal:r}=this.abortController,a=zs.fromMessages([["system","You are an AI assistant for the open source plugin AI Assistant for Acode code editor(open source vscode like code editor for Android)."],["placeholder","{chat_history}"],["human","{input}"]]),s=new xl,i=a.pipe(this.modelInstance).pipe(s),u=await new uo({runnable:i,getMessageHistory:async h=>{if(this.messageHistories[h]===void 0)this.messageHistories[h]=new oo;else{let p=await this.messageHistories[h].getMessages();this.messageHistories[h].addMessages(p.slice(-6))}return this.messageHistories[h]},inputMessagesKey:"input",historyMessagesKey:"chat_history"}).stream({input:e},this.messageSessionConfig,r);clearInterval(this.$loadInterval),this.$sendBtn.classList.add("hide"),this.$stopGenerationBtn.classList.remove("hide");let l=t[t.length-1];l.innerHTML="";let c="";for await(let h of u)c+=h,l.textContent+=h,this.scrollToBottom();let f=this.$mdIt.render(c);l.innerHTML=f;let d=l.querySelectorAll(".copy-button");if(d)for(let h of d)h.addEventListener("click",function(){(0,um.default)(this.dataset.str),window.toast("Copied to clipboard",3e3)});this.$stopGenerationBtn.classList.add("hide"),this.$sendBtn.classList.remove("hide"),await this.saveHistory()}catch(t){let r=Array.from(document.querySelectorAll(".ai_message"));clearInterval(this.$loadInterval);let a=r[r.length-1];a.innerHTML="";let s=tag("div",{className:"error-box"});console.log(t),t.response?s.innerText=`Status code: ${t.response.status}
${JSON.stringify(t.response.data)}`:s.innerText=`${t.message}`,a.appendChild(s),this.$stopGenerationBtn.classList.add("hide"),this.$sendBtn.classList.remove("hide")}}async scrollToBottom(){this.$chatBox.scrollTop=this.$chatBox.scrollHeight}async loader(){let e=Array.from(document.querySelectorAll(".ai_message"));e.length!=0&&(this.$loadInterval=setInterval(()=>{e[e.length-1].innerText+="\u2022",e[e.length-1].innerText=="\u2022\u2022\u2022\u2022\u2022\u2022"&&(e[e.length-1].innerText="\u2022")},300))}async destroy(){editorManager.editor.commands.removeCommand("ai_assistant"),window.localStorage.removeItem(window.localStorage.getItem("ai-assistant-provider")),window.localStorage.removeItem("ai-assistant-provider"),window.localStorage.removeItem("ai-assistant-model-name"),window.localStorage.removeItem("openai-like-baseurl"),await Ue(window.DATA_STORAGE+"secret.key").exists()&&await Ue(window.DATA_STORAGE+"secret.key").delete(),this.$githubDarkFile.remove(),this.$higlightJsFile.remove(),this.$markdownItFile.remove(),this.$style.remove()}};if(window.acode){let n=new lm;acode.setPluginInit(sd.id,(e,t,{cacheFileUrl:r,cacheFile:a})=>{e.endsWith("/")||(e+="/"),n.baseUrl=e,n.init(t,a,r)}),acode.setPluginUnmount(sd.id,()=>{n.destroy()})}})();
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

mustache/mustache.mjs:
  (*!
   * mustache.js - Logic-less {{mustache}} templates with JavaScript
   * http://github.com/janl/mustache.js
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)
*/
