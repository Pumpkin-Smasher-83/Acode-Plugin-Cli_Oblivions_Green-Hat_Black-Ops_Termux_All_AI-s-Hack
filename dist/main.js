(()=>{var N0=Object.create;var yf=Object.defineProperty;var j0=Object.getOwnPropertyDescriptor;var M0=Object.getOwnPropertyNames;var $0=Object.getPrototypeOf,L0=Object.prototype.hasOwnProperty;var y=(n,e)=>()=>(n&&(e=n(n=0)),e);var Fe=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),ya=(n,e)=>{for(var t in e)yf(n,t,{get:e[t],enumerable:!0})},D0=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of M0(e))!L0.call(n,a)&&a!==t&&yf(n,a,{get:()=>e[a],enumerable:!(r=j0(e,a))||r.enumerable});return n};var q=(n,e,t)=>(t=n!=null?N0($0(n)):{},D0(e||!n||!n.__esModule?yf(t,"default",{value:n,enumerable:!0}):t,n));var sl=Fe((gk,fb)=>{"use strict";fb.exports=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var il=Fe((bk,wf)=>{"use strict";var F0=/[\p{Lu}]/u,B0=/[\p{Ll}]/u,hb=/^[\p{Lu}](?![\p{Lu}])/gu,gb=/([\p{Alpha}\p{N}_]|$)/u,bb=/[_.\- ]+/,z0=new RegExp("^"+bb.source),pb=new RegExp(bb.source+gb.source,"gu"),mb=new RegExp("\\d+"+gb.source,"gu"),H0=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){let o=n[i];r&&F0.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&B0.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},G0=(n,e)=>(hb.lastIndex=0,n.replace(hb,t=>e(t))),V0=(n,e)=>(pb.lastIndex=0,mb.lastIndex=0,n.replace(pb,(t,r)=>e(r)).replace(mb,t=>e(t))),yb=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";let t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=H0(n,t,r)),n=n.replace(z0,""),e.preserveConsecutiveUppercase?n=G0(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),V0(n,r))};wf.exports=yb;wf.exports.default=yb});var Tb=Fe((bC,Ib)=>{function Mt(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Ib.exports=Mt;Mt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Mt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Mt.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};Mt.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Mt.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};Mt.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};Mt.prototype.start=Mt.prototype.try;Mt.prototype.errors=function(){return this._errors};Mt.prototype.attempts=function(){return this._attempts};Mt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e}});var Pb=Fe(xa=>{var X0=Tb();xa.operation=function(n){var e=xa.timeouts(n);return new X0(e,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})};xa.timeouts=function(n){if(n instanceof Array)return[].concat(n);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in n)e[t]=n[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<e.retries;a++)r.push(this.createTimeout(a,e));return n&&n.forever&&!r.length&&r.push(this.createTimeout(a,e)),r.sort(function(s,i){return s-i}),r};xa.createTimeout=function(n,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,n));return r=Math.min(r,e.maxTimeout),r};xa.wrap=function(n,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in n)typeof n[r]=="function"&&t.push(r)}for(var a=0;a<t.length;a++){var s=t[a],i=n[s];n[s]=function(u){var l=xa.operation(e),c=Array.prototype.slice.call(arguments,1),f=c.pop();c.push(function(d){l.retry(d)||(d&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){u.apply(n,c)})}.bind(n,i),n[s].options=e}}});var kb=Fe((_C,Sb)=>{Sb.exports=Pb()});var Or=Fe((wC,hl)=>{"use strict";var Q0=kb(),ex=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],fl=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},tx=(n,e,t)=>{let r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},rx=n=>ex.includes(n),Cb=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};let a=Q0.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof fl)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!rx(i.message))a.stop(),r(i);else{tx(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});hl.exports=Cb;hl.exports.default=Cb;hl.exports.AbortError=fl});var Nb=Fe((vC,If)=>{"use strict";var nx=Object.prototype.hasOwnProperty,Qe="~";function yo(){}Object.create&&(yo.prototype=Object.create(null),new yo().__proto__||(Qe=!1));function ax(n,e,t){this.fn=n,this.context=e,this.once=t||!1}function Rb(n,e,t,r,a){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new ax(t,r||n,a),i=Qe?Qe+e:e;return n._events[i]?n._events[i].fn?n._events[i]=[n._events[i],s]:n._events[i].push(s):(n._events[i]=s,n._eventsCount++),n}function pl(n,e){--n._eventsCount===0?n._events=new yo:delete n._events[e]}function Be(){this._events=new yo,this._eventsCount=0}Be.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)nx.call(t,r)&&e.push(Qe?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};Be.prototype.listeners=function(e){var t=Qe?Qe+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,s=r.length,i=new Array(s);a<s;a++)i[a]=r[a].fn;return i};Be.prototype.listenerCount=function(e){var t=Qe?Qe+e:e,r=this._events[t];return r?r.fn?1:r.length:0};Be.prototype.emit=function(e,t,r,a,s,i){var o=Qe?Qe+e:e;if(!this._events[o])return!1;var u=this._events[o],l=arguments.length,c,f;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,a),!0;case 5:return u.fn.call(u.context,t,r,a,s),!0;case 6:return u.fn.call(u.context,t,r,a,s,i),!0}for(f=1,c=new Array(l-1);f<l;f++)c[f-1]=arguments[f];u.fn.apply(u.context,c)}else{var d=u.length,h;for(f=0;f<d;f++)switch(u[f].once&&this.removeListener(e,u[f].fn,void 0,!0),l){case 1:u[f].fn.call(u[f].context);break;case 2:u[f].fn.call(u[f].context,t);break;case 3:u[f].fn.call(u[f].context,t,r);break;case 4:u[f].fn.call(u[f].context,t,r,a);break;default:if(!c)for(h=1,c=new Array(l-1);h<l;h++)c[h-1]=arguments[h];u[f].fn.apply(u[f].context,c)}}return!0};Be.prototype.on=function(e,t,r){return Rb(this,e,t,r,!1)};Be.prototype.once=function(e,t,r){return Rb(this,e,t,r,!0)};Be.prototype.removeListener=function(e,t,r,a){var s=Qe?Qe+e:e;if(!this._events[s])return this;if(!t)return pl(this,s),this;var i=this._events[s];if(i.fn)i.fn===t&&(!a||i.once)&&(!r||i.context===r)&&pl(this,s);else{for(var o=0,u=[],l=i.length;o<l;o++)(i[o].fn!==t||a&&!i[o].once||r&&i[o].context!==r)&&u.push(i[o]);u.length?this._events[s]=u.length===1?u[0]:u:pl(this,s)}return this};Be.prototype.removeAllListeners=function(e){var t;return e?(t=Qe?Qe+e:e,this._events[t]&&pl(this,t)):(this._events=new yo,this._eventsCount=0),this};Be.prototype.off=Be.prototype.removeListener;Be.prototype.addListener=Be.prototype.on;Be.prefixed=Qe;Be.EventEmitter=Be;typeof If<"u"&&(If.exports=Be)});var Mb=Fe((xC,jb)=>{"use strict";jb.exports=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))});var Lb=Fe((OC,gl)=>{"use strict";var sx=Mb(),ml=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},$b=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}let s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}let i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new ml(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);sx(n.then(r,a),()=>{clearTimeout(s)})});gl.exports=$b;gl.exports.default=$b;gl.exports.TimeoutError=ml});var Db=Fe(Tf=>{"use strict";Object.defineProperty(Tf,"__esModule",{value:!0});function ix(n,e,t){let r=0,a=n.length;for(;a>0;){let s=a/2|0,i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}Tf.default=ix});var Ub=Fe(Sf=>{"use strict";Object.defineProperty(Sf,"__esModule",{value:!0});var ox=Db(),Pf=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}let a=ox.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){let e=this._queue.shift();return e?.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};Sf.default=Pf});var Ar=Fe(Cf=>{"use strict";Object.defineProperty(Cf,"__esModule",{value:!0});var ux=Nb(),Fb=Lb(),lx=Ub(),bl=()=>{},cx=new Fb.TimeoutError,kf=class extends ux{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=bl,this._resolveIdle=bl,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:lx.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=bl,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=bl,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{let s=async()=>{this._pendingCount++,this._intervalCount++;try{let i=this._timeout===void 0&&t.timeout===void 0?e():Fb.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(cx)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};Cf.default=kf});var Gb=Fe(_l=>{"use strict";_l.byteLength=px;_l.toByteArray=gx;_l.fromByteArray=_x;var Er=[],$t=[],hx=typeof Uint8Array<"u"?Uint8Array:Array,Rf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Oa=0,zb=Rf.length;Oa<zb;++Oa)Er[Oa]=Rf[Oa],$t[Rf.charCodeAt(Oa)]=Oa;var Oa,zb;$t[45]=62;$t[95]=63;function Hb(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function px(n){var e=Hb(n),t=e[0],r=e[1];return(t+r)*3/4-r}function mx(n,e,t){return(e+t)*3/4-t}function gx(n){var e,t=Hb(n),r=t[0],a=t[1],s=new hx(mx(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=$t[n.charCodeAt(u)]<<18|$t[n.charCodeAt(u+1)]<<12|$t[n.charCodeAt(u+2)]<<6|$t[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=$t[n.charCodeAt(u)]<<2|$t[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=$t[n.charCodeAt(u)]<<10|$t[n.charCodeAt(u+1)]<<4|$t[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function bx(n){return Er[n>>18&63]+Er[n>>12&63]+Er[n>>6&63]+Er[n&63]}function yx(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(bx(r));return a.join("")}function _x(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(yx(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(Er[e>>2]+Er[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(Er[e>>10]+Er[e>>4&63]+Er[e<<2&63]+"=")),a.join("")}});function Sx(n){Wb=n}function vl(){return Wb}function A(n,e){let t=vl(),r=xl({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===Gs?void 0:Gs].filter(a=>!!a)});n.common.issues.push(r)}function Ol(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}function Zb(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t}function M(n){if(!n)return{};let{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>{var u,l;let{message:c}=n;return i.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:(u=c??r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(l=c??t)!==null&&l!==void 0?l:o.defaultError}},description:a}}function Xb(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function Hx(n){return new RegExp(`^${Xb(n)}$`)}function Qb(n){let e=`${Yb}T${Xb(n)}`,t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Gx(n,e){return!!((e==="v4"||!e)&&Ux.test(n)||(e==="v6"||!e)&&Fx.test(n))}function Vx(n,e){let t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}function zs(n){if(n instanceof dt){let e={};for(let t in n.shape){let r=n.shape[t];e[t]=Lt.create(zs(r))}return new dt({...n._def,shape:()=>e})}else return n instanceof Wr?new Wr({...n._def,type:zs(n.element)}):n instanceof Lt?Lt.create(zs(n.unwrap())):n instanceof Tr?Tr.create(zs(n.unwrap())):n instanceof Ir?Ir.create(n.items.map(e=>zs(e))):n}function Df(n,e){let t=Tn(n),r=Tn(e);if(n===e)return{valid:!0,data:n};if(t===E.object&&r===E.object){let a=H.objectKeys(e),s=H.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(let o of s){let u=Df(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===E.array&&r===E.array){if(n.length!==e.length)return{valid:!1};let a=[];for(let s=0;s<n.length;s++){let i=n[s],o=e[s],u=Df(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===E.date&&r===E.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}function ey(n,e){return new Ma({values:n,typeName:v.ZodEnum,...M(e)})}function ty(n,e={},t){return n?Sn.create().superRefine((r,a)=>{var s,i;if(!n(r)){let o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,l=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...l,fatal:u})}}):Sn.create()}var H,Mf,E,Tn,w,Px,vt,Gs,Wb,xl,kx,ze,R,Hs,et,$f,Lf,vo,xo,I,_o,wo,Dt,Kb,$,Cx,Rx,Nx,jx,Mx,$x,Lx,Dx,jf,Ux,Fx,Bx,Yb,zx,Pn,Ea,Ia,Ta,Pa,Vs,Sa,ka,Sn,Jr,Kt,qs,Wr,dt,Ca,Kr,Al,Ra,Ir,El,Ks,Js,Il,Na,ja,Ma,$a,kn,xt,Lt,Tr,La,Da,Ws,qx,Oo,Ao,Ua,Kx,v,Jx,ry,ny,Wx,Zx,ay,Yx,Xx,Qx,eO,tO,rO,nO,aO,sO,iO,oO,uO,lO,cO,dO,fO,hO,pO,mO,gO,bO,yO,_O,wO,Jb,vO,xO,OO,AO,EO,IO,TO,PO,SO,ye,Pr=y(()=>{(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{let s={};for(let i of a)s[i]=i;return s},n.getValidEnumValues=a=>{let s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(let o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{let s=[];for(let i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(let i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(H||(H={}));(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Mf||(Mf={}));E=H.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Tn=n=>{switch(typeof n){case"undefined":return E.undefined;case"string":return E.string;case"number":return isNaN(n)?E.nan:E.number;case"boolean":return E.boolean;case"function":return E.function;case"bigint":return E.bigint;case"symbol":return E.symbol;case"object":return Array.isArray(n)?E.array:n===null?E.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?E.promise:typeof Map<"u"&&n instanceof Map?E.map:typeof Set<"u"&&n instanceof Set?E.set:typeof Date<"u"&&n instanceof Date?E.date:E.object;default:return E.unknown}},w=H.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Px=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:"),vt=class n extends Error{constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){let t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(let i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){let l=i.path[u];u===i.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(i))):o[l]=o[l]||{_errors:[]},o=o[l],u++}}};return a(this),r}static assert(e){if(!(e instanceof n))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,H.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},r=[];for(let a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};vt.create=n=>new vt(n);Gs=(n,e)=>{let t;switch(n.code){case w.invalid_type:n.received===E.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case w.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,H.jsonStringifyReplacer)}`;break;case w.unrecognized_keys:t=`Unrecognized key(s) in object: ${H.joinValues(n.keys,", ")}`;break;case w.invalid_union:t="Invalid input";break;case w.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${H.joinValues(n.options)}`;break;case w.invalid_enum_value:t=`Invalid enum value. Expected ${H.joinValues(n.options)}, received '${n.received}'`;break;case w.invalid_arguments:t="Invalid function arguments";break;case w.invalid_return_type:t="Invalid function return type";break;case w.invalid_date:t="Invalid date";break;case w.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:H.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case w.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case w.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case w.custom:t="Invalid input";break;case w.invalid_intersection_types:t="Intersection results could not be merged";break;case w.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case w.not_finite:t="Number must be finite";break;default:t=e.defaultError,H.assertNever(n)}return{message:t}},Wb=Gs;xl=n=>{let{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};if(a.message!==void 0)return{...a,path:s,message:a.message};let o="",u=r.filter(l=>!!l).slice().reverse();for(let l of u)o=l(i,{data:e,defaultError:o}).message;return{...a,path:s,message:o}},kx=[];ze=class n{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if(a.status==="aborted")return R;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let a of t){let s=await a.key,i=await a.value;r.push({key:s,value:i})}return n.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return R;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}},R=Object.freeze({status:"aborted"}),Hs=n=>({status:"dirty",value:n}),et=n=>({status:"valid",value:n}),$f=n=>n.status==="aborted",Lf=n=>n.status==="dirty",vo=n=>n.status==="valid",xo=n=>typeof Promise<"u"&&n instanceof Promise;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e?.message})(I||(I={}));Dt=class{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},Kb=(n,e)=>{if(vo(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new vt(n.common.issues);return this._error=t,this._error}}};$=class{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return Tn(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Tn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ze,ctx:{common:e.parent.common,data:e.data,parsedType:Tn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(xo(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;let a={common:{issues:[],async:(r=t?.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tn(e)},s=this._parseSync({data:e,path:a.path,parent:a});return Kb(a,s)}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Tn(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(xo(a)?a:Promise.resolve(a));return Kb(r,s)}refine(e,t){let r=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{let i=e(a),o=()=>s.addIssue({code:w.custom,...r(a)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new xt({schema:this,typeName:v.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Lt.create(this,this._def)}nullable(){return Tr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Wr.create(this,this._def)}promise(){return kn.create(this,this._def)}or(e){return Ca.create([this,e],this._def)}and(e){return Ra.create(this,e,this._def)}transform(e){return new xt({...M(this._def),schema:this,typeName:v.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new La({...M(this._def),innerType:this,defaultValue:t,typeName:v.ZodDefault})}brand(){return new Oo({typeName:v.ZodBranded,type:this,...M(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new Da({...M(this._def),innerType:this,catchValue:t,typeName:v.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Ao.create(this,e)}readonly(){return Ua.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Cx=/^c[^\s-]{8,}$/i,Rx=/^[0-9a-z]+$/,Nx=/^[0-9A-HJKMNP-TV-Z]{26}$/,jx=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Mx=/^[a-z0-9_-]{21}$/i,$x=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Lx=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Dx="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",Ux=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Fx=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Bx=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Yb="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",zx=new RegExp(`^${Yb}$`);Pn=class n extends ${_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==E.string){let s=this._getOrReturnCtx(e);return A(s,{code:w.invalid_type,expected:E.string,received:s.parsedType}),R}let r=new ze,a;for(let s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:w.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:w.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){let i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?A(a,{code:w.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&A(a,{code:w.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")Lx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"email",code:w.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")jf||(jf=new RegExp(Dx,"u")),jf.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"emoji",code:w.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")jx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"uuid",code:w.invalid_string,message:s.message}),r.dirty());else if(s.kind==="nanoid")Mx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"nanoid",code:w.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")Cx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid",code:w.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")Rx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid2",code:w.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")Nx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"ulid",code:w.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),A(a,{validation:"url",code:w.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"regex",code:w.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),A(a,{code:w.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:w.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:w.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?Qb(s).test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:w.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="date"?zx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:w.invalid_string,validation:"date",message:s.message}),r.dirty()):s.kind==="time"?Hx(s).test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:w.invalid_string,validation:"time",message:s.message}),r.dirty()):s.kind==="duration"?$x.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"duration",code:w.invalid_string,message:s.message}),r.dirty()):s.kind==="ip"?Gx(e.data,s.version)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"ip",code:w.invalid_string,message:s.message}),r.dirty()):s.kind==="base64"?Bx.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"base64",code:w.invalid_string,message:s.message}),r.dirty()):H.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:w.invalid_string,...I.errToObj(r)})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...I.errToObj(e)})}url(e){return this._addCheck({kind:"url",...I.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...I.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...I.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...I.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...I.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...I.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...I.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...I.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...I.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:(t=e?.offset)!==null&&t!==void 0?t:!1,local:(r=e?.local)!==null&&r!==void 0?r:!1,...I.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...I.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...I.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...I.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...I.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...I.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...I.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...I.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...I.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...I.errToObj(t)})}nonempty(e){return this.min(1,I.errToObj(e))}trim(){return new n({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};Pn.create=n=>{var e;return new Pn({checks:[],typeName:v.ZodString,coerce:(e=n?.coerce)!==null&&e!==void 0?e:!1,...M(n)})};Ea=class n extends ${constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==E.number){let s=this._getOrReturnCtx(e);return A(s,{code:w.invalid_type,expected:E.number,received:s.parsedType}),R}let r,a=new ze;for(let s of this._def.checks)s.kind==="int"?H.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),A(r,{code:w.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:w.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:w.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?Vx(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),A(r,{code:w.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),A(r,{code:w.not_finite,message:s.message}),a.dirty()):H.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,I.toString(t))}gt(e,t){return this.setLimit("min",e,!1,I.toString(t))}lte(e,t){return this.setLimit("max",e,!0,I.toString(t))}lt(e,t){return this.setLimit("max",e,!1,I.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:I.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:I.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:I.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:I.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:I.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:I.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:I.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:I.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:I.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:I.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&H.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};Ea.create=n=>new Ea({checks:[],typeName:v.ZodNumber,coerce:n?.coerce||!1,...M(n)});Ia=class n extends ${constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==E.bigint){let s=this._getOrReturnCtx(e);return A(s,{code:w.invalid_type,expected:E.bigint,received:s.parsedType}),R}let r,a=new ze;for(let s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:w.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:w.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),A(r,{code:w.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):H.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,I.toString(t))}gt(e,t){return this.setLimit("min",e,!1,I.toString(t))}lte(e,t){return this.setLimit("max",e,!0,I.toString(t))}lt(e,t){return this.setLimit("max",e,!1,I.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:I.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:I.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:I.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:I.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:I.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:I.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};Ia.create=n=>{var e;return new Ia({checks:[],typeName:v.ZodBigInt,coerce:(e=n?.coerce)!==null&&e!==void 0?e:!1,...M(n)})};Ta=class extends ${_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==E.boolean){let r=this._getOrReturnCtx(e);return A(r,{code:w.invalid_type,expected:E.boolean,received:r.parsedType}),R}return et(e.data)}};Ta.create=n=>new Ta({typeName:v.ZodBoolean,coerce:n?.coerce||!1,...M(n)});Pa=class n extends ${_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==E.date){let s=this._getOrReturnCtx(e);return A(s,{code:w.invalid_type,expected:E.date,received:s.parsedType}),R}if(isNaN(e.data.getTime())){let s=this._getOrReturnCtx(e);return A(s,{code:w.invalid_date}),R}let r=new ze,a;for(let s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:w.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:w.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):H.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:I.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:I.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};Pa.create=n=>new Pa({checks:[],coerce:n?.coerce||!1,typeName:v.ZodDate,...M(n)});Vs=class extends ${_parse(e){if(this._getType(e)!==E.symbol){let r=this._getOrReturnCtx(e);return A(r,{code:w.invalid_type,expected:E.symbol,received:r.parsedType}),R}return et(e.data)}};Vs.create=n=>new Vs({typeName:v.ZodSymbol,...M(n)});Sa=class extends ${_parse(e){if(this._getType(e)!==E.undefined){let r=this._getOrReturnCtx(e);return A(r,{code:w.invalid_type,expected:E.undefined,received:r.parsedType}),R}return et(e.data)}};Sa.create=n=>new Sa({typeName:v.ZodUndefined,...M(n)});ka=class extends ${_parse(e){if(this._getType(e)!==E.null){let r=this._getOrReturnCtx(e);return A(r,{code:w.invalid_type,expected:E.null,received:r.parsedType}),R}return et(e.data)}};ka.create=n=>new ka({typeName:v.ZodNull,...M(n)});Sn=class extends ${constructor(){super(...arguments),this._any=!0}_parse(e){return et(e.data)}};Sn.create=n=>new Sn({typeName:v.ZodAny,...M(n)});Jr=class extends ${constructor(){super(...arguments),this._unknown=!0}_parse(e){return et(e.data)}};Jr.create=n=>new Jr({typeName:v.ZodUnknown,...M(n)});Kt=class extends ${_parse(e){let t=this._getOrReturnCtx(e);return A(t,{code:w.invalid_type,expected:E.never,received:t.parsedType}),R}};Kt.create=n=>new Kt({typeName:v.ZodNever,...M(n)});qs=class extends ${_parse(e){if(this._getType(e)!==E.undefined){let r=this._getOrReturnCtx(e);return A(r,{code:w.invalid_type,expected:E.void,received:r.parsedType}),R}return et(e.data)}};qs.create=n=>new qs({typeName:v.ZodVoid,...M(n)});Wr=class n extends ${_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==E.array)return A(t,{code:w.invalid_type,expected:E.array,received:t.parsedType}),R;if(a.exactLength!==null){let i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(A(t,{code:i?w.too_big:w.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(A(t,{code:w.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(A(t,{code:w.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new Dt(t,i,t.path,o)))).then(i=>ze.mergeArray(r,i));let s=[...t.data].map((i,o)=>a.type._parseSync(new Dt(t,i,t.path,o)));return ze.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new n({...this._def,minLength:{value:e,message:I.toString(t)}})}max(e,t){return new n({...this._def,maxLength:{value:e,message:I.toString(t)}})}length(e,t){return new n({...this._def,exactLength:{value:e,message:I.toString(t)}})}nonempty(e){return this.min(1,e)}};Wr.create=(n,e)=>new Wr({type:n,minLength:null,maxLength:null,exactLength:null,typeName:v.ZodArray,...M(e)});dt=class n extends ${constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=H.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==E.object){let l=this._getOrReturnCtx(e);return A(l,{code:w.invalid_type,expected:E.object,received:l.parsedType}),R}let{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Kt&&this._def.unknownKeys==="strip"))for(let l in a.data)i.includes(l)||o.push(l);let u=[];for(let l of i){let c=s[l],f=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Dt(a,f,a.path,l)),alwaysSet:l in a.data})}if(this._def.catchall instanceof Kt){let l=this._def.unknownKeys;if(l==="passthrough")for(let c of o)u.push({key:{status:"valid",value:c},value:{status:"valid",value:a.data[c]}});else if(l==="strict")o.length>0&&(A(a,{code:w.unrecognized_keys,keys:o}),r.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let l=this._def.catchall;for(let c of o){let f=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Dt(a,f,a.path,c)),alwaysSet:c in a.data})}}return a.common.async?Promise.resolve().then(async()=>{let l=[];for(let c of u){let f=await c.key,d=await c.value;l.push({key:f,value:d,alwaysSet:c.alwaysSet})}return l}).then(l=>ze.mergeObjectSync(r,l)):ze.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return I.errToObj,new n({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;let u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=I.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new n({...this._def,unknownKeys:"strip"})}passthrough(){return new n({...this._def,unknownKeys:"passthrough"})}extend(e){return new n({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new n({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:v.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new n({...this._def,catchall:e})}pick(e){let t={};return H.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}omit(e){let t={};return H.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}deepPartial(){return zs(this)}partial(e){let t={};return H.objectKeys(this.shape).forEach(r=>{let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new n({...this._def,shape:()=>t})}required(e){let t={};return H.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof Lt;)s=s._def.innerType;t[r]=s}}),new n({...this._def,shape:()=>t})}keyof(){return ey(H.objectKeys(this.shape))}};dt.create=(n,e)=>new dt({shape:()=>n,unknownKeys:"strip",catchall:Kt.create(),typeName:v.ZodObject,...M(e)});dt.strictCreate=(n,e)=>new dt({shape:()=>n,unknownKeys:"strict",catchall:Kt.create(),typeName:v.ZodObject,...M(e)});dt.lazycreate=(n,e)=>new dt({shape:n,unknownKeys:"strip",catchall:Kt.create(),typeName:v.ZodObject,...M(e)});Ca=class extends ${_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(let o of s)if(o.result.status==="valid")return o.result;for(let o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let i=s.map(o=>new vt(o.ctx.common.issues));return A(t,{code:w.invalid_union,unionErrors:i}),R}if(t.common.async)return Promise.all(r.map(async s=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s,i=[];for(let u of r){let l={...t,common:{...t.common,issues:[]},parent:null},c=u._parseSync({data:t.data,path:t.path,parent:l});if(c.status==="valid")return c;c.status==="dirty"&&!s&&(s={result:c,ctx:l}),l.common.issues.length&&i.push(l.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;let o=i.map(u=>new vt(u));return A(t,{code:w.invalid_union,unionErrors:o}),R}}get options(){return this._def.options}};Ca.create=(n,e)=>new Ca({options:n,typeName:v.ZodUnion,...M(e)});Kr=n=>n instanceof Na?Kr(n.schema):n instanceof xt?Kr(n.innerType()):n instanceof ja?[n.value]:n instanceof Ma?n.options:n instanceof $a?H.objectValues(n.enum):n instanceof La?Kr(n._def.innerType):n instanceof Sa?[void 0]:n instanceof ka?[null]:n instanceof Lt?[void 0,...Kr(n.unwrap())]:n instanceof Tr?[null,...Kr(n.unwrap())]:n instanceof Oo||n instanceof Ua?Kr(n.unwrap()):n instanceof Da?Kr(n._def.innerType):[],Al=class n extends ${_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.object)return A(t,{code:w.invalid_type,expected:E.object,received:t.parsedType}),R;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(A(t,{code:w.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),R)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let s of t){let i=Kr(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new n({typeName:v.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...M(r)})}};Ra=class extends ${_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if($f(s)||$f(i))return R;let o=Df(s.value,i.value);return o.valid?((Lf(s)||Lf(i))&&t.dirty(),{status:t.value,value:o.data}):(A(r,{code:w.invalid_intersection_types}),R)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};Ra.create=(n,e,t)=>new Ra({left:n,right:e,typeName:v.ZodIntersection,...M(t)});Ir=class n extends ${_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.array)return A(r,{code:w.invalid_type,expected:E.array,received:r.parsedType}),R;if(r.data.length<this._def.items.length)return A(r,{code:w.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),R;!this._def.rest&&r.data.length>this._def.items.length&&(A(r,{code:w.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let s=[...r.data].map((i,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new Dt(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>ze.mergeArray(t,i)):ze.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new n({...this._def,rest:e})}};Ir.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ir({items:n,typeName:v.ZodTuple,rest:null,...M(e)})};El=class n extends ${get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.object)return A(r,{code:w.invalid_type,expected:E.object,received:r.parsedType}),R;let a=[],s=this._def.keyType,i=this._def.valueType;for(let o in r.data)a.push({key:s._parse(new Dt(r,o,r.path,o)),value:i._parse(new Dt(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?ze.mergeObjectAsync(t,a):ze.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof $?new n({keyType:e,valueType:t,typeName:v.ZodRecord,...M(r)}):new n({keyType:Pn.create(),valueType:e,typeName:v.ZodRecord,...M(t)})}},Ks=class extends ${get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.map)return A(r,{code:w.invalid_type,expected:E.map,received:r.parsedType}),R;let a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],l)=>({key:a._parse(new Dt(r,o,r.path,[l,"key"])),value:s._parse(new Dt(r,u,r.path,[l,"value"]))}));if(r.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of i){let l=await u.key,c=await u.value;if(l.status==="aborted"||c.status==="aborted")return R;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of i){let l=u.key,c=u.value;if(l.status==="aborted"||c.status==="aborted")return R;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}}}};Ks.create=(n,e,t)=>new Ks({valueType:e,keyType:n,typeName:v.ZodMap,...M(t)});Js=class n extends ${_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==E.set)return A(r,{code:w.invalid_type,expected:E.set,received:r.parsedType}),R;let a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(A(r,{code:w.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(A(r,{code:w.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function i(u){let l=new Set;for(let c of u){if(c.status==="aborted")return R;c.status==="dirty"&&t.dirty(),l.add(c.value)}return{status:t.value,value:l}}let o=[...r.data.values()].map((u,l)=>s._parse(new Dt(r,u,r.path,l)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new n({...this._def,minSize:{value:e,message:I.toString(t)}})}max(e,t){return new n({...this._def,maxSize:{value:e,message:I.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};Js.create=(n,e)=>new Js({valueType:n,minSize:null,maxSize:null,typeName:v.ZodSet,...M(e)});Il=class n extends ${constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.function)return A(t,{code:w.invalid_type,expected:E.function,received:t.parsedType}),R;function r(o,u){return xl({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,vl(),Gs].filter(l=>!!l),issueData:{code:w.invalid_arguments,argumentsError:u}})}function a(o,u){return xl({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,vl(),Gs].filter(l=>!!l),issueData:{code:w.invalid_return_type,returnTypeError:u}})}let s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof kn){let o=this;return et(async function(...u){let l=new vt([]),c=await o._def.args.parseAsync(u,s).catch(h=>{throw l.addIssue(r(u,h)),l}),f=await Reflect.apply(i,this,c);return await o._def.returns._def.type.parseAsync(f,s).catch(h=>{throw l.addIssue(a(f,h)),l})})}else{let o=this;return et(function(...u){let l=o._def.args.safeParse(u,s);if(!l.success)throw new vt([r(u,l.error)]);let c=Reflect.apply(i,this,l.data),f=o._def.returns.safeParse(c,s);if(!f.success)throw new vt([a(c,f.error)]);return f.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new n({...this._def,args:Ir.create(e).rest(Jr.create())})}returns(e){return new n({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new n({args:e||Ir.create([]).rest(Jr.create()),returns:t||Jr.create(),typeName:v.ZodFunction,...M(r)})}},Na=class extends ${get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};Na.create=(n,e)=>new Na({getter:n,typeName:v.ZodLazy,...M(e)});ja=class extends ${_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return A(t,{received:t.data,code:w.invalid_literal,expected:this._def.value}),R}return{status:"valid",value:e.data}}get value(){return this._def.value}};ja.create=(n,e)=>new ja({value:n,typeName:v.ZodLiteral,...M(e)});Ma=class n extends ${constructor(){super(...arguments),_o.set(this,void 0)}_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),r=this._def.values;return A(t,{expected:H.joinValues(r),received:t.parsedType,code:w.invalid_type}),R}if(Ol(this,_o,"f")||Zb(this,_o,new Set(this._def.values),"f"),!Ol(this,_o,"f").has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return A(t,{received:t.data,code:w.invalid_enum_value,options:r}),R}return et(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return n.create(e,{...this._def,...t})}exclude(e,t=this._def){return n.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}};_o=new WeakMap;Ma.create=ey;$a=class extends ${constructor(){super(...arguments),wo.set(this,void 0)}_parse(e){let t=H.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==E.string&&r.parsedType!==E.number){let a=H.objectValues(t);return A(r,{expected:H.joinValues(a),received:r.parsedType,code:w.invalid_type}),R}if(Ol(this,wo,"f")||Zb(this,wo,new Set(H.getValidEnumValues(this._def.values)),"f"),!Ol(this,wo,"f").has(e.data)){let a=H.objectValues(t);return A(r,{received:r.data,code:w.invalid_enum_value,options:a}),R}return et(e.data)}get enum(){return this._def.values}};wo=new WeakMap;$a.create=(n,e)=>new $a({values:n,typeName:v.ZodNativeEnum,...M(e)});kn=class extends ${unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.promise&&t.common.async===!1)return A(t,{code:w.invalid_type,expected:E.promise,received:t.parsedType}),R;let r=t.parsedType===E.promise?t.data:Promise.resolve(t.data);return et(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}};kn.create=(n,e)=>new kn({type:n,typeName:v.ZodPromise,...M(e)});xt=class extends ${innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===v.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{A(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){let i=a.transform(r.data,s);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return R;let u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?R:u.status==="dirty"||t.value==="dirty"?Hs(u.value):u});{if(t.value==="aborted")return R;let o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?R:o.status==="dirty"||t.value==="dirty"?Hs(o.value):o}}if(a.type==="refinement"){let i=o=>{let u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){let o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?R:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?R:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!vo(i))return i;let o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>vo(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);H.assertNever(a)}};xt.create=(n,e,t)=>new xt({schema:n,typeName:v.ZodEffects,effect:e,...M(t)});xt.createWithPreprocess=(n,e,t)=>new xt({schema:e,effect:{type:"preprocess",transform:n},typeName:v.ZodEffects,...M(t)});Lt=class extends ${_parse(e){return this._getType(e)===E.undefined?et(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Lt.create=(n,e)=>new Lt({innerType:n,typeName:v.ZodOptional,...M(e)});Tr=class extends ${_parse(e){return this._getType(e)===E.null?et(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Tr.create=(n,e)=>new Tr({innerType:n,typeName:v.ZodNullable,...M(e)});La=class extends ${_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===E.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};La.create=(n,e)=>new La({innerType:n,typeName:v.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...M(e)});Da=class extends ${_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return xo(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new vt(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new vt(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};Da.create=(n,e)=>new Da({innerType:n,typeName:v.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...M(e)});Ws=class extends ${_parse(e){if(this._getType(e)!==E.nan){let r=this._getOrReturnCtx(e);return A(r,{code:w.invalid_type,expected:E.nan,received:r.parsedType}),R}return{status:"valid",value:e.data}}};Ws.create=n=>new Ws({typeName:v.ZodNaN,...M(n)});qx=Symbol("zod_brand"),Oo=class extends ${_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},Ao=class n extends ${_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?R:s.status==="dirty"?(t.dirty(),Hs(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{let a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?R:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new n({in:e,out:t,typeName:v.ZodPipeline})}},Ua=class extends ${_parse(e){let t=this._def.innerType._parse(e),r=a=>(vo(a)&&(a.value=Object.freeze(a.value)),a);return xo(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}};Ua.create=(n,e)=>new Ua({innerType:n,typeName:v.ZodReadonly,...M(e)});Kx={object:dt.lazycreate};(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(v||(v={}));Jx=(n,e={message:`Input not instance of ${n.name}`})=>ty(t=>t instanceof n,e),ry=Pn.create,ny=Ea.create,Wx=Ws.create,Zx=Ia.create,ay=Ta.create,Yx=Pa.create,Xx=Vs.create,Qx=Sa.create,eO=ka.create,tO=Sn.create,rO=Jr.create,nO=Kt.create,aO=qs.create,sO=Wr.create,iO=dt.create,oO=dt.strictCreate,uO=Ca.create,lO=Al.create,cO=Ra.create,dO=Ir.create,fO=El.create,hO=Ks.create,pO=Js.create,mO=Il.create,gO=Na.create,bO=ja.create,yO=Ma.create,_O=$a.create,wO=kn.create,Jb=xt.create,vO=Lt.create,xO=Tr.create,OO=xt.createWithPreprocess,AO=Ao.create,EO=()=>ry().optional(),IO=()=>ny().optional(),TO=()=>ay().optional(),PO={string:n=>Pn.create({...n,coerce:!0}),number:n=>Ea.create({...n,coerce:!0}),boolean:n=>Ta.create({...n,coerce:!0}),bigint:n=>Ia.create({...n,coerce:!0}),date:n=>Pa.create({...n,coerce:!0})},SO=R,ye=Object.freeze({__proto__:null,defaultErrorMap:Gs,setErrorMap:Sx,getErrorMap:vl,makeIssue:xl,EMPTY_PATH:kx,addIssueToContext:A,ParseStatus:ze,INVALID:R,DIRTY:Hs,OK:et,isAborted:$f,isDirty:Lf,isValid:vo,isAsync:xo,get util(){return H},get objectUtil(){return Mf},ZodParsedType:E,getParsedType:Tn,ZodType:$,datetimeRegex:Qb,ZodString:Pn,ZodNumber:Ea,ZodBigInt:Ia,ZodBoolean:Ta,ZodDate:Pa,ZodSymbol:Vs,ZodUndefined:Sa,ZodNull:ka,ZodAny:Sn,ZodUnknown:Jr,ZodNever:Kt,ZodVoid:qs,ZodArray:Wr,ZodObject:dt,ZodUnion:Ca,ZodDiscriminatedUnion:Al,ZodIntersection:Ra,ZodTuple:Ir,ZodRecord:El,ZodMap:Ks,ZodSet:Js,ZodFunction:Il,ZodLazy:Na,ZodLiteral:ja,ZodEnum:Ma,ZodNativeEnum:$a,ZodPromise:kn,ZodEffects:xt,ZodTransformer:xt,ZodOptional:Lt,ZodNullable:Tr,ZodDefault:La,ZodCatch:Da,ZodNaN:Ws,BRAND:qx,ZodBranded:Oo,ZodPipeline:Ao,ZodReadonly:Ua,custom:ty,Schema:$,ZodSchema:$,late:Kx,get ZodFirstPartyTypeKind(){return v},coerce:PO,any:tO,array:sO,bigint:Zx,boolean:ay,date:Yx,discriminatedUnion:lO,effect:Jb,enum:yO,function:mO,instanceof:Jx,intersection:cO,lazy:gO,literal:bO,map:hO,nan:Wx,nativeEnum:_O,never:nO,null:eO,nullable:xO,number:ny,object:iO,oboolean:TO,onumber:IO,optional:vO,ostring:EO,pipeline:AO,preprocess:OO,promise:wO,record:fO,set:pO,strictObject:oO,string:ry,symbol:Xx,transformer:Jb,tuple:dO,undefined:Qx,union:uO,unknown:rO,void:aO,NEVER:SO,ZodIssueCode:w,quotelessJson:Px,ZodError:vt})});function Uf(){if(!Tl&&(Tl=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Tl))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Tl(kO)}var Tl,kO,sy=y(()=>{kO=new Uint8Array(16)});var iy,oy=y(()=>{iy=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i});function CO(n){return typeof n=="string"&&iy.test(n)}var Ot,uy=y(()=>{oy();Ot=CO});function ly(n,e=0){return je[n[e+0]]+je[n[e+1]]+je[n[e+2]]+je[n[e+3]]+"-"+je[n[e+4]]+je[n[e+5]]+"-"+je[n[e+6]]+je[n[e+7]]+"-"+je[n[e+8]]+je[n[e+9]]+"-"+je[n[e+10]]+je[n[e+11]]+je[n[e+12]]+je[n[e+13]]+je[n[e+14]]+je[n[e+15]]}var je,cy=y(()=>{je=[];for(let n=0;n<256;++n)je.push((n+256).toString(16).slice(1))});var RO,Ff,dy=y(()=>{RO=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ff={randomUUID:RO}});function NO(n,e,t){if(Ff.randomUUID&&!e&&!n)return Ff.randomUUID();n=n||{};let r=n.random||(n.rng||Uf)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let a=0;a<16;++a)e[t+a]=r[a];return e}return ly(r)}var S,fy=y(()=>{dy();sy();cy();S=NO});var ce=y(()=>{fy();uy()});var Sl=Fe((nR,yy)=>{"use strict";var gy=(n=0)=>e=>`\x1B[${38+n};5;${e}m`,by=(n=0)=>(e,t,r)=>`\x1B[${38+n};2;${e};${t};${r}m`;function FO(){let n=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,r]of Object.entries(e)){for(let[a,s]of Object.entries(r))e[a]={open:`\x1B[${s[0]}m`,close:`\x1B[${s[1]}m`},r[a]=e[a],n.set(s[0],s[1]);Object.defineProperty(e,t,{value:r,enumerable:!1})}return Object.defineProperty(e,"codes",{value:n,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=gy(),e.color.ansi16m=by(),e.bgColor.ansi256=gy(10),e.bgColor.ansi16m=by(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,r,a)=>t===r&&r===a?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(a/255*5),enumerable:!1},hexToRgb:{value:t=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!r)return[0,0,0];let{colorString:a}=r.groups;a.length===3&&(a=a.split("").map(i=>i+i).join(""));let s=Number.parseInt(a,16);return[s>>16&255,s>>8&255,s&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(yy,"exports",{enumerable:!0,get:FO})});var Ry,Cy,Ny,ql=y(()=>{Ry=Symbol("Let zodToJsonSchema decide on which parser to use"),Cy={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email",base64Strategy:"contentEncoding:base64"},Ny=n=>typeof n=="string"?{...Cy,name:n}:{...Cy,...n}});var jy,ch=y(()=>{ql();jy=n=>{let e=Ny(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}}});function dh(n,e,t,r){r?.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function z(n,e,t,r,a){n[e]=t,dh(n,e,r,a)}var Nn=y(()=>{});function My(){return{}}var fh=y(()=>{});function $y(n,e){let t={type:"array"};return n.type?._def?.typeName!==v.ZodAny&&(t.items=C(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&z(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&z(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(z(t,"minItems",n.exactLength.value,n.exactLength.message,e),z(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}var hh=y(()=>{Pr();Nn();de()});function Ly(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?z(t,"minimum",r.value,r.message,e):z(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),z(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?z(t,"maximum",r.value,r.message,e):z(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),z(t,"maximum",r.value,r.message,e));break;case"multipleOf":z(t,"multipleOf",r.value,r.message,e);break}return t}var ph=y(()=>{Nn()});function Dy(){return{type:"boolean"}}var mh=y(()=>{});function Uy(n,e){return C(n.type._def,e)}var gh=y(()=>{de()});var Fy,bh=y(()=>{de();Fy=(n,e)=>C(n.innerType._def,e)});function yh(n,e,t){let r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>yh(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return dA(n,e)}}var dA,_h=y(()=>{Nn();dA=(n,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let r of n.checks)switch(r.kind){case"min":z(t,"minimum",r.value,r.message,e);break;case"max":z(t,"maximum",r.value,r.message,e);break}return t}});function By(n,e){return{...C(n.innerType._def,e),default:n.defaultValue()}}var wh=y(()=>{de()});function zy(n,e){return e.effectStrategy==="input"?C(n.schema._def,e):{}}var vh=y(()=>{de()});function Hy(n){return{type:"string",enum:n.values}}var xh=y(()=>{});function Gy(n,e){let t=[C(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),C(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if(fA(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}var fA,Oh=y(()=>{de();fA=n=>"type"in n&&n.type==="string"?!1:"allOf"in n});function Vy(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var Ah=y(()=>{});function Kl(n,e){let t={type:"string"};function r(a){return e.patternStrategy==="escape"?hA(a):a}if(n.checks)for(let a of n.checks)switch(a.kind){case"min":z(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":z(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Xt(t,"email",a.message,e);break;case"format:idn-email":Xt(t,"idn-email",a.message,e);break;case"pattern:zod":Qt(t,Ga.email,a.message,e);break}break;case"url":Xt(t,"uri",a.message,e);break;case"uuid":Xt(t,"uuid",a.message,e);break;case"regex":Qt(t,a.regex.source,a.message,e);break;case"cuid":Qt(t,Ga.cuid,a.message,e);break;case"cuid2":Qt(t,Ga.cuid2,a.message,e);break;case"startsWith":Qt(t,"^"+r(a.value),a.message,e);break;case"endsWith":Qt(t,r(a.value)+"$",a.message,e);break;case"datetime":Xt(t,"date-time",a.message,e);break;case"date":Xt(t,"date",a.message,e);break;case"time":Xt(t,"time",a.message,e);break;case"duration":Xt(t,"duration",a.message,e);break;case"length":z(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),z(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{Qt(t,r(a.value),a.message,e);break}case"ip":{a.version!=="v6"&&Xt(t,"ipv4",a.message,e),a.version!=="v4"&&Xt(t,"ipv6",a.message,e);break}case"emoji":Qt(t,Ga.emoji,a.message,e);break;case"ulid":{Qt(t,Ga.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Xt(t,"binary",a.message,e);break}case"contentEncoding:base64":{z(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{Qt(t,Ga.base64,a.message,e);break}}break}case"nanoid":Qt(t,Ga.nanoid,a.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var Ga,hA,Xt,Qt,Jl=y(()=>{Nn();Ga={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$",base64:"^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$",nanoid:"^[a-zA-Z0-9_-]{21}$"};hA=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Xt=(n,e,t,r)=>{n.format||n.anyOf?.some(a=>a.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):z(n,"format",e,t,r)},Qt=(n,e,t,r)=>{n.pattern||n.allOf?.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:e,...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):z(n,"pattern",e,t,r)}});function Wl(n,e){if(e.target==="openApi3"&&n.keyType?._def.typeName===v.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((r,a)=>({...r,[a]:C(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",a]})??{}}),{}),additionalProperties:!1};let t={type:"object",additionalProperties:C(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(n.keyType?._def.typeName===v.ZodString&&n.keyType._def.checks?.length){let r=Object.entries(Kl(n.keyType._def,e)).reduce((a,[s,i])=>s==="type"?a:{...a,[s]:i},{});return{...t,propertyNames:r}}else if(n.keyType?._def.typeName===v.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}var Zl=y(()=>{Pr();de();Jl()});function qy(n,e){if(e.mapStrategy==="record")return Wl(n,e);let t=C(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=C(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}var Eh=y(()=>{de();Zl()});function Ky(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}var Ih=y(()=>{});function Jy(){return{not:{}}}var Th=y(()=>{});function Wy(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Ph=y(()=>{});function Yy(n,e){if(e.target==="openApi3")return Zy(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in jo&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=jo[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Zy(n,e)}var jo,Zy,Yl=y(()=>{de();jo={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};Zy=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>C(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0}});function Xy(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:jo[n.innerType._def.typeName],nullable:!0}:{type:[jo[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=C(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=C(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}var Sh=y(()=>{de();Yl()});function Qy(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",dh(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?z(t,"minimum",r.value,r.message,e):z(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),z(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?z(t,"maximum",r.value,r.message,e):z(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),z(t,"maximum",r.value,r.message,e));break;case"multipleOf":z(t,"multipleOf",r.value,r.message,e);break}return t}var kh=y(()=>{Nn()});function pA(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":C(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":C(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function e_(n,e){let t={type:"object",...Object.entries(n.shape()).reduce((r,[a,s])=>{if(s===void 0||s._def===void 0)return r;let i=C(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?r:{properties:{...r.properties,[a]:i},required:s.isOptional()?r.required:[...r.required,a]}},{properties:{},required:[]}),additionalProperties:pA(n,e)};return t.required.length||delete t.required,t}var Ch=y(()=>{de()});var t_,Rh=y(()=>{de();t_=(n,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return C(n.innerType._def,e);let t=C(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}}});var r_,Nh=y(()=>{de();r_=(n,e)=>{if(e.pipeStrategy==="input")return C(n.in._def,e);if(e.pipeStrategy==="output")return C(n.out._def,e);let t=C(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=C(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}}});function n_(n,e){return C(n.type._def,e)}var jh=y(()=>{de()});function a_(n,e){let r={type:"array",uniqueItems:!0,items:C(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&z(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&z(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}var Mh=y(()=>{Nn();de()});function s_(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>C(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:C(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>C(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}var $h=y(()=>{de()});function i_(){return{not:{}}}var Lh=y(()=>{});function o_(){return{}}var Dh=y(()=>{});var u_,Uh=y(()=>{de();u_=(n,e)=>C(n.innerType._def,e)});function C(n,e,t=!1){let r=e.seen.get(n);if(e.override){let i=e.override?.(n,e,r,t);if(i!==Ry)return i}if(r&&!t){let i=mA(r,e);if(i!==void 0)return i}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=bA(n,n.typeName,e);return s&&yA(n,e,s),a.jsonSchema=s,s}var mA,gA,bA,yA,de=y(()=>{Pr();fh();hh();ph();mh();gh();bh();_h();wh();vh();xh();Oh();Ah();Eh();Ih();Th();Ph();Sh();kh();Ch();Rh();Nh();jh();Zl();Mh();Jl();$h();Lh();Yl();Dh();Uh();ql();mA=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:gA(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},gA=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},bA=(n,e,t)=>{switch(e){case v.ZodString:return Kl(n,t);case v.ZodNumber:return Qy(n,t);case v.ZodObject:return e_(n,t);case v.ZodBigInt:return Ly(n,t);case v.ZodBoolean:return Dy();case v.ZodDate:return yh(n,t);case v.ZodUndefined:return i_();case v.ZodNull:return Wy(t);case v.ZodArray:return $y(n,t);case v.ZodUnion:case v.ZodDiscriminatedUnion:return Yy(n,t);case v.ZodIntersection:return Gy(n,t);case v.ZodTuple:return s_(n,t);case v.ZodRecord:return Wl(n,t);case v.ZodLiteral:return Vy(n,t);case v.ZodEnum:return Hy(n);case v.ZodNativeEnum:return Ky(n);case v.ZodNullable:return Xy(n,t);case v.ZodOptional:return t_(n,t);case v.ZodMap:return qy(n,t);case v.ZodSet:return a_(n,t);case v.ZodLazy:return C(n.getter()._def,t);case v.ZodPromise:return n_(n,t);case v.ZodNaN:case v.ZodNever:return Jy();case v.ZodEffects:return zy(n,t);case v.ZodAny:return My();case v.ZodUnknown:return o_();case v.ZodDefault:return By(n,t);case v.ZodBranded:return Uy(n,t);case v.ZodReadonly:return u_(n,t);case v.ZodCatch:return Fy(n,t);case v.ZodPipeline:return r_(n,t);case v.ZodFunction:case v.ZodVoid:case v.ZodSymbol:return;default:return(r=>{})(e)}},yA=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t)});var ie,Fh=y(()=>{de();ch();ie=(n,e)=>{let t=jy(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((o,[u,l])=>({...o,[u]:C(l._def,{...t,currentPath:[...t.basePath,t.definitionPath,u]},!0)??{}}),{}):void 0,a=typeof e=="string"?e:e?.name,s=C(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1)??{},i=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i}});var Ft=y(()=>{ql();ch();Nn();de();fh();hh();ph();mh();gh();bh();_h();wh();vh();xh();Oh();Ah();Eh();Ih();Th();Ph();Sh();kh();Ch();Rh();Nh();jh();Uh();Zl();Mh();Jl();$h();Lh();Yl();Dh();Fh();Fh()});function m_(n,e){return e?.[n]||(0,p_.default)(n)}function g_(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}var p_,OA,b_=y(()=>{p_=q(sl(),1),OA=q(il(),1)});function y_(n){return Array.isArray(n)?[...n]:{...n}}function AA(n,e){let t=y_(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=y_(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function tp(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var It,ei=y(()=>{b_();It=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,tp(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let l of u.reverse()){if(!(l in s)||s[l]===void 0)return;(!(l in i)||i[l]===void 0)&&(typeof s[l]=="object"&&s[l]!=null?i[l]={}:Array.isArray(s[l])&&(i[l]=[])),s=s[l],i=i[l]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:g_(Object.keys(t).length?AA(r,t):r,m_,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}});function rp(n,e=ti){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function ti(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}var np=y(()=>{});function er(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}function xe(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string")t[r]=t[r]+a;else if(!Array.isArray(t[r])&&typeof t[r]=="object")t[r]=xe(t[r],a);else if(Array.isArray(t[r]))t[r]=ap(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function ap(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=xe(t[a],r):t.push(r)}else t.push(r);return t}}}function Ve(n){return typeof n?._getType=="function"}function __(n){return Ve(n)&&typeof n.concat=="function"}var Me,Tt,kr=y(()=>{ei();Me=class extends It{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}};Tt=class extends Me{}});function w_(n){let e=[],t=[];for(let r of n)if(r.function){let a=r.function.name;try{let s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var rc=y(()=>{kr()});function v_(n){return n._getType()==="ai"}var Oe,Pt,nc=y(()=>{np();kr();rc();Oe=class extends Me{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let a=r.additional_kwargs?.tool_calls,s=r.tool_calls;a!=null&&a.length>0&&(s===void 0||s.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&s===void 0){let[i,o]=w_(a);r.tool_calls=i??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}};Pt=class n extends Tt{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{let r=[],a=[];for(let s of e.tool_call_chunks){let i={};try{if(i=ti(s.args??"{}")??{},typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args."})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){let t={content:er(this.content,e.content),additional_kwargs:xe(this.additional_kwargs,e.additional_kwargs),response_metadata:xe(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let r=ap(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:r.input_tokens+a.input_tokens,output_tokens:r.output_tokens+a.output_tokens,total_tokens:r.total_tokens+a.total_tokens};t.usage_metadata=s}return new n(t)}}});var tr,ri,sp=y(()=>{kr();tr=class n extends Me{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}},ri=class n extends Tt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:er(this.content,e.content),additional_kwargs:xe(this.additional_kwargs,e.additional_kwargs),response_metadata:xe(this.response_metadata,e.response_metadata),role:this.role})}}});var ac,ip=y(()=>{kr();ac=class n extends Tt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new n({content:er(this.content,e.content),additional_kwargs:xe(this.additional_kwargs,e.additional_kwargs),response_metadata:xe(this.response_metadata,e.response_metadata),name:this.name??""})}}});var Ae,ni,op=y(()=>{kr();Ae=class extends Me{static lc_name(){return"HumanMessage"}_getType(){return"human"}},ni=class n extends Tt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new n({content:er(this.content,e.content),additional_kwargs:xe(this.additional_kwargs,e.additional_kwargs),response_metadata:xe(this.response_metadata,e.response_metadata)})}}});var ai,si,up=y(()=>{kr();ai=class extends Me{static lc_name(){return"SystemMessage"}_getType(){return"system"}},si=class n extends Tt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new n({content:er(this.content,e.content),additional_kwargs:xe(this.additional_kwargs,e.additional_kwargs),response_metadata:xe(this.response_metadata,e.response_metadata)})}}});function en(n){if(typeof n=="string")return new Ae(n);if(Ve(n))return n;let[e,t]=n;if(e==="human"||e==="user")return new Ae({content:t});if(e==="ai"||e==="assistant")return new Oe({content:t});if(e==="system")return new ai({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Lo(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"";r.push(`${s}: ${i}${a.content}`)}return r.join(`
`)}function x_(n){let e=n._getType();if(e==="human")return new ni({...n});if(e==="ai")return new Pt({...n});if(e==="system")return new si({...n});if(e==="function")return new ac({...n});if(tr.isInstance(n))return new ri({...n});throw new Error("Unknown message type.")}var lp=y(()=>{kr();op();nc();up();sp();ip();rc()});var Bt=y(()=>{nc();kr();sp();ip();op();up();lp();rc()});function sc(n){return typeof n=="function"&&"langsmith:traceable"in n}var dp,fp,IA,O_,rL,A_=y(()=>{dp=class{getStore(){}run(e,t){return t()}},fp=class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new dp}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}},IA=new fp,O_=()=>{let n=IA.getInstance().getStore();if(n===void 0)throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function."].join(`
`));return n},rL=Symbol.for("langsmith:traceable:root")});var hp=y(()=>{A_()});async function I_(){return pp===void 0&&(pp={library:"langchain-js",runtime:CA()}),pp}function Ee(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var TA,PA,SA,E_,kA,CA,pp,ii=y(()=>{TA=()=>typeof window<"u"&&typeof window.document<"u",PA=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",SA=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),E_=()=>typeof Deno<"u",kA=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!E_(),CA=()=>{let n;return TA()?n="browser":kA()?n="node":PA()?n="webworker":SA()?n="jsdom":E_()?n="deno":n="other",n}});var mp,qa,gp=y(()=>{ce();ei();ii();mp=class{},qa=class n extends mp{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,tp(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Ee("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return It.prototype.toJSON.call(this)}toJSONNotImplemented(){return It.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:S()}),Object.assign(this,e)}}return new t}}});function bp(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function RA(n){return n.replace(/[-:.]/g,"")}function NA(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return RA(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}var St,Ka=y(()=>{gp();St=class extends qa{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){let t=NA(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await this.onRunCreate?.(r)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleChatModelStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}async handleChainStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(f),await this.onChainStart?.(f),f}async handleChainEnd(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=bp(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=bp(s.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=bp(s.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}async handleToolStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onToolStart?.(c),c}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}async handleRetrieverStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onRetrieverStart?.(c),c}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,s,i){let o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:i?.chunk}),o}}});function nt(n,e){return`${n.open}${e}${n.close}`}function rr(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function jn(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var yp,ht,Uo,T_=y(()=>{yp=q(Sl(),1);Ka();({color:ht}=yp.default),Uo=class extends St{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?nt(yp.default.bold,o):o}).join(" > ");return nt(ht.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.green,"[chain/start]")} [${t}] Entering Chain run with input: ${rr(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.cyan,"[chain/end]")} [${t}] [${jn(e)}] Exiting Chain run with output: ${rr(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.red,"[chain/error]")} [${t}] [${jn(e)}] Chain run errored with error: ${rr(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${nt(ht.green,"[llm/start]")} [${t}] Entering LLM run with input: ${rr(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.cyan,"[llm/end]")} [${t}] [${jn(e)}] Exiting LLM run with output: ${rr(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.red,"[llm/error]")} [${t}] [${jn(e)}] LLM run errored with error: ${rr(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.cyan,"[tool/end]")} [${t}] [${jn(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.red,"[tool/error]")} [${t}] [${jn(e)}] Tool run errored with error: ${rr(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${rr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.cyan,"[retriever/end]")} [${t}] [${jn(e)}] Exiting Retriever run with output: ${rr(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${nt(ht.red,"[retriever/error]")} [${t}] [${jn(e)}] Retriever run errored with error: ${rr(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${nt(ht.blue,"[agent/action]")} [${r}] Agent selected action: ${rr(t.actions[t.actions.length-1],"[action]")}`)}}});var P_,ic,jA,MA,Fo,S_=y(()=>{P_=q(Or(),1),ic=q(Ar(),1),jA=[400,401,403,404,405,406,407,408],MA=[409],Fo=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in ic.default?this.queue=new ic.default.default({concurrency:this.maxConcurrency}):this.queue=new ic.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,P_.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;let s=a?.response,i=s?.status;if(i){if(jA.includes(+i))throw a;if(MA.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});function _p(n){return typeof n?._getType=="function"}function wp(n){let e={type:n._getType(),data:{content:n.content}};return n?.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var k_=y(()=>{});async function Op(){if(vp===void 0){let n=FA(),e=zA();vp={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:uc,...e}}return vp}function R_(){let n=BA()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[r,a]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function BA(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Cr(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}function zA(){if(xp!==void 0)return xp;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=Cr(t);r!==void 0&&(e[t]=r)}return xp=e,e}var tn,$A,LA,DA,C_,UA,FA,vp,xp,oc=y(()=>{lc();$A=()=>typeof window<"u"&&typeof window.document<"u",LA=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",DA=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),C_=()=>typeof Deno<"u",UA=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!C_(),FA=()=>tn||($A()?tn="browser":UA()?tn="node":LA()?tn="webworker":DA()?tn="jsdom":C_()?tn="deno":tn="other",tn)});function te(n){if(!Ot(n))throw new Error(`Invalid UUID: ${n}`)}var N_=y(()=>{ce()});async function j_(n){let e=await Op(),t=R_();return n.map(r=>{let a=r.extra??{},s=a.metadata;return r.extra={...a,runtime:{...e,...a?.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...s}},r})}async function VA(n){let e=[];for await(let t of n)e.push(t);return e}function Ap(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var HA,GA,Mn,qA,Ep,KA,oi,Ip=y(()=>{ce();S_();k_();oc();lc();N_();HA=()=>{let n=Cr("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},GA=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},Mn=async(n,e)=>{let t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};qA=async n=>{if(n?.status===429){let e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1},Ep=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");let t=[];for(;t.length<e&&this.items.length;){let r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}},KA=20971520,oi=class n{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ep}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=n.getDefaultClientConfig();this.tracingSampleRate=HA(),this.apiUrl=Ap(e.apiUrl??t.apiUrl)??"",this.apiKey=Ap(e.apiKey??t.apiKey),this.webUrl=Ap(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Fo(e.callerOptions??{}),this.batchIngestCaller=new Fo({...e.callerOptions??{},onFailedResponseHook:qA}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){let e=Cr("LANGCHAIN_API_KEY"),t=Cr("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=Cr("LANGCHAIN_HIDE_INPUTS")==="true",a=Cr("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:GA(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${uc}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){let r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0,a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));let s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);let o=await i.json();if(o.length===0||(yield o,o.length<a))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.sampledPostUuids.has(a.id)&&(r.push(a),this.sampledPostUuids.delete(a.id));return r}else{let r=[];for(let a of e)Math.random()<this.tracingSampleRate&&(r.push(a),this.sampledPostUuids.add(a.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){let[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){let r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;let a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){let e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=await j_([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(s[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Mn(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=e?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[],a=t?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[];if(r.length>0&&a.length>0){let l=r.reduce((f,d)=>(d.id&&(f[d.id]=d),f),{}),c=[];for(let f of a)f.id!==void 0&&l[f.id]?l[f.id]={...l[f.id],...f}:c.push(f);r=Object.values(l),a=c}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;if(r=await j_(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(let l of s.post)await this.createRun(l);for(let l of s.patch)l.id!==void 0&&await this.updateRun(l.id,l);return}let i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??KA,o={post:[],patch:[]},u=0;for(let l of["post","patch"]){let c=l,f=s[c].reverse(),d=f.pop();for(;d!==void 0;){let h=JSON.stringify(d);u>0&&u+h.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=h.length,o[c].push(d),d=f.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Mn(r,"batch create run")}async updateRun(e,t){te(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Mn(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){te(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r?.projectName?a=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?a=r?.projectId:a=(await this.readProject({projectName:Cr("LANGCHAIN_PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await VA(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>(s?.dotted_order??"").localeCompare(i?.dotted_order??""));for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:l,runType:c,error:f,id:d,query:h,filter:p,traceFilter:m,treeFilter:g,limit:b,select:x}=e,_=[];if(t&&(_=Array.isArray(t)?t:[t]),r){let j=Array.isArray(r)?r:[r],J=await Promise.all(j.map(Xe=>this.readProject({projectName:Xe}).then(po=>po.id)));_.push(...J)}let k=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],O={session:_.length?_:null,run_type:c,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:g,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:f,id:d,limit:b,trace:s,select:x||k,is_root:l},B=0;for await(let j of this._getCursorPaginatedList("/runs/query",O))if(b){if(B>=b)break;if(j.length+B>b){yield*j.slice(0,b-B);break}B+=j.length,yield*j}else yield*j}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||S()};te(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){te(e);let t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Mn(t,"unshare run")}async readRunSharedLink(e){te(e);let r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return te(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),te(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};te(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){te(e);let t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Mn(t,"unshare dataset")}async readSharedDataset(e){return te(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=s||{};r&&(l.metadata=r);let c={name:e,extra:l,description:t};i!==null&&(c.reference_dataset_id=i);let f=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await f.json();if(!f.ok)throw new Error(`Failed to create session ${e}: ${f.status} ${f.statusText}`);return d}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let l={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},c=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),f=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return f}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)te(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)te(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){let o=new URLSearchParams;if(e!==void 0)for(let u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){let u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(let u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,te(r);let a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Mn(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(d=>{l.append("input_keys",d)}),a.forEach(d=>{l.append("output_keys",d)}),s&&l.append("description",s),i&&l.append("data_type",i),o&&l.append("name",o);let c=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!c.ok){let d=await c.json();throw d.detail&&d.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){let a={name:e,description:t};r&&(a.data_type=r);let s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok){let o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)te(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s}={}){let i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let u of r)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(let u of this._getPaginated(i,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)te(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to delete ${r}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);let f={dataset_id:l,inputs:e,outputs:t,created_at:(s||new Date)?.toISOString(),id:i,metadata:o,split:u},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createExamples(e){let{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e,l=o;if(l===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:u})).id);let c=t.map((h,p)=>({dataset_id:l,inputs:h,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),f=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!f.ok)throw new Error(`Failed to create examples: ${f.status} ${f.statusText}`);return await f.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>_p(i)?wp(i):i),s=_p(t)?wp(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){te(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o}={}){let u;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)u=e;else if(t!==void 0)u=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let l=new URLSearchParams({dataset:u}),c=a?typeof a=="string"?a:a?.toISOString():void 0;c&&l.append("as_of",c);let f=i??!0;if(l.append("inline_s3_urls",f.toString()),r!==void 0)for(let d of r)l.append("id",d);if(s!==void 0)for(let d of s)l.append("splits",d);if(o!==void 0){let d=JSON.stringify(o);l.append("metadata",d)}for await(let d of this._getPaginated("/examples",l))yield*d}async deleteExample(e){te(e);let t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){te(e);let r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),u=r??{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});let l=o.targetRunId??i.id;return await this.createFeedback(l,o.key,{score:o?.score,value:o?.value,comment:o?.comment,correction:o?.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o?.sourceRunId})}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,feedbackConfig:f,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");let p={type:u??"api",metadata:o??{}};l!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:l}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&te(p.metadata.__run.run_id);let m={id:c??S(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:f,session_id:d},g=`${this.apiUrl}/feedback`,b=await this.caller.call(fetch,g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Mn(b,"create feedback"),m}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),te(e);let o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Mn(o,"update feedback")}async readFeedback(e){te(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){te(e);let t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(a??new Date)?.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){te(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e);for(let s of a){let i=r||{};s.evaluatorInfo&&(i={...s.evaluatorInfo,...i});let o=null;s.targetRunId?o=s.targetRunId:t&&(o=t.id),await this.createFeedback(o,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:i,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"})}return a}}});var M_=y(()=>{oc()});var $_=y(()=>{});var L_=y(()=>{oc();Ip();M_();$_()});var uc,lc=y(()=>{Ip();L_();uc="0.1.30"});var D_=y(()=>{lc()});var Bo,Tp=y(()=>{D_();hp();ii();Ka();Bo=class extends St{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=r??Ee("LANGCHAIN_PROJECT")??Ee("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new oi({});let s=this.getTraceableRunTree();if(s){let i=s,o=new Set;for(;i.parent_run&&!(o.has(i.id)||(o.add(i.id),!i.parent_run));)i=i.parent_run;o.clear();let u=[i];for(;u.length>0;){let l=u.shift();!l||o.has(l.id)||(o.add(l.id),this.runMap.set(l.id,l),l.child_runs&&u.push(...l.child_runs))}this.client=s.client??this.client,this.projectName=s.project_name??this.projectName,this.exampleId=s.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await I_()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return O_()}catch{return}}}});var U_=y(()=>{Bt();ii();Ka()});async function F_(){return new Bo}var B_=y(()=>{Tp();U_()});function JA(){let n="default"in cc.default?cc.default.default:cc.default;return new n({autoStart:!0,concurrency:1})}async function Ie(n,e){e===!0?await n():(typeof Pp>"u"&&(Pp=JA()),Pp.add(n))}var cc,Pp,z_=y(()=>{cc=q(Ar(),1)});function zo(n){return"name"in n?n:qa.fromMethods(n)}var Sp,ui,kp,dc,Cp,Rp,at,fc=y(()=>{ce();gp();T_();B_();Bt();ii();Tp();z_();Ee("LANGCHAIN_TRACING_V2")==="true"&&Ee("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);Sp=class{setHandler(e){return this.setHandlers([e])}},ui=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},kp=class extends ui{getChild(e){let t=new at(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},dc=class extends ui{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>Ie(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(u){if(console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Cp=class extends ui{getChild(e){let t=new at(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ie(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ie(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Rp=class extends ui{getChild(e){let t=new at(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Ie(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},at=class n extends Sp{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:S();return await Promise.all(this.handlers.map(d=>Ie(async()=>{if(!d.ignoreLLM)try{await d.handleLLMStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u)}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new dc(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:S();return await Promise.all(this.handlers.map(d=>Ie(async()=>{if(!d.ignoreLLM)try{if(d.handleChatModelStart)await d.handleChatModelStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u);else if(d.handleLLMStart){let h=Lo(l);await d.handleLLMStart?.(e,[h],f,this._parentRunId,s,this.tags,this.metadata,u)}}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new dc(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>Ie(async()=>{if(!u.ignoreChain)try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Cp(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>Ie(async()=>{if(!u.ignoreAgent)try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Rp(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>Ie(async()=>{if(!u.ignoreRetriever)try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new kp(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends qa{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:S()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers(e?.map(zo)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(zo):t?.handlers,!1));let l=Ee("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=Ee("LANGCHAIN_TRACING_V2")==="true"||Ee("LANGSMITH_TRACING")==="true",f=c||(Ee("LANGCHAIN_TRACING")??!1);if(l||f){if(u||(u=new n),l&&!u.handlers.some(d=>d.name===Uo.prototype.name)){let d=new Uo;u.addHandler(d,!0)}if(f&&!u.handlers.some(d=>d.name==="langchain_tracer")&&c){let d=await F_();u.addHandler(d,!0),u._parentRunId=d.getTraceableRunTree()?.id??u._parentRunId}}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}}});function pc(n,e){return WA.call(n,e)}function mc(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)pc(n,t)&&e.push(t);return e}function qe(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function gc(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Rr(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function Ho(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function hc(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(hc(n[t]))return!0}else if(typeof n=="object"){let t=mc(n),r=t.length;for(var e=0;e<r;e++)if(hc(n[t[e]]))return!0}}return!1}function H_(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var WA,Ja,Go=y(()=>{WA=Object.prototype.hasOwnProperty;Ja=class extends Error{constructor(e,t,r,a,s){super(H_(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=H_(e,{name:t,index:r,operation:a,tree:s})}}});var Np={};ya(Np,{JsonPatchError:()=>oe,_areEquals:()=>Vo,applyOperation:()=>Wa,applyPatch:()=>$n,applyReducer:()=>XA,deepClone:()=>ZA,getValueByPointer:()=>bc,validate:()=>G_,validator:()=>yc});function bc(n,e){if(e=="")return n;var t={op:"_get",path:e};return Wa(n,t),t.value}function Wa(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):yc(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=bc(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=Vo(n,e.value),i.test===!1)throw new oe("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new oe("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=qe(n));let o=(e.path||"").split("/"),u=n,l=1,c=o.length,f,d,h;for(typeof t=="function"?h=t:h=yc;;){if(d=o[l],d&&d.indexOf("~")!=-1&&(d=Ho(d)),a&&(d=="__proto__"||d=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(u[d]===void 0?f=o.slice(0,l).join("/"):l==c-1&&(f=e.path),f!==void 0&&h(e,0,n,f)),l++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!gc(d))throw new oe("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);gc(d)&&(d=~~d)}if(l>=c){if(t&&e.op==="add"&&d>u.length)throw new oe("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let p=YA[e.op].call(e,u,d,n);if(p.test===!1)throw new oe("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(l>=c){let p=li[e.op].call(e,u,d,n);if(p.test===!1)throw new oe("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[d],t&&l<c&&(!u||typeof u!="object"))throw new oe("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function $n(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new oe("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=qe(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=Wa(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function XA(n,e,t){let r=Wa(n,e);if(r.test===!1)throw new oe("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function yc(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new oe("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(li[n.op]){if(typeof n.path!="string")throw new oe("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new oe('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new oe("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new oe("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&hc(n.value))throw new oe("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new oe("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new oe("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=G_([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new oe("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new oe("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function G_(n,e,t){try{if(!Array.isArray(n))throw new oe("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)$n(qe(e),qe(n),t||!0);else{t=t||yc;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof oe)return a;throw a}}function Vo(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!Vo(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!Vo(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}var oe,ZA,li,YA,_c=y(()=>{Go();oe=Ja,ZA=qe,li={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=bc(t,this.path);r&&(r=qe(r));let a=Wa(t,{op:"remove",path:this.from}).removed;return Wa(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=bc(t,this.from);return Wa(t,{op:"add",path:this.path,value:qe(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Vo(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},YA={add:function(n,e,t){return gc(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:li.move,copy:li.copy,test:li.test,_get:li._get}});function V_(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=mc(e),i=mc(n),o=!1,u=!1,l=i.length-1;l>=0;l--){var c=i[l],f=n[c];if(pc(e,c)&&!(e[c]===void 0&&f!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof f=="object"&&f!=null&&typeof d=="object"&&d!=null&&Array.isArray(f)===Array.isArray(d)?V_(f,d,t,r+"/"+Rr(c),a):f!==d&&(o=!0,a&&t.push({op:"test",path:r+"/"+Rr(c),value:qe(f)}),t.push({op:"replace",path:r+"/"+Rr(c),value:qe(d)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+Rr(c),value:qe(f)}),t.push({op:"remove",path:r+"/"+Rr(c)}),u=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&s.length==i.length))for(var l=0;l<s.length;l++){var c=s[l];!pc(n,c)&&e[c]!==void 0&&t.push({op:"add",path:r+"/"+Rr(c),value:qe(e[c])})}}}function wc(n,e,t=!1){var r=[];return V_(n,e,r,"",t),r}var q_=y(()=>{Go();_c();});var g2,jp=y(()=>{_c();q_();Go();_c();Go();g2={...Np,JsonPatchError:Ja,deepClone:qe,escapePathComponent:Rr,unescapePathComponent:Ho}});var Mp,QA,$p,nr,qo=y(()=>{Mp=class{getStore(){}run(e,t){return t()}},QA=new Mp,$p=class{getInstance(){return globalThis.__lc_tracing_async_local_storage??QA}initializeGlobalInstance(e){globalThis.__lc_tracing_async_local_storage===void 0&&(globalThis.__lc_tracing_async_local_storage=e)}},nr=new $p});function Lp(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function pt(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=pt(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}async function K_(n,e,t,...r){let a=new rn({generator:e,startSetup:t}),s=await a.setup;return{output:n(a,s,...r),setup:s}}var Ke,rn,Ln=y(()=>{qo();Ke=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};rn=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise((t,r)=>{nr.getInstance().run(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(s=>t(void 0),r)})})}async next(...e){return this.firstResultUsed?nr.getInstance().run(this.config,async()=>this.generator.next(...e)):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}});async function J_(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function W_(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function eE(n){return n!==void 0&&n.message!==void 0}var ar,Ko,vc,Jo,Dp=y(()=>{jp();Ka();Ln();Bt();ar=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=$n({},t);return new Ko({ops:t,state:r[r.length-1].newDocument})}},Ko=class n extends ar{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=$n(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=$n({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},vc=n=>n.name==="log_stream_tracer";Jo=class extends St{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ke.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new ar({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new ar({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await J_(e,this._schemaFormat)),await this.writer.write(new ar({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await J_(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await W_(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new ar({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new ar({ops:[{op:"replace",path:"/final_output",value:await W_(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?eE(r?.chunk)?i=r?.chunk:i=new Pt(t):i=t;let o=new ar({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}}});var Up,Za,Nr,Wo=y(()=>{Up="__run",Za=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},Nr=class n extends Za{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}});function xc({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var Ac,Oc,Fp=y(()=>{Ka();Ln();nc();Wo();Ac=n=>n.name==="event_stream_tracer",Oc=class extends St{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ke.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}let s=this.tappedPromises.get(e);if(s===void 0){let i;s=new Promise(o=>{i=o}),this.tappedPromises.set(e,s);try{let o={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...o,data:{chunk:r.value}},a),yield r.value;for await(let u of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...o,data:{chunk:u}},a),yield u}finally{i()}}else{yield r.value;for await(let i of t)yield i}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=xc(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(a.runType==="chat_model")i="on_chat_model_stream",r?.chunk===void 0?s=new Pt({content:t}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",r?.chunk===void 0?s=new Za({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=e.outputs?.generations,s;if(t.runType==="chat_model"){for(let i of a??[]){if(s!==void 0)break;s=i[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a?.map(i=>i.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=xc(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=xc(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=xc(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}});async function sr(n){return at.configure(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function Ic(...n){let e={};for(let t of n.filter(r=>!!r))for(let r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){let a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){let a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{let i=a.copy();for(let o of s)i.addHandler(zo(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){let i=s.copy();for(let o of a)i.addHandler(zo(o),!0);e.callbacks=i}else e.callbacks=new at(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{let a=r;e[a]=t[a]??e[a]}return e}function V(n){let e=n??nr.getInstance().getStore(),t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(e&&(t={...t,...e}),e?.configurable)for(let r of Object.keys(e.configurable))tE.has(typeof e.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=e.configurable[r]);return t}function Te(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){let o=V(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}var Ec,tE,ci=y(()=>{fc();qo();Ec=25;tE=new Set(["string","number","boolean"])});var Z_,Tc,rE,nE,nn,Zo=y(()=>{Z_=q(Or(),1),Tc=q(Ar(),1),rE=[400,401,402,403,404,405,406,407,409],nE=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;let e=n?.response?.status??n?.status;if(e&&rE.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){let t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}},nn=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??nE;let t="default"in Tc.default?Tc.default.default:Tc.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Z_.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});var Yo,Y_=y(()=>{Ka();Yo=class extends St{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}});function Sc(n){return n?n.lc_runnable:!1}var Pc,Bp=y(()=>{Pc=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>this.includeTags?.includes(s))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>!this.excludeTags?.includes(s))),r}}});function aE(n){return Sc(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...ie(n.data.schema),title:n.data.name}}}var Xo,X_=y(()=>{Ft();ce();Bp();Xo=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Ot(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...aE(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||S(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let a={source:e.id,target:t.id,data:r};return this.edges.push(a),a}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([t,r])=>{this.nodes[t]=r}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}}});function Q_(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return Ke.fromReadableStream(t)}var ew=y(()=>{Ln()});function zp(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}function kc(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Hp(n,e){let t=nr.getInstance();for(;;){let{value:r,done:a}=t.run(n,e.next.bind(e));if(a)break;yield r}}async function*Gp(n,e){let t=nr.getInstance(),r=e[Symbol.asyncIterator]();for(;;){let{value:a,done:s}=await t.run(n,r.next.bind(e));if(s)break;yield a}}var tw,rw=y(()=>{qo();tw=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function"});function $e(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}function sE(n){if(sc(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}function an(n){if(typeof n=="function")return new di({func:n});if(K.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=an(r);return new Un({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var Vp,K,sn,Cc,Rc,Dn,Un,qp,di,Nc,fi,jc,on=y(()=>{Pr();Vp=q(Or(),1);ce();hp();fc();Dp();Fp();ei();Ln();ci();Zo();Y_();Bp();qo();X_();ew();rw();K=class extends It{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new sn({bound:this,kwargs:e,config:{}})}map(){return new Cc({bound:this})}withRetry(e){return new Rc({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new sn({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Nc({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(V);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>V(s===0?e:r))}return Array.from({length:t},()=>V(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=a[0]?.maxConcurrency??r?.maxConcurrency,i=new nn({maxConcurrency:s,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>i.call(async()=>{try{return await this.invoke(u,a[l])}catch(c){if(r?.returnExceptions)return c;throw c}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=V(t),a=new rn({generator:this._streamIterator(e,r),config:r});return await a.setup,Ke.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=V(e):t=V({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){let a=V(r),i=await(await sr(a))?.handleChainStart(this.toJSON(),$e(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let o;try{o=await e.call(this,t,a,i)}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd($e(o,"output")),o}async _batchWithConfig(e,t,r,a){let s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(sr)),o=await Promise.all(i.map(async(l,c)=>{let f=await l?.handleChainStart(this.toJSON(),$e(t[c],"input"),s[c].runId,s[c].runType,void 0,void 0,s[c].runName??this.getName());return delete s[c].runId,f})),u;try{u=await e.call(this,t,s,o,a)}catch(l){throw await Promise.all(o.map(c=>c?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd($e(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=V(r),l=await sr(u);async function*c(){for await(let d of e){if(s)if(a===void 0)a=d;else try{a=pt(a,d)}catch{a=void 0,s=!1}yield d}}let f;try{let d=await K_(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),u);delete u.runId,f=d.setup;let h=f?.handlers.find(Ac),p=d.output;h!==void 0&&f!==void 0&&(p=h.tapOutputIterable(f.runId,p));let m=f?.handlers.find(vc);m!==void 0&&f!==void 0&&(p=m.tapOutputIterable(f.runId,p));for await(let g of p)if(yield g,o)if(i===void 0)i=g;else try{i=pt(i,g)}catch{i=void 0,o=!1}}catch(d){throw await f?.handleChainError(d,void 0,void 0,void 0,{inputs:$e(a,"input")}),d}await f?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:$e(a,"input")})}getGraph(e){let t=new Xo,r=t.addNode({name:`${this.getName()}Input`,schema:ye.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:ye.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Dn({first:this,last:an(e)})}pick(e){return this.pipe(new jc(e))}assign(e){return this.pipe(new fi(new Un({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=pt(r,a);yield*this._streamIterator(r,V(t))}async*streamLog(e,t,r){let a=new Jo({...r,autoClose:!1,_schemaFormat:"original"}),s=V(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.inheritableHandlers.push(t),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let l of u){let c=new ar({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(c)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?Q_(a):Ke.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){let a=new Oc({...r,autoClose:!1}),s=V(t),i=s.runId??S();s.runId=i;let o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{let h=o.copy();h.inheritableHandlers.push(a),s.callbacks=h}let u=this;async function l(){try{let h=await u.stream(e,s),p=a.tapOutputIterable(i,h);for await(let m of p);}finally{await a.finish()}}let c=l(),f=!1,d;try{for await(let h of a){if(!f){h.data.input=e,f=!0,d=h.run_id,yield h;continue}h.run_id===d&&h.event.endsWith("_end")&&h.data?.input&&delete h.data.input,yield h}}finally{await c}}async*_streamEventsV1(e,t,r){let a,s=!1,i=V(t),o=i.tags??[],u=i.metadata??{},l=i.runName??this.getName(),c=new Jo({...r,autoClose:!1,_schemaFormat:"streaming_events"}),f=new Pc({...r}),d=this._streamLog(e,c,i);for await(let p of d){if(a?a=a.concat(p):a=Ko.fromRunLogPatch(p),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let x={...a.state},_={run_id:x.id,event:`on_${x.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};f.includeEvent(_,x.type)&&(yield _)}let m=p.ops.filter(x=>x.path.startsWith("/logs/")).map(x=>x.path.split("/")[2]),g=[...new Set(m)];for(let x of g){let _,k={},O=a.state.logs[x];if(O.end_time===void 0?O.streamed_output.length>0?_="stream":_="start":_="end",_==="start")O.inputs!==void 0&&(k.input=O.inputs);else if(_==="end")O.inputs!==void 0&&(k.input=O.inputs),k.output=O.final_output;else if(_==="stream"){let B=O.streamed_output.length;if(B!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${B} instead. Encountered in: "${O.name}"`);k={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${_}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:k}}let{state:b}=a;if(b.streamed_output.length>0){let x=b.streamed_output.length;if(x!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${x} instead. Encountered in: "${b.name}"`);let _={chunk:b.streamed_output[0]};b.streamed_output=[];let k={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:u,name:l,data:_};f.includeEvent(k,b.type)&&(yield k)}}let h=a?.state;if(h!==void 0){let p={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:o,metadata:u,data:{output:h.final_output}};f.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return Sc(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new sn({bound:this,config:{},configFactories:[a=>({callbacks:[new Yo({config:a,onStart:e,onEnd:t,onError:r})]})]})}},sn=class n extends K{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=Ic(this.config,...e);return Ic(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(V(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(V(s),this.kwargs))):await this._mergeConfig(V(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(V(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(V(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(V(t),this.kwargs))}streamEvents(e,t,r){let a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(V(t),a.kwargs),version:t.version},r)};return Ke.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&K.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new Yo({config:a,onStart:e,onEnd:t,onError:r})]})]})}},Cc=class n extends K{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,Te(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},Rc=class extends sn{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return Te(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return(0,Vp.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){let s={};try{await(0,Vp.default)(async i=>{let o=e.map((d,h)=>h).filter(d=>s[d.toString()]===void 0||s[d.toString()]instanceof Error),u=o.map(d=>e[d]),l=o.map(d=>this._patchConfigForRetry(i,t?.[d],r?.[d])),c=await super.batch(u,l,{...a,returnExceptions:!0}),f;for(let d=0;d<c.length;d+=1){let h=c[d],p=o[d];h instanceof Error&&f===void 0&&(f=h,f.input=u[d]),s[p.toString()]=h}if(f)throw f;return c},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(a?.returnExceptions!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Dn=class n extends K{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=V(t),s=await(await sr(r))?.handleChainStart(this.toJSON(),$e(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i=e,o;try{let u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1)i=await u[l].invoke(i,Te(r,{callbacks:s?.getChild(`seq:step:${l+1}`)}));o=await this.last.invoke(i,Te(r,{callbacks:s?.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd($e(o,"output")),o}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(sr)),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),$e(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((c,f)=>{let d=c?.getChild(`seq:step:${u+1}`);return Te(a[f],{callbacks:d})}),r)}catch(u){throw await Promise.all(i.map(l=>l?.handleChainError(u))),u}return await Promise.all(i.map(u=>u?.handleChainEnd($e(o,"output")))),o}async*_streamIterator(e,t){let r=await sr(t),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),$e(e,"input"),a,void 0,void 0,void 0,s?.runName),o=[this.first,...this.middle,this.last],u=!0,l;async function*c(){yield e}try{let f=o[0].transform(c(),Te(s,{callbacks:i?.getChild("seq:step:1")}));for(let d=1;d<o.length;d+=1)f=await o[d].transform(f,Te(s,{callbacks:i?.getChild(`seq:step:${d+1}`)}));for await(let d of f)if(yield d,u)if(l===void 0)l=d;else try{l=pt(l,d)}catch{l=void 0,u=!1}}catch(f){throw await i?.handleChainError(f),f}await i?.handleChainEnd($e(l,"output"))}getGraph(e){let t=new Xo,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:an(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&K.isRunnable(e)}static from([e,...t],r){return new n({first:an(e),middle:t.slice(0,-1).map(an),last:an(t[t.length-1]),name:r})}},Un=class n extends K{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=an(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=V(t),s=await(await sr(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,Te(r,{callbacks:s?.getChild(`map:key:${o}`)}))}))}catch(o){throw await s?.handleChainError(o),o}return await s?.handleChainEnd(i),i}async*_transform(e,t,r){let a={...this.steps},s=Lp(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],l)=>{let c=u.transform(s[l],Te(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,c.next().then(f=>({key:o,gen:c,result:f}))]}));for(;i.size;){let{key:o,result:u,gen:l}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,l.next().then(c=>({key:o,gen:l,result:c}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=V(t),s=new rn({generator:this.transform(r(),a),config:a});return await s.setup,Ke.fromAsyncGenerator(s)}},qp=class n extends K{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!sc(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await sr(r);return await this.func(Te(r,{callbacks:a}),e)}async*_streamIterator(e,t){let r=await this.invoke(e,t);if(kc(r)){for await(let a of r)yield a;return}if(tw(r)){for(;;){let a=r.next();if(a.done)break;yield a.value}return}yield r}static from(e){return new n({func:e})}};di=class n extends K{static lc_name(){return"RunnableLambda"}constructor(e){if(sc(e.func))return qp.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),sE(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{let i=Te(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??Ec)-1});nr.getInstance().run(i,async()=>{try{let o=await this.func(e,{...i,config:i});if(o&&K.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??Ec)-1})}else if(kc(o)){let u;for await(let l of Gp(i,o))if(u===void 0)u=l;else try{u=pt(u,l)}catch{u=l}o=u}else if(zp(o)){let u;for(let l of Hp(i,o))if(u===void 0)u=l;else try{u=pt(u,l)}catch{u=l}o=u}a(o)}catch(o){s(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(let i of e)if(a===void 0)a=i;else try{a=pt(a,i)}catch{a=i}let s=await new Promise((i,o)=>{nr.getInstance().run(r,async()=>{try{let u=await this.func(a,{...r,config:r});i(u)}catch(u){o(u)}})});if(s&&K.isRunnable(s)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let i=await s.stream(a,Te(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??Ec)-1}));for await(let o of i)yield o}else if(kc(s))for await(let i of Gp(r,s))yield i;else if(zp(s))for(let i of Hp(r,s))yield i;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=V(t),s=new rn({generator:this.transform(r(),a),config:a});return await s.setup,Ke.fromAsyncGenerator(s)}},Nc=class extends K{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=await at.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),$e(e,"input"),a,void 0,void 0,void 0,s?.runName),o;for(let u of this.runnables())try{let l=await u.invoke(e,Te(s,{callbacks:i?.getChild()}));return await i?.handleChainEnd($e(l,"output")),l}catch(l){o===void 0&&(o=l)}throw o===void 0?new Error("No error stored at end of fallback."):(await i?.handleChainError(o),o)}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>at.configure(u?.callbacks,void 0,u?.tags,void 0,u?.metadata))),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),$e(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o;for(let u of this.runnables())try{let l=await u.batch(e,i.map((c,f)=>Te(a[f],{callbacks:c?.getChild()})),r);return await Promise.all(i.map((c,f)=>c?.handleChainEnd($e(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(i.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};fi=class extends K{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Un&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=Lp(e),o=this.mapper.transform(i,Te(r,{callbacks:t?.getChild()})),u=o.next();for await(let l of s){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let c=Object.fromEntries(Object.entries(l).filter(([f])=>!a.includes(f)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(let l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=V(t),s=new rn({generator:this.transform(r(),a),config:a});return await s.setup,Ke.fromAsyncGenerator(s)}},jc=class extends K{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=V(t),s=new rn({generator:this.transform(r(),a),config:a});return await s.setup,Ke.fromAsyncGenerator(s)}}});var ru,pi,mi,Dc,nu=y(()=>{ei();Bt();ru=class extends It{},pi=class extends ru{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Ae(this.value)]}},mi=class extends ru{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Lo(this.messages)}toChatMessages(){return this.messages}},Dc=class extends ru{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new Ae({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}});var un,au=y(()=>{nu();gi();un=class extends ln{async formatPromptValue(e){let t=await this.format(e);return new pi(t)}}});function Jp(n){return typeof n=="function"}function DE(n){return yi(n)?"array":typeof n}function Kp(n){return n.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function sw(n,e){return n!=null&&typeof n=="object"&&e in n}function UE(n,e){return n!=null&&typeof n!="object"&&n.hasOwnProperty&&n.hasOwnProperty(e)}function BE(n,e){return FE.call(n,e)}function HE(n){return!BE(zE,n)}function VE(n){return String(n).replace(/[&<>"'`=\/]/g,function(t){return GE[t]})}function ZE(n,e){if(!n)return[];var t=!1,r=[],a=[],s=[],i=!1,o=!1,u="",l=0;function c(){if(i&&!o)for(;s.length;)delete a[s.pop()];else s=[];i=!1,o=!1}var f,d,h;function p(J){if(typeof J=="string"&&(J=J.split(KE,2)),!yi(J)||J.length!==2)throw new Error("Invalid tags: "+J);f=new RegExp(Kp(J[0])+"\\s*"),d=new RegExp("\\s*"+Kp(J[1])),h=new RegExp("\\s*"+Kp("}"+J[1]))}p(e||zt.tags);for(var m=new iu(n),g,b,x,_,k,O;!m.eos();){if(g=m.pos,x=m.scanUntil(f),x)for(var B=0,j=x.length;B<j;++B)_=x.charAt(B),HE(_)?(s.push(a.length),u+=_):(o=!0,t=!0,u+=" "),a.push(["text",_,g,g+1]),g+=1,_===`
`&&(c(),u="",l=0,t=!1);if(!m.scan(f))break;if(i=!0,b=m.scan(WE)||"name",m.scan(qE),b==="="?(x=m.scanUntil(iw),m.scan(iw),m.scanUntil(d)):b==="{"?(x=m.scanUntil(h),m.scan(JE),m.scanUntil(d),b="&"):x=m.scanUntil(d),!m.scan(d))throw new Error("Unclosed tag at "+m.pos);if(b==">"?k=[b,x,g,m.pos,u,l,t]:k=[b,x,g,m.pos],l++,a.push(k),b==="#"||b==="^")r.push(k);else if(b==="/"){if(O=r.pop(),!O)throw new Error('Unopened section "'+x+'" at '+g);if(O[1]!==x)throw new Error('Unclosed section "'+O[1]+'" at '+g)}else b==="name"||b==="{"||b==="&"?o=!0:b==="="&&p(x)}if(c(),O=r.pop(),O)throw new Error('Unclosed section "'+O[1]+'" at '+m.pos);return XE(YE(a))}function YE(n){for(var e=[],t,r,a=0,s=n.length;a<s;++a)t=n[a],t&&(t[0]==="text"&&r&&r[0]==="text"?(r[1]+=t[1],r[3]=t[3]):(e.push(t),r=t));return e}function XE(n){for(var e=[],t=e,r=[],a,s,i=0,o=n.length;i<o;++i)switch(a=n[i],a[0]){case"#":case"^":t.push(a),r.push(a),t=a[4]=[];break;case"/":s=r.pop(),s[5]=a[2],t=r.length>0?r[r.length-1][4]:e;break;default:t.push(a)}return e}function iu(n){this.string=n,this.tail=n,this.pos=0}function bi(n,e){this.view=n,this.cache={".":this.view},this.parent=e}function st(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}var LE,yi,FE,zE,GE,qE,KE,iw,JE,WE,zt,su,Wp,ow=y(()=>{LE=Object.prototype.toString,yi=Array.isArray||function(e){return LE.call(e)==="[object Array]"};FE=RegExp.prototype.test;zE=/\S/;GE={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};qE=/\s*/,KE=/\s+/,iw=/\s*=/,JE=/\s*\}/,WE=/#|\^|\/|>|\{|&|=|!/;iu.prototype.eos=function(){return this.tail===""};iu.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};iu.prototype.scanUntil=function(e){var t=this.tail.search(e),r;switch(t){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=r.length,r};bi.prototype.push=function(e){return new bi(e,this)};bi.prototype.lookup=function(e){var t=this.cache,r;if(t.hasOwnProperty(e))r=t[e];else{for(var a=this,s,i,o,u=!1;a;){if(e.indexOf(".")>0)for(s=a.view,i=e.split("."),o=0;s!=null&&o<i.length;)o===i.length-1&&(u=sw(s,i[o])||UE(s,i[o])),s=s[i[o++]];else s=a.view[e],u=sw(a.view,e);if(u){r=s;break}a=a.parent}t[e]=r}return Jp(r)&&(r=r.call(this.view)),r};st.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};st.prototype.parse=function(e,t){var r=this.templateCache,a=e+":"+(t||zt.tags).join(":"),s=typeof r<"u",i=s?r.get(a):void 0;return i==null&&(i=ZE(e,t),s&&r.set(a,i)),i};st.prototype.render=function(e,t,r,a){var s=this.getConfigTags(a),i=this.parse(e,s),o=t instanceof bi?t:new bi(t,void 0);return this.renderTokens(i,o,r,e,a)};st.prototype.renderTokens=function(e,t,r,a,s){for(var i="",o,u,l,c=0,f=e.length;c<f;++c)l=void 0,o=e[c],u=o[0],u==="#"?l=this.renderSection(o,t,r,a,s):u==="^"?l=this.renderInverted(o,t,r,a,s):u===">"?l=this.renderPartial(o,t,r,s):u==="&"?l=this.unescapedValue(o,t):u==="name"?l=this.escapedValue(o,t,s):u==="text"&&(l=this.rawValue(o)),l!==void 0&&(i+=l);return i};st.prototype.renderSection=function(e,t,r,a,s){var i=this,o="",u=t.lookup(e[1]);function l(d){return i.render(d,t,r,s)}if(u){if(yi(u))for(var c=0,f=u.length;c<f;++c)o+=this.renderTokens(e[4],t.push(u[c]),r,a,s);else if(typeof u=="object"||typeof u=="string"||typeof u=="number")o+=this.renderTokens(e[4],t.push(u),r,a,s);else if(Jp(u)){if(typeof a!="string")throw new Error("Cannot use higher-order sections without the original template");u=u.call(t.view,a.slice(e[3],e[5]),l),u!=null&&(o+=u)}else o+=this.renderTokens(e[4],t,r,a,s);return o}};st.prototype.renderInverted=function(e,t,r,a,s){var i=t.lookup(e[1]);if(!i||yi(i)&&i.length===0)return this.renderTokens(e[4],t,r,a,s)};st.prototype.indentPartial=function(e,t,r){for(var a=t.replace(/[^ \t]/g,""),s=e.split(`
`),i=0;i<s.length;i++)s[i].length&&(i>0||!r)&&(s[i]=a+s[i]);return s.join(`
`)};st.prototype.renderPartial=function(e,t,r,a){if(r){var s=this.getConfigTags(a),i=Jp(r)?r(e[1]):r[e[1]];if(i!=null){var o=e[6],u=e[5],l=e[4],c=i;u==0&&l&&(c=this.indentPartial(i,l,o));var f=this.parse(c,s);return this.renderTokens(f,t,r,c,a)}}};st.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(r!=null)return r};st.prototype.escapedValue=function(e,t,r){var a=this.getConfigEscape(r)||zt.escape,s=t.lookup(e[1]);if(s!=null)return typeof s=="number"&&a===zt.escape?String(s):a(s)};st.prototype.rawValue=function(e){return e[1]};st.prototype.getConfigTags=function(e){return yi(e)?e:e&&typeof e=="object"?e.tags:void 0};st.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!yi(e))return e.escape};zt={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(n){su.templateCache=n},get templateCache(){return su.templateCache}},su=new st;zt.clearCache=function(){return su.clearCache()};zt.parse=function(e,t){return su.parse(e,t)};zt.render=function(e,t,r,a){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+DE(e)+'" was given as the first argument for mustache#render(template, view, partials)');return su.render(e,t,r,a)};zt.escape=VE;zt.Scanner=iu;zt.Context=bi;zt.Writer=st;Wp=zt});var ou,QE,eI,tI,rI,Zp,nI,cn,uw,Xa,_i=y(()=>{ow();ou=n=>{let e=n.split(""),t=[],r=(s,i)=>{for(let o=i;o<e.length;o+=1)if(s.includes(e[o]))return o;return-1},a=0;for(;a<e.length;)if(e[a]==="{"&&a+1<e.length&&e[a+1]==="{")t.push({type:"literal",text:"{"}),a+=2;else if(e[a]==="}"&&a+1<e.length&&e[a+1]==="}")t.push({type:"literal",text:"}"}),a+=2;else if(e[a]==="{"){let s=r("}",a);if(s<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(a+1,s).join("")}),a=s+1}else{if(e[a]==="}")throw new Error("Single '}' in template.");{let s=r("{}",a),i=(s<0?e.slice(a):e.slice(a,s)).join("");t.push({type:"literal",text:i}),a=s<0?e.length:s}}return t},QE=n=>n.map(e=>e[0]==="name"?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:e[0]==="#"?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}),eI=n=>{let e=Wp.parse(n);return QE(e)},tI=(n,e)=>ou(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`(f-string) Missing value for input ${r.name}`)}return t+r.text},""),rI=(n,e)=>Wp.render(n,e),Zp={"f-string":tI,mustache:rI},nI={"f-string":ou,mustache:eI},cn=(n,e,t)=>Zp[e](n,t),uw=(n,e)=>nI[e](n),Xa=(n,e,t)=>{if(!(e in Zp)){let r=Object.keys(Zp);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{let r=t.reduce((a,s)=>(a[s]="foo",a),{});Array.isArray(n)?n.forEach(a=>{if(a.type==="text")cn(a.text,e,r);else if(a.type==="image_url")if(typeof a.image_url=="string")cn(a.image_url,e,r);else{let s=a.image_url.url;cn(s,e,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(a,null,2)}`)}):cn(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}}});var Yp={};ya(Yp,{PromptTemplate:()=>or});var or,wi=y(()=>{au();_i();or=class n extends un{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Xa(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return cn(this.template,this.templateFormat,t)}static fromExamples(e,t,r,a=`

`,s=""){let i=[s,...e,t].join(a);return new n({inputVariables:r,template:i})}static fromTemplate(e,t){let{templateFormat:r="f-string",...a}=t??{},s=new Set;return uw(e,r).forEach(i=>{i.type==="variable"&&s.add(i.name)}),new n({inputVariables:[...s],templateFormat:r,template:e,...a})}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new n({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}});var vi,Xp=y(()=>{nu();gi();_i();vi=class n extends ln{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Xa([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}async format(e){let t={};for(let[i,o]of Object.entries(this.template))typeof o=="string"?t[i]=o.replace(/{([^{}]*)}/g,(u,l)=>{let c=e[l];return typeof c=="string"||typeof c=="number"?String(c):u}):t[i]=o;let r=e.url||t.url,a=e.detail||t.detail;if(!r)throw new Error("Must provide either an image URL.");if(typeof r!="string")throw new Error("url must be a string.");let s={url:r};return a&&(s.detail=a),s}async formatPromptValue(e){let t=await this.format(e);return new Dc(t)}}});function aI(n){return typeof n.formatMessages=="function"}function sI(n,e){if(aI(n)||Ve(n))return n;if(Array.isArray(n)&&n[0]==="placeholder"){let a=n[1];if(typeof a!="string"||a[0]!=="{"||a[a.length-1]!=="}")throw new Error(`Invalid placeholder template: "${n[1]}". Expected a variable name surrounded by curly braces.`);let s=a.slice(1,-1);return new Qp({variableName:s,optional:!0})}let t=en(n),r;if(typeof t.content=="string"?r=t.content:r=t.content.map(a=>"text"in a?{text:a.text}:"image_url"in a?{image_url:a.image_url}:a),t._getType()==="human")return Uc.fromTemplate(r,e);if(t._getType()==="ai")return rm.fromTemplate(r,e);if(t._getType()==="system")return nm.fromTemplate(r,e);if(tr.isInstance(t))return tm.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function iI(n){return n.constructor.lc_name()==="MessagesPlaceholder"}var uu,Qp,em,lu,tm,cu,Uc,rm,nm,xi,du=y(()=>{Bt();nu();on();au();gi();wi();Xp();_i();uu=class extends K{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(r=>this.formatMessages(r),e,{...t,runType:"prompt"})}},Qp=class extends uu{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}validateInputOrThrow(e,t){if(this.optional&&!e)return!1;if(!e){let a=new Error(`Error: Field "${t}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw a.name="InputFormatError",a}let r=!1;if(Array.isArray(e)?r=e.every(a=>Ve(a)):r=Ve(e),!r){let a=typeof e=="string"?e:JSON.stringify(e,null,2),s=new Error(`Error: Field "${t}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: ${a}`);throw s.name="InputFormatError",s}return!0}async formatMessages(e){return this.validateInputOrThrow(e[this.variableName],this.variableName),e[this.variableName]??[]}},em=class extends uu{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},lu=class extends ln{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new mi(t)}},tm=class extends em{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new tr(await this.prompt.format(e),this.role)}static fromTemplate(e,t,r){return new this(or.fromTemplate(e,{templateFormat:r?.templateFormat}),t)}},cu=class extends uu{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let r=[];this.prompt.forEach(a=>{"inputVariables"in a&&(r=r.concat(a.inputVariables))}),this.inputVariables=r}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let r=t._messageClass();return new r({content:e})}else if(t.chatMessageClass){let r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(or.fromTemplate(e,t));let r=[];for(let a of e)if(typeof a=="string"||typeof a=="object"&&"text"in a){let s="";typeof a=="string"?s=a:typeof a.text=="string"&&(s=a.text??""),r.push(or.fromTemplate(s))}else if(typeof a=="object"&&"image_url"in a){let s=a.image_url??"",i,o=[];if(typeof s=="string"){let l=ou(s).flatMap(c=>c.type==="variable"?[c.name]:[]);if((l?.length??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${s}`);o=[l[0]]}else o=[];s={url:s},i=new vi({template:s,inputVariables:o})}else if(typeof s=="object")"url"in s?o=ou(s.url).flatMap(l=>l.type==="variable"?[l.name]:[]):o=[],i=new vi({template:s,inputVariables:o});else throw new Error("Invalid image template");r.push(i)}return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof un){let t=await this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let r of this.prompt){let a={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(let s of r.inputVariables)a||(a={[s]:e[s]}),a={...a,[s]:e[s]};if(r instanceof un){let s=await r.format(a);t.push({type:"text",text:s})}else if(r instanceof vi){let s=await r.format(a);t.push({type:"image_url",image_url:s})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},Uc=class extends cu{static _messageClass(){return Ae}static lc_name(){return"HumanMessagePromptTemplate"}},rm=class extends cu{static _messageClass(){return Oe}static lc_name(){return"AIMessagePromptTemplate"}},nm=class extends cu{static _messageClass(){return ai}static lc_name(){return"SystemMessagePromptTemplate"}};xi=class n extends lu{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let o of this.promptMessages)if(!(o instanceof Me))for(let u of o.inputVariables)t.add(u);let r=this.inputVariables,a=new Set(this.partialVariables?r.concat(Object.keys(this.partialVariables)):r),s=new Set([...a].filter(o=>!t.has(o)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are not used in any of the prompt messages.`);let i=new Set([...t].filter(o=>!a.has(o)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if(typeof e.content=="string")return e;let r=await Promise.all(e.content.map(async a=>{if(a.type!=="image_url")return a;let s="";typeof a.image_url=="string"?s=a.image_url:s=a.image_url.url;let o=await or.fromTemplate(s).format(t);return typeof a.image_url!="string"&&"url"in a.image_url?a.image_url.url=o:a.image_url=o,a}));return e.content=r,e}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=[];for(let a of this.promptMessages)if(a instanceof Me)r.push(await this._parseImagePrompts(a,t));else{let s=a.inputVariables.reduce((o,u)=>{if(!(u in t)&&!(iI(a)&&a.optional))throw new Error(`Missing value for input variable \`${u.toString()}\``);return o[u]=t[u],o},{}),i=await a.formatMessages(s);r=r.concat(i)}return r}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}static fromTemplate(e,t){let r=or.fromTemplate(e,t),a=new Uc({prompt:r});return this.fromMessages([a])}static fromMessages(e,t){let r=e.reduce((i,o)=>i.concat(o instanceof n?o.promptMessages:[sI(o,t)]),[]),a=e.reduce((i,o)=>o instanceof n?Object.assign(i,o.partialVariables):i,Object.create(null)),s=new Set;for(let i of r)if(!(i instanceof Me))for(let o of i.inputVariables)o in a||s.add(o);return new this({...t,inputVariables:[...s],promptMessages:r,partialVariables:a,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}});var lw={};ya(lw,{FewShotChatMessagePromptTemplate:()=>sm,FewShotPromptTemplate:()=>am});var am,sm,im=y(()=>{au();_i();wi();du();am=class n extends un{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Xa(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),a=await Promise.all(r.map(i=>this.examplePrompt.format(i))),s=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return cn(s,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let r=await or.deserialize(t),a;if(Array.isArray(e.examples))a=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new n({inputVariables:e.input_variables,examplePrompt:r,examples:a,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}},sm=class n extends lu{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Xa(this.prefix+this.suffix,this.templateFormat,t)}}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t);r=r.map(s=>{let i={};return this.examplePrompt.inputVariables.forEach(o=>{i[o]=s[o]}),i});let a=[];for(let s of r){let i=await this.examplePrompt.formatMessages(s);a.push(...i)}return a}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),s=(await Promise.all(r.map(o=>this.examplePrompt.formatMessages(o)))).flat().map(o=>o.content),i=[this.prefix,...s,this.suffix].join(this.exampleSeparator);return cn(i,this.templateFormat,t)}async partial(e){let t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new n(a)}}});var ln,gi=y(()=>{on();ln=class extends K{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},r={};for(let[s,i]of Object.entries(t))typeof i=="string"?r[s]=i:r[s]=await i();return{...r,...e}}async invoke(e,t){return this._callWithConfig(r=>this.formatPromptValue(r),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await Promise.resolve().then(()=>(wi(),Yp));return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await Promise.resolve().then(()=>(wi(),Yp));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await Promise.resolve().then(()=>(im(),lw));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}});var w0=Fe((sJ,_0)=>{_0.exports=function(){var n=document.getSelection();if(!n.rangeCount)return function(){};for(var e=document.activeElement,t=[],r=0;r<n.rangeCount;r++)t.push(n.getRangeAt(r));switch(e.tagName.toUpperCase()){case"INPUT":case"TEXTAREA":e.blur();break;default:e=null;break}return n.removeAllRanges(),function(){n.type==="Caret"&&n.removeAllRanges(),n.rangeCount||t.forEach(function(a){n.addRange(a)}),e&&e.focus()}}});var O0=Fe((iJ,x0)=>{"use strict";var LS=w0(),v0={"text/plain":"Text","text/html":"Url",default:"Text"},DS="Copy to clipboard: #{key}, Enter";function US(n){var e=(/mac os x/i.test(navigator.userAgent)?"\u2318":"Ctrl")+"+C";return n.replace(/#{\s*key\s*}/g,e)}function FS(n,e){var t,r,a,s,i,o,u=!1;e||(e={}),t=e.debug||!1;try{a=LS(),s=document.createRange(),i=document.getSelection(),o=document.createElement("span"),o.textContent=n,o.ariaHidden="true",o.style.all="unset",o.style.position="fixed",o.style.top=0,o.style.clip="rect(0, 0, 0, 0)",o.style.whiteSpace="pre",o.style.webkitUserSelect="text",o.style.MozUserSelect="text",o.style.msUserSelect="text",o.style.userSelect="text",o.addEventListener("copy",function(c){if(c.stopPropagation(),e.format)if(c.preventDefault(),typeof c.clipboardData>"u"){t&&console.warn("unable to use e.clipboardData"),t&&console.warn("trying IE specific stuff"),window.clipboardData.clearData();var f=v0[e.format]||v0.default;window.clipboardData.setData(f,n)}else c.clipboardData.clearData(),c.clipboardData.setData(e.format,n);e.onCopy&&(c.preventDefault(),e.onCopy(c.clipboardData))}),document.body.appendChild(o),s.selectNodeContents(o),i.addRange(s);var l=document.execCommand("copy");if(!l)throw new Error("copy command was unsuccessful");u=!0}catch(c){t&&console.error("unable to copy using execCommand: ",c),t&&console.warn("trying IE specific stuff");try{window.clipboardData.setData(e.format||"text",n),e.onCopy&&e.onCopy(window.clipboardData),u=!0}catch(f){t&&console.error("unable to copy using clipboardData: ",f),t&&console.error("falling back to prompt"),r=US("message"in e?e.message:DS),window.prompt(r,n)}}finally{i&&(typeof i.removeRange=="function"?i.removeRange(s):i.removeAllRanges()),o&&document.body.removeChild(o),a()}return u}x0.exports=FS});var _f={id:"acode.plugin.chatgpt",name:"AI Assistant",main:"dist/main.js",version:"2.0.0",readme:"readme.md",icon:"icon.png",files:["assets/ai_assistant.svg","assets/user_avatar.png","assets/github-dark.css","assets/highlight.min.js","assets/markdown-it.min.js"],price:0,author:{name:"Raunak",email:"bajrangcoders@gmail.com",github:"bajrangCoder"}};var ab=`/*---------------------------------------*\\
 * Styles For Image generator
 * DALL-E
\\*---------------------------------------*/
.main-sidebar-cont {
  padding: 1rem;
}
.main-sidebar-cont * {
  box-sizing: border-box;
}
.main-sidebar-cont .sidebar-ai-heading {
  text-align: center;
  padding-bottom: 15px;
}
.main-sidebar-cont .prompt-area {
  width: 100%;
  font: initial;
  font-size: 0.9rem;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid gray;
  outline: none;
  color: var(--primary-text-color);
  resize: none;
  margin-bottom: 8px;
  background: transparent;
}
.main-sidebar-cont .prompt-area:focus-visible {
  border-color: var(--button-background-color);
}
.main-sidebar-cont .size-selector {
  width: 100%;
  margin-bottom: 16px;
  background: transparent;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid gray;
  outline: none;
  color: var(--primary-text-color);
}
.main-sidebar-cont .size-selector:focus-visible {
  border-color: var(--button-background-color);
}
.main-sidebar-cont .generatorBtn {
  border: none;
  background: var(--button-background-color);
  color: var(--button-text-color);
  padding: 10px 16px;
  border-top-left-radius: 15px;
  border-bottom-right-radius: 15px;
  font-weight: 600;
  font-size: 16px;
}
.main-sidebar-cont .img-fluid {
  max-width: 100%;
  margin-top: 10px;
}

/*---------------------------------------*\\
 * Styles For Text Generator
 * AI Assistant
\\*---------------------------------------*/
#acode-ai-assistant {
  /**
  * Display User input in chatBox
  */
  /**
  * Displat Ai response in chatBox
  */
  /**
  * Highlights Code AREA
  * In Ai response
  */
  /**
  * Error In ai response
  */
  /**
  * PROMPT AREA For CHATGPT
  */
}
#acode-ai-assistant * {
  box-sizing: border-box;
}
#acode-ai-assistant .mainApp {
  position: absolute;
  left: 0;
  width: 100%;
  height: calc(100% - 80px);
  background: var(--primary-color);
}
#acode-ai-assistant .chatBox {
  height: 100%;
  width: 100%;
  white-space: pre-wrap;
  overflow-y: auto;
}
#acode-ai-assistant .wrapper {
  padding-block: 12px;
  padding-inline: 10px;
}
#acode-ai-assistant .wrapper .chat {
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
#acode-ai-assistant .wrapper .chat .profile {
  height: 35px;
  width: 35px;
  border-radius: 8px;
  background: #5436da;
  display: flex;
  align-items: center;
  justify-content: center;
}
#acode-ai-assistant .wrapper .chat .profile img {
  width: 60%;
}
#acode-ai-assistant .wrapper .chat .message {
  flex: 1;
  color: var(--primary-text-color);
  font-size: 16px;
  line-height: 1.5;
  user-select: text;
}
#acode-ai-assistant .ai_wrapper {
  padding-block: 12px 30px;
  padding-inline: 10px;
  background-color: var(--secondary-color);
}
#acode-ai-assistant .ai_wrapper .ai_chat {
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
#acode-ai-assistant .ai_wrapper .ai_chat .ai_profile {
  height: 35px;
  width: 35px;
  border-radius: 8px;
  background: #10a37f;
  display: flex;
  align-items: center;
  justify-content: center;
}
#acode-ai-assistant .ai_wrapper .ai_chat .ai_profile img {
  width: 60%;
}
#acode-ai-assistant .ai_wrapper .ai_message {
  flex: 1;
  color: var(--secondary-text-color);
  font-size: 16px;
  line-height: 1.5;
  overflow: hidden;
  user-select: text;
  /*
  code block in ai response
  */
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock {
  border: 2px solid var(--border-color);
  width: 100%;
  border-radius: 5px;
  overflow-x: auto;
  position: relative;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .copy-button {
  position: absolute;
  top: 4px;
  right: 8px;
  border: none;
  outline: none;
  border-radius: 8px;
  height: 24px;
  width: 28px;
  color: lightgray;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  background: rgb(26, 34, 46);
  box-shadow: 0 4px 0 #1b232f;
  transition: all 0.3s ease-in-out;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .copy-button:active {
  box-shadow: 0;
  color: gray;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .codesArea {
  box-sizing: border-box;
  padding: 12px;
  margin-bottom: 0;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .codesArea::-webkit-scrollbar {
  height: 10px;
}
#acode-ai-assistant .ai_wrapper .ai_message .codeBlock .codesArea::-webkit-scrollbar-thumb {
  background: lightgray;
  border-radius: 4px;
}
#acode-ai-assistant .ai_wrapper .ai_message hr {
  margin: 1rem 0;
  color: inherit;
  border: 0;
  border-top: 1px solid;
  opacity: 0.25;
}
#acode-ai-assistant .ai_wrapper .ai_message h6,
#acode-ai-assistant .ai_wrapper .ai_message h5,
#acode-ai-assistant .ai_wrapper .ai_message h4,
#acode-ai-assistant .ai_wrapper .ai_message h3,
#acode-ai-assistant .ai_wrapper .ai_message h2,
#acode-ai-assistant .ai_wrapper .ai_message h1 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-weight: 500;
  line-height: 1.2;
  color: inherit;
}
#acode-ai-assistant .ai_wrapper .ai_message h1 {
  font-size: calc(1.375rem + 1.5vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h2 {
  font-size: calc(1.325rem + 0.9vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h3 {
  font-size: calc(1.3rem + 0.6vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h4 {
  font-size: calc(1.275rem + 0.3vw);
}
#acode-ai-assistant .ai_wrapper .ai_message h5 {
  font-size: 1.25rem;
}
#acode-ai-assistant .ai_wrapper .ai_message h6 {
  font-size: 1rem;
}
#acode-ai-assistant .ai_wrapper .ai_message p {
  margin-top: 0;
  margin-bottom: 1rem;
}
#acode-ai-assistant .ai_wrapper .ai_message ul,
#acode-ai-assistant .ai_wrapper .ai_message ol {
  margin: 1em 0;
  padding: 0 0 0 2em;
}
#acode-ai-assistant .ai_wrapper .ai_message ul {
  list-style-type: disc;
}
#acode-ai-assistant .ai_wrapper .ai_message li p:last-child {
  margin: 0;
}
#acode-ai-assistant .ai_wrapper .ai_message dt {
  font-weight: 700;
}
#acode-ai-assistant .ai_wrapper .ai_message dd {
  margin-bottom: 0.5rem;
  margin-left: 0;
}
#acode-ai-assistant .ai_wrapper .ai_message blockquote {
  margin: 0 0 1rem;
}
#acode-ai-assistant .ai_wrapper .ai_message b,
#acode-ai-assistant .ai_wrapper .ai_message strong {
  font-weight: bolder;
}
#acode-ai-assistant .ai_wrapper .ai_message small,
#acode-ai-assistant .ai_wrapper .ai_message .small {
  font-size: 0.875em;
}
#acode-ai-assistant .ai_wrapper .ai_message pre,
#acode-ai-assistant .ai_wrapper .ai_message code,
#acode-ai-assistant .ai_wrapper .ai_message kbd,
#acode-ai-assistant .ai_wrapper .ai_message samp {
  font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 1em;
}
#acode-ai-assistant .ai_wrapper .ai_message pre {
  display: block;
  margin-top: 0;
  margin-bottom: 1rem;
  overflow: auto;
  font-size: 0.875em;
}
#acode-ai-assistant .ai_wrapper .ai_message pre code {
  font-size: inherit;
  color: inherit;
}
#acode-ai-assistant .ai_wrapper .ai_message code {
  font-size: 0.875em;
  color: var(--link-text-color);
  word-wrap: break-word;
}
#acode-ai-assistant .ai_wrapper .ai_message a > code {
  color: inherit;
}
#acode-ai-assistant .ai_wrapper .ai_message kbd {
  padding: 0.1875rem 0.375rem;
  font-size: 0.875em;
  color: var(--primary-text-color);
  background-color: var(--popup-background-color);
  border-radius: 0.25rem;
}
#acode-ai-assistant .ai_wrapper .ai_message kbd kbd {
  padding: 0;
  font-size: 1em;
}
#acode-ai-assistant .error-box {
  border: 1px solid var(--error-text-color);
  color: var(--error-text-color);
  font-weight: 700;
  padding: 8px;
  white-space: pre-wrap;
  word-break: break-word;
  border-radius: 10px;
}
#acode-ai-assistant .inputBox {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 80px;
  padding: 8px;
  display: flex;
  background-color: var(--popup-background-color);
  box-shadow: 0px -2px 4px var(--box-shadow-color);
  z-index: 1;
}
#acode-ai-assistant .chatTextarea {
  flex: 1;
  height: 100%;
  resize: none;
  border: none;
  outline: none;
  background: none;
  font: initial;
  font-size: 1.1rem;
  color: var(--primary-text-color);
  padding-inline-end: 8px;
}
#acode-ai-assistant .sendBtn {
  height: 40px;
  width: 40px;
  border-radius: 8px;
  border: none;
  outline: none;
  background-color: rgba(0, 0, 0, 0.2);
  color: gray;
  display: grid;
  place-items: center;
}
#acode-ai-assistant .sendBtn:active {
  background-color: var(--button-background-color);
  color: var(--primary-text-color);
}`;var sb;(function(n){n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT"})(sb||(sb={}));var rl;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(rl||(rl={}));var nl;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(nl||(nl={}));var ib;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(ib||(ib={}));var ob;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(ob||(ob={}));var al;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.OTHER="OTHER"})(al||(al={}));var ub;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(ub||(ub={}));var lb;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(lb||(lb={}));var cb;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(cb||(cb={}));var hk=[al.RECITATION,al.SAFETY];function db(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}var _b=q(sl(),1),q0=q(il(),1);function wb(n,e){return e?.[n]||(0,_b.default)(n)}function vb(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function xb(n){return Array.isArray(n)?[...n]:{...n}}function K0(n,e){let t=xb(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=xb(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function vf(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var Gt=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vf(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let l of u.reverse()){if(!(l in s)||s[l]===void 0)return;(!(l in i)||i[l]===void 0)&&(typeof s[l]=="object"&&s[l]!=null?i[l]={}:Array.isArray(s[l])&&(i[l]=[])),s=s[l],i=i[l]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:vb(Object.keys(t).length?K0(r,t):r,wb,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function _a(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}var wt=class extends Gt{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}};function xr(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string")t[r]=t[r]+a;else if(!Array.isArray(t[r])&&typeof t[r]=="object")t[r]=xr(t[r],a);else if(Array.isArray(t[r]))t[r]=xf(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function xf(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=xr(t[a],r):t.push(r)}else t.push(r);return t}}}var Vr=class extends wt{};function Ob(n){return typeof n?._getType=="function"}function Ab(n){let e=[],t=[];for(let r of n)if(r.function){let a=r.function.name;try{let s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var Bs=class extends wt{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let a=r.additional_kwargs?.tool_calls,s=r.tool_calls;a!=null&&a.length>0&&(s===void 0||s.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&s===void 0){let[i,o]=Ab(a);r.tool_calls=i??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}};var jt=class n extends Vr{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{let r=[],a=[];for(let s of e.tool_call_chunks){let i={};try{if(i=db(s.args??"{}")??{},typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args."})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){let t={content:_a(this.content,e.content),additional_kwargs:xr(this.additional_kwargs,e.additional_kwargs),response_metadata:xr(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let r=xf(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:r.input_tokens+a.input_tokens,output_tokens:r.output_tokens+a.output_tokens,total_tokens:r.total_tokens+a.total_tokens};t.usage_metadata=s}return new n(t)}};var mo=class n extends wt{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}};var qr=class extends wt{static lc_name(){return"HumanMessage"}_getType(){return"human"}};var ol=class extends wt{static lc_name(){return"SystemMessage"}_getType(){return"system"}};function wa(n){if(typeof n=="string")return new qr(n);if(Ob(n))return n;let[e,t]=n;if(e==="human"||e==="user")return new qr({content:t});if(e==="ai"||e==="assistant")return new Bs({content:t});if(e==="system")return new ol({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function go(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"";r.push(`${s}: ${i}${a.content}`)}return r.join(`
`)}var Of="__run",bo=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},va=class n extends bo{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};var W0=typeof window=="object"?window:{},L="0123456789abcdef".split(""),Z0=[-2147483648,8388608,32768,128],Vt=[24,16,8,0];var be=[];function qt(n){n?(be[0]=be[16]=be[1]=be[2]=be[3]=be[4]=be[5]=be[6]=be[7]=be[8]=be[9]=be[10]=be[11]=be[12]=be[13]=be[14]=be[15]=0,this.blocks=be):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}qt.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===W0.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<Vt[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<Vt[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<Vt[a++&3],i[a>>2]|=(128|t&63)<<Vt[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<Vt[a++&3],i[a>>2]|=(128|t>>6&63)<<Vt[a++&3],i[a>>2]|=(128|t&63)<<Vt[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<Vt[a++&3],i[a>>2]|=(128|t>>12&63)<<Vt[a++&3],i[a>>2]|=(128|t>>6&63)<<Vt[a++&3],i[a>>2]|=(128|t&63)<<Vt[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};qt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=Z0[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};qt.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};qt.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return L[n>>28&15]+L[n>>24&15]+L[n>>20&15]+L[n>>16&15]+L[n>>12&15]+L[n>>8&15]+L[n>>4&15]+L[n&15]+L[e>>28&15]+L[e>>24&15]+L[e>>20&15]+L[e>>16&15]+L[e>>12&15]+L[e>>8&15]+L[e>>4&15]+L[e&15]+L[t>>28&15]+L[t>>24&15]+L[t>>20&15]+L[t>>16&15]+L[t>>12&15]+L[t>>8&15]+L[t>>4&15]+L[t&15]+L[r>>28&15]+L[r>>24&15]+L[r>>20&15]+L[r>>16&15]+L[r>>12&15]+L[r>>8&15]+L[r>>4&15]+L[r&15]+L[a>>28&15]+L[a>>24&15]+L[a>>20&15]+L[a>>16&15]+L[a>>12&15]+L[a>>8&15]+L[a>>4&15]+L[a&15]};qt.prototype.toString=qt.prototype.hex;qt.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};qt.prototype.array=qt.prototype.digest;qt.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var Af=n=>new qt(!0).update(n).hex();var Eb=(...n)=>Af(n.join("_"));var Ef=class{},Y0=new Map,ul=class n extends Ef{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Eb(e,t))??null)}async update(e,t,r){this.cache.set(Eb(e,t),r)}static global(){return new n(Y0)}};var ll=class extends Gt{},cl=class extends ll{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new qr(this.value)]}},dl=class extends ll{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return go(this.messages)}toChatMessages(){return this.messages}};var Bb=q(Or(),1),yl=q(Ar(),1),dx=[400,401,402,403,404,405,406,407,409],fx=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;let e=n?.response?.status??n?.status;if(e&&dx.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){let t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}},En=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??fx;let t="default"in yl.default?yl.default.default:yl.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Bb.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var Vb=q(Gb(),1),wx=Object.defineProperty,vx=(n,e,t)=>e in n?wx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,xx=(n,e,t)=>(vx(n,typeof e!="symbol"?e+"":e,t),t);function Ox(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){let s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){let a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function Ax(n,e){return n.length===1?[e.get(n.join(","))]:Ox(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function Ex(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Nf=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(n,e){this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{let[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((l,c)=>r[l]=u+c),r},{});for(let[r,a]of Object.entries(t)){let s=Vb.default.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){let r=new RegExp(this.patStr,"ug"),a=Nf.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!i.has(l)):t);if(o.size>0){let l=Nf.specialTokenRegex([...o]),c=n.match(l);if(c!=null)throw new Error(`The text contains a special token that is not allowed: ${c[0]}`)}let u=0;for(;;){let l=null,c=u;for(;a.lastIndex=c,l=a.exec(n),!(l==null||i.has(l[0]));)c=l.index+1;let f=l?.index??n.length;for(let h of n.substring(u,f).matchAll(r)){let p=this.textEncoder.encode(h[0]),m=this.rankMap.get(p.join(","));if(m!=null){s.push(m);continue}s.push(...Ax(p,this.rankMap))}if(l==null)break;let d=this.specialTokens[l[0]];s.push(d),u=l.index+l[0].length}return s}decode(n){let e=[],t=0;for(let s=0;s<n.length;++s){let i=n[s],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}let r=new Uint8Array(t),a=0;for(let s of e)r.set(s,a),a+=s.length;return this.textDecoder.decode(r)}},In=Nf;xx(In,"specialTokenRegex",n=>new RegExp(n.map(e=>Ex(e)).join("|"),"g"));function Aa(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":return"o200k_base";default:throw new Error("Unknown model")}}var wl={},Ix=new En({});async function Tx(n){return n in wl||(wl[n]=Ix.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new In(e)).catch(e=>{throw delete wl[n],e})),await wl[n]}async function qb(n){return Tx(Aa(n))}Pr();var Gh=q(Or(),1);ce();var Bf=class{getStore(){}run(e,t){return t()}},zf=class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new Bf}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}},jO=new zf,hy=()=>{let n=jO.getInstance().getStore();if(n===void 0)throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function."].join(`
`));return n},WC=Symbol.for("langsmith:traceable:root");function Pl(n){return typeof n=="function"&&"langsmith:traceable"in n}ce();ce();var MO=()=>typeof window<"u"&&typeof window.document<"u",$O=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",LO=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),py=()=>typeof Deno<"u",DO=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!py(),UO=()=>{let n;return MO()?n="browser":DO()?n="node":$O()?n="webworker":LO()?n="jsdom":py()?n="deno":n="other",n},Hf;async function my(){return Hf===void 0&&(Hf={library:"langchain-js",runtime:UO()}),Hf}function At(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var Gf=class{},Fa=class n extends Gf{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vf(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:At("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Gt.prototype.toJSON.call(this)}toJSONNotImplemented(){return Gt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:S()}),Object.assign(this,e)}}return new t}};var qf=q(Sl(),1);function Vf(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function BO(n){return n.replace(/[-:.]/g,"")}function zO(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return BO(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}var Et=class extends Fa{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){let t=zO(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await this.onRunCreate?.(r)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleChatModelStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}async handleChainStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(f),await this.onChainStart?.(f),f}async handleChainEnd(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Vf(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=Vf(s.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=Vf(s.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}async handleToolStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onToolStart?.(c),c}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}async handleRetrieverStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onRetrieverStart?.(c),c}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,s,i){let o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:i?.chunk}),o}};function tt(n,e){return`${n.open}${e}${n.close}`}function Jt(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function Cn(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:ft}=qf.default,Eo=class extends Et{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?tt(qf.default.bold,o):o}).join(" > ");return tt(ft.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Jt(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.cyan,"[chain/end]")} [${t}] [${Cn(e)}] Exiting Chain run with output: ${Jt(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.red,"[chain/error]")} [${t}] [${Cn(e)}] Chain run errored with error: ${Jt(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${tt(ft.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Jt(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.cyan,"[llm/end]")} [${t}] [${Cn(e)}] Exiting LLM run with output: ${Jt(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.red,"[llm/error]")} [${t}] [${Cn(e)}] LLM run errored with error: ${Jt(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.cyan,"[tool/end]")} [${t}] [${Cn(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.red,"[tool/error]")} [${t}] [${Cn(e)}] Tool run errored with error: ${Jt(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Jt(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.cyan,"[retriever/end]")} [${t}] [${Cn(e)}] Exiting Retriever run with output: ${Jt(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${tt(ft.red,"[retriever/error]")} [${t}] [${Cn(e)}] Retriever run errored with error: ${Jt(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${tt(ft.blue,"[agent/action]")} [${r}] Agent selected action: ${Jt(t.actions[t.actions.length-1],"[action]")}`)}};ce();var _y=q(Or(),1),kl=q(Ar(),1),HO=[400,401,403,404,405,406,407,408],GO=[409],Io=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in kl.default?this.queue=new kl.default.default({concurrency:this.maxConcurrency}):this.queue=new kl.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,_y.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;let s=a?.response,i=s?.status;if(i){if(HO.includes(+i))throw a;if(GO.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Kf(n){return typeof n?._getType=="function"}function Jf(n){let e={type:n._getType(),data:{content:n.content}};return n?.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var Yr,VO=()=>typeof window<"u"&&typeof window.document<"u",qO=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",KO=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),wy=()=>typeof Deno<"u",JO=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!wy(),WO=()=>Yr||(VO()?Yr="browser":JO()?Yr="node":qO()?Yr="webworker":KO()?Yr="jsdom":wy()?Yr="deno":Yr="other",Yr),Wf;async function Yf(){if(Wf===void 0){let n=WO(),e=YO();Wf={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Cl,...e}}return Wf}function vy(){let n=ZO()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[r,a]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function ZO(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Sr(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var Zf;function YO(){if(Zf!==void 0)return Zf;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=Sr(t);r!==void 0&&(e[t]=r)}return Zf=e,e}ce();function ee(n){if(!Ot(n))throw new Error(`Invalid UUID: ${n}`)}async function xy(n){let e=await Yf(),t=vy();return n.map(r=>{let a=r.extra??{},s=a.metadata;return r.extra={...a,runtime:{...e,...a?.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...s}},r})}var XO=()=>{let n=Sr("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},QO=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},Rn=async(n,e)=>{let t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function eA(n){let e=[];for await(let t of n)e.push(t);return e}function Xf(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var tA=async n=>{if(n?.status===429){let e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1},Qf=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");let t=[];for(;t.length<e&&this.items.length;){let r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}},rA=20971520,Zs=class n{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Qf}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=n.getDefaultClientConfig();this.tracingSampleRate=XO(),this.apiUrl=Xf(e.apiUrl??t.apiUrl)??"",this.apiKey=Xf(e.apiKey??t.apiKey),this.webUrl=Xf(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Io(e.callerOptions??{}),this.batchIngestCaller=new Io({...e.callerOptions??{},onFailedResponseHook:tA}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){let e=Sr("LANGCHAIN_API_KEY"),t=Sr("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=Sr("LANGCHAIN_HIDE_INPUTS")==="true",a=Sr("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:QO(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${Cl}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){let r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0,a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));let s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);let o=await i.json();if(o.length===0||(yield o,o.length<a))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.sampledPostUuids.has(a.id)&&(r.push(a),this.sampledPostUuids.delete(a.id));return r}else{let r=[];for(let a of e)Math.random()<this.tracingSampleRate&&(r.push(a),this.sampledPostUuids.add(a.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){let[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){let r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;let a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){let e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=await xy([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(s[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Rn(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=e?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[],a=t?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[];if(r.length>0&&a.length>0){let l=r.reduce((f,d)=>(d.id&&(f[d.id]=d),f),{}),c=[];for(let f of a)f.id!==void 0&&l[f.id]?l[f.id]={...l[f.id],...f}:c.push(f);r=Object.values(l),a=c}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;if(r=await xy(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(let l of s.post)await this.createRun(l);for(let l of s.patch)l.id!==void 0&&await this.updateRun(l.id,l);return}let i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??rA,o={post:[],patch:[]},u=0;for(let l of["post","patch"]){let c=l,f=s[c].reverse(),d=f.pop();for(;d!==void 0;){let h=JSON.stringify(d);u>0&&u+h.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=h.length,o[c].push(d),d=f.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Rn(r,"batch create run")}async updateRun(e,t){ee(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Rn(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){ee(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r?.projectName?a=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?a=r?.projectId:a=(await this.readProject({projectName:Sr("LANGCHAIN_PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await eA(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>(s?.dotted_order??"").localeCompare(i?.dotted_order??""));for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:l,runType:c,error:f,id:d,query:h,filter:p,traceFilter:m,treeFilter:g,limit:b,select:x}=e,_=[];if(t&&(_=Array.isArray(t)?t:[t]),r){let j=Array.isArray(r)?r:[r],J=await Promise.all(j.map(Xe=>this.readProject({projectName:Xe}).then(po=>po.id)));_.push(...J)}let k=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],O={session:_.length?_:null,run_type:c,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:g,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:f,id:d,limit:b,trace:s,select:x||k,is_root:l},B=0;for await(let j of this._getCursorPaginatedList("/runs/query",O))if(b){if(B>=b)break;if(j.length+B>b){yield*j.slice(0,b-B);break}B+=j.length,yield*j}else yield*j}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||S()};ee(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){ee(e);let t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Rn(t,"unshare run")}async readRunSharedLink(e){ee(e);let r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return ee(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),ee(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};ee(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){ee(e);let t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Rn(t,"unshare dataset")}async readSharedDataset(e){return ee(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=s||{};r&&(l.metadata=r);let c={name:e,extra:l,description:t};i!==null&&(c.reference_dataset_id=i);let f=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await f.json();if(!f.ok)throw new Error(`Failed to create session ${e}: ${f.status} ${f.statusText}`);return d}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let l={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},c=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),f=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return f}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)ee(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)ee(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){let o=new URLSearchParams;if(e!==void 0)for(let u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){let u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(let u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,ee(r);let a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Rn(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(d=>{l.append("input_keys",d)}),a.forEach(d=>{l.append("output_keys",d)}),s&&l.append("description",s),i&&l.append("data_type",i),o&&l.append("name",o);let c=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!c.ok){let d=await c.json();throw d.detail&&d.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){let a={name:e,description:t};r&&(a.data_type=r);let s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok){let o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)ee(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s}={}){let i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let u of r)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(let u of this._getPaginated(i,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)ee(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to delete ${r}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);let f={dataset_id:l,inputs:e,outputs:t,created_at:(s||new Date)?.toISOString(),id:i,metadata:o,split:u},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createExamples(e){let{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e,l=o;if(l===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:u})).id);let c=t.map((h,p)=>({dataset_id:l,inputs:h,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),f=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!f.ok)throw new Error(`Failed to create examples: ${f.status} ${f.statusText}`);return await f.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>Kf(i)?Jf(i):i),s=Kf(t)?Jf(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){ee(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o}={}){let u;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)u=e;else if(t!==void 0)u=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let l=new URLSearchParams({dataset:u}),c=a?typeof a=="string"?a:a?.toISOString():void 0;c&&l.append("as_of",c);let f=i??!0;if(l.append("inline_s3_urls",f.toString()),r!==void 0)for(let d of r)l.append("id",d);if(s!==void 0)for(let d of s)l.append("splits",d);if(o!==void 0){let d=JSON.stringify(o);l.append("metadata",d)}for await(let d of this._getPaginated("/examples",l))yield*d}async deleteExample(e){ee(e);let t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){ee(e);let r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),u=r??{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});let l=o.targetRunId??i.id;return await this.createFeedback(l,o.key,{score:o?.score,value:o?.value,comment:o?.comment,correction:o?.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o?.sourceRunId})}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,feedbackConfig:f,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");let p={type:u??"api",metadata:o??{}};l!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:l}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&ee(p.metadata.__run.run_id);let m={id:c??S(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:f,session_id:d},g=`${this.apiUrl}/feedback`,b=await this.caller.call(fetch,g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Rn(b,"create feedback"),m}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),ee(e);let o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Rn(o,"update feedback")}async readFeedback(e){ee(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){ee(e);let t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(a??new Date)?.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){ee(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e);for(let s of a){let i=r||{};s.evaluatorInfo&&(i={...s.evaluatorInfo,...i});let o=null;s.targetRunId?o=s.targetRunId:t&&(o=t.id),await this.createFeedback(o,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:i,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"})}return a}};var Cl="0.1.30";var To=class extends Et{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=r??At("LANGCHAIN_PROJECT")??At("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new Zs({});let s=this.getTraceableRunTree();if(s){let i=s,o=new Set;for(;i.parent_run&&!(o.has(i.id)||(o.add(i.id),!i.parent_run));)i=i.parent_run;o.clear();let u=[i];for(;u.length>0;){let l=u.shift();!l||o.has(l.id)||(o.add(l.id),this.runMap.set(l.id,l),l.child_runs&&u.push(...l.child_runs))}this.client=s.client??this.client,this.projectName=s.project_name??this.projectName,this.exampleId=s.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await my()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return hy()}catch{return}}};async function Oy(){return new To}var Rl=q(Ar(),1),eh;function nA(){let n="default"in Rl.default?Rl.default.default:Rl.default;return new n({autoStart:!0,concurrency:1})}async function _e(n,e){e===!0?await n():(typeof eh>"u"&&(eh=nA()),eh.add(n))}At("LANGCHAIN_TRACING_V2")==="true"&&At("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);var th=class{setHandler(e){return this.setHandlers([e])}},Ys=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>_e(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},rh=class extends Ys{getChild(e){let t=new rt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},Nl=class extends Ys{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>_e(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(u){if(console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},nh=class extends Ys{getChild(e){let t=new rt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>_e(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>_e(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},ah=class extends Ys{getChild(e){let t=new rt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},rt=class n extends th{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:S();return await Promise.all(this.handlers.map(d=>_e(async()=>{if(!d.ignoreLLM)try{await d.handleLLMStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u)}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new Nl(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:S();return await Promise.all(this.handlers.map(d=>_e(async()=>{if(!d.ignoreLLM)try{if(d.handleChatModelStart)await d.handleChatModelStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u);else if(d.handleLLMStart){let h=go(l);await d.handleLLMStart?.(e,[h],f,this._parentRunId,s,this.tags,this.metadata,u)}}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new Nl(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>_e(async()=>{if(!u.ignoreChain)try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new nh(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>_e(async()=>{if(!u.ignoreAgent)try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new ah(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>_e(async()=>{if(!u.ignoreRetriever)try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new rh(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends Fa{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:S()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers(e?.map(Po)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(Po):t?.handlers,!1));let l=At("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=At("LANGCHAIN_TRACING_V2")==="true"||At("LANGSMITH_TRACING")==="true",f=c||(At("LANGCHAIN_TRACING")??!1);if(l||f){if(u||(u=new n),l&&!u.handlers.some(d=>d.name===Eo.prototype.name)){let d=new Eo;u.addHandler(d,!0)}if(f&&!u.handlers.some(d=>d.name==="langchain_tracer")&&c){let d=await Oy();u.addHandler(d,!0),u._parentRunId=d.getTraceableRunTree()?.id??u._parentRunId}}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}};function Po(n){return"name"in n?n:Fa.fromMethods(n)}var sh={};ya(sh,{JsonPatchError:()=>se,_areEquals:()=>ko,applyOperation:()=>za,applyPatch:()=>Ha,applyReducer:()=>oA,deepClone:()=>sA,getValueByPointer:()=>Ll,validate:()=>Ty,validator:()=>Dl});var aA=Object.prototype.hasOwnProperty;function Ey(n,e){return aA.call(n,e)}function Iy(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Ey(n,t)&&e.push(t);return e}function Ut(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Ml(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function $l(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function So(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function jl(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(jl(n[t]))return!0}else if(typeof n=="object"){let t=Iy(n),r=t.length;for(var e=0;e<r;e++)if(jl(n[t[e]]))return!0}}return!1}function Ay(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var Ba=class extends Error{constructor(e,t,r,a,s){super(Ay(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=Ay(e,{name:t,index:r,operation:a,tree:s})}};var se=Ba,sA=Ut,Xs={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Ll(t,this.path);r&&(r=Ut(r));let a=za(t,{op:"remove",path:this.from}).removed;return za(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=Ll(t,this.from);return za(t,{op:"add",path:this.path,value:Ut(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:ko(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},iA={add:function(n,e,t){return Ml(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Xs.move,copy:Xs.copy,test:Xs.test,_get:Xs._get};function Ll(n,e){if(e=="")return n;var t={op:"_get",path:e};return za(n,t),t.value}function za(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):Dl(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Ll(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=ko(n,e.value),i.test===!1)throw new se("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new se("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=Ut(n));let o=(e.path||"").split("/"),u=n,l=1,c=o.length,f,d,h;for(typeof t=="function"?h=t:h=Dl;;){if(d=o[l],d&&d.indexOf("~")!=-1&&(d=So(d)),a&&(d=="__proto__"||d=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(u[d]===void 0?f=o.slice(0,l).join("/"):l==c-1&&(f=e.path),f!==void 0&&h(e,0,n,f)),l++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!Ml(d))throw new se("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);Ml(d)&&(d=~~d)}if(l>=c){if(t&&e.op==="add"&&d>u.length)throw new se("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let p=iA[e.op].call(e,u,d,n);if(p.test===!1)throw new se("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(l>=c){let p=Xs[e.op].call(e,u,d,n);if(p.test===!1)throw new se("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[d],t&&l<c&&(!u||typeof u!="object"))throw new se("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function Ha(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new se("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Ut(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=za(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function oA(n,e,t){let r=za(n,e);if(r.test===!1)throw new se("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function Dl(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new se("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Xs[n.op]){if(typeof n.path!="string")throw new se("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new se('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new se("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new se("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&jl(n.value))throw new se("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new se("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new se("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=Ty([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new se("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new se("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Ty(n,e,t){try{if(!Array.isArray(n))throw new se("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Ha(Ut(e),Ut(n),t||!0);else{t=t||Dl;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof se)return a;throw a}}function ko(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!ko(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!ko(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}var cN={...sh,JsonPatchError:Ba,deepClone:Ut,escapePathComponent:$l,unescapePathComponent:So};var ih=class{getStore(){}run(e,t){return t()}},uA=new ih,oh=class{getInstance(){return globalThis.__lc_tracing_async_local_storage??uA}initializeGlobalInstance(e){globalThis.__lc_tracing_async_local_storage===void 0&&(globalThis.__lc_tracing_async_local_storage=e)}},Wt=new oh;var we=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function uh(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Zt(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Zt(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var Xr=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise((t,r)=>{Wt.getInstance().run(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(s=>t(void 0),r)})})}async next(...e){return this.firstResultUsed?Wt.getInstance().run(this.config,async()=>this.generator.next(...e)):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}};async function Py(n,e,t,...r){let a=new Xr({generator:e,startSetup:t}),s=await a.setup;return{output:n(a,s,...r),setup:s}}var Yt=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=Ha({},t);return new Co({ops:t,state:r[r.length-1].newDocument})}},Co=class n extends Yt{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=Ha(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=Ha({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},Ul=n=>n.name==="log_stream_tracer";async function Sy(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function ky(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function lA(n){return n!==void 0&&n.message!==void 0}var Ro=class extends Et{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=we.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new Yt({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Yt({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Sy(e,this._schemaFormat)),await this.writer.write(new Yt({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Sy(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await ky(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new Yt({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new Yt({ops:[{op:"replace",path:"/final_output",value:await ky(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?lA(r?.chunk)?i=r?.chunk:i=new jt(t):i=t;let o=new Yt({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}};function Fl({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var zl=n=>n.name==="event_stream_tracer",Bl=class extends Et{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=we.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}let s=this.tappedPromises.get(e);if(s===void 0){let i;s=new Promise(o=>{i=o}),this.tappedPromises.set(e,s);try{let o={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...o,data:{chunk:r.value}},a),yield r.value;for await(let u of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...o,data:{chunk:u}},a),yield u}finally{i()}}else{yield r.value;for await(let i of t)yield i}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Fl(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(a.runType==="chat_model")i="on_chat_model_stream",r?.chunk===void 0?s=new jt({content:t}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",r?.chunk===void 0?s=new bo({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=e.outputs?.generations,s;if(t.runType==="chat_model"){for(let i of a??[]){if(s!==void 0)break;s=i[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a?.map(i=>i.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Fl(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Fl(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Fl(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};var Hl=25;async function Qr(n){return rt.configure(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function lh(...n){let e={};for(let t of n.filter(r=>!!r))for(let r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){let a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){let a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{let i=a.copy();for(let o of s)i.addHandler(Po(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){let i=s.copy();for(let o of a)i.addHandler(Po(o),!0);e.callbacks=i}else e.callbacks=new rt(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{let a=r;e[a]=t[a]??e[a]}return e}var cA=new Set(["string","number","boolean"]);function W(n){let e=n??Wt.getInstance().getStore(),t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(e&&(t={...t,...e}),e?.configurable)for(let r of Object.keys(e.configurable))cA.has(typeof e.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=e.configurable[r]);return t}function He(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){let o=W(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}var No=class extends Et{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}};function Vl(n){return n?n.lc_runnable:!1}var Gl=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>this.includeTags?.includes(s))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>!this.excludeTags?.includes(s))),r}};Ft();ce();function _A(n){return Vl(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...ie(n.data.schema),title:n.data.name}}}var Mo=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Ot(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],..._A(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||S(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let a={source:e.id,target:t.id,data:r};return this.edges.push(a),a}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([t,r])=>{this.nodes[t]=r}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}};function l_(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return we.fromReadableStream(t)}function Bh(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}var c_=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function Xl(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*zh(n,e){let t=Wt.getInstance();for(;;){let{value:r,done:a}=t.run(n,e.next.bind(e));if(a)break;yield r}}async function*Hh(n,e){let t=Wt.getInstance(),r=e[Symbol.asyncIterator]();for(;;){let{value:a,done:s}=await t.run(n,r.next.bind(e));if(s)break;yield a}}function Ge(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var ve=class extends Gt{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Qs({bound:this,kwargs:e,config:{}})}map(){return new Vh({bound:this})}withRetry(e){return new qh({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Qs({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Zh({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(W);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>W(s===0?e:r))}return Array.from({length:t},()=>W(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=a[0]?.maxConcurrency??r?.maxConcurrency,i=new En({maxConcurrency:s,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>i.call(async()=>{try{return await this.invoke(u,a[l])}catch(c){if(r?.returnExceptions)return c;throw c}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=W(t),a=new Xr({generator:this._streamIterator(e,r),config:r});return await a.setup,we.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=W(e):t=W({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){let a=W(r),i=await(await Qr(a))?.handleChainStart(this.toJSON(),Ge(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let o;try{o=await e.call(this,t,a,i)}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(Ge(o,"output")),o}async _batchWithConfig(e,t,r,a){let s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(Qr)),o=await Promise.all(i.map(async(l,c)=>{let f=await l?.handleChainStart(this.toJSON(),Ge(t[c],"input"),s[c].runId,s[c].runType,void 0,void 0,s[c].runName??this.getName());return delete s[c].runId,f})),u;try{u=await e.call(this,t,s,o,a)}catch(l){throw await Promise.all(o.map(c=>c?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd(Ge(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=W(r),l=await Qr(u);async function*c(){for await(let d of e){if(s)if(a===void 0)a=d;else try{a=Zt(a,d)}catch{a=void 0,s=!1}yield d}}let f;try{let d=await Py(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),u);delete u.runId,f=d.setup;let h=f?.handlers.find(zl),p=d.output;h!==void 0&&f!==void 0&&(p=h.tapOutputIterable(f.runId,p));let m=f?.handlers.find(Ul);m!==void 0&&f!==void 0&&(p=m.tapOutputIterable(f.runId,p));for await(let g of p)if(yield g,o)if(i===void 0)i=g;else try{i=Zt(i,g)}catch{i=void 0,o=!1}}catch(d){throw await f?.handleChainError(d,void 0,void 0,void 0,{inputs:Ge(a,"input")}),d}await f?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Ge(a,"input")})}getGraph(e){let t=new Mo,r=t.addNode({name:`${this.getName()}Input`,schema:ye.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:ye.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Kh({first:this,last:Va(e)})}pick(e){return this.pipe(new Xh(e))}assign(e){return this.pipe(new Yh(new $o({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=Zt(r,a);yield*this._streamIterator(r,W(t))}async*streamLog(e,t,r){let a=new Ro({...r,autoClose:!1,_schemaFormat:"original"}),s=W(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.inheritableHandlers.push(t),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let l of u){let c=new Yt({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(c)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?l_(a):we.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){let a=new Bl({...r,autoClose:!1}),s=W(t),i=s.runId??S();s.runId=i;let o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{let h=o.copy();h.inheritableHandlers.push(a),s.callbacks=h}let u=this;async function l(){try{let h=await u.stream(e,s),p=a.tapOutputIterable(i,h);for await(let m of p);}finally{await a.finish()}}let c=l(),f=!1,d;try{for await(let h of a){if(!f){h.data.input=e,f=!0,d=h.run_id,yield h;continue}h.run_id===d&&h.event.endsWith("_end")&&h.data?.input&&delete h.data.input,yield h}}finally{await c}}async*_streamEventsV1(e,t,r){let a,s=!1,i=W(t),o=i.tags??[],u=i.metadata??{},l=i.runName??this.getName(),c=new Ro({...r,autoClose:!1,_schemaFormat:"streaming_events"}),f=new Gl({...r}),d=this._streamLog(e,c,i);for await(let p of d){if(a?a=a.concat(p):a=Co.fromRunLogPatch(p),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let x={...a.state},_={run_id:x.id,event:`on_${x.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};f.includeEvent(_,x.type)&&(yield _)}let m=p.ops.filter(x=>x.path.startsWith("/logs/")).map(x=>x.path.split("/")[2]),g=[...new Set(m)];for(let x of g){let _,k={},O=a.state.logs[x];if(O.end_time===void 0?O.streamed_output.length>0?_="stream":_="start":_="end",_==="start")O.inputs!==void 0&&(k.input=O.inputs);else if(_==="end")O.inputs!==void 0&&(k.input=O.inputs),k.output=O.final_output;else if(_==="stream"){let B=O.streamed_output.length;if(B!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${B} instead. Encountered in: "${O.name}"`);k={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${_}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:k}}let{state:b}=a;if(b.streamed_output.length>0){let x=b.streamed_output.length;if(x!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${x} instead. Encountered in: "${b.name}"`);let _={chunk:b.streamed_output[0]};b.streamed_output=[];let k={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:u,name:l,data:_};f.includeEvent(k,b.type)&&(yield k)}}let h=a?.state;if(h!==void 0){let p={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:o,metadata:u,data:{output:h.final_output}};f.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return Vl(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Qs({bound:this,config:{},configFactories:[a=>({callbacks:[new No({config:a,onStart:e,onEnd:t,onError:r})]})]})}},Qs=class n extends ve{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=lh(this.config,...e);return lh(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(W(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(W(s),this.kwargs))):await this._mergeConfig(W(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(W(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(W(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(W(t),this.kwargs))}streamEvents(e,t,r){let a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(W(t),a.kwargs),version:t.version},r)};return we.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&ve.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new No({config:a,onStart:e,onEnd:t,onError:r})]})]})}},Vh=class n extends ve{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,He(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},qh=class extends Qs{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return He(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return(0,Gh.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){let s={};try{await(0,Gh.default)(async i=>{let o=e.map((d,h)=>h).filter(d=>s[d.toString()]===void 0||s[d.toString()]instanceof Error),u=o.map(d=>e[d]),l=o.map(d=>this._patchConfigForRetry(i,t?.[d],r?.[d])),c=await super.batch(u,l,{...a,returnExceptions:!0}),f;for(let d=0;d<c.length;d+=1){let h=c[d],p=o[d];h instanceof Error&&f===void 0&&(f=h,f.input=u[d]),s[p.toString()]=h}if(f)throw f;return c},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(a?.returnExceptions!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Kh=class n extends ve{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=W(t),s=await(await Qr(r))?.handleChainStart(this.toJSON(),Ge(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i=e,o;try{let u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1)i=await u[l].invoke(i,He(r,{callbacks:s?.getChild(`seq:step:${l+1}`)}));o=await this.last.invoke(i,He(r,{callbacks:s?.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(Ge(o,"output")),o}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(Qr)),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),Ge(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((c,f)=>{let d=c?.getChild(`seq:step:${u+1}`);return He(a[f],{callbacks:d})}),r)}catch(u){throw await Promise.all(i.map(l=>l?.handleChainError(u))),u}return await Promise.all(i.map(u=>u?.handleChainEnd(Ge(o,"output")))),o}async*_streamIterator(e,t){let r=await Qr(t),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),Ge(e,"input"),a,void 0,void 0,void 0,s?.runName),o=[this.first,...this.middle,this.last],u=!0,l;async function*c(){yield e}try{let f=o[0].transform(c(),He(s,{callbacks:i?.getChild("seq:step:1")}));for(let d=1;d<o.length;d+=1)f=await o[d].transform(f,He(s,{callbacks:i?.getChild(`seq:step:${d+1}`)}));for await(let d of f)if(yield d,u)if(l===void 0)l=d;else try{l=Zt(l,d)}catch{l=void 0,u=!1}}catch(f){throw await i?.handleChainError(f),f}await i?.handleChainEnd(Ge(l,"output"))}getGraph(e){let t=new Mo,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:Va(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&ve.isRunnable(e)}static from([e,...t],r){return new n({first:Va(e),middle:t.slice(0,-1).map(Va),last:Va(t[t.length-1]),name:r})}},$o=class n extends ve{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=Va(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=W(t),s=await(await Qr(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,He(r,{callbacks:s?.getChild(`map:key:${o}`)}))}))}catch(o){throw await s?.handleChainError(o),o}return await s?.handleChainEnd(i),i}async*_transform(e,t,r){let a={...this.steps},s=uh(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],l)=>{let c=u.transform(s[l],He(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,c.next().then(f=>({key:o,gen:c,result:f}))]}));for(;i.size;){let{key:o,result:u,gen:l}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,l.next().then(c=>({key:o,gen:l,result:c}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=W(t),s=new Xr({generator:this.transform(r(),a),config:a});return await s.setup,we.fromAsyncGenerator(s)}},Jh=class n extends ve{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Pl(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await Qr(r);return await this.func(He(r,{callbacks:a}),e)}async*_streamIterator(e,t){let r=await this.invoke(e,t);if(Xl(r)){for await(let a of r)yield a;return}if(c_(r)){for(;;){let a=r.next();if(a.done)break;yield a.value}return}yield r}static from(e){return new n({func:e})}};function wA(n){if(Pl(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Wh=class n extends ve{static lc_name(){return"RunnableLambda"}constructor(e){if(Pl(e.func))return Jh.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),wA(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{let i=He(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??Hl)-1});Wt.getInstance().run(i,async()=>{try{let o=await this.func(e,{...i,config:i});if(o&&ve.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??Hl)-1})}else if(Xl(o)){let u;for await(let l of Hh(i,o))if(u===void 0)u=l;else try{u=Zt(u,l)}catch{u=l}o=u}else if(Bh(o)){let u;for(let l of zh(i,o))if(u===void 0)u=l;else try{u=Zt(u,l)}catch{u=l}o=u}a(o)}catch(o){s(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(let i of e)if(a===void 0)a=i;else try{a=Zt(a,i)}catch{a=i}let s=await new Promise((i,o)=>{Wt.getInstance().run(r,async()=>{try{let u=await this.func(a,{...r,config:r});i(u)}catch(u){o(u)}})});if(s&&ve.isRunnable(s)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let i=await s.stream(a,He(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??Hl)-1}));for await(let o of i)yield o}else if(Xl(s))for await(let i of Hh(r,s))yield i;else if(Bh(s))for(let i of zh(r,s))yield i;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=W(t),s=new Xr({generator:this.transform(r(),a),config:a});return await s.setup,we.fromAsyncGenerator(s)}};var Zh=class extends ve{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=await rt.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),Ge(e,"input"),a,void 0,void 0,void 0,s?.runName),o;for(let u of this.runnables())try{let l=await u.invoke(e,He(s,{callbacks:i?.getChild()}));return await i?.handleChainEnd(Ge(l,"output")),l}catch(l){o===void 0&&(o=l)}throw o===void 0?new Error("No error stored at end of fallback."):(await i?.handleChainError(o),o)}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>rt.configure(u?.callbacks,void 0,u?.tags,void 0,u?.metadata))),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),Ge(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o;for(let u of this.runnables())try{let l=await u.batch(e,i.map((c,f)=>He(a[f],{callbacks:c?.getChild()})),r);return await Promise.all(i.map((c,f)=>c?.handleChainEnd(Ge(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(i.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Va(n){if(typeof n=="function")return new Wh({func:n});if(ve.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=Va(r);return new $o({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var Yh=class extends ve{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof $o&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=uh(e),o=this.mapper.transform(i,He(r,{callbacks:t?.getChild()})),u=o.next();for await(let l of s){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let c=Object.fromEntries(Object.entries(l).filter(([f])=>!a.includes(f)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(let l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=W(t),s=new Xr({generator:this.transform(r(),a),config:a});return await s.setup,we.fromAsyncGenerator(s)}},Xh=class extends ve{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=W(t),s=new Xr({generator:this.transform(r(),a),config:a});return await s.setup,we.fromAsyncGenerator(s)}};var vA=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;var xA=()=>!1,Qh=class extends ve{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??xA(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},Ql=class extends Qh{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=ul.global():this.cache=void 0,this.caller=new En(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await qb("modelName"in this?vA(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new cl(e):Array.isArray(e)?new dl(e.map(wa)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};var ep=class n extends Ql{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r?.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let a=n._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptions(t),o={...s.metadata,...this.getLsParams(i)},u=await rt.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await u?.handleChatModelStart(this.toJSON(),[a],s.runId,void 0,l,void 0,void 0,s.runName),f;try{for await(let d of this._streamResponseChunks(a,i,c?.[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,f?f=f.concat(d):f=d}catch(d){throw await Promise.all((c??[]).map(h=>h?.handleLLMError(d))),d}await Promise.all((c??[]).map(d=>d?.handleLLMEnd({generations:[[f]]})))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,r){let a=e.map(h=>h.map(wa)),s={...r.metadata,...this.getLsParams(t)},i=await rt.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this?.invocationParams(t),batch_size:1},u=await i?.handleChatModelStart(this.toJSON(),a,r.runId,void 0,o,void 0,void 0,r.runName),l=[],c=[];if(!!u?.[0].handlers.find(h=>zl(h)||Ul(h))&&a.length===1&&this._streamResponseChunks!==n.prototype._streamResponseChunks)try{let h=await this._streamResponseChunks(a[0],t,u?.[0]),p;for await(let m of h)p===void 0?p=m:p=Zt(p,m);if(p===void 0)throw new Error("Received empty response from chat model call.");l.push([p]),await u?.[0].handleLLMEnd({generations:l,llmOutput:{}})}catch(h){throw await u?.[0].handleLLMError(h),h}else{let h=await Promise.allSettled(a.map((p,m)=>this._generate(p,{...t,promptIndex:m},u?.[m])));await Promise.all(h.map(async(p,m)=>{if(p.status==="fulfilled"){let g=p.value;for(let b of g.generations)b.message.response_metadata={...b.generationInfo,...b.message.response_metadata};return g.generations.length===1&&(g.generations[0].message.response_metadata={...g.llmOutput,...g.generations[0].message.response_metadata}),l[m]=g.generations,c[m]=g.llmOutput,u?.[m]?.handleLLMEnd({generations:[g.generations],llmOutput:g.llmOutput})}else return await u?.[m]?.handleLLMError(p.reason),Promise.reject(p.reason)}))}let d={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(d,Of,{value:u?{runIds:u?.map(h=>h.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(g=>g.map(wa)),o={...s.metadata,...this.getLsParams(a)},u=await rt.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1,cached:!0},c=await u?.handleChatModelStart(this.toJSON(),i,s.runId,void 0,l,void 0,void 0,s.runName),f=[],h=(await Promise.allSettled(i.map(async(g,b)=>{let x=n._convertInputToPromptValue(g).toString(),_=await t.lookup(x,r);return _==null&&f.push(b),_}))).map((g,b)=>({result:g,runManager:c?.[b]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),p=[];await Promise.all(h.map(async({result:g,runManager:b},x)=>{if(g.status==="fulfilled"){let _=g.value;return p[x]=_,_.length&&await b?.handleLLMNewToken(_[0].text),b?.handleLLMEnd({generations:[_]})}else return await b?.handleLLMError(g.reason),Promise.reject(g.reason)}));let m={generations:p,missingPromptIndices:f};return Object.defineProperty(m,Of,{value:c?{runIds:c?.map(g=>g.runId)}:void 0,configurable:!0}),m}async generate(e,t,r){let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(h=>h.map(wa)),[i,o]=this._separateRunnableConfigFromCallOptions(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:f}=await this._generateCached({messages:s,cache:u,llmStringKey:l,parsedOptions:o,handledOptions:i}),d={};if(f.length>0){let h=await this._generateUncached(f.map(p=>s[p]),o,i);await Promise.all(h.generations.map(async(p,m)=>{let g=f[m];c[g]=p;let b=n._convertInputToPromptValue(s[g]).toString();return u.update(b,l,p)})),d=h.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(wa)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new qr(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}},ec=class extends ep{async _generate(e,t,r){let a=await this._call(e,t,r),s=new Bs(a);if(typeof s.content!="string")throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}};async function*d_(n,e,t){let r=n;r.startsWith("http://localhost:")&&(r=r.replace("http://localhost:","http://127.0.0.1:"));let a=await fetch(r,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...t.headers},signal:t.signal});if(!a.ok){let u,l=await a.text();try{let c=JSON.parse(l);u=new Error(`Ollama call failed with status code ${a.status}: ${c.error}`)}catch{u=new Error(`Ollama call failed with status code ${a.status}: ${l}`)}throw u.response=a,u}if(!a.body)throw new Error("Could not begin Ollama stream. Please check the given URL and try again.");let s=we.fromReadableStream(a.body),i=new TextDecoder,o="";for await(let u of s){let c=(o+i.decode(u)).split(`
`);o=c.pop()||"";for(let f of c)try{yield JSON.parse(f)}catch{console.warn(`Received a non-JSON parseable chunk: ${f}`)}}}async function*f_(n,e,t){yield*d_(`${n}/api/generate`,e,t)}async function*h_(n,e,t){yield*d_(`${n}/api/chat`,e,t)}var tc=class extends ec{static lc_name(){return"ChatOllama"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama2"}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://localhost:11434"}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:"5m"}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16KV",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGqa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyBase",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ropeFrequencyScale",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMLock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMMap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model??this.model,this.baseUrl=e.baseUrl?.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl??this.baseUrl,this.keepAlive=e.keepAlive??this.keepAlive,this.embeddingOnly=e.embeddingOnly,this.f16KV=e.f16KV,this.frequencyPenalty=e.frequencyPenalty,this.headers=e.headers,this.logitsAll=e.logitsAll,this.lowVram=e.lowVram,this.mainGpu=e.mainGpu,this.mirostat=e.mirostat,this.mirostatEta=e.mirostatEta,this.mirostatTau=e.mirostatTau,this.numBatch=e.numBatch,this.numCtx=e.numCtx,this.numGpu=e.numGpu,this.numGqa=e.numGqa,this.numKeep=e.numKeep,this.numPredict=e.numPredict,this.numThread=e.numThread,this.penalizeNewline=e.penalizeNewline,this.presencePenalty=e.presencePenalty,this.repeatLastN=e.repeatLastN,this.repeatPenalty=e.repeatPenalty,this.ropeFrequencyBase=e.ropeFrequencyBase,this.ropeFrequencyScale=e.ropeFrequencyScale,this.temperature=e.temperature,this.stop=e.stop,this.tfsZ=e.tfsZ,this.topK=e.topK,this.topP=e.topP,this.typicalP=e.typicalP,this.useMLock=e.useMLock,this.useMMap=e.useMMap,this.vocabOnly=e.vocabOnly,this.format=e.format}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"ollama",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.temperature??void 0,ls_stop:this.stop,ls_max_tokens:t.options.num_predict}}_llmType(){return"ollama"}invocationParams(e){return{model:this.model,format:this.format,keep_alive:this.keepAlive,options:{embedding_only:this.embeddingOnly,f16_kv:this.f16KV,frequency_penalty:this.frequencyPenalty,logits_all:this.logitsAll,low_vram:this.lowVram,main_gpu:this.mainGpu,mirostat:this.mirostat,mirostat_eta:this.mirostatEta,mirostat_tau:this.mirostatTau,num_batch:this.numBatch,num_ctx:this.numCtx,num_gpu:this.numGpu,num_gqa:this.numGqa,num_keep:this.numKeep,num_predict:this.numPredict,num_thread:this.numThread,penalize_newline:this.penalizeNewline,presence_penalty:this.presencePenalty,repeat_last_n:this.repeatLastN,repeat_penalty:this.repeatPenalty,rope_frequency_base:this.ropeFrequencyBase,rope_frequency_scale:this.ropeFrequencyScale,temperature:this.temperature,stop:e?.stop??this.stop,tfs_z:this.tfsZ,top_k:this.topK,top_p:this.topP,typical_p:this.typicalP,use_mlock:this.useMLock,use_mmap:this.useMMap,vocab_only:this.vocabOnly}}}_combineLLMOutput(){return{}}async*_streamResponseChunksLegacy(e,t,r){let a=f_(this.baseUrl,{...this.invocationParams(t),prompt:this._formatMessagesAsPrompt(e)},{...t,headers:this.headers});for await(let s of a)s.done?yield new va({text:"",message:new jt({content:""}),generationInfo:{model:s.model,total_duration:s.total_duration,load_duration:s.load_duration,prompt_eval_count:s.prompt_eval_count,prompt_eval_duration:s.prompt_eval_duration,eval_count:s.eval_count,eval_duration:s.eval_duration}}):(yield new va({text:s.response,message:new jt({content:s.response})}),await r?.handleLLMNewToken(s.response??""))}async*_streamResponseChunks(e,t,r){try{let a=await this.caller.call(async()=>h_(this.baseUrl,{...this.invocationParams(t),messages:this._convertMessagesToOllamaMessages(e)},{...t,headers:this.headers}));for await(let s of a)s.done?yield new va({text:"",message:new jt({content:""}),generationInfo:{model:s.model,total_duration:s.total_duration,load_duration:s.load_duration,prompt_eval_count:s.prompt_eval_count,prompt_eval_duration:s.prompt_eval_duration,eval_count:s.eval_count,eval_duration:s.eval_duration}}):(yield new va({text:s.message.content,message:new jt({content:s.message.content})}),await r?.handleLLMNewToken(s.message.content??""))}catch(a){if(a.response?.status===404)console.warn("[WARNING]: It seems you are using a legacy version of Ollama. Please upgrade to a newer version for better chat support."),yield*this._streamResponseChunksLegacy(e,t,r);else throw a}}_convertMessagesToOllamaMessages(e){return e.map(t=>{let r;if(t._getType()==="human")r="user";else if(t._getType()==="ai")r="assistant";else if(t._getType()==="system")r="system";else throw new Error(`Unsupported message type for Ollama: ${t._getType()}`);let a="",s=[];if(typeof t.content=="string")a=t.content;else for(let i of t.content)if(i.type==="text")a=`${a}
${i.text}`;else if(i.type==="image_url"&&typeof i.image_url=="string"){let o=i.image_url.split(",");s.push(o[1]??o[0])}else throw new Error('Unsupported message content type. Must either have type "text" or type "image_url" with a string "image_url" field.');return{role:r,content:a,images:s}})}_formatMessagesAsPrompt(e){return e.map(r=>{let a;return r._getType()==="human"?a=`[INST] ${r.content} [/INST]`:r._getType()==="ai"?a=r.content:r._getType()==="system"?a=`<<SYS>> ${r.content} <</SYS>>`:mo.isInstance(r)?a=`

${r.role[0].toUpperCase()}${r.role.slice(1)}: ${r.content}`:(console.warn(`Unsupported message type passed to Ollama: "${r._getType()}"`),a=""),a}).join(`
`)}async _call(e,t,r){let a=[];for await(let s of this._streamResponseChunks(e,t,r))a.push(s.message.content);return a.join("")}};ei();Bt();var cp=class extends It{addUserMessage(e){return this.addMessage(new Ae(e))}addAIChatMessage(e){return this.addMessage(new Oe(e))}addAIMessage(e){return this.addMessage(new Oe(e))}async addMessages(e){for(let t of e)await this.addMessage(t)}clear(){throw new Error("Not implemented.")}},Do=class extends cp{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}};Bt();on();ci();Ln();on();ci();var ir=class extends K{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=V(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){let r=V(t),a,s=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=pt(a,i)}catch{a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new fi(new Un({steps:e}))}};on();ci();on();ci();Ln();Bt();on();var Qo=class extends sn{constructor(e){let t=new di({func:(i,o)=>this._enterHistory(i,o??{})}).withConfig({runName:"loadHistory"}),r=e.historyMessagesKey??e.inputMessagesKey;r&&(t=ir.assign({[r]:t}).withConfig({runName:"insertHistory"}));let a=t.pipe(e.runnable.withListeners({onEnd:(i,o)=>this._exitHistory(i,o??{})})).withConfig({runName:"RunnableWithMessageHistory"}),s=e.config??{};super({...e,config:s,bound:a}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"historyMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getMessageHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if(typeof e=="object"&&!Array.isArray(e)&&!Ve(e)){let r;this.inputMessagesKey?r=this.inputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="input",Array.isArray(e[r])&&Array.isArray(e[r][0])?t=e[r][0]:t=e[r]}else t=e;if(typeof t=="string")return[new Ae(t)];if(Array.isArray(t))return t;if(Ve(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(!Array.isArray(e)&&!Ve(e)&&typeof e!="string"){let r;this.outputMessagesKey!==void 0?r=this.outputMessagesKey:Object.keys(e).length===1?r=Object.keys(e)[0]:r="output",e.generations!==void 0?t=e.generations[0][0].message:t=e[r]}else t=e;if(typeof t=="string")return[new Oe(t)];if(Array.isArray(t))return t;if(Ve(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){let a=await(t?.config?.configurable?.messageHistory).getMessages();return this.historyMessagesKey===void 0?a.concat(this._getInputMessages(e)):a}async _exitHistory(e,t){let r=t.configurable?.messageHistory,a;Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?a=e.inputs[0]:a=e.inputs;let s=this._getInputMessages(a);if(this.historyMessagesKey===void 0){let u=await r.getMessages();s=s.slice(u.length)}let i=e.outputs;if(!i)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);let o=this._getOutputMessages(i);await r.addMessages([...s,...o])}async _mergeConfig(...e){let t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){let a={[this.inputMessagesKey??"input"]:"foo"},s={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(a)}, ${JSON.stringify(s)})`)}let{sessionId:r}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(r),t}};var Fn=class extends K{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a?.callbacks),e,{...t,runType:"parser"})}},hi=class extends Fn{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},jr=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}};kr();lp();Wo();function eu(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!eu(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let i of r)if(!eu(n[i],e[i]))return!1;return!0}return n===e}var HD=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var oE=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,uE=[0,31,28,31,30,31,30,31,31,30,31,30,31],lE=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,cE=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,dE=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,fE=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,hE=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,pE=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,mE=/^(?:\/(?:[^~/]|~0|~1)*)*$/,gE=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,bE=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,yE=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,_E=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,wE=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,vE=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,xE=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},OE=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,AE=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,EE=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function mt(n){return n.test.bind(n)}var IE={date:nw,time:aw.bind(void 0,!1),"date-time":kE,duration:EE,uri:NE,"uri-reference":mt(dE),"uri-template":mt(fE),url:mt(hE),email:xE,hostname:mt(cE),ipv4:mt(OE),ipv6:mt(AE),regex:ME,uuid:mt(pE),"json-pointer":mt(mE),"json-pointer-uri-fragment":mt(gE),"relative-json-pointer":mt(bE)},TE={...IE,date:mt(yE),time:mt(_E),"date-time":mt(wE),"uri-reference":mt(vE)};function PE(n){return n%4===0&&(n%100!==0||n%400===0)}function nw(n){let e=n.match(oE);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&PE(t)?29:uE[r])}function aw(n,e){let t=e.match(lE);if(!t)return!1;let r=+t[1],a=+t[2],s=+t[3],i=!!t[5];return(r<=23&&a<=59&&s<=59||r==23&&a==59&&s==60)&&(!n||i)}var SE=/t|\s/i;function kE(n){let e=n.split(SE);return e.length==2&&nw(e[0])&&aw(!0,e[1])}var CE=/\/|:/,RE=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function NE(n){return CE.test(n)&&RE.test(n)}var jE=/[^\\]\\Z/;function ME(n){if(jE.test(n))return!1;try{return new RegExp(n),!0}catch{return!1}}var Ya=class extends hi{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},tu=class extends Ya{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(__(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new Nr({message:a,text:a.content})}else if(Ve(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new Nr({message:x_(a),text:a.content})}else s=new Za({text:a});r===void 0?r=s:r=r.concat(s);let i=await this.parsePartialResult([r]);i!=null&&!eu(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}};var Mc=class extends Ya{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((t,r)=>t+this._messageContentComplexToString(r),"")}};Pr();Ft();var $c=class extends hi{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=ye.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,ye.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(ie(this.schema))}
\`\`\`
`}async parse(e){try{let r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new jr(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};jp();np();var Lc=class extends tu{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?wc(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return rp(e[0].text)}async parse(e){return rp(e,JSON.parse)}getFormatInstructions(){return""}};gi();du();im();gi();du();wi();au();_i();Xp();du();var cw=["user","model","function","system"],dw;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(dw||(dw={}));var fw;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(fw||(fw={}));var hw;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(hw||(hw={}));var pw;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(pw||(pw={}));var Bc;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.OTHER="OTHER"})(Bc||(Bc={}));var mw;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(mw||(mw={}));var gw;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(gw||(gw={}));var bw;(function(n){n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT"})(bw||(bw={}));var it=class extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}},Bn=class extends it{constructor(e,t){super(e),this.response=t}};var oI="https://generativelanguage.googleapis.com",uI="v1beta",lI="0.7.1",cI="genai-js",Qa;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(Qa||(Qa={}));var zc=class{constructor(e,t,r,a,s){this.model=e,this.task=t,this.apiKey=r,this.stream=a,this.requestOptions=s}toString(){var e,t;let r=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||uI,s=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||oI}/${r}/${this.model}:${this.task}`;return this.stream&&(s+="?alt=sse"),s}};function dI(n){let e=[];return n?.apiClient&&e.push(n.apiClient),e.push(`${cI}/${lI}`),e.join(" ")}async function fI(n){let e=new Headers;return e.append("Content-Type","application/json"),e.append("x-goog-api-client",dI(n.requestOptions)),e.append("x-goog-api-key",n.apiKey),e}async function hI(n,e,t,r,a,s){let i=new zc(n,e,t,r,s);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},mI(s)),{method:"POST",headers:await fI(i),body:a})}}async function pu(n,e,t,r,a,s){return pI(n,e,t,r,a,s,fetch)}async function pI(n,e,t,r,a,s,i=fetch){let o=new zc(n,e,t,r,s),u;try{let l=await hI(n,e,t,r,a,s);if(u=await i(l.url,l.fetchOptions),!u.ok){let c="";try{let f=await u.json();c=f.error.message,f.error.details&&(c+=` ${JSON.stringify(f.error.details)}`)}catch{}throw new Error(`[${u.status} ${u.statusText}] ${c}`)}}catch(l){let c=new it(`Error fetching from ${o.toString()}: ${l.message}`);throw c.stack=l.stack,c}return u}function mI(n){let e={};if(n?.timeout>=0){let t=new AbortController,r=t.signal;setTimeout(()=>t.abort(),n.timeout),e.signal=r}return e}function cm(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Fc(n.candidates[0]))throw new Bn(`${zn(n)}`,n);return gI(n)}else if(n.promptFeedback)throw new Bn(`Text not available. ${zn(n)}`,n);return""},n.functionCall=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Fc(n.candidates[0]))throw new Bn(`${zn(n)}`,n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),yw(n)[0]}else if(n.promptFeedback)throw new Bn(`Function call not available. ${zn(n)}`,n)},n.functionCalls=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Fc(n.candidates[0]))throw new Bn(`${zn(n)}`,n);return yw(n)}else if(n.promptFeedback)throw new Bn(`Function call not available. ${zn(n)}`,n)},n}function gI(n){var e,t,r,a;return!((a=(r=(t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0?void 0:t.parts)===null||r===void 0?void 0:r[0])===null||a===void 0)&&a.text?n.candidates[0].content.parts.map(({text:s})=>s).join(""):""}function yw(n){var e,t,r,a;let s=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let i of(a=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||a===void 0?void 0:a.parts)i.functionCall&&s.push(i.functionCall);if(s.length>0)return s}var bI=[Bc.RECITATION,Bc.SAFETY];function Fc(n){return!!n.finishReason&&bI.includes(n.finishReason)}function zn(n){var e,t,r;let a="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)a+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(a+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(a+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((r=n.candidates)===null||r===void 0)&&r[0]){let s=n.candidates[0];Fc(s)&&(a+=`Candidate was blocked due to ${s.finishReason}`,s.finishMessage&&(a+=`: ${s.finishMessage}`))}return a}function fu(n){return this instanceof fu?(this.v=n,this):new fu(n)}function yI(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),a,s=[];return a={},i("next"),i("throw"),i("return"),a[Symbol.asyncIterator]=function(){return this},a;function i(d){r[d]&&(a[d]=function(h){return new Promise(function(p,m){s.push([d,h,p,m])>1||o(d,h)})})}function o(d,h){try{u(r[d](h))}catch(p){f(s[0][3],p)}}function u(d){d.value instanceof fu?Promise.resolve(d.value.v).then(l,c):f(s[0][2],d)}function l(d){o("next",d)}function c(d){o("throw",d)}function f(d,h){d(h),s.shift(),s.length&&o(s[0][0],s[0][1])}}var _w=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function _I(n){let e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=xI(e),[r,a]=t.tee();return{stream:vI(r),response:wI(a)}}async function wI(n){let e=[],t=n.getReader();for(;;){let{done:r,value:a}=await t.read();if(r)return cm(OI(e));e.push(a)}}function vI(n){return yI(this,arguments,function*(){let t=n.getReader();for(;;){let{value:r,done:a}=yield fu(t.read());if(a)break;yield yield fu(cm(r))}})}function xI(n){let e=n.getReader();return new ReadableStream({start(r){let a="";return s();function s(){return e.read().then(({value:i,done:o})=>{if(o){if(a.trim()){r.error(new it("Failed to parse stream"));return}r.close();return}a+=i;let u=a.match(_w),l;for(;u;){try{l=JSON.parse(u[1])}catch{r.error(new it(`Error parsing JSON response: "${u[1]}"`));return}r.enqueue(l),a=a.substring(u[0].length),u=a.match(_w)}return s()})}}})}function OI(n){let e=n[n.length-1],t={promptFeedback:e?.promptFeedback};for(let r of n)if(r.candidates)for(let a of r.candidates){let s=a.index;if(t.candidates||(t.candidates=[]),t.candidates[s]||(t.candidates[s]={index:a.index}),t.candidates[s].citationMetadata=a.citationMetadata,t.candidates[s].finishReason=a.finishReason,t.candidates[s].finishMessage=a.finishMessage,t.candidates[s].safetyRatings=a.safetyRatings,a.content&&a.content.parts){t.candidates[s].content||(t.candidates[s].content={role:a.content.role||"user",parts:[]});let i={};for(let o of a.content.parts)o.text&&(i.text=o.text),o.functionCall&&(i.functionCall=o.functionCall),Object.keys(i).length===0&&(i.text=""),t.candidates[s].content.parts.push(i)}}return t}async function Ow(n,e,t,r){let a=await pu(e,Qa.STREAM_GENERATE_CONTENT,n,!0,JSON.stringify(t),r);return _I(a)}async function Aw(n,e,t,r){let s=await(await pu(e,Qa.GENERATE_CONTENT,n,!1,JSON.stringify(t),r)).json();return{response:cm(s)}}function Hc(n){let e=[];if(typeof n=="string")e=[{text:n}];else for(let t of n)typeof t=="string"?e.push({text:t}):e.push(t);return AI(e)}function AI(n){let e={role:"user",parts:[]},t={role:"function",parts:[]},r=!1,a=!1;for(let s of n)"functionResponse"in s?(t.parts.push(s),a=!0):(e.parts.push(s),r=!0);if(r&&a)throw new it("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!a)throw new it("No content is provided for sending chat message.");return r?e:t}function om(n){return n.contents?n:{contents:[Hc(n)]}}function EI(n){return typeof n=="string"||Array.isArray(n)?{content:Hc(n)}:n}var ww=["text","inlineData","functionCall","functionResponse"],II={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall"],system:["text"]},vw={user:["model"],function:["model"],model:["user","function"],system:[]};function TI(n){let e;for(let t of n){let{role:r,parts:a}=t;if(!e&&r!=="user")throw new it(`First content should be with role 'user', got ${r}`);if(!cw.includes(r))throw new it(`Each item should include role field. Got ${r} but valid roles are: ${JSON.stringify(cw)}`);if(!Array.isArray(a))throw new it("Content should have 'parts' property with an array of Parts");if(a.length===0)throw new it("Each Content should have at least one part");let s={text:0,inlineData:0,functionCall:0,functionResponse:0};for(let o of a)for(let u of ww)u in o&&(s[u]+=1);let i=II[r];for(let o of ww)if(!i.includes(o)&&s[o]>0)throw new it(`Content with role '${r}' can't contain '${o}' part`);if(e&&!vw[r].includes(e.role))throw new it(`Content with role '${r}' can't follow '${e.role}'. Valid previous roles: ${JSON.stringify(vw)}`);e=t}}var xw="SILENT_ERROR",um=class{constructor(e,t,r,a){this.model=t,this.params=r,this.requestOptions=a,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,r?.history&&(TI(r.history),this._history=r.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,r,a,s,i;await this._sendPromise;let o=Hc(e),u={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(s=this.params)===null||s===void 0?void 0:s.toolConfig,systemInstruction:(i=this.params)===null||i===void 0?void 0:i.systemInstruction,contents:[...this._history,o]},l;return this._sendPromise=this._sendPromise.then(()=>Aw(this._apiKey,this.model,u,this.requestOptions)).then(c=>{var f;if(c.response.candidates&&c.response.candidates.length>0){this._history.push(o);let d=Object.assign({parts:[],role:"model"},(f=c.response.candidates)===null||f===void 0?void 0:f[0].content);this._history.push(d)}else{let d=zn(c.response);d&&console.warn(`sendMessage() was unsuccessful. ${d}. Inspect response object for details.`)}l=c}),await this._sendPromise,l}async sendMessageStream(e){var t,r,a,s,i;await this._sendPromise;let o=Hc(e),u={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(s=this.params)===null||s===void 0?void 0:s.toolConfig,systemInstruction:(i=this.params)===null||i===void 0?void 0:i.systemInstruction,contents:[...this._history,o]},l=Ow(this._apiKey,this.model,u,this.requestOptions);return this._sendPromise=this._sendPromise.then(()=>l).catch(c=>{throw new Error(xw)}).then(c=>c.response).then(c=>{if(c.candidates&&c.candidates.length>0){this._history.push(o);let f=Object.assign({},c.candidates[0].content);f.role||(f.role="model"),this._history.push(f)}else{let f=zn(c);f&&console.warn(`sendMessageStream() was unsuccessful. ${f}. Inspect response object for details.`)}}).catch(c=>{c.message!==xw&&console.error(c)}),l}};async function PI(n,e,t,r){return(await pu(e,Qa.COUNT_TOKENS,n,!1,JSON.stringify(Object.assign(Object.assign({},t),{model:e})),r)).json()}async function SI(n,e,t,r){return(await pu(e,Qa.EMBED_CONTENT,n,!1,JSON.stringify(t),r)).json()}async function kI(n,e,t,r){let a=t.requests.map(i=>Object.assign(Object.assign({},i),{model:e}));return(await pu(e,Qa.BATCH_EMBED_CONTENTS,n,!1,JSON.stringify({requests:a}),r)).json()}var lm=class{constructor(e,t,r){this.apiKey=e,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=t.systemInstruction,this.requestOptions=r||{}}async generateContent(e){let t=om(e);return Aw(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}async generateContentStream(e){let t=om(e);return Ow(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}startChat(e){return new um(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},e),this.requestOptions)}async countTokens(e){let t=om(e);return PI(this.apiKey,this.model,t,this.requestOptions)}async embedContent(e){let t=EI(e);return SI(this.apiKey,this.model,t,this.requestOptions)}async batchEmbedContents(e){return kI(this.apiKey,this.model,e,this.requestOptions)}};var hu=class{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new it("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new lm(this.apiKey,e,t)}};ii();Bt();Wo();var CI=typeof window=="object"?window:{},D="0123456789abcdef".split(""),RI=[-2147483648,8388608,32768,128],ur=[24,16,8,0];var Pe=[];function lr(n){n?(Pe[0]=Pe[16]=Pe[1]=Pe[2]=Pe[3]=Pe[4]=Pe[5]=Pe[6]=Pe[7]=Pe[8]=Pe[9]=Pe[10]=Pe[11]=Pe[12]=Pe[13]=Pe[14]=Pe[15]=0,this.blocks=Pe):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}lr.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===CI.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<ur[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<ur[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<ur[a++&3],i[a>>2]|=(128|t&63)<<ur[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<ur[a++&3],i[a>>2]|=(128|t>>6&63)<<ur[a++&3],i[a>>2]|=(128|t&63)<<ur[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<ur[a++&3],i[a>>2]|=(128|t>>12&63)<<ur[a++&3],i[a>>2]|=(128|t>>6&63)<<ur[a++&3],i[a>>2]|=(128|t&63)<<ur[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};lr.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=RI[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};lr.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};lr.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return D[n>>28&15]+D[n>>24&15]+D[n>>20&15]+D[n>>16&15]+D[n>>12&15]+D[n>>8&15]+D[n>>4&15]+D[n&15]+D[e>>28&15]+D[e>>24&15]+D[e>>20&15]+D[e>>16&15]+D[e>>12&15]+D[e>>8&15]+D[e>>4&15]+D[e&15]+D[t>>28&15]+D[t>>24&15]+D[t>>20&15]+D[t>>16&15]+D[t>>12&15]+D[t>>8&15]+D[t>>4&15]+D[t&15]+D[r>>28&15]+D[r>>24&15]+D[r>>20&15]+D[r>>16&15]+D[r>>12&15]+D[r>>8&15]+D[r>>4&15]+D[r&15]+D[a>>28&15]+D[a>>24&15]+D[a>>20&15]+D[a>>16&15]+D[a>>12&15]+D[a>>8&15]+D[a>>4&15]+D[a&15]};lr.prototype.toString=lr.prototype.hex;lr.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};lr.prototype.array=lr.prototype.digest;lr.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var dm=n=>new lr(!0).update(n).hex();Bt();var Ew=(...n)=>dm(n.join("_"));var fm=class{},NI=new Map,Gc=class n extends fm{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Ew(e,t))??null)}async update(e,t,r){this.cache.set(Ew(e,t),r)}static global(){return new n(NI)}};nu();Bt();Zo();Zo();var Vc={},jI=new nn({});async function MI(n){return n in Vc||(Vc[n]=jI.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new In(e)).catch(e=>{throw delete Vc[n],e})),await Vc[n]}async function Iw(n){return MI(Aa(n))}on();var $I=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;var LI=()=>!1,hm=class extends K{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??LI(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},qc=class extends hm{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=Gc.global():this.cache=void 0,this.caller=new nn(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Iw("modelName"in this?$I(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new pi(e):Array.isArray(e)?new mi(e.map(en)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};fc();Fp();Dp();Ln();var Oi=class n extends qc{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r?.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let a=n._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptions(t),o={...s.metadata,...this.getLsParams(i)},u=await at.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await u?.handleChatModelStart(this.toJSON(),[a],s.runId,void 0,l,void 0,void 0,s.runName),f;try{for await(let d of this._streamResponseChunks(a,i,c?.[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,f?f=f.concat(d):f=d}catch(d){throw await Promise.all((c??[]).map(h=>h?.handleLLMError(d))),d}await Promise.all((c??[]).map(d=>d?.handleLLMEnd({generations:[[f]]})))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,r){let a=e.map(h=>h.map(en)),s={...r.metadata,...this.getLsParams(t)},i=await at.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this?.invocationParams(t),batch_size:1},u=await i?.handleChatModelStart(this.toJSON(),a,r.runId,void 0,o,void 0,void 0,r.runName),l=[],c=[];if(!!u?.[0].handlers.find(h=>Ac(h)||vc(h))&&a.length===1&&this._streamResponseChunks!==n.prototype._streamResponseChunks)try{let h=await this._streamResponseChunks(a[0],t,u?.[0]),p;for await(let m of h)p===void 0?p=m:p=pt(p,m);if(p===void 0)throw new Error("Received empty response from chat model call.");l.push([p]),await u?.[0].handleLLMEnd({generations:l,llmOutput:{}})}catch(h){throw await u?.[0].handleLLMError(h),h}else{let h=await Promise.allSettled(a.map((p,m)=>this._generate(p,{...t,promptIndex:m},u?.[m])));await Promise.all(h.map(async(p,m)=>{if(p.status==="fulfilled"){let g=p.value;for(let b of g.generations)b.message.response_metadata={...b.generationInfo,...b.message.response_metadata};return g.generations.length===1&&(g.generations[0].message.response_metadata={...g.llmOutput,...g.generations[0].message.response_metadata}),l[m]=g.generations,c[m]=g.llmOutput,u?.[m]?.handleLLMEnd({generations:[g.generations],llmOutput:g.llmOutput})}else return await u?.[m]?.handleLLMError(p.reason),Promise.reject(p.reason)}))}let d={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(d,Up,{value:u?{runIds:u?.map(h=>h.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(g=>g.map(en)),o={...s.metadata,...this.getLsParams(a)},u=await at.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1,cached:!0},c=await u?.handleChatModelStart(this.toJSON(),i,s.runId,void 0,l,void 0,void 0,s.runName),f=[],h=(await Promise.allSettled(i.map(async(g,b)=>{let x=n._convertInputToPromptValue(g).toString(),_=await t.lookup(x,r);return _==null&&f.push(b),_}))).map((g,b)=>({result:g,runManager:c?.[b]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),p=[];await Promise.all(h.map(async({result:g,runManager:b},x)=>{if(g.status==="fulfilled"){let _=g.value;return p[x]=_,_.length&&await b?.handleLLMNewToken(_[0].text),b?.handleLLMEnd({generations:[_]})}else return await b?.handleLLMError(g.reason),Promise.reject(g.reason)}));let m={generations:p,missingPromptIndices:f};return Object.defineProperty(m,Up,{value:c?{runIds:c?.map(g=>g.runId)}:void 0,configurable:!0}),m}async generate(e,t,r){let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(h=>h.map(en)),[i,o]=this._separateRunnableConfigFromCallOptions(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:f}=await this._generateCached({messages:s,cache:u,llmStringKey:l,parsedOptions:o,handledOptions:i}),d={};if(f.length>0){let h=await this._generateUncached(f.map(p=>s[p]),o,i);await Promise.all(h.generations.map(async(p,m)=>{let g=f[m];c[g]=p;let b=n._convertInputToPromptValue(s[g]).toString();return u.update(b,l,p)})),d=h.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(en)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new Ae(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}};function mu(n){return typeof n?.parse=="function"}Ft();function Tw(n){let e={...n};if(Object.hasOwn(e,"additionalProperties")&&delete e.additionalProperties,e.properties){let t=Object.keys(e.properties);Pw(e.properties,t,0)}return e}function Pw(n,e,t){if(t>=e.length||!n)return;let r=e[t];n[r]=Tw(n[r]),Pw(n,e,t+1)}function Kc(n){let e=Tw(ie(n)),{$schema:t,...r}=e;return r}Wo();Ft();function DI(n){return{name:n.name,description:n.description,parameters:ie(n.schema)}}function Sw(n){return pm(n)?{type:"function",function:DI(n)}:n}function pm(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function UI(n){let e=n._getType();return tr.isInstance(n)?n.role:n.name??e}function FI(n){switch(n){case"ai":case"model":return"model";case"system":case"human":return"user";default:throw new Error(`Unknown / unsupported author: ${n}`)}}function BI(n){if("mimeType"in n&&"data"in n)return{inlineData:{mimeType:n.mimeType,data:n.data}};throw new Error("Invalid media content")}function zI(n,e){return typeof n=="string"?[{text:n}]:n.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){if(!e)throw new Error("This model does not support images");let r;if(typeof t.image_url=="string")r=t.image_url;else if(typeof t.image_url=="object"&&"url"in t.image_url)r=t.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");let[a,s]=r.split(",");if(!a.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");let[i,o]=a.replace(/^data:/,"").split(";");if(o!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:s,mimeType:i}}}else if(t.type==="media")return BI(t);throw new Error(`Unknown content type ${t.type}`)})}function mm(n,e){return n.reduce((t,r,a)=>{if(!Ve(r))throw new Error("Unsupported message input");let s=UI(r);if(s==="system"&&a!==0)throw new Error("System message should be the first one");let i=FI(s),o=t.content[t.content.length];if(!t.mergeWithPreviousContent&&o&&o.role===i)throw new Error("Google Generative AI requires alternate messages between authors");let u=zI(r.content,e);if(t.mergeWithPreviousContent){let c=t.content[t.content.length-1];if(!c)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return c.parts.push(...u),{mergeWithPreviousContent:!1,content:t.content}}let l={role:i,parts:u};return{mergeWithPreviousContent:s==="system",content:[...t.content,l]}},{content:[],mergeWithPreviousContent:!1}).content}function kw(n){if(!n.candidates||n.candidates.length===0||!n.candidates[0])return{generations:[],llmOutput:{filters:n.promptFeedback}};let e=n.functionCalls(),[t]=n.candidates,{content:r,...a}=t,s=r?.parts[0]?.text??"";return{generations:[{text:s,message:new Oe({content:s,tool_calls:e,additional_kwargs:{...a}}),generationInfo:a}]}}function Cw(n){if(!n.candidates||n.candidates.length===0)return null;let[e]=n.candidates,{content:t,...r}=e,a=t?.parts[0]?.text??"";return new Nr({text:a,message:new Pt({content:a,name:t?t.role:void 0,additional_kwargs:{}}),generationInfo:r})}function gm(n){return n.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?n:[{functionDeclarations:n.map(e=>{if(pm(e)){let t=Kc(e.schema);return{name:e.name,description:e.description,parameters:t}}return e})}]}var gu=class extends Fn{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new jr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let t=e.flatMap(s=>{let{message:i}=s;return!("tool_calls"in i)||!Array.isArray(i.tool_calls)?[]:i.tool_calls});if(t[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");let[r]=t;return await this._validateResult(r.args)}};var Jc=class extends Oi{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=e?.model?.replace(/^models\//,"")??e?.modelName?.replace(/^models\//,"")??this.model,this.model=this.modelName,this.maxOutputTokens=e?.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e?.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=e?.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e?.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e?.stopSequences??this.stopSequences,this.apiKey=e?.apiKey??Ee("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e?.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(r=>r.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=e?.streaming??this.streaming,this.client=new hu(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK}},{apiVersion:e?.apiVersion,baseUrl:e?.baseUrl})}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){return this.bind({tools:gm(e),...t})}invocationParams(e){let t=e?.tools;return Array.isArray(t)&&!t.some(r=>!("lc_namespace"in r))?{tools:gm(e?.tools)}:{tools:e?.tools}}async _generate(e,t,r){let a=mm(e,this._isMultimodalModel),s=this.invocationParams(t);if(this.streaming){let u={},l=this._streamResponseChunks(e,t,r),c={};for await(let d of l){let h=d.generationInfo?.completion??0;c[h]===void 0?c[h]=d:c[h]=c[h].concat(d)}return{generations:Object.entries(c).sort(([d],[h])=>parseInt(d,10)-parseInt(h,10)).map(([d,h])=>h),llmOutput:{estimatedTokenUsage:u}}}let i=await this.caller.callWithOptions({signal:t?.signal},async()=>{let u;try{u=await this.client.generateContent({...s,contents:a})}catch(l){throw l.message?.includes("400 Bad Request")&&(l.status=400),l}return u}),o=kw(i.response);return await r?.handleLLMNewToken(o.generations[0].text??""),o}async*_streamResponseChunks(e,t,r){let a=mm(e,this._isMultimodalModel),s=this.invocationParams(t),i=await this.caller.callWithOptions({signal:t?.signal},async()=>{let{stream:o}=await this.client.generateContentStream({...s,contents:a});return o});for await(let o of i){let u=Cw(o);u&&(yield u,await r?.handleLLMNewToken(u.text??""))}}withStructuredOutput(e,t){let r=e,a=t?.name,s=t?.method,i=t?.includeRaw;if(s==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "functionCalling" as a method.');let o=a??"extract",u,l;if(mu(r)){let p=Kc(r);l=[{functionDeclarations:[{name:o,description:p.description??"A function available to call.",parameters:p}]}],u=new gu({returnSingle:!0,keyName:o,zodSchema:r})}else{let p;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(p=r,o=r.name):p={name:o,description:r.description??"",parameters:r},l=[{functionDeclarations:[p]}],u=new gu({returnSingle:!0,keyName:o})}let c=this.bind({tools:l});if(!i)return c.pipe(u).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});let f=ir.assign({parsed:(p,m)=>u.invoke(p.raw,m)}),d=ir.assign({parsed:()=>null}),h=f.withFallbacks({fallbacks:[d]});return Dn.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}};Zo();Ft();var es="0.3.3";var Rw=!1,ts,bm,HI,GI,VI,ym,qI,Wc,_m,wm,vm,Zc,xm;function Nw(n,e={auto:!1}){if(Rw)throw new Error(`you must \`import 'groq-sdk/shims/${n.kind}'\` before importing anything else from groq-sdk`);if(ts)throw new Error(`can't \`import 'groq-sdk/shims/${n.kind}'\` after \`import 'groq-sdk/shims/${ts}'\``);Rw=e.auto,ts=n.kind,bm=n.fetch,HI=n.Request,GI=n.Response,VI=n.Headers,ym=n.FormData,qI=n.Blob,Wc=n.File,_m=n.ReadableStream,wm=n.getMultipartRequestOptions,vm=n.getDefaultAgent,Zc=n.fileFromPath,xm=n.isFsReadStream}var Yc=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function jw({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n",t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new Yc(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:i=>!1}}ts||Nw(jw(),{auto:!0});var Om={};ya(Om,{APIConnectionError:()=>dn,APIConnectionTimeoutError:()=>rs,APIError:()=>me,APIUserAbortError:()=>Hn,AuthenticationError:()=>Ei,BadRequestError:()=>Ai,ConflictError:()=>Pi,GroqError:()=>Se,InternalServerError:()=>Ci,NotFoundError:()=>Ti,PermissionDeniedError:()=>Ii,RateLimitError:()=>ki,UnprocessableEntityError:()=>Si});var Se=class extends Error{},me=class n extends Se{constructor(e,t,r,a){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.error=t}static makeMessage(e,t,r){let a=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e)return new dn({cause:Xc(t)});let s=t;return e===400?new Ai(e,s,r,a):e===401?new Ei(e,s,r,a):e===403?new Ii(e,s,r,a):e===404?new Ti(e,s,r,a):e===409?new Pi(e,s,r,a):e===422?new Si(e,s,r,a):e===429?new ki(e,s,r,a):e>=500?new Ci(e,s,r,a):new n(e,s,r,a)}},Hn=class extends me{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},dn=class extends me{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},rs=class extends dn{constructor({message:e}={}){super({message:e??"Request timed out."})}},Ai=class extends me{constructor(){super(...arguments),this.status=400}},Ei=class extends me{constructor(){super(...arguments),this.status=401}},Ii=class extends me{constructor(){super(...arguments),this.status=403}},Ti=class extends me{constructor(){super(...arguments),this.status=404}},Pi=class extends me{constructor(){super(...arguments),this.status=409}},Si=class extends me{constructor(){super(...arguments),this.status=422}},ki=class extends me{constructor(){super(...arguments),this.status=429}},Ci=class extends me{};var Qc=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1,a=new Am;async function*s(){if(!e.body)throw t.abort(),new Se("Attempted to iterate over a response with no body");let o=new Ri,u=Mw(e.body);for await(let l of u)for(let c of o.decode(l)){let f=a.decode(c);f&&(yield f)}for(let l of o.flush()){let c=a.decode(l);c&&(yield c)}}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(let u of s())if(!o){if(u.data.startsWith("[DONE]")){o=!0;continue}if(u.event===null){let l;try{l=JSON.parse(u.data)}catch(c){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),c}if(l&&l.error)throw new me(void 0,l.error,void 0,void 0);yield l}}o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||t.abort()}}return new n(i,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let i=new Ri,o=Mw(e);for await(let u of o)for(let l of i.decode(u))yield l;for(let u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){let i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new n(()=>a(e),this.controller),new n(()=>a(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new _m({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await t.next();if(i)return a.close();let o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){await t.return?.()}})}},Am=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=JI(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}},Ri=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),a=t.split(n.NEWLINE_REGEXP);return a.length===1&&!r?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),r||(this.buffer=[a.pop()||""]),a)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Se(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Se(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Se("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};Ri.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]);Ri.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function JI(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function Mw(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var $w=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",WI=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Lw(n),Lw=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",ZI=n=>WI(n)||$w(n)||xm(n);async function Tm(n,e,t={}){if(n=await n,$w(n)){let a=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new Wc([a],e,t)}let r=await YI(n);if(e||(e=QI(n)??"unknown_file"),!t.type){let a=r[0]?.type;typeof a=="string"&&(t={...t,type:a})}return new Wc(r,e,t)}async function YI(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Lw(n))e.push(await n.arrayBuffer());else if(eT(n))for await(let t of n)e.push(t);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${n?.constructor?.name}; props: ${XI(n)}`);return e}function XI(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function QI(n){return Em(n.name)||Em(n.filename)||Em(n.path)?.split(/[\\/]/).pop()}var Em=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},eT=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Pm=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var bu=async n=>{let e=await Dw(n.body);return wm(e,n)},Dw=async n=>{let e=new ym;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Im(e,t,r))),e};var Im=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(ZI(t)){let r=await Tm(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Im(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>Im(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var rT=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},nT=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ed;async function Gw(n){let{response:e}=n;if(n.options.stream)return Ni("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Qc.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let s=await e.json();return Ni("response",e.status,e.url,e.headers,s),s}let a=await e.text();return Ni("response",e.status,e.url,e.headers,a),a}var td=class n extends Promise{constructor(e,t=Gw){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},rd=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e4,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Sm("maxRetries",t),this.timeout=Sm("timeout",r),this.httpAgent=a,this.fetch=s??bm}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...oT(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${pT()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(a=>({method:e,path:t,...a})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){let{method:t,path:r,query:a,headers:s={}}=e,i=Pm(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),u=this.buildURL(r,a);"timeout"in e&&Sm("timeout",e.timeout);let l=e.timeout??this.timeout,c=e.httpAgent??this.httpAgent??vm(u),f=l+1e3;typeof c?.options?.timeout=="number"&&f>(c.options.timeout??0)&&(c.options.timeout=f),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let d=this.buildHeaders({options:e,headers:s,contentLength:o});return{req:{method:t,...i&&{body:i},headers:d,...c&&{agent:c},signal:e.signal??null},url:u,timeout:l}}buildHeaders({options:e,headers:t,contentLength:r}){let a={};r&&(a["content-length"]=r);let s=this.defaultHeaders(e);return Hw(a,s),Hw(a,t),Pm(e.body)&&ts!=="node"&&delete a["content-type"],this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return me.generate(e,t,r,a)}request(e,t=null){return new td(this.makeRequest(e,t))}async makeRequest(e,t){let r=await e;t==null&&(t=r.maxRetries??this.maxRetries),await this.prepareOptions(r);let{req:a,url:s,timeout:i}=this.buildRequest(r);if(await this.prepareRequest(a,{url:s,options:r}),Ni("request",s,r,a.headers),r.signal?.aborted)throw new Hn;let o=new AbortController,u=await this.fetchWithTimeout(s,a,i,o).catch(Xc);if(u instanceof Error){if(r.signal?.aborted)throw new Hn;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new rs:new dn({cause:u})}let l=aT(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){let m=`retrying, ${t} attempts remaining`;return Ni(`response (error; ${m})`,u.status,s,l),this.retryRequest(r,t,l)}let c=await u.text().catch(m=>Xc(m).message),f=uT(c),d=f?void 0:c;throw Ni(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,s,l,d),this.makeStatusError(u.status,f,d,l)}return{response:u,options:r,controller:o}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new km(this,r,e)}buildURL(e,t){let r=cT(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return fT(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new Se(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:a.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a,s=r?.["retry-after-ms"];if(s){let o=parseFloat(s);Number.isNaN(o)||(a=o)}let i=r?.["retry-after"];if(i&&!a){let o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){let o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await dT(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${es}`}},Uw=class{constructor(e,t,r,a){ed.set(this,void 0),rT(this,ed,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new Se("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await nT(this,ed,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(ed=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},km=class extends td{constructor(e,t,r){super(t,async a=>new r(e,a.response,await Gw(a),a.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},aT=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}});var sT=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":es,"X-Stainless-OS":Bw(Deno.build.os),"X-Stainless-Arch":Fw(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":es,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":es,"X-Stainless-OS":Bw(process.platform),"X-Stainless-Arch":Fw(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=iT();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":es,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":es,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function iT(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}var Fw=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Bw=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),zw,oT=()=>zw??(zw=sT()),uT=n=>{try{return JSON.parse(n)}catch{return}},lT=new RegExp("^(?:[a-z]+:)?//","i"),cT=n=>lT.test(n),dT=n=>new Promise(e=>setTimeout(e,n)),Sm=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Se(`${n} must be an integer`);if(e<0)throw new Se(`${n} must be a positive integer`);return e},Xc=n=>n instanceof Error?n:new Error(n);var Cm=n=>{if(typeof process<"u")return process.env?.[n]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(n)?.trim()};function fT(n){if(!n)return!0;for(let e in n)return!1;return!0}function hT(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Hw(n,e){for(let t in e){if(!hT(e,t))continue;let r=t.toLowerCase();if(!r)continue;let a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function Ni(n,...e){typeof process<"u"&&process.env.DEBUG==="true"&&console.log(`Groq:DEBUG:${n}`,...e)}var pT=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Vw=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";var gt=class{constructor(e){this._client=e}};var ns=class extends gt{create(e,t){return this._client.post("/openai/v1/chat/completions",{body:e,...t,stream:e.stream??!1})}};ns||(ns={});var Gn=class extends gt{constructor(){super(...arguments),this.completions=new ns(this._client)}};(function(n){n.Completions=ns})(Gn||(Gn={}));var Vn=class extends gt{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}};Vn||(Vn={});var as=class extends gt{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",bu({body:e,...t}))}};as||(as={});var ss=class extends gt{create(e,t){return this._client.post("/openai/v1/audio/translations",bu({body:e,...t}))}};ss||(ss={});var qn=class extends gt{constructor(){super(...arguments),this.transcriptions=new as(this._client),this.translations=new ss(this._client)}};(function(n){n.Transcriptions=as,n.Translations=ss})(qn||(qn={}));var qw,fe=class extends rd{constructor({baseURL:e=Cm("GROQ_BASE_URL"),apiKey:t=Cm("GROQ_API_KEY"),...r}={}){if(t===void 0)throw new Se("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");let a={apiKey:t,...r,baseURL:e||"https://api.groq.com"};if(!a.dangerouslyAllowBrowser&&Vw())throw new Se("This is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew Groq({ dangerouslyAllowBrowser: true })");super({baseURL:a.baseURL,timeout:a.timeout??6e4,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.chat=new Gn(this),this.audio=new qn(this),this.models=new Vn(this),this._options=a,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};qw=fe;fe.Groq=qw;fe.GroqError=Se;fe.APIError=me;fe.APIConnectionError=dn;fe.APIConnectionTimeoutError=rs;fe.APIUserAbortError=Hn;fe.NotFoundError=Ti;fe.ConflictError=Pi;fe.RateLimitError=ki;fe.BadRequestError=Ai;fe.AuthenticationError=Ei;fe.InternalServerError=Ci;fe.PermissionDeniedError=Ii;fe.UnprocessableEntityError=Si;var{GroqError:o9,APIError:u9,APIConnectionError:l9,APIConnectionTimeoutError:c9,APIUserAbortError:d9,NotFoundError:f9,ConflictError:h9,RateLimitError:p9,BadRequestError:m9,AuthenticationError:g9,InternalServerError:b9,PermissionDeniedError:y9,UnprocessableEntityError:_9}=Om;(function(n){n.toFile=Tm,n.fileFromPath=Zc,n.Chat=Gn,n.Audio=qn,n.Models=Vn})(fe||(fe={}));var Kw=fe;function Nm(n,e){if(n.function===void 0)return;let t;if(e?.partial)try{t=ti(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(a){throw new jr([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join(`
`))}let r={name:n.function.name,args:t};return e?.returnId&&(r.id=n.id),r}function Jw(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function Ww(n,e){return{name:n.function?.name,args:n.function?.arguments,id:n.id,error:e}}var Rm=class extends Fn{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){let t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);let r=JSON.parse(JSON.stringify(t)),a=[];for(let s of r){let i=Nm(s,{partial:!0});if(i!==void 0){let o={type:i.name,args:i.args,id:i.id};Object.defineProperty(o,"name",{get(){return this.type}}),Object.defineProperty(o,"arguments",{get(){return this.args}}),a.push(o)}}return a}},yu=class extends Fn{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new Rm(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new jr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let r=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName),a=r;return this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))}};function wT(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}}function Zw(n){return n.map(e=>{if(typeof e.content!="string")throw new Error("Non string message content not supported");let t={role:wT(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id};return v_(e)&&e.tool_calls?.length?t.tool_calls=e.tool_calls.map(Jw):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function vT(n){let e=n.tool_calls;switch(n.role){case"assistant":{let t=[],r=[];for(let a of e??[])try{t.push(Nm(a,{returnId:!0}))}catch(s){r.push(Ww(a,s.message))}return new Oe({content:n.content||"",additional_kwargs:{tool_calls:e},tool_calls:t,invalid_tool_calls:r})}default:return new tr(n.content||"",n.role??"unknown")}}function xT(n){let{role:e}=n,t=n.content??"",r;return n.function_call?r={function_call:n.function_call}:n.tool_calls?r={tool_calls:n.tool_calls}:r={},e==="user"?new ni({content:t}):e==="assistant"?new Pt({content:t,additional_kwargs:r}):e==="system"?new si({content:t}):new ri({content:t,role:e})}var nd=class extends Oi{static lc_name(){return"ChatGroq"}_llmType(){return"groq"}get lc_secrets(){return{apiKey:"GROQ_API_KEY"}}constructor(e){super(e??{}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"mixtral-8x7b-32768"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"mixtral-8x7b-32768"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0});let t=e?.apiKey||Ee("GROQ_API_KEY");if(!t)throw new Error('Groq API key not found. Please set the GROQ_API_KEY environment variable or provide the key into "apiKey"');this.client=new Kw({apiKey:t,dangerouslyAllowBrowser:!0}),this.temperature=e?.temperature??this.temperature,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.streaming=e?.streaming??this.streaming,this.stop=e?.stopSequences??(typeof e?.stop=="string"?[e.stop]:e?.stop)??[],this.stopSequences=this.stop,this.maxTokens=e?.maxTokens}async completionWithRetry(e,t){return this.caller.call(async()=>this.client.chat.completions.create(e,t))}invocationParams(e){let t=super.invocationParams(e);return e.tool_choice!==void 0&&(t.tool_choice=e.tool_choice),e.tools!==void 0&&(t.tools=e.tools),e.response_format!==void 0&&(t.response_format=e.response_format),{...t,stop:e.stop??this.stopSequences,model:this.model,temperature:this.temperature,max_tokens:this.maxTokens}}bindTools(e,t){return this.bind({tools:e.map(Sw),...t})}async*_streamResponseChunks(e,t,r){let a=this.invocationParams(t),s=Zw(e);if(t.tools!==void 0&&t.tools.length>0){let o=(await this._generateNonStreaming(e,t,r)).generations[0].message;if(o===void 0||typeof o.content!="string")throw new Error("Could not parse Groq output.");let u=o.tool_calls?.map((l,c)=>({name:l.name,args:JSON.stringify(l.args),id:l.id,index:c}));yield new Nr({message:new Pt({content:o.content,additional_kwargs:o.additional_kwargs,tool_call_chunks:u}),text:o.content})}else{let i=await this.completionWithRetry({...a,messages:s,stream:!0},{signal:t?.signal,headers:t?.headers});for await(let o of i){let u=o?.choices[0];if(!u)continue;let l=new Nr({message:xT(u.delta??{}),text:u.delta.content??"",generationInfo:{finishReason:u.finish_reason}});yield l,r?.handleLLMNewToken(l.text??"")}if(t.signal?.aborted)throw new Error("AbortError")}}async _generate(e,t,r){if(this.streaming){let a={},s=this._streamResponseChunks(e,t,r),i={};for await(let u of s){let l=u.generationInfo?.completion??0;i[l]===void 0?i[l]=u:i[l]=i[l].concat(u)}return{generations:Object.entries(i).sort(([u],[l])=>parseInt(u,10)-parseInt(l,10)).map(([u,l])=>l),llmOutput:{estimatedTokenUsage:a}}}else return this._generateNonStreaming(e,t,r)}async _generateNonStreaming(e,t,r){let a={},s=this.invocationParams(t),i=Zw(e),o=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,headers:t?.headers});if("usage"in o&&o.usage){let{completion_tokens:l,prompt_tokens:c,total_tokens:f}=o.usage;l&&(a.completionTokens=(a.completionTokens??0)+l),c&&(a.promptTokens=(a.promptTokens??0)+c),f&&(a.totalTokens=(a.totalTokens??0)+f)}let u=[];if("choices"in o&&o.choices)for(let l of o.choices){let f={text:l.message?.content??"",message:vT(l.message??{role:"assistant"})};f.generationInfo={...l.finish_reason?{finish_reason:l.finish_reason}:{},...l.logprobs?{logprobs:l.logprobs}:{}},u.push(f)}return{generations:u,llmOutput:{tokenUsage:a}}}withStructuredOutput(e,t){let r=e,a=t?.name,s=t?.method,i=t?.includeRaw,o=a??"extract",u,l;if(s==="jsonMode")l=this.bind({response_format:{type:"json_object"}}),mu(r)?u=$c.fromZodSchema(r):u=new Lc;else if(mu(r)){let h=ie(r);l=this.bind({tools:[{type:"function",function:{name:o,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:o}}}),u=new yu({returnSingle:!0,keyName:o,zodSchema:r})}else{let h;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(h=r,o=r.name):(o=r.title??o,h={name:o,description:r.description??"",parameters:r}),l=this.bind({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:o}}}),u=new yu({returnSingle:!0,keyName:o})}if(!i)return l.pipe(u).withConfig({runName:"ChatGroqStructuredOutput"});let c=ir.assign({parsed:(h,p)=>u.invoke(h.raw,p)}),f=ir.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[f]});return Dn.from([{raw:l},d]).withConfig({runName:"ChatGroqStructuredOutput"})}};var is="4.47.3";var Yw=!1,os,jm,OT,AT,ET,Mm,IT,ad,$m,Lm,Dm,sd,Um;function Xw(n,e={auto:!1}){if(Yw)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(os)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${os}'\``);Yw=e.auto,os=n.kind,jm=n.fetch,OT=n.Request,AT=n.Response,ET=n.Headers,Mm=n.FormData,IT=n.Blob,ad=n.File,$m=n.ReadableStream,Lm=n.getMultipartRequestOptions,Dm=n.getDefaultAgent,sd=n.fileFromPath,Um=n.isFsReadStream}var id=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Qw({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new id(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}os||Xw(Qw(),{auto:!0});var Fm={};ya(Fm,{APIConnectionError:()=>fn,APIConnectionTimeoutError:()=>hn,APIError:()=>he,APIUserAbortError:()=>ue,AuthenticationError:()=>Mi,BadRequestError:()=>ji,ConflictError:()=>Di,InternalServerError:()=>Bi,NotFoundError:()=>Li,OpenAIError:()=>N,PermissionDeniedError:()=>$i,RateLimitError:()=>Fi,UnprocessableEntityError:()=>Ui});var N=class extends Error{},he=class n extends N{constructor(e,t,r,a){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a?.["x-request-id"];let s=t;this.error=s,this.code=s?.code,this.param=s?.param,this.type=s?.type}static makeMessage(e,t,r){let a=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e)return new fn({cause:od(t)});let s=t?.error;return e===400?new ji(e,s,r,a):e===401?new Mi(e,s,r,a):e===403?new $i(e,s,r,a):e===404?new Li(e,s,r,a):e===409?new Di(e,s,r,a):e===422?new Ui(e,s,r,a):e===429?new Fi(e,s,r,a):e>=500?new Bi(e,s,r,a):new n(e,s,r,a)}},ue=class extends he{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},fn=class extends he{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},hn=class extends fn{constructor({message:e}={}){super({message:e??"Request timed out."})}},ji=class extends he{constructor(){super(...arguments),this.status=400}},Mi=class extends he{constructor(){super(...arguments),this.status=401}},$i=class extends he{constructor(){super(...arguments),this.status=403}},Li=class extends he{constructor(){super(...arguments),this.status=404}},Di=class extends he{constructor(){super(...arguments),this.status=409}},Ui=class extends he{constructor(){super(...arguments),this.status=422}},Fi=class extends he{constructor(){super(...arguments),this.status=429}},Bi=class extends he{};var Mr=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let i of PT(e,t))if(!s){if(i.data.startsWith("[DONE]")){s=!0;continue}if(i.event===null){let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(o&&o.error)throw new he(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(i.event=="error")throw new he(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new n(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let i=new zi,o=ev(e);for await(let u of o)for(let l of i.decode(u))yield l;for(let u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){let i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new n(()=>a(e),this.controller),new n(()=>a(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new $m({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await t.next();if(i)return a.close();let o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){await t.return?.()}})}};async function*PT(n,e){if(!n.body)throw e.abort(),new N("Attempted to iterate over a response with no body");let t=new Bm,r=new zi,a=ev(n.body);for await(let s of ST(a))for(let i of r.decode(s)){let o=t.decode(i);o&&(yield o)}for(let s of r.flush()){let i=t.decode(s);i&&(yield i)}}async function*ST(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=kT(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}function kT(n){for(let r=0;r<n.length-2;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}var Bm=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=CT(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}},zi=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),a=t.split(n.NEWLINE_REGEXP);return r&&a.pop(),a.length===1&&!r?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),r||(this.buffer=[a.pop()||""]),a)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new N(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new N(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new N("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};zi.NEWLINE_CHARS=new Set([`
`,"\r"]);zi.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function CT(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function ev(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var tv=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",rv=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&nv(n),nv=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",RT=n=>rv(n)||tv(n)||Um(n);async function Gm(n,e,t){if(n=await n,t??(t=rv(n)?{lastModified:n.lastModified,type:n.type}:{}),tv(n)){let a=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new ad([a],e,t)}let r=await NT(n);if(e||(e=MT(n)??"unknown_file"),!t.type){let a=r[0]?.type;typeof a=="string"&&(t={...t,type:a})}return new ad(r,e,t)}async function NT(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(nv(n))e.push(await n.arrayBuffer());else if($T(n))for await(let t of n)e.push(t);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${n?.constructor?.name}; props: ${jT(n)}`);return e}function jT(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function MT(n){return zm(n.name)||zm(n.filename)||zm(n.path)?.split(/[\\/]/).pop()}var zm=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},$T=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Vm=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var $r=async n=>{let e=await av(n.body);return Lm(e,n)},av=async n=>{let e=new Mm;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Hm(e,t,r))),e};var Hm=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(RT(t)){let r=await Gm(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Hm(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>Hm(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var DT=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},UT=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ud;async function lv(n){let{response:e}=n;if(n.options.stream)return Hi("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Mr.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let s=await e.json();return Hi("response",e.status,e.url,e.headers,s),s}let a=await e.text();return Hi("response",e.status,e.url,e.headers,a),a}var ld=class n extends Promise{constructor(e,t=lv){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},cd=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=qm("maxRetries",t),this.timeout=qm("timeout",r),this.httpAgent=a,this.fetch=s??jm}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...GT(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${JT()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(a=>({method:e,path:t,...a})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){let{method:t,path:r,query:a,headers:s={}}=e,i=Vm(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),u=this.buildURL(r,a);"timeout"in e&&qm("timeout",e.timeout);let l=e.timeout??this.timeout,c=e.httpAgent??this.httpAgent??Dm(u),f=l+1e3;typeof c?.options?.timeout=="number"&&f>(c.options.timeout??0)&&(c.options.timeout=f),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let d=this.buildHeaders({options:e,headers:s,contentLength:o});return{req:{method:t,...i&&{body:i},headers:d,...c&&{agent:c},signal:e.signal??null},url:u,timeout:l}}buildHeaders({options:e,headers:t,contentLength:r}){let a={};r&&(a["content-length"]=r);let s=this.defaultHeaders(e);return uv(a,s),uv(a,t),Vm(e.body)&&os!=="node"&&delete a["content-type"],this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return he.generate(e,t,r,a)}request(e,t=null){return new ld(this.makeRequest(e,t))}async makeRequest(e,t){let r=await e;t==null&&(t=r.maxRetries??this.maxRetries),await this.prepareOptions(r);let{req:a,url:s,timeout:i}=this.buildRequest(r);if(await this.prepareRequest(a,{url:s,options:r}),Hi("request",s,r,a.headers),r.signal?.aborted)throw new ue;let o=new AbortController,u=await this.fetchWithTimeout(s,a,i,o).catch(od);if(u instanceof Error){if(r.signal?.aborted)throw new ue;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new hn:new fn({cause:u})}let l=FT(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){let m=`retrying, ${t} attempts remaining`;return Hi(`response (error; ${m})`,u.status,s,l),this.retryRequest(r,t,l)}let c=await u.text().catch(m=>od(m).message),f=VT(c),d=f?void 0:c;throw Hi(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,s,l,d),this.makeStatusError(u.status,f,d,l)}return{response:u,options:r,controller:o}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new Km(this,r,e)}buildURL(e,t){let r=KT(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return cv(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new N(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:a.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let a,s=r?.["retry-after-ms"];if(s){let o=parseFloat(s);Number.isNaN(o)||(a=o)}let i=r?.["retry-after"];if(i&&!a){let o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){let o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await pn(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${is}`}},_u=class{constructor(e,t,r,a){ud.set(this,void 0),DT(this,ud,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new N("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await UT(this,ud,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(ud=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Km=class extends ld{constructor(e,t,r){super(t,async a=>new r(e,a.response,await lv(a),a.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},FT=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),BT={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},Y=n=>typeof n=="object"&&n!==null&&!cv(n)&&Object.keys(n).every(e=>dv(BT,e)),zT=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":is,"X-Stainless-OS":iv(Deno.build.os),"X-Stainless-Arch":sv(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":is,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":is,"X-Stainless-OS":iv(process.platform),"X-Stainless-Arch":sv(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=HT();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":is,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":is,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function HT(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}var sv=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",iv=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),ov,GT=()=>ov??(ov=zT()),VT=n=>{try{return JSON.parse(n)}catch{return}},qT=new RegExp("^(?:[a-z]+:)?//","i"),KT=n=>qT.test(n),pn=n=>new Promise(e=>setTimeout(e,n)),qm=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new N(`${n} must be an integer`);if(e<0)throw new N(`${n} must be a positive integer`);return e},od=n=>n instanceof Error?n:new Error(n);var wu=n=>{if(typeof process<"u")return process.env?.[n]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(n)?.trim()};function cv(n){if(!n)return!0;for(let e in n)return!1;return!0}function dv(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function uv(n,e){for(let t in e){if(!dv(e,t))continue;let r=t.toLowerCase();if(!r)continue;let a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function Hi(n,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}var JT=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),fv=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function dd(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var Kn=class extends _u{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}},ne=class extends _u{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}};var T=class{constructor(e){this._client=e}};var us=class extends T{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}};us||(us={});var Jn=class extends T{constructor(){super(...arguments),this.completions=new us(this._client)}};(function(n){n.Completions=us})(Jn||(Jn={}));var ls=class extends T{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}};ls||(ls={});var cs=class extends T{create(e,t){return this._client.post("/audio/transcriptions",$r({body:e,...t}))}};cs||(cs={});var ds=class extends T{create(e,t){return this._client.post("/audio/translations",$r({body:e,...t}))}};ds||(ds={});var Wn=class extends T{constructor(){super(...arguments),this.transcriptions=new cs(this._client),this.translations=new ds(this._client),this.speech=new ls(this._client)}};(function(n){n.Transcriptions=cs,n.Translations=ds,n.Speech=ls})(Wn||(Wn={}));var Zn=class extends T{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/batches",Yn,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},Yn=class extends ne{};(function(n){n.BatchesPage=Yn})(Zn||(Zn={}));var fs=class extends T{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/assistants",hs,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},hs=class extends ne{};(function(n){n.AssistantsPage=hs})(fs||(fs={}));function Jm(n){return typeof n.parse=="function"}var Xn=n=>n?.role==="assistant",Wm=n=>n?.role==="function",Zm=n=>n?.role==="tool";var cr=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},F=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Je,fd,hd,vu,xu,pd,Ou,mn,Au,md,gd,Gi,Ym,bd,Xm,Qm,eg,tg,gv,rg,mv=10,Vi=class{constructor(){Je.add(this),this.controller=new AbortController,fd.set(this,void 0),hd.set(this,()=>{}),vu.set(this,()=>{}),xu.set(this,void 0),pd.set(this,()=>{}),Ou.set(this,()=>{}),mn.set(this,{}),this._chatCompletions=[],this.messages=[],Au.set(this,!1),md.set(this,!1),gd.set(this,!1),Gi.set(this,!1),tg.set(this,e=>{if(cr(this,md,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new ue),e instanceof ue)return cr(this,gd,!0,"f"),this._emit("abort",e);if(e instanceof N)return this._emit("error",e);if(e instanceof Error){let t=new N(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new N(String(e)))}),cr(this,fd,new Promise((e,t)=>{cr(this,hd,e,"f"),cr(this,vu,t,"f")}),"f"),cr(this,xu,new Promise((e,t)=>{cr(this,pd,e,"f"),cr(this,Ou,t,"f")}),"f"),F(this,fd,"f").catch(()=>{}),F(this,xu,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},F(this,tg,"f"))},0)}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Wm(e)||Zm(e))&&e.content)this._emit("functionCallResult",e.content);else if(Xn(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Xn(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}_connected(){this.ended||(F(this,hd,"f").call(this),this._emit("connect"))}get ended(){return F(this,Au,"f")}get errored(){return F(this,md,"f")}get aborted(){return F(this,gd,"f")}abort(){this.controller.abort()}on(e,t){return(F(this,mn,"f")[e]||(F(this,mn,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=F(this,mn,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(F(this,mn,"f")[e]||(F(this,mn,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{cr(this,Gi,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){cr(this,Gi,!0,"f"),await F(this,xu,"f")}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new N("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),F(this,Je,"m",Ym).call(this)}async finalMessage(){return await this.done(),F(this,Je,"m",bd).call(this)}async finalFunctionCall(){return await this.done(),F(this,Je,"m",Xm).call(this)}async finalFunctionCallResult(){return await this.done(),F(this,Je,"m",Qm).call(this)}async totalUsage(){return await this.done(),F(this,Je,"m",eg).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(F(this,Au,"f"))return;e==="end"&&(cr(this,Au,!0,"f"),F(this,pd,"f").call(this));let r=F(this,mn,"f")[e];if(r&&(F(this,mn,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!F(this,Gi,"f")&&!r?.length&&Promise.reject(a),F(this,vu,"f").call(this,a),F(this,Ou,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!F(this,Gi,"f")&&!r?.length&&Promise.reject(a),F(this,vu,"f").call(this,a),F(this,Ou,"f").call(this,a),this._emit("end")}}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=F(this,Je,"m",bd).call(this);t&&this._emit("finalMessage",t);let r=F(this,Je,"m",Ym).call(this);r&&this._emit("finalContent",r);let a=F(this,Je,"m",Xm).call(this);a&&this._emit("finalFunctionCall",a);let s=F(this,Je,"m",Qm).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",F(this,Je,"m",eg).call(this))}async _createChatCompletion(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),F(this,Je,"m",gv).call(this,t);let s=await e.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(s)}async _runChatCompletion(e,t,r){for(let a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){let a="function",{function_call:s="auto",stream:i,...o}=t,u=typeof s!="string"&&s?.name,{maxChatCompletions:l=mv}=r||{},c={};for(let d of t.functions)c[d.name||d.function.name]=d;let f=t.functions.map(d=>({name:d.name||d.function.name,parameters:d.parameters,description:d.description}));for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){let p=(await this._createChatCompletion(e,{...o,function_call:s,functions:f,messages:[...this.messages]},r)).choices[0]?.message;if(!p)throw new N("missing message in ChatCompletion response");if(!p.function_call)return;let{name:m,arguments:g}=p.function_call,b=c[m];if(b){if(u&&u!==m){let O=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,name:m,content:O});continue}}else{let O=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${f.map(B=>JSON.stringify(B.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:m,content:O});continue}let x;try{x=Jm(b)?await b.parse(g):g}catch(O){this._addMessage({role:a,name:m,content:O instanceof Error?O.message:String(O)});continue}let _=await b.function(x,this),k=F(this,Je,"m",rg).call(this,_);if(this._addMessage({role:a,name:m,content:k}),u)return}}async _runTools(e,t,r){let a="tool",{tool_choice:s="auto",stream:i,...o}=t,u=typeof s!="string"&&s?.function?.name,{maxChatCompletions:l=mv}=r||{},c={};for(let d of t.tools)d.type==="function"&&(c[d.function.name||d.function.function.name]=d.function);let f="tools"in t?t.tools.map(d=>d.type==="function"?{type:"function",function:{name:d.function.name||d.function.function.name,parameters:d.function.parameters,description:d.function.description}}:d):void 0;for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){let p=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:f,messages:[...this.messages]},r)).choices[0]?.message;if(!p)throw new N("missing message in ChatCompletion response");if(!p.tool_calls)return;for(let m of p.tool_calls){if(m.type!=="function")continue;let g=m.id,{name:b,arguments:x}=m.function,_=c[b];if(_){if(u&&u!==b){let j=`Invalid tool_call: ${JSON.stringify(b)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,tool_call_id:g,content:j});continue}}else{let j=`Invalid tool_call: ${JSON.stringify(b)}. Available options are: ${f.map(J=>JSON.stringify(J.function.name)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:g,content:j});continue}let k;try{k=Jm(_)?await _.parse(x):x}catch(j){let J=j instanceof Error?j.message:String(j);this._addMessage({role:a,tool_call_id:g,content:J});continue}let O=await _.function(k,this),B=F(this,Je,"m",rg).call(this,O);if(this._addMessage({role:a,tool_call_id:g,content:B}),u)return}}}};fd=new WeakMap,hd=new WeakMap,vu=new WeakMap,xu=new WeakMap,pd=new WeakMap,Ou=new WeakMap,mn=new WeakMap,Au=new WeakMap,md=new WeakMap,gd=new WeakMap,Gi=new WeakMap,tg=new WeakMap,Je=new WeakSet,Ym=function(){return F(this,Je,"m",bd).call(this).content??null},bd=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(Xn(t))return{...t,content:t.content??null}}throw new N("stream ended without producing a ChatCompletionMessage with role=assistant")},Xm=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Xn(t)&&t?.function_call)return t.function_call;if(Xn(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},Qm=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Wm(t)&&t.content!=null||Zm(t)&&t.content!=null&&this.messages.some(r=>r.role==="assistant"&&r.tool_calls?.some(a=>a.type==="function"&&a.id===t.tool_call_id)))return t.content}},eg=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},gv=function(e){if(e.n!=null&&e.n>1)throw new N("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},rg=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Eu=class n extends Vi{static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e){super._addMessage(e),Xn(e)&&e.content&&this._emit("content",e.content)}};var dr=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ng=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Lr,Qn,ag,sg,yd,bv,qi=class n extends Vi{constructor(){super(...arguments),Lr.add(this),Qn.set(this,void 0)}get currentChatCompletionSnapshot(){return dr(this,Qn,"f")}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let a=new n;return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),dr(this,Lr,"m",ag).call(this);let s=await e.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let i of s)dr(this,Lr,"m",sg).call(this,i);if(s.controller.signal?.aborted)throw new ue;return this._addChatCompletion(dr(this,Lr,"m",yd).call(this))}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),dr(this,Lr,"m",ag).call(this),this._connected();let a=Mr.fromReadableStream(e,this.controller),s;for await(let i of a)s&&s!==i.id&&this._addChatCompletion(dr(this,Lr,"m",yd).call(this)),dr(this,Lr,"m",sg).call(this,i),s=i.id;if(a.controller.signal?.aborted)throw new ue;return this._addChatCompletion(dr(this,Lr,"m",yd).call(this))}[(Qn=new WeakMap,Lr=new WeakSet,ag=function(){this.ended||ng(this,Qn,void 0,"f")},sg=function(t){if(this.ended)return;let r=dr(this,Lr,"m",bv).call(this,t);this._emit("chunk",t,r);let a=t.choices[0]?.delta?.content,s=r.choices[0]?.message;a!=null&&s?.role==="assistant"&&s?.content&&this._emit("content",a,s.content)},yd=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");let t=dr(this,Qn,"f");if(!t)throw new N("request ended without sending any chunks");return ng(this,Qn,void 0,"f"),tP(t)},bv=function(t){var r,a,s;let i=dr(this,Qn,"f"),{choices:o,...u}=t;i?Object.assign(i,u):i=ng(this,Qn,{...u,choices:[]},"f");for(let{delta:l,finish_reason:c,index:f,logprobs:d=null,...h}of t.choices){let p=i.choices[f];if(p||(p=i.choices[f]={finish_reason:c,index:f,message:{},logprobs:d,...h}),d)if(!p.logprobs)p.logprobs=Object.assign({},d);else{let{content:k,...O}=d;Object.assign(p.logprobs,O),k&&((r=p.logprobs).content??(r.content=[]),p.logprobs.content.push(...k))}if(c&&(p.finish_reason=c),Object.assign(p,h),!l)continue;let{content:m,function_call:g,role:b,tool_calls:x,..._}=l;if(Object.assign(p.message,_),m&&(p.message.content=(p.message.content||"")+m),b&&(p.message.role=b),g&&(p.message.function_call?(g.name&&(p.message.function_call.name=g.name),g.arguments&&((a=p.message.function_call).arguments??(a.arguments=""),p.message.function_call.arguments+=g.arguments)):p.message.function_call=g),x){p.message.tool_calls||(p.message.tool_calls=[]);for(let{index:k,id:O,type:B,function:j,...J}of x){let Xe=(s=p.message.tool_calls)[k]??(s[k]={});Object.assign(Xe,J),O&&(Xe.id=O),B&&(Xe.type=B),j&&(Xe.function??(Xe.function={arguments:""})),j?.name&&(Xe.function.name=j.name),j?.arguments&&(Xe.function.arguments+=j.arguments)}}}return i},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Mr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function tP(n){let{id:e,choices:t,created:r,model:a,system_fingerprint:s,...i}=n;return{...i,id:e,choices:t.map(({message:o,finish_reason:u,index:l,logprobs:c,...f})=>{if(!u)throw new N(`missing finish_reason for choice ${l}`);let{content:d=null,function_call:h,tool_calls:p,...m}=o,g=o.role;if(!g)throw new N(`missing role for choice ${l}`);if(h){let{arguments:b,name:x}=h;if(b==null)throw new N(`missing function_call.arguments for choice ${l}`);if(!x)throw new N(`missing function_call.name for choice ${l}`);return{...f,message:{content:d,function_call:{arguments:b,name:x},role:g},finish_reason:u,index:l,logprobs:c}}return p?{...f,index:l,finish_reason:u,logprobs:c,message:{...m,role:g,content:d,tool_calls:p.map((b,x)=>{let{function:_,type:k,id:O,...B}=b,{arguments:j,name:J,...Xe}=_||{};if(O==null)throw new N(`missing choices[${l}].tool_calls[${x}].id
${_d(n)}`);if(k==null)throw new N(`missing choices[${l}].tool_calls[${x}].type
${_d(n)}`);if(J==null)throw new N(`missing choices[${l}].tool_calls[${x}].function.name
${_d(n)}`);if(j==null)throw new N(`missing choices[${l}].tool_calls[${x}].function.arguments
${_d(n)}`);return{...B,id:O,type:k,function:{...Xe,name:J,arguments:j}}})}}:{...f,message:{...m,content:d,role:g},finish_reason:u,index:l,logprobs:c}}),created:r,model:a,object:"chat.completion",...s?{system_fingerprint:s}:{}}}function _d(n){return JSON.stringify(n)}var Iu=class n extends qi{static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}};var Tu=class extends T{runFunctions(e,t){return e.stream?Iu.runFunctions(this._client.chat.completions,e,t):Eu.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?Iu.runTools(this._client.chat.completions,e,t):Eu.runTools(this._client.chat.completions,e,t)}stream(e,t){return qi.createChatCompletion(this._client.chat.completions,e,t)}};var ps=class extends T{constructor(){super(...arguments),this.completions=new Tu(this._client)}};(function(n){n.Completions=Tu})(ps||(ps={}));var fr=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},ae=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},wd,vd,Pu,Su,xd,ku,gn,Cu,Od,Ad,Ki,ig,Ed=class{constructor(){this.controller=new AbortController,wd.set(this,void 0),vd.set(this,()=>{}),Pu.set(this,()=>{}),Su.set(this,void 0),xd.set(this,()=>{}),ku.set(this,()=>{}),gn.set(this,{}),Cu.set(this,!1),Od.set(this,!1),Ad.set(this,!1),Ki.set(this,!1),ig.set(this,e=>{if(fr(this,Od,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new ue),e instanceof ue)return fr(this,Ad,!0,"f"),this._emit("abort",e);if(e instanceof N)return this._emit("error",e);if(e instanceof Error){let t=new N(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new N(String(e)))}),fr(this,wd,new Promise((e,t)=>{fr(this,vd,e,"f"),fr(this,Pu,t,"f")}),"f"),fr(this,Su,new Promise((e,t)=>{fr(this,xd,e,"f"),fr(this,ku,t,"f")}),"f"),ae(this,wd,"f").catch(()=>{}),ae(this,Su,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emit("end")},ae(this,ig,"f"))},0)}_addRun(e){return e}_connected(){this.ended||(ae(this,vd,"f").call(this),this._emit("connect"))}get ended(){return ae(this,Cu,"f")}get errored(){return ae(this,Od,"f")}get aborted(){return ae(this,Ad,"f")}abort(){this.controller.abort()}on(e,t){return(ae(this,gn,"f")[e]||(ae(this,gn,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=ae(this,gn,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(ae(this,gn,"f")[e]||(ae(this,gn,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{fr(this,Ki,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){fr(this,Ki,!0,"f"),await ae(this,Su,"f")}_emit(e,...t){if(ae(this,Cu,"f"))return;e==="end"&&(fr(this,Cu,!0,"f"),ae(this,xd,"f").call(this));let r=ae(this,gn,"f")[e];if(r&&(ae(this,gn,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!ae(this,Ki,"f")&&!r?.length&&Promise.reject(a),ae(this,Pu,"f").call(this,a),ae(this,ku,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!ae(this,Ki,"f")&&!r?.length&&Promise.reject(a),ae(this,Pu,"f").call(this,a),ae(this,ku,"f").call(this,a),this._emit("end")}}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,s){return await this._createToolAssistantStream(r,e,t,a,s)}async _createThreadAssistantStream(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s=await e.createAndRun({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addRun(s)}async _createToolAssistantStream(e,t,r,a,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o=await e.submitToolOutputs(t,r,{...a,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addRun(o)}async _createAssistantStream(e,t,r,a){let s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i=await e.create(t,{...r,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addRun(i)}};wd=new WeakMap,vd=new WeakMap,Pu=new WeakMap,Su=new WeakMap,xd=new WeakMap,ku=new WeakMap,gn=new WeakMap,Cu=new WeakMap,Od=new WeakMap,Ad=new WeakMap,Ki=new WeakMap,ig=new WeakMap;var P=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},kt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Le,og,Dr,Id,hr,gs,Ji,ms,Sd,Ct,Td,Pd,ju,Ru,Nu,yv,_v,wv,vv,xv,Ov,Av,Ur=class n extends Ed{constructor(){super(...arguments),Le.add(this),og.set(this,[]),Dr.set(this,{}),Id.set(this,{}),hr.set(this,void 0),gs.set(this,void 0),Ji.set(this,void 0),ms.set(this,void 0),Sd.set(this,void 0),Ct.set(this,void 0),Td.set(this,void 0),Pd.set(this,void 0),ju.set(this,void 0)}[(og=new WeakMap,Dr=new WeakMap,Id=new WeakMap,hr=new WeakMap,gs=new WeakMap,Ji=new WeakMap,ms=new WeakMap,Sd=new WeakMap,Ct=new WeakMap,Td=new WeakMap,Pd=new WeakMap,ju=new WeakMap,Le=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let a=Mr.fromReadableStream(e,this.controller);for await(let s of a)P(this,Le,"m",Ru).call(this,s);if(a.controller.signal?.aborted)throw new ue;return this._addRun(P(this,Le,"m",Nu).call(this))}toReadableStream(){return new Mr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,s){let i=new n;return i._run(()=>i._runToolAssistantStream(e,t,r,a,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o={...a,stream:!0},u=await e.submitToolOutputs(t,r,o,{...s,signal:this.controller.signal});this._connected();for await(let l of u)P(this,Le,"m",Ru).call(this,l);if(u.controller.signal?.aborted)throw new ue;return this._addRun(P(this,Le,"m",Nu).call(this))}static createThreadAssistantStream(e,t,r){let a=new n;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){let s=new n;return s._run(()=>s._runAssistantStream(e,t,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return P(this,Td,"f")}currentRun(){return P(this,Pd,"f")}currentMessageSnapshot(){return P(this,hr,"f")}currentRunStepSnapshot(){return P(this,ju,"f")}async finalRunSteps(){return await this.done(),Object.values(P(this,Dr,"f"))}async finalMessages(){return await this.done(),Object.values(P(this,Id,"f"))}async finalRun(){if(await this.done(),!P(this,gs,"f"))throw Error("Final run was not received.");return P(this,gs,"f")}async _createThreadAssistantStream(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});this._connected();for await(let o of i)P(this,Le,"m",Ru).call(this,o);if(i.controller.signal?.aborted)throw new ue;return this._addRun(P(this,Le,"m",Nu).call(this))}async _createAssistantStream(e,t,r,a){let s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...r,stream:!0},o=await e.create(t,i,{...a,signal:this.controller.signal});this._connected();for await(let u of o)P(this,Le,"m",Ru).call(this,u);if(o.controller.signal?.aborted)throw new ue;return this._addRun(P(this,Le,"m",Nu).call(this))}static accumulateDelta(e,t){for(let[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let s=e[r];if(s==null){e[r]=a;continue}if(r==="index"||r==="type"){e[r]=a;continue}if(typeof s=="string"&&typeof a=="string")s+=a;else if(typeof s=="number"&&typeof a=="number")s+=a;else if(dd(s)&&dd(a))s=this.accumulateDelta(s,a);else if(Array.isArray(s)&&Array.isArray(a)){if(s.every(i=>typeof i=="string"||typeof i=="number")){s.push(...a);continue}}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${s}`);e[r]=s}return e}};Ru=function(e){if(!this.ended)switch(kt(this,Td,e,"f"),P(this,Le,"m",wv).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":P(this,Le,"m",Av).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":P(this,Le,"m",_v).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":P(this,Le,"m",yv).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Nu=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");if(!P(this,gs,"f"))throw Error("Final run has not been received");return P(this,gs,"f")},yv=function(e){let[t,r]=P(this,Le,"m",xv).call(this,e,P(this,hr,"f"));kt(this,hr,t,"f"),P(this,Id,"f")[t.id]=t;for(let a of r){let s=t.content[a.index];s?.type=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let a of e.data.delta.content){if(a.type=="text"&&a.text){let s=a.text,i=t.content[a.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(a.index!=P(this,Ji,"f")){if(P(this,ms,"f"))switch(P(this,ms,"f").type){case"text":this._emit("textDone",P(this,ms,"f").text,P(this,hr,"f"));break;case"image_file":this._emit("imageFileDone",P(this,ms,"f").image_file,P(this,hr,"f"));break}kt(this,Ji,a.index,"f")}kt(this,ms,t.content[a.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(P(this,Ji,"f")!==void 0){let a=e.data.content[P(this,Ji,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,P(this,hr,"f"));break;case"text":this._emit("textDone",a.text,P(this,hr,"f"));break}}P(this,hr,"f")&&this._emit("messageDone",e.data),kt(this,hr,void 0,"f")}},_v=function(e){let t=P(this,Le,"m",vv).call(this,e);switch(kt(this,ju,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let s of r.step_details.tool_calls)s.index==P(this,Sd,"f")?this._emit("toolCallDelta",s,t.step_details.tool_calls[s.index]):(P(this,Ct,"f")&&this._emit("toolCallDone",P(this,Ct,"f")),kt(this,Sd,s.index,"f"),kt(this,Ct,t.step_details.tool_calls[s.index],"f"),P(this,Ct,"f")&&this._emit("toolCallCreated",P(this,Ct,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":kt(this,ju,void 0,"f"),e.data.step_details.type=="tool_calls"&&P(this,Ct,"f")&&(this._emit("toolCallDone",P(this,Ct,"f")),kt(this,Ct,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},wv=function(e){P(this,og,"f").push(e),this._emit("event",e)},vv=function(e){switch(e.event){case"thread.run.step.created":return P(this,Dr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=P(this,Dr,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let a=Ur.accumulateDelta(t,r.delta);P(this,Dr,"f")[e.data.id]=a}return P(this,Dr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":P(this,Dr,"f")[e.data.id]=e.data;break}if(P(this,Dr,"f")[e.data.id])return P(this,Dr,"f")[e.data.id];throw new Error("No snapshot available")},xv=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(let s of a.delta.content)if(s.index in t.content){let i=t.content[s.index];t.content[s.index]=P(this,Le,"m",Ov).call(this,s,i)}else t.content[s.index]=s,r.push(s);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Ov=function(e,t){return Ur.accumulateDelta(t,e)},Av=function(e){switch(kt(this,Pd,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":kt(this,gs,e.data,"f"),P(this,Ct,"f")&&(this._emit("toolCallDone",P(this,Ct,"f")),kt(this,Ct,void 0,"f"));break;case"thread.run.cancelling":break}};var bs=class extends T{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t={},r){return Y(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,ys,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}},ys=class extends ne{};(function(n){n.MessagesPage=ys})(bs||(bs={}));var _s=class extends T{retrieve(e,t,r,a){return this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t,r={},a){return Y(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,ws,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},ws=class extends ne{};(function(n){n.RunStepsPage=ws})(_s||(_s={}));var vs=class extends T{constructor(){super(...arguments),this.steps=new _s(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/runs`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t={},r){return Y(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,xs,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}createAndStream(e,t,r){return Ur.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...a}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await pn(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,r){return Ur.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,a){let s=await this.submitToolOutputs(e,t,r,a);return await this.poll(e,s.id,a)}submitToolOutputsStream(e,t,r,a){return Ur.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}},xs=class extends ne{};(function(n){n.RunsPage=xs,n.Steps=_s,n.RunStepsPage=ws})(vs||(vs={}));var Os=class extends T{constructor(){super(...arguments),this.runs=new vs(this._client),this.messages=new bs(this._client)}create(e={},t){return Y(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return Ur.createThreadAssistantStream(e,this._client.beta.threads,t)}};(function(n){n.Runs=vs,n.RunsPage=xs,n.Messages=bs,n.MessagesPage=ys})(Os||(Os={}));var Pv=async n=>{let e=await Promise.allSettled(n),t=e.filter(a=>a.status==="rejected");if(t.length){for(let a of t)console.error(a.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let r=[];for(let a of e)a.status==="fulfilled"&&r.push(a.value);return r};var As=class extends T{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},r){return Y(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,bn,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let s=await this.retrieve(e,t,{...r,headers:a}).withResponse(),i=s.data;switch(i.status){case"in_progress":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let u=s.response.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await pn(o);break;case"failed":case"completed":return i}}}async upload(e,t,r){let a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){let a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}},bn=class extends ne{};(function(n){n.VectorStoreFilesPage=bn})(As||(As={}));var Es=class extends T{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r={},a){return Y(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,bn,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:a}).withResponse();switch(s.status){case"in_progress":let o=5e3;if(r?.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await pn(o);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){if(t===null||t.length==0)throw new Error("No files provided to process.");let s=a?.maxConcurrency??5,i=Math.min(s,t.length),o=this._client,u=t.values(),l=[...r];async function c(d){for(let h of d){let p=await o.files.create({file:h,purpose:"assistants"},a);l.push(p.id)}}let f=Array(i).fill(u).map(c);return await Pv(f),await this.createAndPoll(e,{file_ids:l})}};Es||(Es={});var Is=class extends T{constructor(){super(...arguments),this.files=new As(this._client),this.fileBatches=new Es(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/vector_stores",Ts,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},Ts=class extends ne{};(function(n){n.VectorStoresPage=Ts,n.Files=As,n.VectorStoreFilesPage=bn,n.FileBatches=Es})(Is||(Is={}));var ea=class extends T{constructor(){super(...arguments),this.vectorStores=new Is(this._client),this.chat=new ps(this._client),this.assistants=new fs(this._client),this.threads=new Os(this._client)}};(function(n){n.VectorStores=Is,n.VectorStoresPage=Ts,n.Chat=ps,n.Assistants=fs,n.AssistantsPage=hs,n.Threads=Os})(ea||(ea={}));var ta=class extends T{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};ta||(ta={});var ra=class extends T{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};ra||(ra={});var na=class extends T{create(e,t){return this._client.post("/files",$r({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/files",aa,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let a=new Set(["processed","error","deleted"]),s=Date.now(),i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await pn(t),i=await this.retrieve(e),Date.now()-s>r)throw new hn({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}},aa=class extends Kn{};(function(n){n.FileObjectsPage=aa})(na||(na={}));var Ps=class extends T{list(e,t={},r){return Y(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Ss,{query:t,...r})}},Ss=class extends ne{};(function(n){n.FineTuningJobCheckpointsPage=Ss})(Ps||(Ps={}));var ks=class extends T{constructor(){super(...arguments),this.checkpoints=new Ps(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Cs,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return Y(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Rs,{query:t,...r})}},Cs=class extends ne{},Rs=class extends ne{};(function(n){n.FineTuningJobsPage=Cs,n.FineTuningJobEventsPage=Rs,n.Checkpoints=Ps,n.FineTuningJobCheckpointsPage=Ss})(ks||(ks={}));var sa=class extends T{constructor(){super(...arguments),this.jobs=new ks(this._client)}};(function(n){n.Jobs=ks,n.FineTuningJobsPage=Cs,n.FineTuningJobEventsPage=Rs})(sa||(sa={}));var ia=class extends T{createVariation(e,t){return this._client.post("/images/variations",$r({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",$r({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};ia||(ia={});var oa=class extends T{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ua,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},ua=class extends Kn{};(function(n){n.ModelsPage=ua})(oa||(oa={}));var la=class extends T{create(e,t){return this._client.post("/moderations",{body:e,...t})}};la||(la={});var Nv,X=class extends cd{constructor({baseURL:e=wu("OPENAI_BASE_URL"),apiKey:t=wu("OPENAI_API_KEY"),organization:r=wu("OPENAI_ORG_ID")??null,project:a=wu("OPENAI_PROJECT_ID")??null,...s}={}){if(t===void 0)throw new N("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let i={apiKey:t,organization:r,project:a,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&fv())throw new N(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new ta(this),this.chat=new Jn(this),this.embeddings=new ra(this),this.files=new na(this),this.images=new ia(this),this.audio=new Wn(this),this.moderations=new la(this),this.models=new oa(this),this.fineTuning=new sa(this),this.beta=new ea(this),this.batches=new Zn(this),this._options=i,this.apiKey=t,this.organization=r,this.project=a}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};Nv=X;X.OpenAI=Nv;X.OpenAIError=N;X.APIError=he;X.APIConnectionError=fn;X.APIConnectionTimeoutError=hn;X.APIUserAbortError=ue;X.NotFoundError=Li;X.ConflictError=Di;X.RateLimitError=Fi;X.BadRequestError=ji;X.AuthenticationError=Mi;X.InternalServerError=Bi;X.PermissionDeniedError=$i;X.UnprocessableEntityError=Ui;X.toFile=Gm;X.fileFromPath=sd;var{OpenAIError:_3,APIError:w3,APIConnectionError:v3,APIConnectionTimeoutError:jv,APIUserAbortError:Mv,NotFoundError:x3,ConflictError:O3,RateLimitError:A3,BadRequestError:E3,AuthenticationError:I3,InternalServerError:T3,PermissionDeniedError:P3,UnprocessableEntityError:S3}=Fm;(function(n){n.Page=Kn,n.CursorPage=ne,n.Completions=ta,n.Chat=Jn,n.Embeddings=ra,n.Files=na,n.FileObjectsPage=aa,n.Images=ia,n.Audio=Wn,n.Moderations=la,n.Models=oa,n.ModelsPage=ua,n.FineTuning=sa,n.Beta=ea,n.Batches=Zn,n.BatchesPage=Yn})(X||(X={}));function ug(n,e=Wi){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function Wi(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch{return null}}var $v=q(sl(),1),lP=q(il(),1);function Lv(n,e){return e?.[n]||(0,$v.default)(n)}function Dv(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function Uv(n){return Array.isArray(n)?[...n]:{...n}}function cP(n,e){let t=Uv(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=Uv(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function lg(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var pr=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,lg(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let l of u.reverse()){if(!(l in s)||s[l]===void 0)return;(!(l in i)||i[l]===void 0)&&(typeof s[l]=="object"&&s[l]!=null?i[l]={}:Array.isArray(s[l])&&(i[l]=[])),s=s[l],i=i[l]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Dv(Object.keys(t).length?cP(r,t):r,Lv,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Ht(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}var Rt=class extends pr{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}};function pe(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string")t[r]=t[r]+a;else if(!Array.isArray(t[r])&&typeof t[r]=="object")t[r]=pe(t[r],a);else if(Array.isArray(t[r]))t[r]=cg(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function cg(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=pe(t[a],r):t.push(r)}else t.push(r);return t}}}var bt=class extends Rt{};function Zi(n){return typeof n?._getType=="function"}function Fv(n){return Zi(n)&&typeof n.concat=="function"}var Mu=class n extends bt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new n({content:Ht(this.content,e.content),additional_kwargs:pe(this.additional_kwargs,e.additional_kwargs),response_metadata:pe(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}};function Bv(n){let e=[],t=[];for(let r of n)if(r.function){let a=r.function.name;try{let s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var yn=class extends Rt{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let a=r.additional_kwargs?.tool_calls,s=r.tool_calls;a!=null&&a.length>0&&(s===void 0||s.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&s===void 0){let[i,o]=Bv(a);r.tool_calls=i??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}};function dg(n){return n._getType()==="ai"}var mr=class n extends bt{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{let r=[],a=[];for(let s of e.tool_call_chunks){let i={};try{if(i=Wi(s.args??"{}")??{},typeof i!="object"||Array.isArray(i))throw new Error("Malformed tool call chunk args.");r.push({name:s.name??"",args:i,id:s.id})}catch{a.push({name:s.name,args:s.args,id:s.id,error:"Malformed args."})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){let t={content:Ht(this.content,e.content),additional_kwargs:pe(this.additional_kwargs,e.additional_kwargs),response_metadata:pe(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let r=cg(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:r.input_tokens+a.input_tokens,output_tokens:r.output_tokens+a.output_tokens,total_tokens:r.total_tokens+a.total_tokens};t.usage_metadata=s}return new n(t)}};var Ns=class n extends Rt{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}},Yi=class n extends bt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:Ht(this.content,e.content),additional_kwargs:pe(this.additional_kwargs,e.additional_kwargs),response_metadata:pe(this.response_metadata,e.response_metadata),role:this.role})}};var Xi=class n extends bt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new n({content:Ht(this.content,e.content),additional_kwargs:pe(this.additional_kwargs,e.additional_kwargs),response_metadata:pe(this.response_metadata,e.response_metadata),name:this.name??""})}};var Fr=class extends Rt{static lc_name(){return"HumanMessage"}_getType(){return"human"}},Qi=class n extends bt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new n({content:Ht(this.content,e.content),additional_kwargs:pe(this.additional_kwargs,e.additional_kwargs),response_metadata:pe(this.response_metadata,e.response_metadata)})}};var kd=class extends Rt{static lc_name(){return"SystemMessage"}_getType(){return"system"}},eo=class n extends bt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new n({content:Ht(this.content,e.content),additional_kwargs:pe(this.additional_kwargs,e.additional_kwargs),response_metadata:pe(this.response_metadata,e.response_metadata)})}};function js(n){if(typeof n=="string")return new Fr(n);if(Zi(n))return n;let[e,t]=n;if(e==="human"||e==="user")return new Fr({content:t});if(e==="ai"||e==="assistant")return new yn({content:t});if(e==="system")return new kd({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function to(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"";r.push(`${s}: ${i}${a.content}`)}return r.join(`
`)}function zv(n){let e=n._getType();if(e==="human")return new Qi({...n});if(e==="ai")return new mr({...n});if(e==="system")return new eo({...n});if(e==="function")return new Xi({...n});if(Ns.isInstance(n))return new Yi({...n});throw new Error("Unknown message type.")}var Cd="__run",Br=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},ca=class n extends Br{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};var fP=()=>typeof window<"u"&&typeof window.document<"u",hP=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",pP=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Hv=()=>typeof Deno<"u",mP=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Hv(),gP=()=>{let n;return fP()?n="browser":mP()?n="node":hP()?n="webworker":pP()?n="jsdom":Hv()?n="deno":n="other",n},fg;async function Gv(){return fg===void 0&&(fg={library:"langchain-js",runtime:gP()}),fg}function Z(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var bP=typeof window=="object"?window:{},U="0123456789abcdef".split(""),yP=[-2147483648,8388608,32768,128],gr=[24,16,8,0];var ke=[];function br(n){n?(ke[0]=ke[16]=ke[1]=ke[2]=ke[3]=ke[4]=ke[5]=ke[6]=ke[7]=ke[8]=ke[9]=ke[10]=ke[11]=ke[12]=ke[13]=ke[14]=ke[15]=0,this.blocks=ke):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}br.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===bP.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<gr[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<gr[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<gr[a++&3],i[a>>2]|=(128|t&63)<<gr[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<gr[a++&3],i[a>>2]|=(128|t>>6&63)<<gr[a++&3],i[a>>2]|=(128|t&63)<<gr[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<gr[a++&3],i[a>>2]|=(128|t>>12&63)<<gr[a++&3],i[a>>2]|=(128|t>>6&63)<<gr[a++&3],i[a>>2]|=(128|t&63)<<gr[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};br.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=yP[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};br.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};br.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return U[n>>28&15]+U[n>>24&15]+U[n>>20&15]+U[n>>16&15]+U[n>>12&15]+U[n>>8&15]+U[n>>4&15]+U[n&15]+U[e>>28&15]+U[e>>24&15]+U[e>>20&15]+U[e>>16&15]+U[e>>12&15]+U[e>>8&15]+U[e>>4&15]+U[e&15]+U[t>>28&15]+U[t>>24&15]+U[t>>20&15]+U[t>>16&15]+U[t>>12&15]+U[t>>8&15]+U[t>>4&15]+U[t&15]+U[r>>28&15]+U[r>>24&15]+U[r>>20&15]+U[r>>16&15]+U[r>>12&15]+U[r>>8&15]+U[r>>4&15]+U[r&15]+U[a>>28&15]+U[a>>24&15]+U[a>>20&15]+U[a>>16&15]+U[a>>12&15]+U[a>>8&15]+U[a>>4&15]+U[a&15]};br.prototype.toString=br.prototype.hex;br.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};br.prototype.array=br.prototype.digest;br.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var hg=n=>new br(!0).update(n).hex();var Vv=(...n)=>hg(n.join("_"));var pg=class{},_P=new Map,Rd=class n extends pg{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Vv(e,t))??null)}async update(e,t,r){this.cache.set(Vv(e,t),r)}static global(){return new n(_P)}};var Nd=class extends pr{},jd=class extends Nd{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Fr(this.value)]}},Md=class extends Nd{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return to(this.messages)}toChatMessages(){return this.messages}};var qv=q(Or(),1),$d=q(Ar(),1),wP=[400,401,402,403,404,405,406,407,409],vP=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;let e=n?.response?.status??n?.status;if(e&&wP.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){let t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}},_n=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??vP;let t="default"in $d.default?$d.default.default:$d.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,qv.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var Ld={},xP=new _n({});async function OP(n){return n in Ld||(Ld[n]=xP.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new In(e)).catch(e=>{throw delete Ld[n],e})),await Ld[n]}async function Kv(n){return OP(Aa(n))}Pr();var Ug=q(Or(),1);ce();var mg=class{getStore(){}run(e,t){return t()}},gg=class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new mg}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}},AP=new gg,Jv=()=>{let n=AP.getInstance().getStore();if(n===void 0)throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function."].join(`
`));return n},L5=Symbol.for("langsmith:traceable:root");function Dd(n){return typeof n=="function"&&"langsmith:traceable"in n}ce();ce();var bg=class{},Ms=class n extends bg{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,lg(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Z("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return pr.prototype.toJSON.call(this)}toJSONNotImplemented(){return pr.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:S()}),Object.assign(this,e)}}return new t}};var _g=q(Sl(),1);function yg(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function EP(n){return n.replace(/[-:.]/g,"")}function IP(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return EP(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}var Nt=class extends Ms{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){let t=IP(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await this.onRunCreate?.(r)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleChatModelStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f=o?{...s,metadata:o}:s,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:i||[]};return await this._startTrace(d),await this.onLLMStart?.(d),d}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}async handleChainStart(e,t,r,a,s,i,o,u){let l=this._getExecutionOrder(a),c=Date.now(),f={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(f),await this.onChainStart?.(f),f}async handleChainEnd(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=yg(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=yg(s.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),s?.inputs!==void 0&&(i.inputs=yg(s.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}async handleToolStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onToolStart?.(c),c}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}async handleRetrieverStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(c),await this.onRetrieverStart?.(c),c}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,s,i){let o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:i?.chunk}),o}};function ot(n,e){return`${n.open}${e}${n.close}`}function yr(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function da(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:yt}=_g.default,$u=class extends Nt{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?ot(_g.default.bold,o):o}).join(" > ");return ot(yt.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.green,"[chain/start]")} [${t}] Entering Chain run with input: ${yr(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.cyan,"[chain/end]")} [${t}] [${da(e)}] Exiting Chain run with output: ${yr(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.red,"[chain/error]")} [${t}] [${da(e)}] Chain run errored with error: ${yr(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${ot(yt.green,"[llm/start]")} [${t}] Entering LLM run with input: ${yr(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.cyan,"[llm/end]")} [${t}] [${da(e)}] Exiting LLM run with output: ${yr(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.red,"[llm/error]")} [${t}] [${da(e)}] LLM run errored with error: ${yr(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.cyan,"[tool/end]")} [${t}] [${da(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.red,"[tool/error]")} [${t}] [${da(e)}] Tool run errored with error: ${yr(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${yr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.cyan,"[retriever/end]")} [${t}] [${da(e)}] Exiting Retriever run with output: ${yr(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${ot(yt.red,"[retriever/error]")} [${t}] [${da(e)}] Retriever run errored with error: ${yr(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${ot(yt.blue,"[agent/action]")} [${r}] Agent selected action: ${yr(t.actions[t.actions.length-1],"[action]")}`)}};ce();var Wv=q(Or(),1),Ud=q(Ar(),1),TP=[400,401,403,404,405,406,407,408],PP=[409],Lu=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Ud.default?this.queue=new Ud.default.default({concurrency:this.maxConcurrency}):this.queue=new Ud.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,Wv.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;let s=a?.response,i=s?.status;if(i){if(TP.includes(+i))throw a;if(PP.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{e.signal?.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};function wg(n){return typeof n?._getType=="function"}function vg(n){let e={type:n._getType(),data:{content:n.content}};return n?.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var wn,SP=()=>typeof window<"u"&&typeof window.document<"u",kP=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",CP=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Zv=()=>typeof Deno<"u",RP=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Zv(),NP=()=>wn||(SP()?wn="browser":RP()?wn="node":kP()?wn="webworker":CP()?wn="jsdom":Zv()?wn="deno":wn="other",wn),xg;async function Ag(){if(xg===void 0){let n=NP(),e=MP();xg={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Fd,...e}}return xg}function Yv(){let n=jP()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[r,a]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function jP(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function zr(n){try{return typeof process<"u"?process.env?.[n]:void 0}catch{return}}var Og;function MP(){if(Og!==void 0)return Og;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=zr(t);r!==void 0&&(e[t]=r)}return Og=e,e}ce();function re(n){if(!Ot(n))throw new Error(`Invalid UUID: ${n}`)}async function Xv(n){let e=await Ag(),t=Yv();return n.map(r=>{let a=r.extra??{},s=a.metadata;return r.extra={...a,runtime:{...e,...a?.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...s}},r})}var $P=()=>{let n=zr("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},LP=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},fa=async(n,e)=>{let t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function DP(n){let e=[];for await(let t of n)e.push(t);return e}function Eg(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var UP=async n=>{if(n?.status===429){let e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1},Ig=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");let t=[];for(;t.length<e&&this.items.length;){let r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}},FP=20971520,ro=class n{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ig}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=n.getDefaultClientConfig();this.tracingSampleRate=$P(),this.apiUrl=Eg(e.apiUrl??t.apiUrl)??"",this.apiKey=Eg(e.apiKey??t.apiKey),this.webUrl=Eg(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Lu(e.callerOptions??{}),this.batchIngestCaller=new Lu({...e.callerOptions??{},onFailedResponseHook:UP}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){let e=zr("LANGCHAIN_API_KEY"),t=zr("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",r=zr("LANGCHAIN_HIDE_INPUTS")==="true",a=zr("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:LP(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${Fd}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){let r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0,a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));let s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);let o=await i.json();if(o.length===0||(yield o,o.length<a))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.sampledPostUuids.has(a.id)&&(r.push(a),this.sampledPostUuids.delete(a.id));return r}else{let r=[];for(let a of e)Math.random()<this.tracingSampleRate&&(r.push(a),this.sampledPostUuids.add(a.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){let[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){let r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;let a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){let e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch{return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=await Xv([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(s[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await fa(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=e?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[],a=t?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[];if(r.length>0&&a.length>0){let l=r.reduce((f,d)=>(d.id&&(f[d.id]=d),f),{}),c=[];for(let f of a)f.id!==void 0&&l[f.id]?l[f.id]={...l[f.id],...f}:c.push(f);r=Object.values(l),a=c}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;if(r=await Xv(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(let l of s.post)await this.createRun(l);for(let l of s.patch)l.id!==void 0&&await this.updateRun(l.id,l);return}let i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??FP,o={post:[],patch:[]},u=0;for(let l of["post","patch"]){let c=l,f=s[c].reverse(),d=f.pop();for(;d!==void 0;){let h=JSON.stringify(d);u>0&&u+h.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=h.length,o[c].push(d),d=f.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await fa(r,"batch create run")}async updateRun(e,t){re(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await fa(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){re(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r?.projectName?a=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?a=r?.projectId:a=(await this.readProject({projectName:zr("LANGCHAIN_PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await DP(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>(s?.dotted_order??"").localeCompare(i?.dotted_order??""));for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:l,runType:c,error:f,id:d,query:h,filter:p,traceFilter:m,treeFilter:g,limit:b,select:x}=e,_=[];if(t&&(_=Array.isArray(t)?t:[t]),r){let j=Array.isArray(r)?r:[r],J=await Promise.all(j.map(Xe=>this.readProject({projectName:Xe}).then(po=>po.id)));_.push(...J)}let k=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],O={session:_.length?_:null,run_type:c,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:g,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:f,id:d,limit:b,trace:s,select:x||k,is_root:l},B=0;for await(let j of this._getCursorPaginatedList("/runs/query",O))if(b){if(B>=b)break;if(j.length+B>b){yield*j.slice(0,b-B);break}B+=j.length,yield*j}else yield*j}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||S()};re(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){re(e);let t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await fa(t,"unshare run")}async readRunSharedLink(e){re(e);let r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return re(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),re(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};re(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){re(e);let t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await fa(t,"unshare dataset")}async readSharedDataset(e){return re(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=s||{};r&&(l.metadata=r);let c={name:e,extra:l,description:t};i!==null&&(c.reference_dataset_id=i);let f=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await f.json();if(!f.ok)throw new Error(`Failed to create session ${e}: ${f.status} ${f.statusText}`);return d}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let l={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},c=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),f=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return f}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)re(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)re(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){let o=new URLSearchParams;if(e!==void 0)for(let u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){let u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(let u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,re(r);let a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await fa(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(d=>{l.append("input_keys",d)}),a.forEach(d=>{l.append("output_keys",d)}),s&&l.append("description",s),i&&l.append("data_type",i),o&&l.append("name",o);let c=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!c.ok){let d=await c.json();throw d.detail&&d.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){let a={name:e,description:t};r&&(a.data_type=r);let s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok){let o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)re(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s}={}){let i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let u of r)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(let u of this._getPaginated(i,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)re(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to delete ${r}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);let f={dataset_id:l,inputs:e,outputs:t,created_at:(s||new Date)?.toISOString(),id:i,metadata:o,split:u},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createExamples(e){let{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e,l=o;if(l===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:u})).id);let c=t.map((h,p)=>({dataset_id:l,inputs:h,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),f=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!f.ok)throw new Error(`Failed to create examples: ${f.status} ${f.statusText}`);return await f.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>wg(i)?vg(i):i),s=wg(t)?vg(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){re(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o}={}){let u;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)u=e;else if(t!==void 0)u=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let l=new URLSearchParams({dataset:u}),c=a?typeof a=="string"?a:a?.toISOString():void 0;c&&l.append("as_of",c);let f=i??!0;if(l.append("inline_s3_urls",f.toString()),r!==void 0)for(let d of r)l.append("id",d);if(s!==void 0)for(let d of s)l.append("splits",d);if(o!==void 0){let d=JSON.stringify(o);l.append("metadata",d)}for await(let d of this._getPaginated("/examples",l))yield*d}async deleteExample(e){re(e);let t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){re(e);let r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),u=r??{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});let l=o.targetRunId??i.id;return await this.createFeedback(l,o.key,{score:o?.score,value:o?.value,comment:o?.comment,correction:o?.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o?.sourceRunId})}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,feedbackConfig:f,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");let p={type:u??"api",metadata:o??{}};l!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:l}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&re(p.metadata.__run.run_id);let m={id:c??S(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:f,session_id:d},g=`${this.apiUrl}/feedback`,b=await this.caller.call(fetch,g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await fa(b,"create feedback"),m}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),re(e);let o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await fa(o,"update feedback")}async readFeedback(e){re(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){re(e);let t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(a??new Date)?.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){re(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e);for(let s of a){let i=r||{};s.evaluatorInfo&&(i={...s.evaluatorInfo,...i});let o=null;s.targetRunId?o=s.targetRunId:t&&(o=t.id),await this.createFeedback(o,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:i,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"})}return a}};var Fd="0.1.30";var Du=class extends Nt{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=r??Z("LANGCHAIN_PROJECT")??Z("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new ro({});let s=this.getTraceableRunTree();if(s){let i=s,o=new Set;for(;i.parent_run&&!(o.has(i.id)||(o.add(i.id),!i.parent_run));)i=i.parent_run;o.clear();let u=[i];for(;u.length>0;){let l=u.shift();!l||o.has(l.id)||(o.add(l.id),this.runMap.set(l.id,l),l.child_runs&&u.push(...l.child_runs))}this.client=s.client??this.client,this.projectName=s.project_name??this.projectName,this.exampleId=s.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Gv()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return Jv()}catch{return}}};async function Qv(){return new Du}var Bd=q(Ar(),1),Tg;function BP(){let n="default"in Bd.default?Bd.default.default:Bd.default;return new n({autoStart:!0,concurrency:1})}async function Ce(n,e){e===!0?await n():(typeof Tg>"u"&&(Tg=BP()),Tg.add(n))}Z("LANGCHAIN_TRACING_V2")==="true"&&Z("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);function e0(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}var Pg=class{setHandler(e){return this.setHandlers([e])}},no=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Sg=class extends no{getChild(e){let t=new Re(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},zd=class extends no{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>Ce(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(u){if(console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},kg=class extends no{getChild(e){let t=new Re(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ce(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainError: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>Ce(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s)}catch(o){if(console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${o}`),i.raiseError)throw o}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Cg=class extends no{getChild(e){let t=new Re(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Ce(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Re=class n extends Pg{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:S();return await Promise.all(this.handlers.map(d=>Ce(async()=>{if(!d.ignoreLLM)try{await d.handleLLMStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u)}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new zd(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let f=c===0&&r?r:S();return await Promise.all(this.handlers.map(d=>Ce(async()=>{if(!d.ignoreLLM)try{if(d.handleChatModelStart)await d.handleChatModelStart?.(e,[l],f,this._parentRunId,s,this.tags,this.metadata,u);else if(d.handleLLMStart){let h=to(l);await d.handleLLMStart?.(e,[h],f,this._parentRunId,s,this.tags,this.metadata,u)}}catch(h){if(console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${h}`),d.raiseError)throw h}},d.awaitHandlers))),new zd(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>Ce(async()=>{if(!u.ignoreChain)try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new kg(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>Ce(async()=>{if(!u.ignoreAgent)try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Cg(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=S(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>Ce(async()=>{if(!u.ignoreRetriever)try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if(console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers))),new Sg(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends Ms{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:S()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers(e?.map(Uu)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(Uu):t?.handlers,!1));let l=Z("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=Z("LANGCHAIN_TRACING_V2")==="true"||Z("LANGSMITH_TRACING")==="true",f=c||(Z("LANGCHAIN_TRACING")??!1);if(l||f){if(u||(u=new n),l&&!u.handlers.some(d=>d.name===$u.prototype.name)){let d=new $u;u.addHandler(d,!0)}if(f&&!u.handlers.some(d=>d.name==="langchain_tracer")&&c){let d=await Qv();u.addHandler(d,!0),u._parentRunId=d.getTraceableRunTree()?.id??u._parentRunId}}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}};function Uu(n){return"name"in n?n:Ms.fromMethods(n)}var Rg={};ya(Rg,{JsonPatchError:()=>le,_areEquals:()=>Bu,applyOperation:()=>Ls,applyPatch:()=>ha,applyReducer:()=>VP,deepClone:()=>HP,getValueByPointer:()=>Kd,validate:()=>r0,validator:()=>Jd});var zP=Object.prototype.hasOwnProperty;function Gd(n,e){return zP.call(n,e)}function Vd(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Gd(n,t)&&e.push(t);return e}function We(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function qd(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Hr(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function Fu(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function Hd(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(Hd(n[t]))return!0}else if(typeof n=="object"){let t=Vd(n),r=t.length;for(var e=0;e<r;e++)if(Hd(n[t[e]]))return!0}}return!1}function t0(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var $s=class extends Error{constructor(e,t,r,a,s){super(t0(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=t0(e,{name:t,index:r,operation:a,tree:s})}};var le=$s,HP=We,ao={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Kd(t,this.path);r&&(r=We(r));let a=Ls(t,{op:"remove",path:this.from}).removed;return Ls(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=Kd(t,this.from);return Ls(t,{op:"add",path:this.path,value:We(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Bu(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},GP={add:function(n,e,t){return qd(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:ao.move,copy:ao.copy,test:ao.test,_get:ao._get};function Kd(n,e){if(e=="")return n;var t={op:"_get",path:e};return Ls(n,t),t.value}function Ls(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):Jd(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Kd(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=Bu(n,e.value),i.test===!1)throw new le("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new le("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=We(n));let o=(e.path||"").split("/"),u=n,l=1,c=o.length,f,d,h;for(typeof t=="function"?h=t:h=Jd;;){if(d=o[l],d&&d.indexOf("~")!=-1&&(d=Fu(d)),a&&(d=="__proto__"||d=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(u[d]===void 0?f=o.slice(0,l).join("/"):l==c-1&&(f=e.path),f!==void 0&&h(e,0,n,f)),l++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!qd(d))throw new le("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);qd(d)&&(d=~~d)}if(l>=c){if(t&&e.op==="add"&&d>u.length)throw new le("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let p=GP[e.op].call(e,u,d,n);if(p.test===!1)throw new le("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(l>=c){let p=ao[e.op].call(e,u,d,n);if(p.test===!1)throw new le("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[d],t&&l<c&&(!u||typeof u!="object"))throw new le("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function ha(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new le("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=We(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=Ls(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function VP(n,e,t){let r=Ls(n,e);if(r.test===!1)throw new le("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function Jd(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new le("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(ao[n.op]){if(typeof n.path!="string")throw new le("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new le('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new le("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new le("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&Hd(n.value))throw new le("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new le("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new le("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=r0([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new le("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new le("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function r0(n,e,t){try{if(!Array.isArray(n))throw new le("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)ha(We(e),We(n),t||!0);else{t=t||Jd;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof le)return a;throw a}}function Bu(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!Bu(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!Bu(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}function n0(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=Vd(e),i=Vd(n),o=!1,u=!1,l=i.length-1;l>=0;l--){var c=i[l],f=n[c];if(Gd(e,c)&&!(e[c]===void 0&&f!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof f=="object"&&f!=null&&typeof d=="object"&&d!=null&&Array.isArray(f)===Array.isArray(d)?n0(f,d,t,r+"/"+Hr(c),a):f!==d&&(o=!0,a&&t.push({op:"test",path:r+"/"+Hr(c),value:We(f)}),t.push({op:"replace",path:r+"/"+Hr(c),value:We(d)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+Hr(c),value:We(f)}),t.push({op:"remove",path:r+"/"+Hr(c)}),u=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&s.length==i.length))for(var l=0;l<s.length;l++){var c=s[l];!Gd(n,c)&&e[c]!==void 0&&t.push({op:"add",path:r+"/"+Hr(c),value:We(e[c])})}}}function Wd(n,e,t=!1){var r=[];return n0(n,e,r,"",t),r}var Z8={...Rg,JsonPatchError:$s,deepClone:We,escapePathComponent:Hr,unescapePathComponent:Fu};var Ng=class{getStore(){}run(e,t){return t()}},qP=new Ng,jg=class{getInstance(){return globalThis.__lc_tracing_async_local_storage??qP}initializeGlobalInstance(e){globalThis.__lc_tracing_async_local_storage===void 0&&(globalThis.__lc_tracing_async_local_storage=e)}},_r=new jg;var Ze=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function Mg(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function ut(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=ut(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var vn=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise((t,r)=>{_r.getInstance().run(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(s=>t(void 0),r)})})}async next(...e){return this.firstResultUsed?_r.getInstance().run(this.config,async()=>this.generator.next(...e)):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}};async function a0(n,e,t,...r){let a=new vn({generator:e,startSetup:t}),s=await a.setup;return{output:n(a,s,...r),setup:s}}var wr=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=ha({},t);return new zu({ops:t,state:r[r.length-1].newDocument})}},zu=class n extends wr{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=ha(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=ha({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},Gu=n=>n.name==="log_stream_tracer";async function s0(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function i0(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function KP(n){return n!==void 0&&n.message!==void 0}var Hu=class extends Nt{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ze.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new wr({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new wr({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await s0(e,this._schemaFormat)),await this.writer.write(new wr({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await s0(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await i0(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new wr({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new wr({ops:[{op:"replace",path:"/final_output",value:await i0(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?KP(r?.chunk)?i=r?.chunk:i=new mr(t):i=t;let o=new wr({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}};function Zd({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var Vu=n=>n.name==="event_stream_tracer",Yd=class extends Nt{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ze.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}let s=this.tappedPromises.get(e);if(s===void 0){let i;s=new Promise(o=>{i=o}),this.tappedPromises.set(e,s);try{let o={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...o,data:{chunk:r.value}},a),yield r.value;for await(let u of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...o,data:{chunk:u}},a),yield u}finally{i()}}else{yield r.value;for await(let i of t)yield i}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Zd(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(a.runType==="chat_model")i="on_chat_model_stream",r?.chunk===void 0?s=new mr({content:t}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",r?.chunk===void 0?s=new Br({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=e.outputs?.generations,s;if(t.runType==="chat_model"){for(let i of a??[]){if(s!==void 0)break;s=i[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a?.map(i=>i.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Zd(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Zd(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Zd(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};var Xd=25;async function vr(n){return Re.configure(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function Qd(...n){let e={};for(let t of n.filter(r=>!!r))for(let r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){let a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){let a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{let i=a.copy();for(let o of s)i.addHandler(Uu(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){let i=s.copy();for(let o of a)i.addHandler(Uu(o),!0);e.callbacks=i}else e.callbacks=new Re(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{let a=r;e[a]=t[a]??e[a]}return e}var JP=new Set(["string","number","boolean"]);function G(n){let e=n??_r.getInstance().getStore(),t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(e&&(t={...t,...e}),e?.configurable)for(let r of Object.keys(e.configurable))JP.has(typeof e.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=e.configurable[r]);return t}function Ne(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){let o=G(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}var qu=class extends Nt{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}};function tf(n){return n?n.lc_runnable:!1}var ef=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(s=>this.includeTags?.includes(s))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(s=>!this.excludeTags?.includes(s))),r}};Ft();ce();function WP(n){return tf(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...ie(n.data.schema),title:n.data.name}}}var Ku=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Ot(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...WP(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||S(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let a={source:e.id,target:t.id,data:r};return this.edges.push(a),a}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([t,r])=>{this.nodes[t]=r}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}};function o0(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return Ze.fromReadableStream(t)}function $g(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}var u0=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function rf(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Lg(n,e){let t=_r.getInstance();for(;;){let{value:r,done:a}=t.run(n,e.next.bind(e));if(a)break;yield r}}async function*Dg(n,e){let t=_r.getInstance(),r=e[Symbol.asyncIterator]();for(;;){let{value:a,done:s}=await t.run(n,r.next.bind(e));if(s)break;yield a}}function De(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var Q=class extends pr{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new pa({bound:this,kwargs:e,config:{}})}map(){return new nf({bound:this})}withRetry(e){return new af({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new pa({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new sf({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(G);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>G(s===0?e:r))}return Array.from({length:t},()=>G(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=a[0]?.maxConcurrency??r?.maxConcurrency,i=new _n({maxConcurrency:s,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>i.call(async()=>{try{return await this.invoke(u,a[l])}catch(c){if(r?.returnExceptions)return c;throw c}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=G(t),a=new vn({generator:this._streamIterator(e,r),config:r});return await a.setup,Ze.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=G(e):t=G({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){let a=G(r),i=await(await vr(a))?.handleChainStart(this.toJSON(),De(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let o;try{o=await e.call(this,t,a,i)}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(De(o,"output")),o}async _batchWithConfig(e,t,r,a){let s=this._getOptionsList(r??{},t.length),i=await Promise.all(s.map(vr)),o=await Promise.all(i.map(async(l,c)=>{let f=await l?.handleChainStart(this.toJSON(),De(t[c],"input"),s[c].runId,s[c].runType,void 0,void 0,s[c].runName??this.getName());return delete s[c].runId,f})),u;try{u=await e.call(this,t,s,o,a)}catch(l){throw await Promise.all(o.map(c=>c?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd(De(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=G(r),l=await vr(u);async function*c(){for await(let d of e){if(s)if(a===void 0)a=d;else try{a=ut(a,d)}catch{a=void 0,s=!1}yield d}}let f;try{let d=await a0(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),u);delete u.runId,f=d.setup;let h=f?.handlers.find(Vu),p=d.output;h!==void 0&&f!==void 0&&(p=h.tapOutputIterable(f.runId,p));let m=f?.handlers.find(Gu);m!==void 0&&f!==void 0&&(p=m.tapOutputIterable(f.runId,p));for await(let g of p)if(yield g,o)if(i===void 0)i=g;else try{i=ut(i,g)}catch{i=void 0,o=!1}}catch(d){throw await f?.handleChainError(d,void 0,void 0,void 0,{inputs:De(a,"input")}),d}await f?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:De(a,"input")})}getGraph(e){let t=new Ku,r=t.addNode({name:`${this.getName()}Input`,schema:ye.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:ye.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new so({first:this,last:xn(e)})}pick(e){return this.pipe(new of(e))}assign(e){return this.pipe(new io(new ma({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=ut(r,a);yield*this._streamIterator(r,G(t))}async*streamLog(e,t,r){let a=new Hu({...r,autoClose:!1,_schemaFormat:"original"}),s=G(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.inheritableHandlers.push(t),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let l of u){let c=new wr({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(c)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?o0(a):Ze.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){let a=new Yd({...r,autoClose:!1}),s=G(t),i=s.runId??S();s.runId=i;let o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{let h=o.copy();h.inheritableHandlers.push(a),s.callbacks=h}let u=this;async function l(){try{let h=await u.stream(e,s),p=a.tapOutputIterable(i,h);for await(let m of p);}finally{await a.finish()}}let c=l(),f=!1,d;try{for await(let h of a){if(!f){h.data.input=e,f=!0,d=h.run_id,yield h;continue}h.run_id===d&&h.event.endsWith("_end")&&h.data?.input&&delete h.data.input,yield h}}finally{await c}}async*_streamEventsV1(e,t,r){let a,s=!1,i=G(t),o=i.tags??[],u=i.metadata??{},l=i.runName??this.getName(),c=new Hu({...r,autoClose:!1,_schemaFormat:"streaming_events"}),f=new ef({...r}),d=this._streamLog(e,c,i);for await(let p of d){if(a?a=a.concat(p):a=zu.fromRunLogPatch(p),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let x={...a.state},_={run_id:x.id,event:`on_${x.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};f.includeEvent(_,x.type)&&(yield _)}let m=p.ops.filter(x=>x.path.startsWith("/logs/")).map(x=>x.path.split("/")[2]),g=[...new Set(m)];for(let x of g){let _,k={},O=a.state.logs[x];if(O.end_time===void 0?O.streamed_output.length>0?_="stream":_="start":_="end",_==="start")O.inputs!==void 0&&(k.input=O.inputs);else if(_==="end")O.inputs!==void 0&&(k.input=O.inputs),k.output=O.final_output;else if(_==="stream"){let B=O.streamed_output.length;if(B!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${B} instead. Encountered in: "${O.name}"`);k={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${_}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:k}}let{state:b}=a;if(b.streamed_output.length>0){let x=b.streamed_output.length;if(x!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${x} instead. Encountered in: "${b.name}"`);let _={chunk:b.streamed_output[0]};b.streamed_output=[];let k={event:`on_${b.type}_stream`,run_id:b.id,tags:o,metadata:u,name:l,data:_};f.includeEvent(k,b.type)&&(yield k)}}let h=a?.state;if(h!==void 0){let p={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:o,metadata:u,data:{output:h.final_output}};f.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return tf(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new pa({bound:this,config:{},configFactories:[a=>({callbacks:[new qu({config:a,onStart:e,onEnd:t,onError:r})]})]})}},pa=class n extends Q{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=Qd(this.config,...e);return Qd(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(G(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(G(s),this.kwargs))):await this._mergeConfig(G(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(G(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(G(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(G(t),this.kwargs))}streamEvents(e,t,r){let a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(G(t),a.kwargs),version:t.version},r)};return Ze.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&Q.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new qu({config:a,onStart:e,onEnd:t,onError:r})]})]})}},nf=class n extends Q{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,Ne(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},af=class extends pa{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return Ne(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return(0,Ug.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){let s={};try{await(0,Ug.default)(async i=>{let o=e.map((d,h)=>h).filter(d=>s[d.toString()]===void 0||s[d.toString()]instanceof Error),u=o.map(d=>e[d]),l=o.map(d=>this._patchConfigForRetry(i,t?.[d],r?.[d])),c=await super.batch(u,l,{...a,returnExceptions:!0}),f;for(let d=0;d<c.length;d+=1){let h=c[d],p=o[d];h instanceof Error&&f===void 0&&(f=h,f.input=u[d]),s[p.toString()]=h}if(f)throw f;return c},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(a?.returnExceptions!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},so=class n extends Q{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=G(t),s=await(await vr(r))?.handleChainStart(this.toJSON(),De(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i=e,o;try{let u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1)i=await u[l].invoke(i,Ne(r,{callbacks:s?.getChild(`seq:step:${l+1}`)}));o=await this.last.invoke(i,Ne(r,{callbacks:s?.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(De(o,"output")),o}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(vr)),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),De(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((c,f)=>{let d=c?.getChild(`seq:step:${u+1}`);return Ne(a[f],{callbacks:d})}),r)}catch(u){throw await Promise.all(i.map(l=>l?.handleChainError(u))),u}return await Promise.all(i.map(u=>u?.handleChainEnd(De(o,"output")))),o}async*_streamIterator(e,t){let r=await vr(t),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),De(e,"input"),a,void 0,void 0,void 0,s?.runName),o=[this.first,...this.middle,this.last],u=!0,l;async function*c(){yield e}try{let f=o[0].transform(c(),Ne(s,{callbacks:i?.getChild("seq:step:1")}));for(let d=1;d<o.length;d+=1)f=await o[d].transform(f,Ne(s,{callbacks:i?.getChild(`seq:step:${d+1}`)}));for await(let d of f)if(yield d,u)if(l===void 0)l=d;else try{l=ut(l,d)}catch{l=void 0,u=!1}}catch(f){throw await i?.handleChainError(f),f}await i?.handleChainEnd(De(l,"output"))}getGraph(e){let t=new Ku,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:xn(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Q.isRunnable(e)}static from([e,...t],r){return new n({first:xn(e),middle:t.slice(0,-1).map(xn),last:xn(t[t.length-1]),name:r})}},ma=class n extends Q{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=xn(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=G(t),s=await(await vr(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,Ne(r,{callbacks:s?.getChild(`map:key:${o}`)}))}))}catch(o){throw await s?.handleChainError(o),o}return await s?.handleChainEnd(i),i}async*_transform(e,t,r){let a={...this.steps},s=Mg(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],l)=>{let c=u.transform(s[l],Ne(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,c.next().then(f=>({key:o,gen:c,result:f}))]}));for(;i.size;){let{key:o,result:u,gen:l}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,l.next().then(c=>({key:o,gen:l,result:c}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=G(t),s=new vn({generator:this.transform(r(),a),config:a});return await s.setup,Ze.fromAsyncGenerator(s)}},Fg=class n extends Q{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Dd(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await vr(r);return await this.func(Ne(r,{callbacks:a}),e)}async*_streamIterator(e,t){let r=await this.invoke(e,t);if(rf(r)){for await(let a of r)yield a;return}if(u0(r)){for(;;){let a=r.next();if(a.done)break;yield a.value}return}yield r}static from(e){return new n({func:e})}};function ZP(n){if(Dd(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Ju=class n extends Q{static lc_name(){return"RunnableLambda"}constructor(e){if(Dd(e.func))return Fg.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),ZP(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{let i=Ne(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??Xd)-1});_r.getInstance().run(i,async()=>{try{let o=await this.func(e,{...i,config:i});if(o&&Q.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...i,recursionLimit:(i.recursionLimit??Xd)-1})}else if(rf(o)){let u;for await(let l of Dg(i,o))if(u===void 0)u=l;else try{u=ut(u,l)}catch{u=l}o=u}else if($g(o)){let u;for(let l of Lg(i,o))if(u===void 0)u=l;else try{u=ut(u,l)}catch{u=l}o=u}a(o)}catch(o){s(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(let i of e)if(a===void 0)a=i;else try{a=ut(a,i)}catch{a=i}let s=await new Promise((i,o)=>{_r.getInstance().run(r,async()=>{try{let u=await this.func(a,{...r,config:r});i(u)}catch(u){o(u)}})});if(s&&Q.isRunnable(s)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let i=await s.stream(a,Ne(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??Xd)-1}));for await(let o of i)yield o}else if(rf(s))for await(let i of Dg(r,s))yield i;else if($g(s))for(let i of Lg(r,s))yield i;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=G(t),s=new vn({generator:this.transform(r(),a),config:a});return await s.setup,Ze.fromAsyncGenerator(s)}};var sf=class extends Q{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=await Re.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:a,...s}=t??{},i=await r?.handleChainStart(this.toJSON(),De(e,"input"),a,void 0,void 0,void 0,s?.runName),o;for(let u of this.runnables())try{let l=await u.invoke(e,Ne(s,{callbacks:i?.getChild()}));return await i?.handleChainEnd(De(l,"output")),l}catch(l){o===void 0&&(o=l)}throw o===void 0?new Error("No error stored at end of fallback."):(await i?.handleChainError(o),o)}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>Re.configure(u?.callbacks,void 0,u?.tags,void 0,u?.metadata))),i=await Promise.all(s.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),De(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c})),o;for(let u of this.runnables())try{let l=await u.batch(e,i.map((c,f)=>Ne(a[f],{callbacks:c?.getChild()})),r);return await Promise.all(i.map((c,f)=>c?.handleChainEnd(De(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(i.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function xn(n){if(typeof n=="function")return new Ju({func:n});if(Q.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=xn(r);return new ma({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var io=class extends Q{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof ma&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=Mg(e),o=this.mapper.transform(i,Ne(r,{callbacks:t?.getChild()})),u=o.next();for await(let l of s){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let c=Object.fromEntries(Object.entries(l).filter(([f])=>!a.includes(f)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(let l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=G(t),s=new vn({generator:this.transform(r(),a),config:a});return await s.setup,Ze.fromAsyncGenerator(s)}},of=class extends Q{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=G(t),s=new vn({generator:this.transform(r(),a),config:a});return await s.setup,Ze.fromAsyncGenerator(s)}};var YP=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;var XP=()=>!1,Wu=class extends Q{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??XP(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},Zu=class extends Wu{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=Rd.global():this.cache=void 0,this.caller=new _n(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Kv("modelName"in this?YP(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new jd(e):Array.isArray(e)?new Md(e.map(js)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};var uf=class n extends Zu{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r?.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let a=n._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptions(t),o={...s.metadata,...this.getLsParams(i)},u=await Re.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await u?.handleChatModelStart(this.toJSON(),[a],s.runId,void 0,l,void 0,void 0,s.runName),f;try{for await(let d of this._streamResponseChunks(a,i,c?.[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,f?f=f.concat(d):f=d}catch(d){throw await Promise.all((c??[]).map(h=>h?.handleLLMError(d))),d}await Promise.all((c??[]).map(d=>d?.handleLLMEnd({generations:[[f]]})))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,r){let a=e.map(h=>h.map(js)),s={...r.metadata,...this.getLsParams(t)},i=await Re.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this?.invocationParams(t),batch_size:1},u=await i?.handleChatModelStart(this.toJSON(),a,r.runId,void 0,o,void 0,void 0,r.runName),l=[],c=[];if(!!u?.[0].handlers.find(h=>Vu(h)||Gu(h))&&a.length===1&&this._streamResponseChunks!==n.prototype._streamResponseChunks)try{let h=await this._streamResponseChunks(a[0],t,u?.[0]),p;for await(let m of h)p===void 0?p=m:p=ut(p,m);if(p===void 0)throw new Error("Received empty response from chat model call.");l.push([p]),await u?.[0].handleLLMEnd({generations:l,llmOutput:{}})}catch(h){throw await u?.[0].handleLLMError(h),h}else{let h=await Promise.allSettled(a.map((p,m)=>this._generate(p,{...t,promptIndex:m},u?.[m])));await Promise.all(h.map(async(p,m)=>{if(p.status==="fulfilled"){let g=p.value;for(let b of g.generations)b.message.response_metadata={...b.generationInfo,...b.message.response_metadata};return g.generations.length===1&&(g.generations[0].message.response_metadata={...g.llmOutput,...g.generations[0].message.response_metadata}),l[m]=g.generations,c[m]=g.llmOutput,u?.[m]?.handleLLMEnd({generations:[g.generations],llmOutput:g.llmOutput})}else return await u?.[m]?.handleLLMError(p.reason),Promise.reject(p.reason)}))}let d={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(d,Cd,{value:u?{runIds:u?.map(h=>h.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(g=>g.map(js)),o={...s.metadata,...this.getLsParams(a)},u=await Re.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1,cached:!0},c=await u?.handleChatModelStart(this.toJSON(),i,s.runId,void 0,l,void 0,void 0,s.runName),f=[],h=(await Promise.allSettled(i.map(async(g,b)=>{let x=n._convertInputToPromptValue(g).toString(),_=await t.lookup(x,r);return _==null&&f.push(b),_}))).map((g,b)=>({result:g,runManager:c?.[b]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),p=[];await Promise.all(h.map(async({result:g,runManager:b},x)=>{if(g.status==="fulfilled"){let _=g.value;return p[x]=_,_.length&&await b?.handleLLMNewToken(_[0].text),b?.handleLLMEnd({generations:[_]})}else return await b?.handleLLMError(g.reason),Promise.reject(g.reason)}));let m={generations:p,missingPromptIndices:f};return Object.defineProperty(m,Cd,{value:c?{runIds:c?.map(g=>g.runId)}:void 0,configurable:!0}),m}async generate(e,t,r){let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(h=>h.map(js)),[i,o]=this._separateRunnableConfigFromCallOptions(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:f}=await this._generateCached({messages:s,cache:u,llmStringKey:l,parsedOptions:o,handledOptions:i}),d={};if(f.length>0){let h=await this._generateUncached(f.map(p=>s[p]),o,i);await Promise.all(h.generations.map(async(p,m)=>{let g=f[m];c[g]=p;let b=n._convertInputToPromptValue(s[g]).toString();return u.update(b,l,p)})),d=h.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(js)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new Fr(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}};Ft();function l0(n){return{name:n.name,description:n.description,parameters:ie(n.schema)}}function lf(n){return QP(n)?{type:"function",function:l0(n)}:n}function QP(n){return n!==void 0&&Array.isArray(n.lc_namespace)}var Ds=class extends Q{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=G(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){let r=G(t),a,s=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=ut(a,i)}catch{a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new io(new ma({steps:e}))}};var oo=class extends Q{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a?.callbacks),e,{...t,runType:"parser"})}},uo=class extends oo{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},ga=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}};function Yu(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!Yu(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let i of r)if(!Yu(n[i],e[i]))return!1;return!0}return n===e}var VV=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var tS=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,rS=[0,31,28,31,30,31,30,31,31,30,31,30,31],nS=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,aS=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,sS=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,iS=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,oS=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,uS=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,lS=/^(?:\/(?:[^~/]|~0|~1)*)*$/,cS=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,dS=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,fS=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,hS=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,pS=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,mS=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,gS=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},bS=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,yS=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,_S=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function _t(n){return n.test.bind(n)}var wS={date:c0,time:d0.bind(void 0,!1),"date-time":AS,duration:_S,uri:TS,"uri-reference":_t(sS),"uri-template":_t(iS),url:_t(oS),email:gS,hostname:_t(aS),ipv4:_t(bS),ipv6:_t(yS),regex:SS,uuid:_t(uS),"json-pointer":_t(lS),"json-pointer-uri-fragment":_t(cS),"relative-json-pointer":_t(dS)},vS={...wS,date:_t(fS),time:_t(hS),"date-time":_t(pS),"uri-reference":_t(mS)};function xS(n){return n%4===0&&(n%100!==0||n%400===0)}function c0(n){let e=n.match(tS);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&xS(t)?29:rS[r])}function d0(n,e){let t=e.match(nS);if(!t)return!1;let r=+t[1],a=+t[2],s=+t[3],i=!!t[5];return(r<=23&&a<=59&&s<=59||r==23&&a==59&&s==60)&&(!n||i)}var OS=/t|\s/i;function AS(n){let e=n.split(OS);return e.length==2&&c0(e[0])&&d0(!0,e[1])}var ES=/\/|:/,IS=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function TS(n){return ES.test(n)&&IS.test(n)}var PS=/[^\\]\\Z/;function SS(n){if(PS.test(n))return!1;try{return new RegExp(n),!0}catch{return!1}}var lo=class extends uo{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},Xu=class extends lo{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(Fv(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new ca({message:a,text:a.content})}else if(Zi(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new ca({message:zv(a),text:a.content})}else s=new Br({text:a});r===void 0?r=s:r=r.concat(s);let i=await this.parsePartialResult([r]);i!=null&&!Yu(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}};Pr();Ft();var cf=class extends uo{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=ye.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,ye.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(ie(this.schema))}
\`\`\`
`}async parse(e){try{let r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new ga(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};var df=class extends Xu{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Wd(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return ug(e[0].text)}async parse(e){return ug(e,JSON.parse)}getFormatInstructions(){return""}};function zg(n,e){if(n.function===void 0)return;let t;if(e?.partial)try{t=Wi(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(a){throw new ga([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join(`
`))}let r={name:n.function.name,args:t};return e?.returnId&&(r.id=n.id),r}function f0(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function h0(n,e){return{name:n.function?.name,args:n.function?.arguments,id:n.id,error:e}}var Bg=class extends oo{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){let t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);let r=JSON.parse(JSON.stringify(t)),a=[];for(let s of r){let i=zg(s,{partial:!0});if(i!==void 0){let o={type:i.name,args:i.args,id:i.id};Object.defineProperty(o,"name",{get(){return this.type}}),Object.defineProperty(o,"arguments",{get(){return this.args}}),a.push(o)}}return a}},Qu=class extends oo{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new Bg(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new ga(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let r=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName),a=r;return this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))}};Ft();function ba(n){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i}=n;if((r||i)&&a&&e)return`${a}/${e}`;if(r||i){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}Ft();function co(n){let e;return n.constructor.name===jv.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===Mv.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}function CS(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function p0(n){let e=["namespace functions {",""];for(let t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(m0(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function m0(n,e){let t=[];for(let[r,a]of Object.entries(n.properties??{}))a.description&&e<2&&t.push(`// ${a.description}`),n.required?.includes(r)?t.push(`${r}: ${ff(a,e)},`):t.push(`${r}?: ${ff(a,e)},`);return t.map(r=>" ".repeat(e)+r).join(`
`)}function ff(n,e){if(CS(n))return n.anyOf.map(t=>ff(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",m0(n,e+2),"}"].join(`
`);case"array":return n.items?`${ff(n.items,e)}[]`:"any[]";default:return""}}function RS(n){return n.role!=="system"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function y0(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Ns.isInstance(n))throw new Error("Invalid generic chat message");return RS(n)}default:throw new Error(`Unknown message type: ${e}`)}}function NS(n){let e=n.tool_calls;switch(n.role){case"assistant":{let t=[],r=[];for(let a of e??[])try{t.push(zg(a,{returnId:!0}))}catch(s){r.push(h0(a,s.message))}return new yn({content:n.content||"",tool_calls:t,invalid_tool_calls:r,additional_kwargs:{function_call:n.function_call,tool_calls:e}})}default:return new Ns(n.content||"",n.role??"unknown")}}function jS(n,e){let t=n.role??e,r=n.content??"",a;if(n.function_call?a={function_call:n.function_call}:n.tool_calls?a={tool_calls:n.tool_calls}:a={},t==="user")return new Qi({content:r});if(t==="assistant"){let s=[];if(Array.isArray(n.tool_calls))for(let i of n.tool_calls)s.push({name:i.function?.name,args:i.function?.arguments,id:i.id,index:i.index});return new mr({content:r,tool_call_chunks:s,additional_kwargs:a})}else return t==="system"?new eo({content:r}):t==="function"?new Xi({content:r,additional_kwargs:a,name:n.name}):t==="tool"?new Mu({content:r,additional_kwargs:a,tool_call_id:n.tool_call_id}):new Yi({content:r,role:t})}function g0(n){return n.map(e=>{let t={role:y0(e),content:e.content};return e.name!=null&&(t.name=e.name),e.additional_kwargs.function_call!=null&&(t.function_call=e.additional_kwargs.function_call),dg(e)&&e.tool_calls?.length?t.tool_calls=e.tool_calls.map(f0):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}var fo=class extends uf{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??Z("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??Z("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??Z("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??Z("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??Z("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??Z("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??Z("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??""}this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){return this.bind({tools:e.map(lf),...t})}invocationParams(e){function t(a){return a!==void 0&&a.every(s=>Array.isArray(s.lc_namespace))}return{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:t(e?.tools)?e?.tools.map(lf):e?.tools,tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...e?.stream_options!==void 0?{stream_options:e.stream_options}:{},...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){let a=g0(e),s={...this.invocationParams(t),messages:a,stream:!0},i,o=await this.completionWithRetry(s,t),u;for await(let l of o){let c=l?.choices[0];if(l.usage&&(u=l.usage),!c)continue;let{delta:f}=c;if(!f)continue;let d=jS(f,i);i=f.role??i;let h={prompt:t.promptIndex??0,completion:c.index??0};if(typeof d.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let p={...h};c.finish_reason!==void 0&&(p.finish_reason=c.finish_reason),this.logprobs&&(p.logprobs=c.logprobs);let m=new ca({message:d,text:d.content,generationInfo:p});yield m,r?.handleLLMNewToken(m.text??"",h,void 0,void 0,void 0,{chunk:m})}if(u&&(yield new ca({message:new mr({content:"",usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens}}),text:""})),t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let a={},s=this.invocationParams(t),i=g0(e);if(s.stream){let o=this._streamResponseChunks(e,t,r),u={};for await(let p of o){p.message.response_metadata={...p.generationInfo,...p.message.response_metadata};let m=p.generationInfo?.completion??0;u[m]===void 0?u[m]=p:u[m]=u[m].concat(p)}let l=Object.entries(u).sort(([p],[m])=>parseInt(p,10)-parseInt(m,10)).map(([p,m])=>m),{functions:c,function_call:f}=this.invocationParams(t),d=await this.getEstimatedTokenCountFromPrompt(e,c,f),h=await this.getNumTokensFromGenerations(l);return a.promptTokens=d,a.completionTokens=h,a.totalTokens=d+h,{generations:l,llmOutput:{estimatedTokenUsage:a}}}else{let o=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,...t?.options}),{completion_tokens:u,prompt_tokens:l,total_tokens:c}=o?.usage??{};u&&(a.completionTokens=(a.completionTokens??0)+u),l&&(a.promptTokens=(a.promptTokens??0)+l),c&&(a.totalTokens=(a.totalTokens??0)+c);let f=[];for(let d of o?.choices??[]){let p={text:d.message?.content??"",message:NS(d.message??{role:"assistant"})};p.generationInfo={...d.finish_reason?{finish_reason:d.finish_reason}:{},...d.logprobs?{logprobs:d.logprobs}:{}},dg(p.message)&&(p.message.usage_metadata={input_tokens:a.promptTokens??0,output_tokens:a.completionTokens??0,total_tokens:a.totalTokens??0}),f.push(p)}return{generations:f,llmOutput:{tokenUsage:a}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){let s=p0(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),r==="none"?a+=1:typeof r=="object"&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>r.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)))).reduce((r,a)=>r+a,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;this.model==="gpt-3.5-turbo-0301"?(r=4,a=-1):(r=3,a=1);let s=await Promise.all(e.map(async i=>{let o=await this.getNumTokens(i.content),u=await this.getNumTokens(y0(i)),l=i.name!==void 0?a+await this.getNumTokens(i.name):0,c=o+r+u+l,f=i;if(f._getType()==="function"&&(c-=2),f.additional_kwargs?.function_call&&(c+=3),f?.additional_kwargs.function_call?.name&&(c+=await this.getNumTokens(f.additional_kwargs.function_call?.name)),f.additional_kwargs.function_call?.arguments)try{c+=await this.getNumTokens(JSON.stringify(JSON.parse(f.additional_kwargs.function_call?.arguments)))}catch(d){console.error("Error parsing function arguments",d,JSON.stringify(f.additional_kwargs.function_call)),c+=await this.getNumTokens(f.additional_kwargs.function_call?.arguments)}return t+=c,c}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(a){throw co(a)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},a=ba(r),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new X(s)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,a,s,i;MS(e)?(r=e.schema,a=e.name,s=e.method,i=e.includeRaw):(r=e,a=t?.name,s=t?.method,i=t?.includeRaw);let o,u;if(s==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),b0(r)?u=cf.fromZodSchema(r):u=new df;else{let d=a??"extract";if(b0(r)){let h=ie(r);o=this.bind({tools:[{type:"function",function:{name:d,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:d}}}),u=new Qu({returnSingle:!0,keyName:d,zodSchema:r})}else{let h;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(h=r,d=r.name):(d=r.title??d,h={name:d,description:r.description??"",parameters:r}),o=this.bind({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:d}}}),u=new Qu({returnSingle:!0,keyName:d})}}if(!i)return o.pipe(u);let l=Ds.assign({parsed:(d,h)=>u.invoke(d.raw,h)}),c=Ds.assign({parsed:()=>null}),f=l.withFallbacks({fallbacks:[c]});return so.from([{raw:o},f])}};function b0(n){return typeof n?.parse=="function"}function MS(n){return n!==void 0&&typeof n.schema=="object"}Pr();var Hg=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}},Gg=class extends Wu{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1})}async invoke(e,t){return this.call(e,G(t))}async call(e,t,r){let a;try{a=await this.schema.parseAsync(e)}catch{throw new Hg("Received tool input did not match expected schema",JSON.stringify(e))}let s=e0(t),o=await(await Re.configure(s.callbacks,this.callbacks,s.tags||r,this.tags,s.metadata,this.metadata,{verbose:this.verbose}))?.handleToolStart(this.toJSON(),typeof a=="string"?a:JSON.stringify(a),s.runId,void 0,void 0,void 0,s.runName);delete s.runId;let u;try{u=await this._call(a,o,s)}catch(l){throw await o?.handleToolError(l),l}return await o?.handleToolEnd(u),u}},hf=class extends Gg{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:ye.object({input:ye.string().optional()}).transform(t=>t.input)})}call(e,t){return super.call(typeof e=="string"||!e?{input:e}:e,t)}};var Vg=class extends hf{static lc_name(){return"DallEAPIWrapper"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.apiKey??e?.openAIApiKey??Z("OPENAI_API_KEY"),r=e?.organization??Z("OPENAI_ORGANIZATION"),a={apiKey:t,organization:r,dangerouslyAllowBrowser:!0};this.client=new X(a),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.responseFormat=e?.responseFormat??this.responseFormat,this.user=e?.user}async _call(e){let t=await this.client.images.generate({model:this.model,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user}),r="";return this.responseFormat==="url"?[r]=t.data.map(a=>a.url).filter(a=>a!=="undefined"):[r]=t.data.map(a=>a.b64_json).filter(a=>a!=="undefined"),r}};Object.defineProperty(Vg,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var rb=q(O0());ce();var pf=class{constructor(e){this.secret=e}_encode(e){return new TextEncoder().encode(e)}_decode(e){return new TextDecoder().decode(e)}async _importKey(e){let t=await crypto.subtle.importKey("raw",this._encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:this._encode("salt"),iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async _encrypt(e){let t=await this._importKey(this.secret),r=crypto.getRandomValues(new Uint8Array(12)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},t,this._encode(e));return{iv:r,encrypted:a}}async _decrypt(e,t){let r=await this._importKey(this.secret),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},r,e);return this._decode(a)}async saveAPIKey(e,t){let{iv:r,encrypted:a}=await this._encrypt(t),s={iv:Array.from(r),encrypted:Array.from(new Uint8Array(a))};localStorage.setItem(e,JSON.stringify(s))}async getAPIKey(e){let t=localStorage.getItem(e);if(!t)return null;let{iv:r,encrypted:a}=JSON.parse(t);return await this._decrypt(new Uint8Array(a),new Uint8Array(r))}deleteAPIKey(e){localStorage.removeItem(e)}apiKeyExists(e){return localStorage.getItem(e)!==null}};var Ye=["OpenAI","Google","Deepseek","Ollama","Groq"],A0='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14L21 3m0 0l-6.5 18a.55.55 0 0 1-1 0L10 14l-7-3.5a.55.55 0 0 1 0-1L21 3"/></svg>',E0='<svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" height="1.5em" width="1.5em"><path fill="currentColor" d="M15 37.95q-1.25 0-2.125-.875T12 34.95v-28q0-1.25.875-2.125T15 3.95h22q1.25 0 2.125.875T40 6.95v28q0 1.25-.875 2.125T37 37.95Zm0-3h22v-28H15v28Zm-6 9q-1.25 0-2.125-.875T6 40.95V12.3q0-.65.425-1.075Q6.85 10.8 7.5 10.8q.65 0 1.075.425Q9 11.65 9 12.3v28.65h22.2q.65 0 1.075.425.425.425.425 1.075 0 .65-.425 1.075-.425.425-1.075.425Zm6-37v28-28Z"/></svg>';var Ue=typeof globalThis<"u"&&globalThis||typeof self<"u"&&self||typeof global<"u"&&global||{},lt={searchParams:"URLSearchParams"in Ue,iterable:"Symbol"in Ue&&"iterator"in Symbol,blob:"FileReader"in Ue&&"Blob"in Ue&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in Ue,arrayBuffer:"ArrayBuffer"in Ue};function BS(n){return n&&DataView.prototype.isPrototypeOf(n)}lt.arrayBuffer&&(I0=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],P0=ArrayBuffer.isView||function(n){return n&&I0.indexOf(Object.prototype.toString.call(n))>-1});var I0,P0;function ho(n){if(typeof n!="string"&&(n=String(n)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(n)||n==="")throw new TypeError('Invalid character in header field name: "'+n+'"');return n.toLowerCase()}function Kg(n){return typeof n!="string"&&(n=String(n)),n}function Jg(n){var e={next:function(){var t=n.shift();return{done:t===void 0,value:t}}};return lt.iterable&&(e[Symbol.iterator]=function(){return e}),e}function ge(n){this.map={},n instanceof ge?n.forEach(function(e,t){this.append(t,e)},this):Array.isArray(n)?n.forEach(function(e){if(e.length!=2)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):n&&Object.getOwnPropertyNames(n).forEach(function(e){this.append(e,n[e])},this)}ge.prototype.append=function(n,e){n=ho(n),e=Kg(e);var t=this.map[n];this.map[n]=t?t+", "+e:e};ge.prototype.delete=function(n){delete this.map[ho(n)]};ge.prototype.get=function(n){return n=ho(n),this.has(n)?this.map[n]:null};ge.prototype.has=function(n){return this.map.hasOwnProperty(ho(n))};ge.prototype.set=function(n,e){this.map[ho(n)]=Kg(e)};ge.prototype.forEach=function(n,e){for(var t in this.map)this.map.hasOwnProperty(t)&&n.call(e,this.map[t],t,this)};ge.prototype.keys=function(){var n=[];return this.forEach(function(e,t){n.push(t)}),Jg(n)};ge.prototype.values=function(){var n=[];return this.forEach(function(e){n.push(e)}),Jg(n)};ge.prototype.entries=function(){var n=[];return this.forEach(function(e,t){n.push([t,e])}),Jg(n)};lt.iterable&&(ge.prototype[Symbol.iterator]=ge.prototype.entries);function qg(n){if(!n._noBody){if(n.bodyUsed)return Promise.reject(new TypeError("Already read"));n.bodyUsed=!0}}function S0(n){return new Promise(function(e,t){n.onload=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function zS(n){var e=new FileReader,t=S0(e);return e.readAsArrayBuffer(n),t}function HS(n){var e=new FileReader,t=S0(e),r=/charset=([A-Za-z0-9_-]+)/.exec(n.type),a=r?r[1]:"utf-8";return e.readAsText(n,a),t}function GS(n){for(var e=new Uint8Array(n),t=new Array(e.length),r=0;r<e.length;r++)t[r]=String.fromCharCode(e[r]);return t.join("")}function T0(n){if(n.slice)return n.slice(0);var e=new Uint8Array(n.byteLength);return e.set(new Uint8Array(n)),e.buffer}function k0(){return this.bodyUsed=!1,this._initBody=function(n){this.bodyUsed=this.bodyUsed,this._bodyInit=n,n?typeof n=="string"?this._bodyText=n:lt.blob&&Blob.prototype.isPrototypeOf(n)?this._bodyBlob=n:lt.formData&&FormData.prototype.isPrototypeOf(n)?this._bodyFormData=n:lt.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)?this._bodyText=n.toString():lt.arrayBuffer&&lt.blob&&BS(n)?(this._bodyArrayBuffer=T0(n.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):lt.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(n)||P0(n))?this._bodyArrayBuffer=T0(n):this._bodyText=n=Object.prototype.toString.call(n):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||(typeof n=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):lt.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},lt.blob&&(this.blob=function(){var n=qg(this);if(n)return n;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var n=qg(this);return n||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}else{if(lt.blob)return this.blob().then(zS);throw new Error("could not read as ArrayBuffer")}},this.text=function(){var n=qg(this);if(n)return n;if(this._bodyBlob)return HS(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(GS(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},lt.formData&&(this.formData=function(){return this.text().then(KS)}),this.json=function(){return this.text().then(JSON.parse)},this}var VS=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function qS(n){var e=n.toUpperCase();return VS.indexOf(e)>-1?e:n}function Fs(n,e){if(!(this instanceof Fs))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');e=e||{};var t=e.body;if(n instanceof Fs){if(n.bodyUsed)throw new TypeError("Already read");this.url=n.url,this.credentials=n.credentials,e.headers||(this.headers=new ge(n.headers)),this.method=n.method,this.mode=n.mode,this.signal=n.signal,!t&&n._bodyInit!=null&&(t=n._bodyInit,n.bodyUsed=!0)}else this.url=String(n);if(this.credentials=e.credentials||this.credentials||"same-origin",(e.headers||!this.headers)&&(this.headers=new ge(e.headers)),this.method=qS(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal||function(){if("AbortController"in Ue){var s=new AbortController;return s.signal}}(),this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&t)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(t),(this.method==="GET"||this.method==="HEAD")&&(e.cache==="no-store"||e.cache==="no-cache")){var r=/([?&])_=[^&]*/;if(r.test(this.url))this.url=this.url.replace(r,"$1_="+new Date().getTime());else{var a=/\?/;this.url+=(a.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}Fs.prototype.clone=function(){return new Fs(this,{body:this._bodyInit})};function KS(n){var e=new FormData;return n.trim().split("&").forEach(function(t){if(t){var r=t.split("="),a=r.shift().replace(/\+/g," "),s=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(a),decodeURIComponent(s))}}),e}function JS(n){var e=new ge,t=n.replace(/\r?\n[\t ]+/g," ");return t.split("\r").map(function(r){return r.indexOf(`
`)===0?r.substr(1,r.length):r}).forEach(function(r){var a=r.split(":"),s=a.shift().trim();if(s){var i=a.join(":").trim();try{e.append(s,i)}catch(o){console.warn("Response "+o.message)}}}),e}k0.call(Fs.prototype);function Gr(n,e){if(!(this instanceof Gr))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(e||(e={}),this.type="default",this.status=e.status===void 0?200:e.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=e.statusText===void 0?"":""+e.statusText,this.headers=new ge(e.headers),this.url=e.url||"",this._initBody(n)}k0.call(Gr.prototype);Gr.prototype.clone=function(){return new Gr(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new ge(this.headers),url:this.url})};Gr.error=function(){var n=new Gr(null,{status:200,statusText:""});return n.ok=!1,n.status=0,n.type="error",n};var WS=[301,302,303,307,308];Gr.redirect=function(n,e){if(WS.indexOf(e)===-1)throw new RangeError("Invalid status code");return new Gr(null,{status:e,headers:{location:n}})};var Us=Ue.DOMException;try{new Us}catch{Us=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack},Us.prototype=Object.create(Error.prototype),Us.prototype.constructor=Us}function C0(n,e){return new Promise(function(t,r){var a=new Fs(n,e);if(a.signal&&a.signal.aborted)return r(new Us("Aborted","AbortError"));var s=new XMLHttpRequest;function i(){s.abort()}s.onload=function(){var l={statusText:s.statusText,headers:JS(s.getAllResponseHeaders()||"")};a.url.indexOf("file://")===0&&(s.status<200||s.status>599)?l.status=200:l.status=s.status,l.url="responseURL"in s?s.responseURL:l.headers.get("X-Request-URL");var c="response"in s?s.response:s.responseText;setTimeout(function(){t(new Gr(c,l))},0)},s.onerror=function(){setTimeout(function(){r(new TypeError("Network request failed"))},0)},s.ontimeout=function(){setTimeout(function(){r(new TypeError("Network request timed out"))},0)},s.onabort=function(){setTimeout(function(){r(new Us("Aborted","AbortError"))},0)};function o(l){try{return l===""&&Ue.location.href?Ue.location.href:l}catch{return l}}if(s.open(a.method,o(a.url),!0),a.credentials==="include"?s.withCredentials=!0:a.credentials==="omit"&&(s.withCredentials=!1),"responseType"in s&&(lt.blob?s.responseType="blob":lt.arrayBuffer&&(s.responseType="arraybuffer")),e&&typeof e.headers=="object"&&!(e.headers instanceof ge||Ue.Headers&&e.headers instanceof Ue.Headers)){var u=[];Object.getOwnPropertyNames(e.headers).forEach(function(l){u.push(ho(l)),s.setRequestHeader(l,Kg(e.headers[l]))}),a.headers.forEach(function(l,c){u.indexOf(c)===-1&&s.setRequestHeader(c,l)})}else a.headers.forEach(function(l,c){s.setRequestHeader(c,l)});a.signal&&(a.signal.addEventListener("abort",i),s.onreadystatechange=function(){s.readyState===4&&a.signal.removeEventListener("abort",i)}),s.send(typeof a._bodyInit>"u"?null:a._bodyInit)})}C0.polyfill=!0;Ue.fetch||(Ue.fetch=C0,Ue.Headers=ge,Ue.Request=Fs,Ue.Response=Gr);var ZS="0.5.2",YS=Object.defineProperty,XS=(n,e,t)=>e in n?YS(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Wg=(n,e,t)=>(XS(n,typeof e!="symbol"?e+"":e,t),t),Yg=class n extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,n)}},Xg=class{constructor(e,t,r){Wg(this,"abortController"),Wg(this,"itr"),Wg(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=r}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(let e of this.itr){if("error"in e)throw new Error(e.error);if(yield e,e.done||e.status==="success"){this.doneCallback();return}}throw new Error("Did not receive done or success response in stream.")}},Qg=async n=>{if(n.ok)return;let e=`Error ${n.status}: ${n.statusText}`,t=null;if(n.headers.get("content-type")?.includes("application/json"))try{t=await n.json(),e=t.error||e}catch{console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response"),e=await n.text()||e}catch{console.log("Failed to get text from error response")}throw new Yg(e,n.status)};function QS(){return typeof window<"u"&&window.navigator?`${window.navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:typeof process<"u"?`${process.arch} ${process.platform} Node.js/${process.version}`:""}var eb=async(n,e,t={})=>{let r={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/${ZS} (${QS()})`};return t.headers||(t.headers={}),t.headers={...r,...t.headers},n(e,t)},R0=async(n,e)=>{let t=await eb(n,e);return await Qg(t),t};var el=async(n,e,t,r)=>{let s=(o=>o!==null&&typeof o=="object"&&!Array.isArray(o))(t)?JSON.stringify(t):t,i=await eb(n,e,{method:"POST",body:s,signal:r?.signal});return await Qg(i),i},ek=async(n,e,t)=>{let r=await eb(n,e,{method:"DELETE",body:JSON.stringify(t)});return await Qg(r),r},tk=async function*(n){let e=new TextDecoder("utf-8"),t="",r=n.getReader();for(;;){let{done:a,value:s}=await r.read();if(a)break;t+=e.decode(s);let i=t.split(`
`);t=i.pop()??"";for(let o of i)try{yield JSON.parse(o)}catch{console.warn("invalid json: ",o)}}for(let a of t.split(`
`).filter(s=>s!==""))try{yield JSON.parse(a)}catch{console.warn("invalid json: ",a)}},rk=n=>{if(!n)return"http://127.0.0.1:11434";let e=n.includes("://");n.startsWith(":")&&(n=`http://127.0.0.1${n}`,e=!1),e||(n=`http://${n}`);let t=new URL(n),r=t.port;r||(e?r=t.protocol==="https:"?"443":"80":r="11434");let a=`${t.protocol}//${t.hostname}:${r}${t.pathname}`;return a.endsWith("/")&&(a=a.slice(0,-1)),a},nk=Object.defineProperty,ak=(n,e,t)=>e in n?nk(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Zg=(n,e,t)=>(ak(n,typeof e!="symbol"?e+"":e,t),t),mf=class{constructor(e){Zg(this,"config"),Zg(this,"fetch"),Zg(this,"ongoingStreamedRequests",[]),this.config={host:""},e?.proxy||(this.config.host=rk(e?.host??"http://127.0.0.1:11434")),this.fetch=fetch,e?.fetch!=null&&(this.fetch=e.fetch)}abort(){for(let e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,t){t.stream=t.stream??!1;let r=`${this.config.host}/api/${e}`;if(t.stream){let s=new AbortController,i=await el(this.fetch,r,t,{signal:s.signal});if(!i.body)throw new Error("Missing body");let o=tk(i.body),u=new Xg(s,o,()=>{let l=this.ongoingStreamedRequests.indexOf(u);l>-1&&this.ongoingStreamedRequests.splice(l,1)});return this.ongoingStreamedRequests.push(u),u}return await(await el(this.fetch,r,t)).json()}async encodeImage(e){if(typeof e!="string"){let t=new Uint8Array(e),r="",a=t.byteLength;for(let s=0;s<a;s++)r+=String.fromCharCode(t[s]);return btoa(r)}return e}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(let t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{name:e.model,stream:e.stream,modelfile:e.modelfile,quantize:e.quantize})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await ek(this.fetch,`${this.config.host}/api/delete`,{name:e.model}),{status:"success"}}async copy(e){return await el(this.fetch,`${this.config.host}/api/copy`,{...e}),{status:"success"}}async list(){return await(await R0(this.fetch,`${this.config.host}/api/tags`)).json()}async show(e){return await(await el(this.fetch,`${this.config.host}/api/show`,{...e})).json()}async embeddings(e){return await(await el(this.fetch,`${this.config.host}/api/embeddings`,{...e})).json()}async ps(){return await(await R0(this.fetch,`${this.config.host}/api/ps`)).json()}},sk=new mf;async function gf(n,e){let t;try{switch(n){case Ye[0]:let r=await fetch("https://api.openai.com/v1/models",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw acode.alert("AI Assistant",`Error fetching OpenAI models: ${r.statusText}`),new Error(`Error fetching OpenAI models: ${r.statusText}`);t=(await r.json()).data.filter(p=>/gpt/i.test(p.id)).map(p=>p.id);break;case Ye[1]:let s=await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${e}`,{headers:{"Content-Type":"application/json"}});if(!s.ok)throw acode.alert("AI Assistant",`Error fetching Google AI models: ${s.statusText}`),new Error(`Error fetching Google AI models: ${s.statusText}`);t=(await s.json()).models.filter(p=>/gemini/i.test(p.name)).map(p=>p.name.replace(/^models\//,""));break;case Ye[2]:let o=await fetch("https://api.deepseek.com/v1/models",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!o.ok)throw acode.alert("AI Assistant",`Error fetching Deepseek AI models: ${o.statusText}`),new Error(`Error fetching Deepseek AI models: ${o.statusText}`);t=(await o.json()).data.map(p=>p.id);break;case Ye[3]:let l=window.localStorage.getItem("Ollama-Host")?window.localStorage.getItem("Ollama-Host"):"http://localhost:11434";t=(await new mf({host:l}).list()).models.map(p=>p.model);break;case Ye[4]:let d=await fetch("https://api.groq.com/openai/v1/models",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!d.ok)throw acode.alert("AI Assistant",`Error fetching Groq AI models: ${d.statusText}`),new Error(`Error fetching Groq AI models: ${d.statusText}`);t=(await d.json()).data.map(p=>p.id);break;default:throw new Error(`Unsupported provider: ${n}`)}}catch(r){console.error(r.message)}return t}var MJ=acode.require("multiPrompt"),ct=acode.require("fs"),tl=acode.require("select"),tb=acode.require("prompt"),ik=acode.require("dialogBox"),ok=acode.require("helpers"),On=acode.require("loader"),$J=acode.require("sidebarApps"),LJ=acode.require("toInternalUrl"),uk=acode.require("contextMenu"),{editor:lk}=editorManager,bf=window.DATA_STORAGE+"chatgpt",An=null,nb=class{async init(e){this.$githubDarkFile=tag("link",{rel:"stylesheet",href:this.baseUrl+"assets/github-dark.css"}),this.$higlightJsFile=tag("script",{src:this.baseUrl+"assets/highlight.min.js"}),this.$markdownItFile=tag("script",{src:this.baseUrl+"assets/markdown-it.min.js"}),this.$style=tag("style",{textContent:ab}),document.head.append(this.$githubDarkFile,this.$higlightJsFile,this.$markdownItFile,this.$style),lk.commands.addCommand({name:"ai_assistant",description:"AI Assistant",exec:this.run.bind(this)}),e.id="acode-ai-assistant",e.settitle("AI Assistant"),this.$page=e;let t=tag("span",{className:"icon more_vert",dataset:{action:"toggle-menu"}}),r=tag("span",{className:"icon historyrestore",dataset:{action:"history"}}),a=tag("span",{className:"icon add",dataset:{action:"new-chat"}});this.$page.header.append(a,r,t),r.onclick=this.myHistory.bind(this),a.onclick=this.newChat.bind(this);let i=uk({innerHTML:()=>`
        <li action="model-provider" provider="">Provider: ${window.localStorage.getItem("ai-assistant-provider")}</li>
        <li action="model" modelNme="">Model: ${window.localStorage.getItem("ai-assistant-model-name")}</li>
        `,...{top:"35px",right:"10px",toggler:t,transformOrigin:"top right"}});i.onclick=async u=>{switch(i.hide(),u.target.getAttribute("action")){case"model-provider":let c=window.localStorage.getItem("ai-assistant-provider"),f=await tl("Select AI Provider",Ye,{default:c||""});if(c!=f)if(window.localStorage.getItem(f)===null){let m=f==Ye[3]?"No Need Of API Key":await tb("API key of selected provider","","text",{required:!0});if(!m)return;On.showTitleLoader(),window.toast("Fetching available models from your account",2e3);let g=await gf(f,m);On.removeTitleLoader();let b=await tl("Select AI Model",g);window.localStorage.setItem("ai-assistant-provider",f),window.localStorage.setItem("ai-assistant-model-name",b),await this.apiKeyManager.saveAPIKey(f,m),this.initiateModel(f,m,b),this.newChat()}else{let m=await this.apiKeyManager.getAPIKey(f);this.initiateModel(f,m,window.localStorage.getItem("ai-assistant-model-name")),this.newChat()}break;case"model":On.showTitleLoader(),window.toast("Fetching available models from your account",2e3);let d=await this.apiKeyManager.getAPIKey(window.localStorage.getItem("ai-assistant-provider")),h=await gf(window.localStorage.getItem("ai-assistant-provider"),d);On.removeTitleLoader();let p=await tl("Select AI Model",h,{default:window.localStorage.getItem("ai-assistant-model-name")||""});window.localStorage.getItem("ai-assistant-model-name")!=p&&(window.localStorage.setItem("ai-assistant-model-name",p),this.initiateModel(window.localStorage.getItem("ai-assistant-provider"),d,p));break}};let o=tag("div",{className:"mainApp"});this.$chatBox=tag("div",{className:"chatBox"}),this.$inputBox=tag("div",{className:"inputBox"}),this.$chatTextarea=tag("textarea",{className:"chatTextarea",placeholder:"Type your query..."}),this.$sendBtn=tag("button",{className:"sendBtn"}),this.$sendBtn.innerHTML=A0,this.$inputBox.append(this.$chatTextarea,this.$sendBtn),o.append(this.$inputBox,this.$chatBox),this.$page.append(o),acode.addIcon("ai-assistant-icon",this.baseUrl+"assets/ai_assistant.svg"),this.messageHistories={},this.messageSessionConfig={configurable:{sessionId:S()}}}async run(){try{let e;if(await ct(window.DATA_STORAGE+"secret.key").exists())e=await ct(window.DATA_STORAGE+"secret.key").readFile("utf-8");else{let s=await tb("Enter a secret pass pharse to save the api key","","text",{required:!0});if(!s)return;e=s}this.apiKeyManager=new pf(e);let t,r=window.localStorage.getItem("ai-assistant-provider");if(r)t=await this.apiKeyManager.getAPIKey(r);else{let s=await tl("Select AI Provider",Ye),i=s==Ye[3]?"No Need Of API Key":await tb("API key of selected provider","","text",{required:!0});if(!i)return;On.showTitleLoader(),window.toast("Fetching available models from your account",2e3);let o=await gf(s,i);On.removeTitleLoader();let u=await tl("Select AI Model",o);window.localStorage.setItem("ai-assistant-provider",s),window.localStorage.setItem("ai-assistant-model-name",u),r=s,t=i,await ct(window.DATA_STORAGE).createFile("secret.key",e),await this.apiKeyManager.saveAPIKey(r,t),window.toast("Configuration saved \u{1F389}",3e3)}let a=window.localStorage.getItem("ai-assistant-model-name");this.initiateModel(r,t,a),this.$mdIt=window.markdownit({html:!1,xhtmlOut:!1,breaks:!1,linkify:!1,typographer:!1,quotes:"\u201C\u201D\u2018\u2019",highlight:function(s,i){let o=document.createElement("button");o.classList.add("copy-button"),o.innerHTML=E0,o.setAttribute("data-str",s);let u=`<pre class="hljs codesArea"><code>${hljs.highlightAuto(s).value}</code></pre>`;return`<div class="codeBlock">${o.outerHTML}${u}</div>`}}),this.$sendBtn.addEventListener("click",this.sendQuery.bind(this)),this.$page.show()}catch(e){console.log(e)}}initiateModel(e,t,r){switch(e){case Ye[0]:this.modelInstance=new fo({apiKey:t,model:r});break;case Ye[1]:this.modelInstance=new Jc({model:r,apiKey:t,safetySettings:[{category:rl.HARM_CATEGORY_HARASSMENT,threshold:nl.BLOCK_LOW_AND_ABOVE}]});break;case Ye[2]:this.modelInstance=new fo({apiKey:t,model:r,azureOpenAIBasePath:"https://api.deepseek.com/v1"});break;case Ye[3]:let a=window.localStorage.getItem("Ollama-Host")?window.localStorage.getItem("Ollama-Host"):"http://localhost:11434";this.modelInstance=new tc({baseUrl:a,model:r});break;case Ye[4]:this.modelInstance=new nd({apiKey:t,model:r});break;default:throw new Error("Unknown provider")}}_sanitizeFileName(e){return e.replace(/[^\w\s.-]/gi,"").trim().replace(/\s+/g,"_")}transformMessages(e){return e.map((r,a)=>a%2===0&&a+1<e.length?{prompt:e[a].content,result:e[a+1].content}:null).filter(r=>r!==null)}async saveHistory(){try{let e=this.messageSessionConfig.configurable.sessionId;if(!this.messageHistories[e].messages.length)return;if(An==null)try{let r=`${this._sanitizeFileName(this.messageHistories[e].messages[0].content.substring(0,30))}__${e}.json`;await ct(bf).exists()||await ct(window.DATA_STORAGE).createDirectory("chatgpt");let a=await this.messageHistories[e].getMessages(),s=this.transformMessages(a);An=await ct(bf).createFile(r,s)}catch(t){alert(t.message)}else try{if(!await ct(An).exists()){this.newChat(),window.toast("Some error occurred or file you trying to open has been deleted");return}let t=await this.messageHistories[e].getMessages();An=await ct(An).writeFile(this.transformMessages(t))}catch(t){alert(t.message)}}catch(e){window.alert(e.message)}}newChat(){this.$chatBox.innerHTML="",window.toast("New session",3e3),this.messageHistories={},this.messageSessionConfig={configurable:{sessionId:S()}},An=null}async getHistoryItems(){if(await ct(bf).exists()){let e=await ct(bf).lsDir(),t="";for(let r=0;r<e.length;r++)t+=`<li class="dialog-item" style="background: var(--secondary-color);color: var(--secondary-text-color);padding: 5px;margin-bottom: 5px;border-radius: 8px;font-size:15px;display:flex;flex-direction:row;justify-content:space-between;gap:5px;" data-path="${JSON.parse(JSON.stringify(e[r])).url}">
                  <p class="history-item">${e[r].name.split("__")[0].substring(0,25)}...</p><div><button class="delete-history-btn" style="height:25px;width:25px;border:none;padding:5px;outline:none;border-radius:50%;background:var(--error-text-color);text-align:center;">\u2717</button></div>
                </li>`;return t}else{let e="";return e='<li style="background: var(--secondary-color);color: var(--secondary-text-color);padding: 10px;border-radius: 8px;" data-path="#not-available">Not Available</li>',e}}extractUUID(e){let t=/([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})/,r=e.match(t);return r?r[0]:null}async displayHistory(e,t){this.$chatBox.innerHTML="";let r=e.slice(1,e.length-1),a=this.extractUUID(r);if(!a){this.newChat(),window.toast("Some error occurred");return}if(!await ct(r).exists()){this.newChat(),window.toast("Some error occurred or file you trying to open has been deleted");return}An=r;try{t.hide(),On.create("Wait","Fetching chat history....");let s=await ct(r).readFile(),i=JSON.parse(await ok.decodeText(s));this.messageHistories={},this.messageHistories[a]=new Do;let o=i.flatMap(u=>[new Ae({content:u.prompt}),new Oe({content:u.result})]);await this.messageHistories[a].addMessages(o),this.messageSessionConfig={configurable:{sessionId:a}},i.forEach(u=>{this.appendUserQuery(u.prompt),this.appendGptResponse(u.result)}),On.destroy()}catch(s){On.destroy(),console.error(s.message)}}async myHistory(){try{let t=`<ul>${await this.getHistoryItems()}</ul>`,r=ik("Conversation History",t,"Cancel");r.onclick(async a=>{let s=a.target.closest(".dialog-item"),i=s.querySelector(".delete-history-btn"),o=s.querySelector(".history-item");if(s.getAttribute("data-path")!="#not-available"&&s.getAttribute("data-path")){if(a.target===s||a.target===o){let u=JSON.stringify(s.getAttribute("data-path"));this.displayHistory(u,r)}else if(a.target===i){let u=JSON.stringify(s.getAttribute("data-path")),l=u.slice(1,u.length-1);if(await ct(s.getAttribute("data-path")).delete(),An==l){let c=document.querySelector(".chatBox");c.innerHTML="",this.messageHistories={},this.messageSessionConfig={configurable:{sessionId:S()}}}s.remove(),window.toast("Deleted",3e3),An=null}}})}catch(e){window.alert(e.message)}}async sendQuery(){let e=this.$chatTextarea;e.value!=""&&(this.appendUserQuery(e.value),this.scrollToBottom(),this.appendGptResponse(""),this.loader(),this.getChatgptResponse(e.value),e.value="")}async appendUserQuery(e){try{let t=this.baseUrl+"assets/user_avatar.png",r=tag("div",{className:"wrapper"}),a=tag("div",{className:"chat"}),s=tag("div",{className:"profile",child:tag("img",{src:t,alt:"user"})}),i=tag("div",{className:"message",textContent:e});a.append(s,i),r.append(a),this.$chatBox.appendChild(r)}catch(t){window.alert(t)}}async appendGptResponse(e){let t=this.baseUrl+"assets/ai_assistant.svg",r=tag("div",{className:"ai_wrapper"}),a=tag("div",{className:"ai_chat"}),s=tag("div",{className:"ai_profile",child:tag("img",{src:t,alt:"ai"})}),i=tag("div",{className:"ai_message"});i.innerHTML=this.$mdIt.render(e);let o=i.querySelectorAll(".copy-button");if(o)for(let u of o)u.addEventListener("click",function(){(0,rb.default)(this.dataset.str),window.toast("Copied to clipboard",3e3)});a.append(s,i),r.append(a),this.$chatBox.appendChild(r)}async getChatgptResponse(e){try{let t=Array.from(document.querySelectorAll(".ai_message")),r=xi.fromMessages([["system","You are an AI assistant for the open source plugin AI Assistant for Acode code editor(open source vscode like code editor for Android)."],["placeholder","{chat_history}"],["human","{input}"]]),a=new Mc,s=r.pipe(this.modelInstance).pipe(a),o=await new Qo({runnable:s,getMessageHistory:d=>(this.messageHistories[d]===void 0&&(this.messageHistories[d]=new Do),this.messageHistories[d]),inputMessagesKey:"input",historyMessagesKey:"chat_history"}).stream({input:e},this.messageSessionConfig);clearInterval(this.$loadInterval);let u=t[t.length-1];u.innerHTML="";let l="";for await(let d of o)l+=d,u.textContent+=d,this.scrollToBottom();let c=this.$mdIt.render(l);u.innerHTML=c;let f=u.querySelectorAll(".copy-button");if(f)for(let d of f)d.addEventListener("click",function(){(0,rb.default)(this.dataset.str),window.toast("Copied to clipboard",3e3)});await this.saveHistory()}catch(t){let r=Array.from(document.querySelectorAll(".ai_message"));clearInterval(this.$loadInterval);let a=r[r.length-1];a.innerHTML="";let s=tag("div",{className:"error-box"});t.response?s.innerText=`Status code: ${t.response.status}
${JSON.stringify(t.response.data)}`:s.innerText=`${t.message}`,a.appendChild(s)}}async scrollToBottom(){this.$chatBox.scrollTop=this.$chatBox.scrollHeight}async loader(){let e=Array.from(document.querySelectorAll(".ai_message"));e.length!=0&&(this.$loadInterval=setInterval(()=>{e[e.length-1].innerText+="\u2022",e[e.length-1].innerText=="\u2022\u2022\u2022\u2022\u2022\u2022"&&(e[e.length-1].innerText="\u2022")},300))}async destroy(){editorManager.editor.commands.removeCommand("ai_assistant"),window.localStorage.removeItem(window.localStorage.getItem("ai-assistant-provider")),window.localStorage.removeItem("ai-assistant-provider"),window.localStorage.removeItem("ai-assistant-model-name"),await ct(window.DATA_STORAGE+"secret.key").exists()&&await ct(window.DATA_STORAGE+"secret.key").delete(),this.$githubDarkFile.remove(),this.$higlightJsFile.remove(),this.$markdownItFile.remove(),this.$style.remove()}};if(window.acode){let n=new nb;acode.setPluginInit(_f.id,(e,t,{cacheFileUrl:r,cacheFile:a})=>{e.endsWith("/")||(e+="/"),n.baseUrl=e,n.init(t,a,r)}),acode.setPluginUnmount(_f.id,()=>{n.destroy()})}})();
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

mustache/mustache.mjs:
  (*!
   * mustache.js - Logic-less {{mustache}} templates with JavaScript
   * http://github.com/janl/mustache.js
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)
*/
